"use strict";(globalThis.webpackChunkjobmetric_document=globalThis.webpackChunkjobmetric_document||[]).push([[9745],{22068(e,t,a){a.r(t),a.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>v,frontMatter:()=>l,metadata:()=>n,toc:()=>o});const n=JSON.parse('{"id":"laravel-metadata/deep-diving/events","title":"Events","description":"Laravel Metadata provides a comprehensive event system that fires domain events for all metadata operations. These events allow you to hook into the metadata lifecycle and perform additional actions when metadata is stored or deleted.","source":"@site/packages/laravel-metadata/deep-diving/events.md","sourceDirName":"laravel-metadata/deep-diving","slug":"/laravel-metadata/deep-diving/events","permalink":"/packages/laravel-metadata/deep-diving/events","draft":false,"unlisted":false,"editUrl":"https://github.com/jobmetric/document/blob/master/packages/laravel-metadata/deep-diving/events.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"sidebar_label":"Events"},"sidebar":"packagesSidebar","previous":{"title":"Meta","permalink":"/packages/laravel-metadata/deep-diving/models/meta"},"next":{"title":"MetadataResource","permalink":"/packages/laravel-metadata/deep-diving/resources/metadata-resource"}}');var d=a(74848),s=a(28453),i=a(28774);const l={sidebar_position:5,sidebar_label:"Events"},r="Events",c={},o=[{value:"Overview",id:"overview",level:2},{value:"Event Structure",id:"event-structure",level:2},{value:"Base Event Structure",id:"base-event-structure",level:3},{value:"Available Events",id:"available-events",level:2},{value:"Metadata Events",id:"metadata-events",level:3},{value:"Listening to Events",id:"listening-to-events",level:2},{value:"Method 1: Event Listeners in Service Provider",id:"method-1-event-listeners-in-service-provider",level:3},{value:"Method 2: Using Event Facade",id:"method-2-using-event-facade",level:3},{value:"Method 3: Using Event Subscribers",id:"method-3-using-event-subscribers",level:3},{value:"Complete Examples",id:"complete-examples",level:2},{value:"Example 1: Cache Invalidation on Metadata Changes",id:"example-1-cache-invalidation-on-metadata-changes",level:3},{value:"Example 2: Audit Logging",id:"example-2-audit-logging",level:3},{value:"Example 3: Search Index Updates",id:"example-3-search-index-updates",level:3},{value:"Example 4: Notification System",id:"example-4-notification-system",level:3},{value:"Example 5: Analytics Tracking",id:"example-5-analytics-tracking",level:3},{value:"Example 6: Validation and Business Rules",id:"example-6-validation-and-business-rules",level:3},{value:"Example 7: Metadata Synchronization",id:"example-7-metadata-synchronization",level:3},{value:"Example 8: Complete Event Listener Setup",id:"example-8-complete-event-listener-setup",level:3},{value:"Event Timing",id:"event-timing",level:2},{value:"MetadataStoringEvent",id:"metadatastoringevent",level:3},{value:"MetadataStoredEvent",id:"metadatastoredevent",level:3},{value:"MetadataDeletingEvent / MetadataDeletedEvent",id:"metadatadeletingevent--metadatadeletedevent",level:3},{value:"Queued Events",id:"queued-events",level:2},{value:"Event Payload Details",id:"event-payload-details",level:2},{value:"MetadataStoringEvent",id:"metadatastoringevent-1",level:3},{value:"MetadataStoredEvent",id:"metadatastoredevent-1",level:3},{value:"MetadataDeletingEvent / MetadataDeletedEvent",id:"metadatadeletingevent--metadatadeletedevent-1",level:3},{value:"When to Use Events",id:"when-to-use-events",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function h(e){const t={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(t.header,{children:(0,d.jsx)(t.h1,{id:"events",children:"Events"})}),"\n",(0,d.jsx)(t.p,{children:"Laravel Metadata provides a comprehensive event system that fires domain events for all metadata operations. These events allow you to hook into the metadata lifecycle and perform additional actions when metadata is stored or deleted."}),"\n",(0,d.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,d.jsx)(t.p,{children:"The event system in Laravel Metadata:"}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Fires automatically"})," during metadata operations"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Provides model and metadata instances"})," in event payloads"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Uses DomainEvent interface"})," for consistency"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Supports event listeners"})," for custom logic"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Enables event-driven architecture"})," for metadata management"]}),"\n"]}),"\n",(0,d.jsx)(t.h2,{id:"event-structure",children:"Event Structure"}),"\n",(0,d.jsx)(t.p,{children:"All events in Laravel Metadata:"}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:["Implement ",(0,d.jsx)(t.code,{children:"JobMetric\\EventSystem\\Contracts\\DomainEvent"})]}),"\n",(0,d.jsxs)(t.li,{children:["Are ",(0,d.jsx)(t.code,{children:"readonly"})," classes for immutability"]}),"\n",(0,d.jsx)(t.li,{children:"Contain model and metadata information"}),"\n",(0,d.jsxs)(t.li,{children:["Provide a stable ",(0,d.jsx)(t.code,{children:"key()"})," method"]}),"\n",(0,d.jsxs)(t.li,{children:["Include metadata via ",(0,d.jsx)(t.code,{children:"definition()"})," method"]}),"\n"]}),"\n",(0,d.jsx)(t.h3,{id:"base-event-structure",children:"Base Event Structure"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"readonly class MetadataStoredEvent implements DomainEvent\n{\n    public function __construct(\n        public Model $model,\n        public Meta $meta\n    ) {}\n\n    public static function key(): string\n    {\n        return 'metadata.stored';\n    }\n\n    public static function definition(): DomainEventDefinition\n    {\n        return new DomainEventDefinition(\n            self::key(),\n            'metadata::base.entity_names.metadata',\n            'metadata::base.events.metadata_stored.title',\n            'metadata::base.events.metadata_stored.description',\n            'fas fa-save',\n            ['metadata', 'storage', 'management']\n        );\n    }\n}\n"})}),"\n",(0,d.jsx)(t.h2,{id:"available-events",children:"Available Events"}),"\n",(0,d.jsx)(t.h3,{id:"metadata-events",children:"Metadata Events"}),"\n",(0,d.jsx)(t.p,{children:"Events fired for metadata operations."}),"\n",(0,d.jsxs)(t.table,{children:[(0,d.jsx)(t.thead,{children:(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.th,{children:"Event Class"}),(0,d.jsx)(t.th,{children:"Event Key"}),(0,d.jsx)(t.th,{children:"Description"}),(0,d.jsx)(t.th,{children:"Payload"}),(0,d.jsx)(t.th,{children:"Triggered When"})]})}),(0,d.jsxs)(t.tbody,{children:[(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"MetadataStoringEvent"})}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"metadata.storing"})}),(0,d.jsx)(t.td,{children:"Fired before metadata is stored"}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"Model $model, string $key, array|string|bool|null $value"})}),(0,d.jsxs)(t.td,{children:["Before ",(0,d.jsx)(t.code,{children:"HasMeta::storeMetadata()"})," saves to database"]})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"MetadataStoredEvent"})}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"metadata.stored"})}),(0,d.jsx)(t.td,{children:"Fired after metadata is stored"}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"Model $model, Meta $meta"})}),(0,d.jsxs)(t.td,{children:["After ",(0,d.jsx)(t.code,{children:"HasMeta::storeMetadata()"})," saves to database"]})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"MetadataDeletingEvent"})}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"metadata.deleting"})}),(0,d.jsx)(t.td,{children:"Fired before metadata is deleted"}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"Meta $meta"})}),(0,d.jsxs)(t.td,{children:["Before ",(0,d.jsx)(t.code,{children:"HasMeta::forgetMetadata()"})," deletes from database"]})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"MetadataDeletedEvent"})}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"metadata.deleted"})}),(0,d.jsx)(t.td,{children:"Fired after metadata is deleted"}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"Meta $meta"})}),(0,d.jsxs)(t.td,{children:["After ",(0,d.jsx)(t.code,{children:"HasMeta::forgetMetadata()"})," deletes from database"]})]})]})]}),"\n",(0,d.jsxs)(t.p,{children:[(0,d.jsx)(t.strong,{children:"Namespace:"})," ",(0,d.jsx)(t.code,{children:"JobMetric\\Metadata\\Events\\*"})]}),"\n",(0,d.jsx)(t.h2,{id:"listening-to-events",children:"Listening to Events"}),"\n",(0,d.jsx)(t.h3,{id:"method-1-event-listeners-in-service-provider",children:"Method 1: Event Listeners in Service Provider"}),"\n",(0,d.jsx)(t.p,{children:"Register event listeners in a service provider:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"namespace App\\Providers;\n\nuse Illuminate\\Foundation\\Support\\Providers\\EventServiceProvider as ServiceProvider;\nuse JobMetric\\Metadata\\Events\\MetadataStoredEvent;\nuse JobMetric\\Metadata\\Events\\MetadataDeletedEvent;\n\nclass EventServiceProvider extends ServiceProvider\n{\n    protected $listen = [\n        MetadataStoredEvent::class => [\n            \\App\\Listeners\\Metadata\\LogMetadataStored::class,\n            \\App\\Listeners\\Metadata\\InvalidateMetadataCache::class,\n            \\App\\Listeners\\Metadata\\UpdateSearchIndex::class,\n            \\App\\Listeners\\Metadata\\NotifyMetadataChange::class,\n        ],\n        MetadataDeletedEvent::class => [\n            \\App\\Listeners\\Metadata\\LogMetadataDeleted::class,\n            \\App\\Listeners\\Metadata\\InvalidateMetadataCache::class,\n        ],\n    ];\n\n    public function boot(): void\n    {\n        parent::boot();\n    }\n}\n"})}),"\n",(0,d.jsx)(t.h3,{id:"method-2-using-event-facade",children:"Method 2: Using Event Facade"}),"\n",(0,d.jsx)(t.p,{children:"Listen to events using the Event facade:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"use Illuminate\\Support\\Facades\\Event;\nuse JobMetric\\Metadata\\Events\\MetadataStoredEvent;\n\nEvent::listen(MetadataStoredEvent::class, function (MetadataStoredEvent $event) {\n    $model = $event->model;\n    $meta = $event->meta;\n    \n    // Perform actions\n    Log::info('Metadata stored', [\n        'model' => get_class($model),\n        'model_id' => $model->id,\n        'key' => $meta->key,\n        'value' => $meta->value,\n    ]);\n    \n    Cache::forget(\"metadata.{$model->getMorphClass()}.{$model->id}\");\n});\n"})}),"\n",(0,d.jsx)(t.h3,{id:"method-3-using-event-subscribers",children:"Method 3: Using Event Subscribers"}),"\n",(0,d.jsx)(t.p,{children:"Create event subscribers for multiple events:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"namespace App\\Listeners;\n\nuse Illuminate\\Events\\Dispatcher;\nuse JobMetric\\Metadata\\Events\\MetadataStoredEvent;\nuse JobMetric\\Metadata\\Events\\MetadataDeletedEvent;\n\nclass MetadataEventSubscriber\n{\n    public function handleMetadataStored(MetadataStoredEvent $event): void\n    {\n        $model = $event->model;\n        $meta = $event->meta;\n        \n        Log::info('Metadata stored', [\n            'model' => get_class($model),\n            'model_id' => $model->id,\n            'key' => $meta->key,\n            'value' => $meta->value,\n        ]);\n    }\n\n    public function handleMetadataDeleted(MetadataDeletedEvent $event): void\n    {\n        $meta = $event->meta;\n        \n        Log::warning('Metadata deleted', [\n            'meta_id' => $meta->id,\n            'key' => $meta->key,\n            'metaable_type' => $meta->metaable_type,\n            'metaable_id' => $meta->metaable_id,\n        ]);\n    }\n\n    public function subscribe(Dispatcher $events): void\n    {\n        $events->listen(\n            MetadataStoredEvent::class,\n            [MetadataEventSubscriber::class, 'handleMetadataStored']\n        );\n\n        $events->listen(\n            MetadataDeletedEvent::class,\n            [MetadataEventSubscriber::class, 'handleMetadataDeleted']\n        );\n    }\n}\n"})}),"\n",(0,d.jsx)(t.p,{children:"Register the subscriber:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"namespace App\\Providers;\n\nuse App\\Listeners\\MetadataEventSubscriber;\nuse Illuminate\\Foundation\\Support\\Providers\\EventServiceProvider as ServiceProvider;\n\nclass EventServiceProvider extends ServiceProvider\n{\n    protected $subscribe = [\n        MetadataEventSubscriber::class,\n    ];\n}\n"})}),"\n",(0,d.jsx)(t.h2,{id:"complete-examples",children:"Complete Examples"}),"\n",(0,d.jsx)(t.h3,{id:"example-1-cache-invalidation-on-metadata-changes",children:"Example 1: Cache Invalidation on Metadata Changes"}),"\n",(0,d.jsx)(t.p,{children:"Invalidate cache when metadata is modified:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:'namespace App\\Listeners\\Metadata;\n\nuse Illuminate\\Support\\Facades\\Cache;\nuse JobMetric\\Metadata\\Events\\MetadataStoredEvent;\nuse JobMetric\\Metadata\\Events\\MetadataDeletedEvent;\n\nclass InvalidateMetadataCache\n{\n    public function handle(MetadataStoredEvent|MetadataDeletedEvent $event): void\n    {\n        $model = $event->model ?? $event->meta->metaable;\n        $meta = $event->meta;\n\n        // Invalidate specific model metadata cache\n        Cache::forget("metadata.{$model->getMorphClass()}.{$model->id}");\n        Cache::forget("metadata.{$model->getMorphClass()}.{$model->id}.{$meta->key}");\n        \n        // Invalidate all metadata cache for this model\n        Cache::forget("metadata_all.{$model->getMorphClass()}.{$model->id}");\n\n        // Clear tagged cache\n        Cache::tags(["metadata_{$model->getMorphClass()}_{$model->id}"])->flush();\n    }\n}\n'})}),"\n",(0,d.jsx)(t.h3,{id:"example-2-audit-logging",children:"Example 2: Audit Logging"}),"\n",(0,d.jsx)(t.p,{children:"Log all metadata operations for audit trail:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"namespace App\\Listeners\\Metadata;\n\nuse App\\Models\\AuditLog;\nuse Illuminate\\Support\\Facades\\Auth;\nuse JobMetric\\Metadata\\Events\\MetadataStoredEvent;\nuse JobMetric\\Metadata\\Events\\MetadataDeletedEvent;\nuse JobMetric\\Metadata\\Events\\MetadataStoringEvent;\n\nclass AuditMetadataOperations\n{\n    public function handleMetadataStoring(MetadataStoringEvent $event): void\n    {\n        $this->logAudit('storing', $event->model, $event->key, $event->value);\n    }\n\n    public function handleMetadataStored(MetadataStoredEvent $event): void\n    {\n        $this->logAudit('stored', $event->model, $event->meta->key, $event->meta->value);\n    }\n\n    public function handleMetadataDeleted(MetadataDeletedEvent $event): void\n    {\n        $this->logAudit('deleted', $event->meta->metaable, $event->meta->key, $event->meta->value);\n    }\n\n    protected function logAudit(string $action, $model, string $key, $value): void\n    {\n        AuditLog::create([\n            'user_id' => Auth::id(),\n            'action' => \"metadata.{$action}\",\n            'model_type' => get_class($model),\n            'model_id' => $model->id,\n            'metadata_key' => $key,\n            'metadata_value' => is_array($value) ? json_encode($value) : $value,\n            'ip_address' => request()->ip(),\n        ]);\n    }\n}\n"})}),"\n",(0,d.jsx)(t.h3,{id:"example-3-search-index-updates",children:"Example 3: Search Index Updates"}),"\n",(0,d.jsx)(t.p,{children:"Update search index when important metadata changes:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"namespace App\\Listeners\\Metadata;\n\nuse App\\Services\\SearchService;\nuse JobMetric\\Metadata\\Events\\MetadataStoredEvent;\nuse JobMetric\\Metadata\\Events\\MetadataDeletedEvent;\n\nclass UpdateSearchIndex\n{\n    protected array $searchableKeys = ['title', 'description', 'tags', 'keywords', 'content'];\n\n    public function handleMetadataStored(MetadataStoredEvent $event): void\n    {\n        $meta = $event->meta;\n        \n        // Only update index for searchable keys\n        if (in_array($meta->key, $this->searchableKeys)) {\n            SearchService::index($event->model);\n        }\n    }\n\n    public function handleMetadataDeleted(MetadataDeletedEvent $event): void\n    {\n        $meta = $event->meta;\n        \n        // Re-index if searchable key was deleted\n        if (in_array($meta->key, $this->searchableKeys)) {\n            SearchService::index($meta->metaable);\n        }\n    }\n}\n"})}),"\n",(0,d.jsx)(t.h3,{id:"example-4-notification-system",children:"Example 4: Notification System"}),"\n",(0,d.jsx)(t.p,{children:"Send notifications when critical metadata changes:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"namespace App\\Listeners\\Metadata;\n\nuse App\\Notifications\\MetadataChanged;\nuse Illuminate\\Support\\Facades\\Notification;\nuse JobMetric\\Metadata\\Events\\MetadataStoredEvent;\n\nclass NotifyMetadataChanges\n{\n    protected array $notifiableKeys = ['status', 'published', 'approved', 'featured'];\n\n    public function handle(MetadataStoredEvent $event): void\n    {\n        $meta = $event->meta;\n        $model = $event->model;\n\n        // Only notify for specific keys\n        if (!in_array($meta->key, $this->notifiableKeys)) {\n            return;\n        }\n\n        // Get model owner\n        $owner = null;\n        if (method_exists($model, 'user')) {\n            $owner = $model->user;\n        } elseif (method_exists($model, 'author')) {\n            $owner = $model->author;\n        } elseif (method_exists($model, 'owner')) {\n            $owner = $model->owner;\n        }\n\n        if ($owner) {\n            $owner->notify(new MetadataChanged($model, $meta));\n        }\n\n        // Notify administrators for status changes\n        if ($meta->key === 'status' && in_array($meta->value, ['published', 'rejected'])) {\n            $admins = User::whereHas('roles', function ($query) {\n                $query->where('name', 'admin');\n            })->get();\n\n            Notification::send($admins, new MetadataChanged($model, $meta));\n        }\n    }\n}\n"})}),"\n",(0,d.jsx)(t.h3,{id:"example-5-analytics-tracking",children:"Example 5: Analytics Tracking"}),"\n",(0,d.jsx)(t.p,{children:"Track metadata changes for analytics:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"namespace App\\Listeners\\Metadata;\n\nuse App\\Services\\AnalyticsService;\nuse JobMetric\\Metadata\\Events\\MetadataStoredEvent;\nuse JobMetric\\Metadata\\Events\\MetadataDeletedEvent;\n\nclass TrackMetadataAnalytics\n{\n    public function __construct(\n        protected AnalyticsService $analytics\n    ) {}\n\n    public function handleMetadataStored(MetadataStoredEvent $event): void\n    {\n        $model = $event->model;\n        $meta = $event->meta;\n        \n        $this->analytics->track('metadata.stored', [\n            'model_type' => get_class($model),\n            'model_id' => $model->id,\n            'metadata_key' => $meta->key,\n            'metadata_value' => $meta->value,\n            'is_json' => $meta->is_json,\n            'meta_id' => $meta->id,\n        ]);\n    }\n\n    public function handleMetadataDeleted(MetadataDeletedEvent $event): void\n    {\n        $meta = $event->meta;\n        \n        $this->analytics->track('metadata.deleted', [\n            'meta_id' => $meta->id,\n            'metadata_key' => $meta->key,\n            'metadata_value' => $meta->value,\n            'metaable_type' => $meta->metaable_type,\n            'metaable_id' => $meta->metaable_id,\n            'deleted_at' => now(),\n        ]);\n    }\n}\n"})}),"\n",(0,d.jsx)(t.h3,{id:"example-6-validation-and-business-rules",children:"Example 6: Validation and Business Rules"}),"\n",(0,d.jsx)(t.p,{children:"Validate metadata before storing:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"namespace App\\Listeners\\Metadata;\n\nuse Illuminate\\Validation\\ValidationException;\nuse JobMetric\\Metadata\\Events\\MetadataStoringEvent;\n\nclass ValidateMetadataRules\n{\n    public function handle(MetadataStoringEvent $event): void\n    {\n        $key = $event->key;\n        $value = $event->value;\n        $model = $event->model;\n\n        // Validate specific keys\n        if ($key === 'price' && is_numeric($value) && $value < 0) {\n            throw ValidationException::withMessages([\n                'metadata.price' => 'Price cannot be negative.',\n            ]);\n        }\n\n        if ($key === 'email' && !filter_var($value, FILTER_VALIDATE_EMAIL)) {\n            throw ValidationException::withMessages([\n                'metadata.email' => 'Invalid email format.',\n            ]);\n        }\n\n        if ($key === 'status' && !in_array($value, ['draft', 'published', 'archived'])) {\n            throw ValidationException::withMessages([\n                'metadata.status' => 'Invalid status value.',\n            ]);\n        }\n\n        // Business rule: Cannot publish without required metadata\n        if ($key === 'status' && $value === 'published') {\n            $requiredKeys = ['title', 'description', 'content'];\n            $existingKeys = $model->metas()->pluck('key')->toArray();\n            \n            $missing = array_diff($requiredKeys, $existingKeys);\n            if (!empty($missing)) {\n                throw ValidationException::withMessages([\n                    'metadata.status' => 'Cannot publish without: ' . implode(', ', $missing),\n                ]);\n            }\n        }\n    }\n}\n"})}),"\n",(0,d.jsx)(t.h3,{id:"example-7-metadata-synchronization",children:"Example 7: Metadata Synchronization"}),"\n",(0,d.jsx)(t.p,{children:"Synchronize metadata with external systems:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"namespace App\\Listeners\\Metadata;\n\nuse App\\Services\\ExternalApiService;\nuse JobMetric\\Metadata\\Events\\MetadataStoredEvent;\nuse JobMetric\\Metadata\\Events\\MetadataDeletedEvent;\n\nclass SynchronizeMetadata\n{\n    protected array $syncableKeys = ['status', 'category', 'tags', 'featured'];\n\n    public function __construct(\n        protected ExternalApiService $externalApi\n    ) {}\n\n    public function handleMetadataStored(MetadataStoredEvent $event): void\n    {\n        $meta = $event->meta;\n        \n        // Only sync specific keys\n        if (!in_array($meta->key, $this->syncableKeys)) {\n            return;\n        }\n\n        $this->externalApi->syncMetadata(\n            $event->model,\n            $meta->key,\n            $meta->value\n        );\n    }\n\n    public function handleMetadataDeleted(MetadataDeletedEvent $event): void\n    {\n        $meta = $event->meta;\n        \n        if (in_array($meta->key, $this->syncableKeys)) {\n            $this->externalApi->deleteMetadata(\n                $meta->metaable,\n                $meta->key\n            );\n        }\n    }\n}\n"})}),"\n",(0,d.jsx)(t.h3,{id:"example-8-complete-event-listener-setup",children:"Example 8: Complete Event Listener Setup"}),"\n",(0,d.jsx)(t.p,{children:"Complete setup for all metadata events:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"namespace App\\Providers;\n\nuse App\\Listeners\\Metadata\\AuditMetadataOperations;\nuse App\\Listeners\\Metadata\\InvalidateMetadataCache;\nuse App\\Listeners\\Metadata\\NotifyMetadataChanges;\nuse App\\Listeners\\Metadata\\TrackMetadataAnalytics;\nuse App\\Listeners\\Metadata\\UpdateSearchIndex;\nuse App\\Listeners\\Metadata\\ValidateMetadataRules;\nuse App\\Listeners\\Metadata\\SynchronizeMetadata;\nuse Illuminate\\Foundation\\Support\\Providers\\EventServiceProvider as ServiceProvider;\nuse JobMetric\\Metadata\\Events\\MetadataStoringEvent;\nuse JobMetric\\Metadata\\Events\\MetadataStoredEvent;\nuse JobMetric\\Metadata\\Events\\MetadataDeletingEvent;\nuse JobMetric\\Metadata\\Events\\MetadataDeletedEvent;\n\nclass EventServiceProvider extends ServiceProvider\n{\n    protected $listen = [\n        // Before storing\n        MetadataStoringEvent::class => [\n            ValidateMetadataRules::class,\n        ],\n\n        // After storing\n        MetadataStoredEvent::class => [\n            AuditMetadataOperations::class,\n            InvalidateMetadataCache::class,\n            UpdateSearchIndex::class,\n            NotifyMetadataChanges::class,\n            TrackMetadataAnalytics::class,\n            SynchronizeMetadata::class,\n        ],\n\n        // Before deleting\n        MetadataDeletingEvent::class => [\n            // Add any pre-deletion logic here\n        ],\n\n        // After deleting\n        MetadataDeletedEvent::class => [\n            AuditMetadataOperations::class,\n            InvalidateMetadataCache::class,\n            UpdateSearchIndex::class,\n            TrackMetadataAnalytics::class,\n            SynchronizeMetadata::class,\n        ],\n    ];\n\n    public function boot(): void\n    {\n        parent::boot();\n    }\n}\n"})}),"\n",(0,d.jsx)(t.h2,{id:"event-timing",children:"Event Timing"}),"\n",(0,d.jsx)(t.h3,{id:"metadatastoringevent",children:"MetadataStoringEvent"}),"\n",(0,d.jsxs)(t.p,{children:["Fired ",(0,d.jsx)(t.strong,{children:"before"})," the metadata is saved to database:"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"// Execution order:\n// 1. Validate key is allowed\n// 2. Fire MetadataStoringEvent \u2190 Event fired here\n// 3. Save/update metadata record\n// 4. Fire MetadataStoredEvent\n// 5. Return model instance\n"})}),"\n",(0,d.jsx)(t.h3,{id:"metadatastoredevent",children:"MetadataStoredEvent"}),"\n",(0,d.jsxs)(t.p,{children:["Fired ",(0,d.jsx)(t.strong,{children:"after"})," the metadata is saved to database:"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"// Execution order:\n// 1. Fire MetadataStoringEvent\n// 2. Create/update metadata record\n// 3. Save to database\n// 4. Fire MetadataStoredEvent \u2190 Event fired here\n// 5. Return model instance\n"})}),"\n",(0,d.jsx)(t.h3,{id:"metadatadeletingevent--metadatadeletedevent",children:"MetadataDeletingEvent / MetadataDeletedEvent"}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"MetadataDeletingEvent"}),": Fired ",(0,d.jsx)(t.strong,{children:"before"})," the deletion operation"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"MetadataDeletedEvent"}),": Fired ",(0,d.jsx)(t.strong,{children:"after"})," the deletion operation completes"]}),"\n"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"// Execution order:\n// 1. Find metadata record(s)\n// 2. Fire MetadataDeletingEvent \u2190 Before deletion\n// 3. Delete metadata record\n// 4. Fire MetadataDeletedEvent \u2190 After deletion\n// 5. Return model instance\n"})}),"\n",(0,d.jsxs)(t.p,{children:[(0,d.jsx)(t.strong,{children:"Important Notes"}),":"]}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:["The metadata is ",(0,d.jsx)(t.strong,{children:"saved"})," to database before ",(0,d.jsx)(t.code,{children:"MetadataStoredEvent"})," fires"]}),"\n",(0,d.jsxs)(t.li,{children:["You can access ",(0,d.jsx)(t.strong,{children:"fresh metadata data"})," in listeners"]}),"\n",(0,d.jsxs)(t.li,{children:["Database transaction is ",(0,d.jsx)(t.strong,{children:"committed"})," before events fire"]}),"\n",(0,d.jsxs)(t.li,{children:["Events are ",(0,d.jsx)(t.strong,{children:"synchronous"})," by default (can be queued)"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"MetadataStoringEvent"})," allows you to ",(0,d.jsx)(t.strong,{children:"validate"})," or ",(0,d.jsx)(t.strong,{children:"prevent"})," storage"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"MetadataDeletingEvent"})," allows you to ",(0,d.jsx)(t.strong,{children:"prevent"})," deletion if needed"]}),"\n",(0,d.jsxs)(t.li,{children:["Batch operations (",(0,d.jsx)(t.code,{children:"storeMetadataBatch"}),") fire events for ",(0,d.jsx)(t.strong,{children:"each"})," metadata item"]}),"\n"]}),"\n",(0,d.jsx)(t.h2,{id:"queued-events",children:"Queued Events"}),"\n",(0,d.jsx)(t.p,{children:"You can queue events for asynchronous processing:"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"namespace App\\Listeners\\Metadata;\n\nuse Illuminate\\Contracts\\Queue\\ShouldQueue;\nuse JobMetric\\Metadata\\Events\\MetadataStoredEvent;\n\nclass ProcessMetadataAsync implements ShouldQueue\n{\n    public function handle(MetadataStoredEvent $event): void\n    {\n        $model = $event->model;\n        $meta = $event->meta;\n        \n        // Heavy processing that doesn't block the request\n        $this->updateSearchIndex($model, $meta);\n        $this->syncWithExternalService($model, $meta);\n        $this->generateAnalyticsReport($model, $meta);\n    }\n\n    protected function updateSearchIndex($model, $meta): void\n    {\n        // Update search index\n    }\n\n    protected function syncWithExternalService($model, $meta): void\n    {\n        // Sync with external API\n    }\n\n    protected function generateAnalyticsReport($model, $meta): void\n    {\n        // Generate analytics\n    }\n}\n"})}),"\n",(0,d.jsx)(t.h2,{id:"event-payload-details",children:"Event Payload Details"}),"\n",(0,d.jsx)(t.h3,{id:"metadatastoringevent-1",children:"MetadataStoringEvent"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"readonly class MetadataStoringEvent implements DomainEvent\n{\n    public function __construct(\n        public Model $model,                    // Model instance\n        public string $key,                      // Metadata key\n        public array|string|bool|null $value     // Metadata value (before storage)\n    ) {}\n}\n"})}),"\n",(0,d.jsxs)(t.p,{children:[(0,d.jsx)(t.strong,{children:"Available Properties"}),":"]}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"$model"}),": The model instance that will receive the metadata"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"$key"}),": The metadata key being stored"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"$value"}),": The metadata value (raw, before JSON encoding if array)"]}),"\n"]}),"\n",(0,d.jsx)(t.h3,{id:"metadatastoredevent-1",children:"MetadataStoredEvent"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"readonly class MetadataStoredEvent implements DomainEvent\n{\n    public function __construct(\n        public Model $model,    // Model instance\n        public Meta $meta        // Meta model instance (saved to database)\n    ) {}\n}\n"})}),"\n",(0,d.jsxs)(t.p,{children:[(0,d.jsx)(t.strong,{children:"Available Properties"}),":"]}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"$model"}),": The model instance that received the metadata"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"$meta"}),": The ",(0,d.jsx)(t.code,{children:"Meta"})," model instance with:","\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"id"}),": Meta ID"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"metaable_type"}),": Type of parent model"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"metaable_id"}),": ID of parent model"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"key"}),": Metadata key"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"value"}),": Metadata value (string, decoded from JSON if ",(0,d.jsx)(t.code,{children:"is_json"})," is true)"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"is_json"}),": Whether value is JSON-encoded"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"created_at"}),": Creation timestamp"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"updated_at"}),": Update timestamp"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,d.jsx)(t.h3,{id:"metadatadeletingevent--metadatadeletedevent-1",children:"MetadataDeletingEvent / MetadataDeletedEvent"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-php",children:"readonly class MetadataDeletedEvent implements DomainEvent\n{\n    public function __construct(\n        public Meta $meta  // Meta model instance (deleted)\n    ) {}\n}\n"})}),"\n",(0,d.jsxs)(t.p,{children:[(0,d.jsx)(t.strong,{children:"Available Properties"}),":"]}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"$meta"}),": The ",(0,d.jsx)(t.code,{children:"Meta"})," model instance with all properties (still accessible after deletion)"]}),"\n",(0,d.jsxs)(t.li,{children:["All properties from ",(0,d.jsx)(t.code,{children:"Meta"})," model are available"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"metaable"}),": Access parent model via ",(0,d.jsx)(t.code,{children:"$meta->metaable"})]}),"\n"]}),"\n",(0,d.jsx)(t.h2,{id:"when-to-use-events",children:"When to Use Events"}),"\n",(0,d.jsx)(t.p,{children:"Use events when you need to:"}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Cache Management"}),": Invalidate or update cached metadata"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Search Indexing"}),": Update search index when metadata changes"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Notifications"}),": Send notifications when critical metadata changes"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Analytics"}),": Track metadata operations for analytics"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Audit Logging"}),": Log metadata changes for compliance"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Validation"}),": Validate metadata before storing"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Synchronization"}),": Sync metadata with external systems"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Business Rules"}),": Enforce business rules on metadata operations"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Integration"}),": Integrate with external services"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.strong,{children:"Side Effects"}),": Perform side effects without coupling"]}),"\n"]}),"\n",(0,d.jsx)(t.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:["\n",(0,d.jsx)(i.A,{to:"/packages/laravel-metadata/deep-diving/has-meta",children:"HasMeta"}),"\n"]}),"\n",(0,d.jsxs)(t.li,{children:["\n",(0,d.jsx)(i.A,{to:"/packages/laravel-metadata/deep-diving/models/meta",children:"Meta Model"}),"\n"]}),"\n",(0,d.jsxs)(t.li,{children:["\n",(0,d.jsx)(i.A,{to:"/packages/laravel-event-system/deep-diving/event-system",children:"Event System"}),"\n"]}),"\n"]})]})}function v(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,d.jsx)(t,{...e,children:(0,d.jsx)(h,{...e})}):h(e)}},28453(e,t,a){a.d(t,{R:()=>i,x:()=>l});var n=a(96540);const d={},s=n.createContext(d);function i(e){const t=n.useContext(s);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:i(e.components),n.createElement(s.Provider,{value:t},e.children)}}}]);