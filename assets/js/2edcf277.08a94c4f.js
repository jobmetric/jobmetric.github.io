"use strict";(globalThis.webpackChunkjobmetric_document=globalThis.webpackChunkjobmetric_document||[]).push([[4037],{28453(e,n,t){t.d(n,{R:()=>o,x:()=>a});var r=t(96540);const s={},i=r.createContext(s);function o(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:n},e.children)}},70689(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"laravel-flow/deep-diving/support/restriction-result","title":"RestrictionResult","description":"The RestrictionResult class represents the outcome of a restriction task evaluation. It indicates whether a workflow transition is allowed to proceed and provides machine-readable codes and human-readable messages to explain the decision.","source":"@site/packages/laravel-flow/deep-diving/support/restriction-result.md","sourceDirName":"laravel-flow/deep-diving/support","slug":"/laravel-flow/deep-diving/support/restriction-result","permalink":"/packages/laravel-flow/deep-diving/support/restriction-result","draft":false,"unlisted":false,"editUrl":"https://github.com/jobmetric/document/blob/master/packages/laravel-flow/deep-diving/support/restriction-result.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"sidebar_label":"RestrictionResult"},"sidebar":"packagesSidebar","previous":{"title":"FlowTaskContext","permalink":"/packages/laravel-flow/deep-diving/support/flow-task-context"},"next":{"title":"StoreFlowRequest","permalink":"/packages/laravel-flow/deep-diving/requests/store-flow-request"}}');var s=t(74848),i=t(28453);const o={sidebar_position:5,sidebar_label:"RestrictionResult"},a="RestrictionResult",l={},c=[{value:"Namespace",id:"namespace",level:2},{value:"Overview",id:"overview",level:2},{value:"Static Factory Methods",id:"static-factory-methods",level:2},{value:"allow()",id:"allow",level:3},{value:"deny()",id:"deny",level:3},{value:"Query Methods",id:"query-methods",level:2},{value:"allowed()",id:"allowed",level:3},{value:"code()",id:"code",level:3},{value:"message()",id:"message",level:3},{value:"Understanding RestrictionResult in Workflow Execution",id:"understanding-restrictionresult-in-workflow-execution",level:2},{value:"How RestrictionResult Works",id:"how-restrictionresult-works",level:3},{value:"Complete Examples",id:"complete-examples",level:2},{value:"Example 1: Basic Allow - Simple Pass-Through",id:"example-1-basic-allow---simple-pass-through",level:3},{value:"Example 2: Advanced Permission Check - Multi-Level Authorization",id:"example-2-advanced-permission-check---multi-level-authorization",level:3},{value:"Example 3: Comprehensive Business Rule Check - Order State Machine",id:"example-3-comprehensive-business-rule-check---order-state-machine",level:3},{value:"Example 4: Enterprise-Level Multi-Condition Restriction",id:"example-4-enterprise-level-multi-condition-restriction",level:3},{value:"Example 5: Advanced Configurable Restrictions - Dynamic Business Rules",id:"example-5-advanced-configurable-restrictions---dynamic-business-rules",level:3},{value:"Example 6: Advanced Time-Based Restrictions - Scheduling and Windows",id:"example-6-advanced-time-based-restrictions---scheduling-and-windows",level:3},{value:"Example 7: Resource Locking and Concurrency Control",id:"example-7-resource-locking-and-concurrency-control",level:3},{value:"Example 8: Quota and Limit Restrictions",id:"example-8-quota-and-limit-restrictions",level:3},{value:"Example 9: Complete Real-World System - Order Cancellation Workflow",id:"example-9-complete-real-world-system---order-cancellation-workflow",level:3},{value:"Code Conventions",id:"code-conventions",level:2},{value:"Recommended Code Format",id:"recommended-code-format",level:3},{value:"Common Code Patterns",id:"common-code-patterns",level:3},{value:"Error Handling and Integration",id:"error-handling-and-integration",level:2},{value:"How Restriction Failures Work",id:"how-restriction-failures-work",level:3},{value:"Basic Error Handling",id:"basic-error-handling",level:3},{value:"Advanced Error Handling with Code-Based Responses",id:"advanced-error-handling-with-code-based-responses",level:3},{value:"Frontend Integration Example",id:"frontend-integration-example",level:3},{value:"Logging and Monitoring",id:"logging-and-monitoring",level:3},{value:"Testing Restriction Results",id:"testing-restriction-results",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Integration with FlowTransition",id:"integration-with-flowtransition",level:2},{value:"Execution Order",id:"execution-order",level:3},{value:"How Restrictions Stop Transitions",id:"how-restrictions-stop-transitions",level:3},{value:"Multiple Restrictions",id:"multiple-restrictions",level:3},{value:"Real-World Workflow Example",id:"real-world-workflow-example",level:3},{value:"Debugging Restrictions",id:"debugging-restrictions",level:3},{value:"Best Practices for Restriction Codes",id:"best-practices-for-restriction-codes",level:3},{value:"Related Documentation",id:"related-documentation",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"restrictionresult",children:"RestrictionResult"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"RestrictionResult"})," class represents the outcome of a restriction task evaluation. It indicates whether a workflow transition is allowed to proceed and provides machine-readable codes and human-readable messages to explain the decision."]}),"\n",(0,s.jsx)(n.h2,{id:"namespace",children:"Namespace"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"JobMetric\\Flow\\Support\\RestrictionResult\n"})}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"RestrictionResult"})," encapsulates:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Allowed Flag"}),": Boolean indicating if the operation is allowed"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Code"}),": Machine-readable code identifying the reason"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Message"}),": Human-readable explanation for UI or logging"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"static-factory-methods",children:"Static Factory Methods"}),"\n",(0,s.jsx)(n.h3,{id:"allow",children:"allow()"}),"\n",(0,s.jsx)(n.p,{children:"Create a result that allows the operation:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\Flow\\Support\\RestrictionResult;\n\n$result = RestrictionResult::allow();\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Returns:"})," ",(0,s.jsx)(n.code,{children:"RestrictionResult"})," with ",(0,s.jsx)(n.code,{children:"allowed=true"}),", ",(0,s.jsx)(n.code,{children:"code=null"}),", ",(0,s.jsx)(n.code,{children:"message=null"})]}),"\n",(0,s.jsx)(n.h3,{id:"deny",children:"deny()"}),"\n",(0,s.jsx)(n.p,{children:"Create a result that denies the operation:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// With code only\n$result = RestrictionResult::deny('PERMISSION_DENIED');\n\n// With code and message\n$result = RestrictionResult::deny(\n    'ORDER_SHIPPED',\n    'Cannot cancel shipped orders'\n);\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"string $code"}),": Machine-readable code (required)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"?string $message = null"}),": Human-readable message (optional)"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Returns:"})," ",(0,s.jsx)(n.code,{children:"RestrictionResult"})," with ",(0,s.jsx)(n.code,{children:"allowed=false"})]}),"\n",(0,s.jsx)(n.h2,{id:"query-methods",children:"Query Methods"}),"\n",(0,s.jsx)(n.h3,{id:"allowed",children:"allowed()"}),"\n",(0,s.jsx)(n.p,{children:"Determine if the operation is allowed:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$result = RestrictionResult::allow();\n$result->allowed(); // true\n\n$result = RestrictionResult::deny('ERROR_CODE');\n$result->allowed(); // false\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Returns:"})," ",(0,s.jsx)(n.code,{children:"bool"})]}),"\n",(0,s.jsx)(n.h3,{id:"code",children:"code()"}),"\n",(0,s.jsx)(n.p,{children:"Get the machine-readable code:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$result = RestrictionResult::deny('PERMISSION_DENIED', 'Message');\n$result->code(); // 'PERMISSION_DENIED'\n\n$result = RestrictionResult::allow();\n$result->code(); // null\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Returns:"})," ",(0,s.jsx)(n.code,{children:"?string"})]}),"\n",(0,s.jsx)(n.h3,{id:"message",children:"message()"}),"\n",(0,s.jsx)(n.p,{children:"Get the human-readable message:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$result = RestrictionResult::deny('ERROR', 'Error message');\n$result->message(); // 'Error message'\n\n$result = RestrictionResult::allow();\n$result->message(); // null\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Returns:"})," ",(0,s.jsx)(n.code,{children:"?string"})]}),"\n",(0,s.jsx)(n.h2,{id:"understanding-restrictionresult-in-workflow-execution",children:"Understanding RestrictionResult in Workflow Execution"}),"\n",(0,s.jsx)(n.h3,{id:"how-restrictionresult-works",children:"How RestrictionResult Works"}),"\n",(0,s.jsxs)(n.p,{children:["When a transition is executed, restriction tasks are evaluated ",(0,s.jsx)(n.strong,{children:"first"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// Inside FlowTransition::runner()\n// 1. Execute all restriction tasks\nforeach ($restrictionTasks as $task) {\n    $result = $task->restriction($context);\n    \n    if (!$result->allowed()) {\n        // Transition is DENIED - stop immediately\n        throw new TaskRestrictionException(\n            $result->code(),\n            $result->message()\n        );\n    }\n}\n\n// 2. If all restrictions pass, continue with validation tasks\n// 3. Then execute action tasks\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Points:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Restriction tasks run ",(0,s.jsx)(n.strong,{children:"before"})," validation and action tasks"]}),"\n",(0,s.jsxs)(n.li,{children:["If ",(0,s.jsx)(n.strong,{children:"any"})," restriction denies, the transition stops immediately"]}),"\n",(0,s.jsx)(n.li,{children:"The code and message are used for error handling and user feedback"}),"\n",(0,s.jsx)(n.li,{children:"Multiple restriction tasks can exist - all must allow"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"complete-examples",children:"Complete Examples"}),"\n",(0,s.jsx)(n.h3,{id:"example-1-basic-allow---simple-pass-through",children:"Example 1: Basic Allow - Simple Pass-Through"}),"\n",(0,s.jsx)(n.p,{children:"A simple restriction that always allows (useful for testing or optional restrictions):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Flows\\Order;\n\nuse JobMetric\\Flow\\Contracts\\AbstractRestrictionTask;\nuse JobMetric\\Flow\\Support\\FlowTaskContext;\nuse JobMetric\\Flow\\Support\\FlowTaskDefinition;\nuse JobMetric\\Flow\\Support\\RestrictionResult;\nuse JobMetric\\Form\\FormBuilder;\n\nclass BasicAllowRestrictionTask extends AbstractRestrictionTask\n{\n    public static function subject(): string\n    {\n        return \\App\\Models\\Order::class;\n    }\n\n    public static function definition(): FlowTaskDefinition\n    {\n        return new FlowTaskDefinition(\n            title: 'flow::base.task.basic_allow.title',\n            description: 'Always allows the transition',\n        );\n    }\n\n    public function form(): FormBuilder\n    {\n        return new FormBuilder;\n    }\n\n    public function restriction(FlowTaskContext $context): RestrictionResult\n    {\n        // Always allow - no restrictions\n        return RestrictionResult::allow();\n    }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use Cases:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Testing scenarios"}),"\n",(0,s.jsx)(n.li,{children:"Optional restrictions that can be enabled/disabled"}),"\n",(0,s.jsx)(n.li,{children:"Placeholder restrictions"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example-2-advanced-permission-check---multi-level-authorization",children:"Example 2: Advanced Permission Check - Multi-Level Authorization"}),"\n",(0,s.jsx)(n.p,{children:"A comprehensive permission check that handles multiple authorization scenarios:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Flows\\Order;\n\nuse App\\Models\\Order;\nuse App\\Models\\User;\nuse Illuminate\\Support\\Facades\\Gate;\nuse JobMetric\\Flow\\Contracts\\AbstractRestrictionTask;\nuse JobMetric\\Flow\\Support\\FlowTaskContext;\nuse JobMetric\\Flow\\Support\\FlowTaskDefinition;\nuse JobMetric\\Flow\\Support\\RestrictionResult;\nuse JobMetric\\Form\\FormBuilder;\n\nclass PermissionRestrictionTask extends AbstractRestrictionTask\n{\n    public static function subject(): string\n    {\n        return \\App\\Models\\Order::class;\n    }\n\n    public static function definition(): FlowTaskDefinition\n    {\n        return new FlowTaskDefinition(\n            title: 'flow::base.task.permission_check.title',\n            description: 'Checks user permissions before allowing transition',\n        );\n    }\n\n    public function form(): FormBuilder\n    {\n        return (new FormBuilder)\n            ->hiddenCustomField('require_authentication', 'boolean', true, 'Require user authentication')\n            ->hiddenCustomField('allowed_roles', 'array', ['admin', 'manager'], 'Allowed roles')\n            ->hiddenCustomField('check_ownership', 'boolean', true, 'Check resource ownership')\n            ->hiddenCustomField('require_specific_permission', 'string', 'cancel', 'Required permission');\n    }\n\n    public function restriction(FlowTaskContext $context): RestrictionResult\n    {\n        $order = $context->subject();\n        $user = $context->user();\n        $config = $context->config();\n\n        // Extract configuration\n        $requireAuth = $config['require_authentication'] ?? true;\n        $allowedRoles = $config['allowed_roles'] ?? [];\n        $checkOwnership = $config['check_ownership'] ?? true;\n        $requiredPermission = $config['require_specific_permission'] ?? 'cancel';\n\n        // 1. Check authentication\n        if ($requireAuth && !$user) {\n            return RestrictionResult::deny(\n                'USER_NOT_AUTHENTICATED',\n                'You must be logged in to perform this action'\n            );\n        }\n\n        // 2. Check role-based access\n        if (!empty($allowedRoles)) {\n            $userRoles = $user?->roles->pluck('name')->toArray() ?? [];\n            $hasAllowedRole = !empty(array_intersect($userRoles, $allowedRoles));\n\n            if (!$hasAllowedRole) {\n                return RestrictionResult::deny(\n                    'INSUFFICIENT_ROLE',\n                    'You do not have the required role to perform this action'\n                );\n            }\n        }\n\n        // 3. Check policy/permission\n        if ($requiredPermission && $user) {\n            if (!Gate::allows($requiredPermission, $order)) {\n                return RestrictionResult::deny(\n                    'PERMISSION_DENIED',\n                    \"You do not have permission to {$requiredPermission} this order\"\n                );\n            }\n        }\n\n        // 4. Check ownership (if enabled)\n        if ($checkOwnership && $user) {\n            // Admin can access any order\n            if (!$user->hasRole('admin')) {\n                if ($order->user_id !== $user->id) {\n                    return RestrictionResult::deny(\n                        'OWNERSHIP_MISMATCH',\n                        'You can only perform this action on your own orders'\n                    );\n                }\n            }\n        }\n\n        // 5. Check account status\n        if ($user && $user->account_status === 'suspended') {\n            return RestrictionResult::deny(\n                'ACCOUNT_SUSPENDED',\n                'Your account is suspended. Please contact support.'\n            );\n        }\n\n        // All permission checks passed\n        return RestrictionResult::allow();\n    }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Points:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Multiple permission checks in sequence"}),"\n",(0,s.jsx)(n.li,{children:"Configurable permission requirements"}),"\n",(0,s.jsx)(n.li,{children:"Role-based and policy-based authorization"}),"\n",(0,s.jsx)(n.li,{children:"Ownership verification"}),"\n",(0,s.jsx)(n.li,{children:"Account status checks"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example-3-comprehensive-business-rule-check---order-state-machine",children:"Example 3: Comprehensive Business Rule Check - Order State Machine"}),"\n",(0,s.jsx)(n.p,{children:"A complete business rule check that validates order state transitions:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Flows\\Order;\n\nuse App\\Models\\Order;\nuse Illuminate\\Support\\Facades\\DB;\nuse Illuminate\\Support\\Facades\\Log;\nuse JobMetric\\Flow\\Contracts\\AbstractRestrictionTask;\nuse JobMetric\\Flow\\Support\\FlowTaskContext;\nuse JobMetric\\Flow\\Support\\FlowTaskDefinition;\nuse JobMetric\\Flow\\Support\\RestrictionResult;\nuse JobMetric\\Form\\FormBuilder;\n\nclass OrderStateRestrictionTask extends AbstractRestrictionTask\n{\n    public static function subject(): string\n    {\n        return \\App\\Models\\Order::class;\n    }\n\n    public static function definition(): FlowTaskDefinition\n    {\n        return new FlowTaskDefinition(\n            title: 'flow::base.task.order_state_check.title',\n            description: 'Validates order state transitions',\n        );\n    }\n\n    public function form(): FormBuilder\n    {\n        return (new FormBuilder)\n            ->hiddenCustomField('allowed_from_statuses', 'array', ['pending', 'processing'], 'Allowed source statuses')\n            ->hiddenCustomField('blocked_statuses', 'array', ['cancelled', 'refunded'], 'Blocked statuses')\n            ->hiddenCustomField('check_payment_status', 'boolean', true, 'Check payment status')\n            ->hiddenCustomField('check_inventory', 'boolean', true, 'Check inventory availability');\n    }\n\n    public function restriction(FlowTaskContext $context): RestrictionResult\n    {\n        $order = $context->subject();\n        $payload = $context->payload();\n        $config = $context->config();\n\n        // Extract configuration\n        $allowedFromStatuses = $config['allowed_from_statuses'] ?? [];\n        $blockedStatuses = $config['blocked_statuses'] ?? ['cancelled', 'refunded'];\n        $checkPayment = $config['check_payment_status'] ?? true;\n        $checkInventory = $config['check_inventory'] ?? true;\n\n        // Get target status from payload\n        $targetStatus = $payload['status'] ?? null;\n\n        // 1. Check if order is in a blocked state\n        if (in_array($order->status, $blockedStatuses)) {\n            return RestrictionResult::deny(\n                'ORDER_IN_BLOCKED_STATE',\n                \"Cannot transition from '{$order->status}' status\"\n            );\n        }\n\n        // 2. Check if current status allows transition\n        if (!empty($allowedFromStatuses) && !in_array($order->status, $allowedFromStatuses)) {\n            return RestrictionResult::deny(\n                'INVALID_SOURCE_STATUS',\n                \"Cannot transition from '{$order->status}' status. Allowed statuses: \" . implode(', ', $allowedFromStatuses)\n            );\n        }\n\n        // 3. Check state machine rules\n        $stateMachineRules = $this->getStateMachineRules();\n        if (isset($stateMachineRules[$order->status])) {\n            $allowedTransitions = $stateMachineRules[$order->status];\n            \n            if ($targetStatus && !in_array($targetStatus, $allowedTransitions)) {\n                return RestrictionResult::deny(\n                    'INVALID_STATE_TRANSITION',\n                    \"Cannot transition from '{$order->status}' to '{$targetStatus}'\"\n                );\n            }\n        }\n\n        // 4. Check payment status\n        if ($checkPayment) {\n            if ($order->payment_status === 'refunded' && $targetStatus !== 'cancelled') {\n                return RestrictionResult::deny(\n                    'PAYMENT_ALREADY_REFUNDED',\n                    'Payment has already been refunded. Order must remain cancelled.'\n                );\n            }\n\n            if ($order->payment_status === 'pending' && in_array($targetStatus, ['shipped', 'delivered'])) {\n                return RestrictionResult::deny(\n                    'PAYMENT_PENDING',\n                    'Cannot ship or deliver order with pending payment'\n                );\n            }\n        }\n\n        // 5. Check inventory availability (for shipping)\n        if ($checkInventory && $targetStatus === 'shipped') {\n            foreach ($order->items as $item) {\n                if ($item->product->stock < $item->quantity) {\n                    return RestrictionResult::deny(\n                        'INSUFFICIENT_INVENTORY',\n                        \"Insufficient inventory for product: {$item->product->name}\"\n                    );\n                }\n            }\n        }\n\n        // 6. Check if order has active disputes\n        if ($this->hasActiveDispute($order)) {\n            return RestrictionResult::deny(\n                'ACTIVE_DISPUTE',\n                'Cannot modify order with active dispute'\n            );\n        }\n\n        // 7. Check if order is locked\n        if ($order->is_locked) {\n            return RestrictionResult::deny(\n                'ORDER_LOCKED',\n                'Order is currently locked and cannot be modified'\n            );\n        }\n\n        // All business rule checks passed\n        return RestrictionResult::allow();\n    }\n\n    protected function getStateMachineRules(): array\n    {\n        return [\n            'pending' => ['processing', 'cancelled'],\n            'processing' => ['shipped', 'cancelled'],\n            'shipped' => ['delivered', 'returned'],\n            'delivered' => ['returned', 'completed'],\n            'cancelled' => [], // Terminal state\n            'completed' => [], // Terminal state\n        ];\n    }\n\n    protected function hasActiveDispute(Order $order): bool\n    {\n        return $order->disputes()\n            ->where('status', 'open')\n            ->exists();\n    }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Points:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"State machine validation"}),"\n",(0,s.jsx)(n.li,{children:"Configurable business rules"}),"\n",(0,s.jsx)(n.li,{children:"Multiple validation layers"}),"\n",(0,s.jsx)(n.li,{children:"Terminal state protection"}),"\n",(0,s.jsx)(n.li,{children:"Payment and inventory checks"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example-4-enterprise-level-multi-condition-restriction",children:"Example 4: Enterprise-Level Multi-Condition Restriction"}),"\n",(0,s.jsx)(n.p,{children:"A comprehensive restriction that checks multiple business conditions with detailed error reporting:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Flows\\Order;\n\nuse App\\Models\\Order;\nuse App\\Models\\User;\nuse Illuminate\\Support\\Facades\\Cache;\nuse Illuminate\\Support\\Facades\\DB;\nuse JobMetric\\Flow\\Contracts\\AbstractRestrictionTask;\nuse JobMetric\\Flow\\Support\\FlowTaskContext;\nuse JobMetric\\Flow\\Support\\FlowTaskDefinition;\nuse JobMetric\\Flow\\Support\\RestrictionResult;\nuse JobMetric\\Form\\FormBuilder;\n\nclass EnterpriseOrderCancellationRestrictionTask extends AbstractRestrictionTask\n{\n    public static function subject(): string\n    {\n        return \\App\\Models\\Order::class;\n    }\n\n    public static function definition(): FlowTaskDefinition\n    {\n        return new FlowTaskDefinition(\n            title: 'flow::base.task.enterprise_cancellation_restriction.title',\n            description: 'Comprehensive order cancellation restrictions',\n        );\n    }\n\n    public function form(): FormBuilder\n    {\n        return (new FormBuilder)\n            ->hiddenCustomField('max_cancellation_hours', 'integer', 24, 'Maximum hours after creation')\n            ->hiddenCustomField('max_cancellation_amount', 'decimal', 1000, 'Maximum order amount for cancellation')\n            ->hiddenCustomField('require_reason', 'boolean', true, 'Require cancellation reason')\n            ->hiddenCustomField('check_rate_limit', 'boolean', true, 'Check user rate limit')\n            ->hiddenCustomField('max_cancellations_per_month', 'integer', 5, 'Maximum cancellations per month')\n            ->hiddenCustomField('allow_admin_override', 'boolean', true, 'Allow admin override');\n    }\n\n    public function restriction(FlowTaskContext $context): RestrictionResult\n    {\n        $order = $context->subject();\n        $user = $context->user();\n        $payload = $context->payload();\n        $config = $context->config();\n\n        // Extract configuration\n        $maxHours = $config['max_cancellation_hours'] ?? 24;\n        $maxAmount = $config['max_cancellation_amount'] ?? 1000;\n        $requireReason = $config['require_reason'] ?? true;\n        $checkRateLimit = $config['check_rate_limit'] ?? true;\n        $maxPerMonth = $config['max_cancellations_per_month'] ?? 5;\n        $allowAdminOverride = $config['allow_admin_override'] ?? true;\n\n        // Admin override check (early exit)\n        if ($allowAdminOverride && $user && $user->hasRole('admin')) {\n            return RestrictionResult::allow();\n        }\n\n        // 1. User authentication check\n        if (!$user) {\n            return RestrictionResult::deny(\n                'USER_NOT_AUTHENTICATED',\n                'You must be logged in to cancel orders'\n            );\n        }\n\n        // 2. Permission check\n        if (!$user->can('cancel', $order)) {\n            return RestrictionResult::deny(\n                'PERMISSION_DENIED',\n                'You do not have permission to cancel this order'\n            );\n        }\n\n        // 3. Ownership check\n        if ($order->user_id !== $user->id && !$user->hasRole('admin')) {\n            return RestrictionResult::deny(\n                'OWNERSHIP_MISMATCH',\n                'You can only cancel your own orders'\n            );\n        }\n\n        // 4. Order status check\n        $blockedStatuses = ['shipped', 'delivered', 'cancelled', 'refunded'];\n        if (in_array($order->status, $blockedStatuses)) {\n            return RestrictionResult::deny(\n                'ORDER_STATUS_INVALID',\n                \"Cannot cancel order with status: {$order->status}\"\n            );\n        }\n\n        // 5. Time limit check\n        $hoursSinceCreated = $order->created_at->diffInHours(now());\n        if ($hoursSinceCreated > $maxHours) {\n            return RestrictionResult::deny(\n                'TIME_LIMIT_EXCEEDED',\n                \"Orders can only be cancelled within {$maxHours} hours of creation. \" .\n                \"Order was created {$hoursSinceCreated} hours ago.\"\n            );\n        }\n\n        // 6. Amount limit check\n        if ($order->total > $maxAmount) {\n            return RestrictionResult::deny(\n                'AMOUNT_EXCEEDED',\n                \"Orders over {$maxAmount} cannot be cancelled automatically. Please contact support.\"\n            );\n        }\n\n        // 7. Reason requirement check\n        if ($requireReason && empty($payload['reason'])) {\n            return RestrictionResult::deny(\n                'REASON_REQUIRED',\n                'Cancellation reason is required'\n            );\n        }\n\n        if ($requireReason && strlen($payload['reason'] ?? '') < 10) {\n            return RestrictionResult::deny(\n                'REASON_TOO_SHORT',\n                'Cancellation reason must be at least 10 characters'\n            );\n        }\n\n        // 8. Rate limiting check\n        if ($checkRateLimit) {\n            $cancellationCount = $this->getRecentCancellationCount($user);\n            if ($cancellationCount >= $maxPerMonth) {\n                return RestrictionResult::deny(\n                    'RATE_LIMIT_EXCEEDED',\n                    \"You have exceeded the maximum of {$maxPerMonth} cancellations per month. Please contact support.\"\n                );\n            }\n        }\n\n        // 9. Payment status check\n        if ($order->payment_status === 'refunded') {\n            return RestrictionResult::deny(\n                'PAYMENT_ALREADY_REFUNDED',\n                'Payment has already been refunded. Order cannot be cancelled again.'\n            );\n        }\n\n        // 10. Active dispute check\n        if ($this->hasActiveDispute($order)) {\n            return RestrictionResult::deny(\n                'ACTIVE_DISPUTE',\n                'Cannot cancel order with active dispute. Please resolve the dispute first.'\n            );\n        }\n\n        // 11. Inventory restock check\n        $restockInventory = $payload['restock_inventory'] ?? true;\n        if ($restockInventory && !$this->canRestockInventory($order)) {\n            return RestrictionResult::deny(\n                'INVENTORY_RESTOCK_FAILED',\n                'Cannot cancel order: some items cannot be restocked to inventory'\n            );\n        }\n\n        // 12. Shipping status check\n        if ($order->shipping_status === 'in_transit') {\n            return RestrictionResult::deny(\n                'ORDER_IN_TRANSIT',\n                'Cannot cancel order that is already in transit. Please contact shipping department.'\n            );\n        }\n\n        // 13. Subscription order check\n        if ($order->is_subscription && $order->subscription->is_active) {\n            return RestrictionResult::deny(\n                'ACTIVE_SUBSCRIPTION',\n                'Cannot cancel order with active subscription. Please cancel the subscription first.'\n            );\n        }\n\n        // All checks passed\n        return RestrictionResult::allow();\n    }\n\n    protected function getRecentCancellationCount(User $user): int\n    {\n        $cacheKey = \"user_cancellations_{$user->id}_\" . now()->format('Y-m');\n        \n        return Cache::remember($cacheKey, 3600, function () use ($user) {\n            return $user->orders()\n                ->where('status', 'cancelled')\n                ->where('cancelled_at', '>=', now()->startOfMonth())\n                ->count();\n        });\n    }\n\n    protected function hasActiveDispute(Order $order): bool\n    {\n        return $order->disputes()\n            ->where('status', 'open')\n            ->exists();\n    }\n\n    protected function canRestockInventory(Order $order): bool\n    {\n        foreach ($order->items as $item) {\n            if (!$item->product->canRestock()) {\n                return false;\n            }\n        }\n        return true;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Points:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Multiple validation layers"}),"\n",(0,s.jsx)(n.li,{children:"Early exit for admin override"}),"\n",(0,s.jsx)(n.li,{children:"Detailed error messages with context"}),"\n",(0,s.jsx)(n.li,{children:"Rate limiting with caching"}),"\n",(0,s.jsx)(n.li,{children:"Complex business logic"}),"\n",(0,s.jsx)(n.li,{children:"Configurable restrictions"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example-5-advanced-configurable-restrictions---dynamic-business-rules",children:"Example 5: Advanced Configurable Restrictions - Dynamic Business Rules"}),"\n",(0,s.jsx)(n.p,{children:"A sophisticated restriction system that uses configuration for flexible business rules:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Flows\\Order;\n\nuse App\\Models\\Order;\nuse Illuminate\\Support\\Facades\\DB;\nuse JobMetric\\Flow\\Contracts\\AbstractRestrictionTask;\nuse JobMetric\\Flow\\Support\\FlowTaskContext;\nuse JobMetric\\Flow\\Support\\FlowTaskDefinition;\nuse JobMetric\\Flow\\Support\\RestrictionResult;\nuse JobMetric\\Form\\FormBuilder;\n\nclass ConfigurableBusinessRulesRestrictionTask extends AbstractRestrictionTask\n{\n    public static function subject(): string\n    {\n        return \\App\\Models\\Order::class;\n    }\n\n    public static function definition(): FlowTaskDefinition\n    {\n        return new FlowTaskDefinition(\n            title: 'flow::base.task.configurable_rules.title',\n            description: 'Configurable business rules restriction',\n        );\n    }\n\n    public function form(): FormBuilder\n    {\n        return (new FormBuilder)\n            ->hiddenCustomField('allowed_statuses', 'array', ['pending', 'processing'], 'Allowed source statuses')\n            ->hiddenCustomField('blocked_statuses', 'array', ['cancelled'], 'Blocked statuses')\n            ->hiddenCustomField('allowed_user_roles', 'array', ['customer', 'admin'], 'Allowed user roles')\n            ->hiddenCustomField('min_order_amount', 'decimal', 0, 'Minimum order amount')\n            ->hiddenCustomField('max_order_amount', 'decimal', 10000, 'Maximum order amount')\n            ->hiddenCustomField('allowed_payment_methods', 'array', ['credit_card', 'paypal'], 'Allowed payment methods')\n            ->hiddenCustomField('require_verification', 'boolean', false, 'Require email verification')\n            ->hiddenCustomField('business_hours_only', 'boolean', false, 'Only allow during business hours')\n            ->hiddenCustomField('business_hours_start', 'integer', 9, 'Business hours start')\n            ->hiddenCustomField('business_hours_end', 'integer', 17, 'Business hours end');\n    }\n\n    public function restriction(FlowTaskContext $context): RestrictionResult\n    {\n        $order = $context->subject();\n        $user = $context->user();\n        $payload = $context->payload();\n        $config = $context->config();\n\n        // Extract all configuration\n        $allowedStatuses = $config['allowed_statuses'] ?? [];\n        $blockedStatuses = $config['blocked_statuses'] ?? [];\n        $allowedRoles = $config['allowed_user_roles'] ?? [];\n        $minAmount = $config['min_order_amount'] ?? 0;\n        $maxAmount = $config['max_order_amount'] ?? 10000;\n        $allowedPaymentMethods = $config['allowed_payment_methods'] ?? [];\n        $requireVerification = $config['require_verification'] ?? false;\n        $businessHoursOnly = $config['business_hours_only'] ?? false;\n        $businessHoursStart = $config['business_hours_start'] ?? 9;\n        $businessHoursEnd = $config['business_hours_end'] ?? 17;\n\n        // 1. Status validation\n        if (!empty($allowedStatuses) && !in_array($order->status, $allowedStatuses)) {\n            return RestrictionResult::deny(\n                'STATUS_NOT_ALLOWED',\n                \"Order status '{$order->status}' is not allowed. Allowed statuses: \" . implode(', ', $allowedStatuses)\n            );\n        }\n\n        if (!empty($blockedStatuses) && in_array($order->status, $blockedStatuses)) {\n            return RestrictionResult::deny(\n                'STATUS_BLOCKED',\n                \"Order status '{$order->status}' is blocked for this transition\"\n            );\n        }\n\n        // 2. User role validation\n        if (!empty($allowedRoles) && $user) {\n            $userRoles = $user->roles->pluck('name')->toArray();\n            $hasAllowedRole = !empty(array_intersect($userRoles, $allowedRoles));\n\n            if (!$hasAllowedRole) {\n                return RestrictionResult::deny(\n                    'ROLE_NOT_ALLOWED',\n                    'Your role is not allowed for this transition'\n                );\n            }\n        }\n\n        // 3. Amount validation\n        if ($order->total < $minAmount) {\n            return RestrictionResult::deny(\n                'AMOUNT_TOO_LOW',\n                \"Order amount {$order->total} is below minimum {$minAmount}\"\n            );\n        }\n\n        if ($order->total > $maxAmount) {\n            return RestrictionResult::deny(\n                'AMOUNT_TOO_HIGH',\n                \"Order amount {$order->total} exceeds maximum {$maxAmount}\"\n            );\n        }\n\n        // 4. Payment method validation\n        if (!empty($allowedPaymentMethods) && !in_array($order->payment_method, $allowedPaymentMethods)) {\n            return RestrictionResult::deny(\n                'PAYMENT_METHOD_NOT_ALLOWED',\n                \"Payment method '{$order->payment_method}' is not allowed\"\n            );\n        }\n\n        // 5. Email verification check\n        if ($requireVerification && $user && !$user->email_verified_at) {\n            return RestrictionResult::deny(\n                'EMAIL_NOT_VERIFIED',\n                'Email verification is required for this transition'\n            );\n        }\n\n        // 6. Business hours check\n        if ($businessHoursOnly) {\n            $currentHour = now()->hour;\n            if ($currentHour < $businessHoursStart || $currentHour >= $businessHoursEnd) {\n                return RestrictionResult::deny(\n                    'OUTSIDE_BUSINESS_HOURS',\n                    \"This operation is only available during business hours ({$businessHoursStart}:00 - {$businessHoursEnd}:00)\"\n                );\n            }\n        }\n\n        // All configurable checks passed\n        return RestrictionResult::allow();\n    }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Points:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Fully configurable restrictions"}),"\n",(0,s.jsx)(n.li,{children:"Multiple validation layers from config"}),"\n",(0,s.jsx)(n.li,{children:"Flexible business rules"}),"\n",(0,s.jsx)(n.li,{children:"Easy to adjust without code changes"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example-6-advanced-time-based-restrictions---scheduling-and-windows",children:"Example 6: Advanced Time-Based Restrictions - Scheduling and Windows"}),"\n",(0,s.jsx)(n.p,{children:"A comprehensive time-based restriction system with multiple time windows and scheduling:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Flows\\Order;\n\nuse App\\Models\\Order;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Facades\\Cache;\nuse JobMetric\\Flow\\Contracts\\AbstractRestrictionTask;\nuse JobMetric\\Flow\\Support\\FlowTaskContext;\nuse JobMetric\\Flow\\Support\\FlowTaskDefinition;\nuse JobMetric\\Flow\\Support\\RestrictionResult;\nuse JobMetric\\Form\\FormBuilder;\n\nclass TimeBasedRestrictionTask extends AbstractRestrictionTask\n{\n    public static function subject(): string\n    {\n        return \\App\\Models\\Order::class;\n    }\n\n    public static function definition(): FlowTaskDefinition\n    {\n        return new FlowTaskDefinition(\n            title: 'flow::base.task.time_based_restriction.title',\n            description: 'Time-based restrictions for transitions',\n        );\n    }\n\n    public function form(): FormBuilder\n    {\n        return (new FormBuilder)\n            ->hiddenCustomField('business_hours_start', 'integer', 9, 'Business hours start (24h format)')\n            ->hiddenCustomField('business_hours_end', 'integer', 17, 'Business hours end (24h format)')\n            ->hiddenCustomField('allowed_days', 'array', ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'], 'Allowed days of week')\n            ->hiddenCustomField('blocked_dates', 'array', [], 'Blocked dates (YYYY-MM-DD)')\n            ->hiddenCustomField('time_window_start', 'string', null, 'Time window start (HH:MM)')\n            ->hiddenCustomField('time_window_end', 'string', null, 'Time window end (HH:MM)')\n            ->hiddenCustomField('max_operations_per_hour', 'integer', 10, 'Maximum operations per hour')\n            ->hiddenCustomField('timezone', 'string', 'UTC', 'Timezone for time checks');\n    }\n\n    public function restriction(FlowTaskContext $context): RestrictionResult\n    {\n        $order = $context->subject();\n        $user = $context->user();\n        $config = $context->config();\n\n        // Extract configuration\n        $businessHoursStart = $config['business_hours_start'] ?? 9;\n        $businessHoursEnd = $config['business_hours_end'] ?? 17;\n        $allowedDays = $config['allowed_days'] ?? [];\n        $blockedDates = $config['blocked_dates'] ?? [];\n        $timeWindowStart = $config['time_window_start'] ?? null;\n        $timeWindowEnd = $config['time_window_end'] ?? null;\n        $maxPerHour = $config['max_operations_per_hour'] ?? 10;\n        $timezone = $config['timezone'] ?? 'UTC';\n\n        $now = Carbon::now($timezone);\n\n        // 1. Business hours check\n        $currentHour = $now->hour;\n        if ($currentHour < $businessHoursStart || $currentHour >= $businessHoursEnd) {\n            return RestrictionResult::deny(\n                'OUTSIDE_BUSINESS_HOURS',\n                \"This operation is only available during business hours ({$businessHoursStart}:00 - {$businessHoursEnd}:00 {$timezone})\"\n            );\n        }\n\n        // 2. Day of week check\n        if (!empty($allowedDays)) {\n            $currentDay = strtolower($now->format('l'));\n            if (!in_array($currentDay, $allowedDays)) {\n                return RestrictionResult::deny(\n                    'DAY_NOT_ALLOWED',\n                    \"This operation is not available on {$currentDay}. Allowed days: \" . implode(', ', $allowedDays)\n                );\n            }\n        }\n\n        // 3. Blocked dates check\n        if (!empty($blockedDates)) {\n            $currentDate = $now->format('Y-m-d');\n            if (in_array($currentDate, $blockedDates)) {\n                return RestrictionResult::deny(\n                    'DATE_BLOCKED',\n                    \"This operation is blocked on {$currentDate}\"\n                );\n            }\n        }\n\n        // 4. Time window check\n        if ($timeWindowStart && $timeWindowEnd) {\n            $windowStart = Carbon::parse($timeWindowStart, $timezone);\n            $windowEnd = Carbon::parse($timeWindowEnd, $timezone);\n            $currentTime = $now->copy()->setDate($windowStart->year, $windowStart->month, $windowStart->day);\n\n            if ($currentTime->lt($windowStart) || $currentTime->gt($windowEnd)) {\n                return RestrictionResult::deny(\n                    'OUTSIDE_TIME_WINDOW',\n                    \"This operation is only available between {$timeWindowStart} and {$timeWindowEnd} {$timezone}\"\n                );\n            }\n        }\n\n        // 5. Rate limiting per hour\n        if ($maxPerHour > 0 && $user) {\n            $rateLimitKey = \"operation_rate_limit_{$user->id}_\" . $now->format('Y-m-d-H');\n            $currentCount = Cache::get($rateLimitKey, 0);\n\n            if ($currentCount >= $maxPerHour) {\n                return RestrictionResult::deny(\n                    'RATE_LIMIT_EXCEEDED',\n                    \"You have exceeded the maximum of {$maxPerHour} operations per hour. Please try again later.\"\n                );\n            }\n\n            // Increment counter\n            Cache::put($rateLimitKey, $currentCount + 1, 3600);\n        }\n\n        // 6. Order age check (time since creation)\n        $hoursSinceCreation = $order->created_at->diffInHours($now);\n        if ($hoursSinceCreation > 48) {\n            return RestrictionResult::deny(\n                'ORDER_TOO_OLD',\n                \"This operation is not available for orders older than 48 hours. Order was created {$hoursSinceCreation} hours ago.\"\n            );\n        }\n\n        // All time-based checks passed\n        return RestrictionResult::allow();\n    }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Points:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Multiple time-based validations"}),"\n",(0,s.jsx)(n.li,{children:"Business hours and days"}),"\n",(0,s.jsx)(n.li,{children:"Time windows"}),"\n",(0,s.jsx)(n.li,{children:"Rate limiting with caching"}),"\n",(0,s.jsx)(n.li,{children:"Timezone support"}),"\n",(0,s.jsx)(n.li,{children:"Order age restrictions"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example-7-resource-locking-and-concurrency-control",children:"Example 7: Resource Locking and Concurrency Control"}),"\n",(0,s.jsx)(n.p,{children:"A restriction that prevents concurrent modifications and handles resource locking:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Flows\\Order;\n\nuse App\\Models\\Order;\nuse Illuminate\\Support\\Facades\\Cache;\nuse Illuminate\\Support\\Facades\\DB;\nuse JobMetric\\Flow\\Contracts\\AbstractRestrictionTask;\nuse JobMetric\\Flow\\Support\\FlowTaskContext;\nuse JobMetric\\Flow\\Support\\FlowTaskDefinition;\nuse JobMetric\\Flow\\Support\\RestrictionResult;\nuse JobMetric\\Form\\FormBuilder;\n\nclass ResourceLockingRestrictionTask extends AbstractRestrictionTask\n{\n    public static function subject(): string\n    {\n        return \\App\\Models\\Order::class;\n    }\n\n    public static function definition(): FlowTaskDefinition\n    {\n        return new FlowTaskDefinition(\n            title: 'flow::base.task.resource_locking.title',\n            description: 'Prevents concurrent modifications',\n        );\n    }\n\n    public function form(): FormBuilder\n    {\n        return (new FormBuilder)\n            ->hiddenCustomField('lock_timeout', 'integer', 300, 'Lock timeout in seconds')\n            ->hiddenCustomField('check_concurrent_edits', 'boolean', true, 'Check for concurrent edits')\n            ->hiddenCustomField('require_lock', 'boolean', true, 'Require resource lock');\n    }\n\n    public function restriction(FlowTaskContext $context): RestrictionResult\n    {\n        $order = $context->subject();\n        $user = $context->user();\n        $config = $context->config();\n\n        $lockTimeout = $config['lock_timeout'] ?? 300;\n        $checkConcurrent = $config['check_concurrent_edits'] ?? true;\n        $requireLock = $config['require_lock'] ?? true;\n\n        // 1. Check if resource is locked\n        $lockKey = \"order_lock_{$order->id}\";\n        $lockedBy = Cache::get($lockKey);\n\n        if ($lockedBy && $lockedBy !== $user?->id) {\n            $lockedUser = \\App\\Models\\User::find($lockedBy);\n            return RestrictionResult::deny(\n                'RESOURCE_LOCKED',\n                \"Order is currently being edited by {$lockedUser?->name}. Please try again later.\"\n            );\n        }\n\n        // 2. Check for concurrent edits (optimistic locking)\n        if ($checkConcurrent) {\n            $lastModified = $order->updated_at;\n            $payloadVersion = $context->payload()['version'] ?? null;\n\n            if ($payloadVersion && $order->version !== $payloadVersion) {\n                return RestrictionResult::deny(\n                    'CONCURRENT_MODIFICATION',\n                    'Order has been modified by another user. Please refresh and try again.'\n                );\n            }\n        }\n\n        // 3. Acquire lock if required\n        if ($requireLock && $user) {\n            $lockAcquired = Cache::add($lockKey, $user->id, $lockTimeout);\n            \n            if (!$lockAcquired) {\n                return RestrictionResult::deny(\n                    'LOCK_ACQUISITION_FAILED',\n                    'Could not acquire lock on resource. Please try again.'\n                );\n            }\n        }\n\n        // 4. Check if order is in a transaction\n        if (DB::transactionLevel() > 0) {\n            // Order is already in a transaction, might be locked\n            return RestrictionResult::deny(\n                'RESOURCE_IN_TRANSACTION',\n                'Order is currently being processed in another transaction'\n            );\n        }\n\n        // All locking checks passed\n        return RestrictionResult::allow();\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"example-8-quota-and-limit-restrictions",children:"Example 8: Quota and Limit Restrictions"}),"\n",(0,s.jsx)(n.p,{children:"A restriction that enforces quotas and usage limits:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Flows\\Order;\n\nuse App\\Models\\Order;\nuse App\\Models\\User;\nuse Illuminate\\Support\\Facades\\Cache;\nuse Illuminate\\Support\\Facades\\DB;\nuse JobMetric\\Flow\\Contracts\\AbstractRestrictionTask;\nuse JobMetric\\Flow\\Support\\FlowTaskContext;\nuse JobMetric\\Flow\\Support\\FlowTaskDefinition;\nuse JobMetric\\Flow\\Support\\RestrictionResult;\nuse JobMetric\\Form\\FormBuilder;\n\nclass QuotaRestrictionTask extends AbstractRestrictionTask\n{\n    public static function subject(): string\n    {\n        return \\App\\Models\\Order::class;\n    }\n\n    public static function definition(): FlowTaskDefinition\n    {\n        return new FlowTaskDefinition(\n            title: 'flow::base.task.quota_restriction.title',\n            description: 'Enforces quotas and usage limits',\n        );\n    }\n\n    public function form(): FormBuilder\n    {\n        return (new FormBuilder)\n            ->hiddenCustomField('max_orders_per_day', 'integer', 10, 'Maximum orders per day')\n            ->hiddenCustomField('max_orders_per_month', 'integer', 100, 'Maximum orders per month')\n            ->hiddenCustomField('max_total_amount_per_day', 'decimal', 5000, 'Maximum total amount per day')\n            ->hiddenCustomField('check_user_tier', 'boolean', true, 'Check user tier limits')\n            ->hiddenCustomField('allow_unlimited_tier', 'string', 'premium', 'Tier with unlimited access');\n    }\n\n    public function restriction(FlowTaskContext $context): RestrictionResult\n    {\n        $order = $context->subject();\n        $user = $context->user();\n        $config = $context->config();\n\n        if (!$user) {\n            return RestrictionResult::deny(\n                'USER_REQUIRED',\n                'User is required for quota checks'\n            );\n        }\n\n        $maxPerDay = $config['max_orders_per_day'] ?? 10;\n        $maxPerMonth = $config['max_orders_per_month'] ?? 100;\n        $maxAmountPerDay = $config['max_total_amount_per_day'] ?? 5000;\n        $checkTier = $config['check_user_tier'] ?? true;\n        $unlimitedTier = $config['allow_unlimited_tier'] ?? 'premium';\n\n        // Check if user has unlimited tier\n        if ($checkTier && $user->tier === $unlimitedTier) {\n            return RestrictionResult::allow();\n        }\n\n        // 1. Daily order count check\n        $dailyCount = $this->getDailyOrderCount($user);\n        if ($dailyCount >= $maxPerDay) {\n            return RestrictionResult::deny(\n                'DAILY_QUOTA_EXCEEDED',\n                \"You have reached the daily limit of {$maxPerDay} orders. Please try again tomorrow.\"\n            );\n        }\n\n        // 2. Monthly order count check\n        $monthlyCount = $this->getMonthlyOrderCount($user);\n        if ($monthlyCount >= $maxPerMonth) {\n            return RestrictionResult::deny(\n                'MONTHLY_QUOTA_EXCEEDED',\n                \"You have reached the monthly limit of {$maxPerMonth} orders.\"\n            );\n        }\n\n        // 3. Daily amount check\n        $dailyAmount = $this->getDailyOrderAmount($user);\n        $newTotal = $dailyAmount + $order->total;\n        if ($newTotal > $maxAmountPerDay) {\n            return RestrictionResult::deny(\n                'DAILY_AMOUNT_EXCEEDED',\n                \"This order would exceed your daily spending limit of {$maxAmountPerDay}. \" .\n                \"Current daily total: {$dailyAmount}, Order amount: {$order->total}\"\n            );\n        }\n\n        // All quota checks passed\n        return RestrictionResult::allow();\n    }\n\n    protected function getDailyOrderCount(User $user): int\n    {\n        $cacheKey = \"user_daily_orders_{$user->id}_\" . now()->format('Y-m-d');\n        \n        return Cache::remember($cacheKey, 3600, function () use ($user) {\n            return $user->orders()\n                ->whereDate('created_at', today())\n                ->count();\n        });\n    }\n\n    protected function getMonthlyOrderCount(User $user): int\n    {\n        $cacheKey = \"user_monthly_orders_{$user->id}_\" . now()->format('Y-m');\n        \n        return Cache::remember($cacheKey, 3600, function () use ($user) {\n            return $user->orders()\n                ->whereYear('created_at', now()->year)\n                ->whereMonth('created_at', now()->month)\n                ->count();\n        });\n    }\n\n    protected function getDailyOrderAmount(User $user): float\n    {\n        $cacheKey = \"user_daily_amount_{$user->id}_\" . now()->format('Y-m-d');\n        \n        return Cache::remember($cacheKey, 3600, function () use ($user) {\n            return $user->orders()\n                ->whereDate('created_at', today())\n                ->sum('total');\n        });\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"example-9-complete-real-world-system---order-cancellation-workflow",children:"Example 9: Complete Real-World System - Order Cancellation Workflow"}),"\n",(0,s.jsx)(n.p,{children:"A complete example showing all restriction patterns working together:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Flows\\Order;\n\nuse App\\Models\\Order;\nuse App\\Models\\User;\nuse Illuminate\\Support\\Facades\\Cache;\nuse Illuminate\\Support\\Facades\\DB;\nuse Illuminate\\Support\\Facades\\Log;\nuse JobMetric\\Flow\\Contracts\\AbstractRestrictionTask;\nuse JobMetric\\Flow\\Support\\FlowTaskContext;\nuse JobMetric\\Flow\\Support\\FlowTaskDefinition;\nuse JobMetric\\Flow\\Support\\RestrictionResult;\nuse JobMetric\\Form\\FormBuilder;\n\nclass CompleteOrderCancellationRestrictionTask extends AbstractRestrictionTask\n{\n    public static function subject(): string\n    {\n        return \\App\\Models\\Order::class;\n    }\n\n    public static function definition(): FlowTaskDefinition\n    {\n        return new FlowTaskDefinition(\n            title: 'flow::base.task.complete_cancellation_restriction.title',\n            description: 'Complete order cancellation restrictions',\n        );\n    }\n\n    public function form(): FormBuilder\n    {\n        return (new FormBuilder)\n            ->hiddenCustomField('max_cancellation_hours', 'integer', 24, 'Max hours after creation')\n            ->hiddenCustomField('require_reason', 'boolean', true, 'Require cancellation reason')\n            ->hiddenCustomField('check_rate_limit', 'boolean', true, 'Check rate limit')\n            ->hiddenCustomField('max_cancellations_per_month', 'integer', 5, 'Max cancellations per month')\n            ->hiddenCustomField('allow_admin_override', 'boolean', true, 'Allow admin override')\n            ->hiddenCustomField('check_inventory', 'boolean', true, 'Check inventory restock')\n            ->hiddenCustomField('check_payment', 'boolean', true, 'Check payment status')\n            ->hiddenCustomField('check_disputes', 'boolean', true, 'Check active disputes');\n    }\n\n    public function restriction(FlowTaskContext $context): RestrictionResult\n    {\n        $order = $context->subject();\n        $user = $context->user();\n        $payload = $context->payload();\n        $config = $context->config();\n\n        // Log restriction check start\n        Log::info('Order cancellation restriction check', [\n            'order_id' => $order->id,\n            'user_id' => $user?->id,\n        ]);\n\n        // Admin override (early exit)\n        if (($config['allow_admin_override'] ?? true) && $user && $user->hasRole('admin')) {\n            Log::info('Admin override granted', ['order_id' => $order->id, 'user_id' => $user->id]);\n            return RestrictionResult::allow();\n        }\n\n        // 1. User checks\n        if (!$user) {\n            return $this->denyWithLog('USER_NOT_AUTHENTICATED', 'User must be authenticated', $order);\n        }\n\n        if (!$user->can('cancel', $order)) {\n            return $this->denyWithLog('PERMISSION_DENIED', 'No permission to cancel', $order, $user);\n        }\n\n        if ($order->user_id !== $user->id && !$user->hasRole('admin')) {\n            return $this->denyWithLog('OWNERSHIP_MISMATCH', 'Not your order', $order, $user);\n        }\n\n        // 2. Order status checks\n        if (in_array($order->status, ['shipped', 'delivered', 'cancelled', 'refunded'])) {\n            return $this->denyWithLog(\n                'INVALID_STATUS',\n                \"Cannot cancel order with status: {$order->status}\",\n                $order,\n                $user\n            );\n        }\n\n        // 3. Time-based checks\n        $maxHours = $config['max_cancellation_hours'] ?? 24;\n        $hoursSinceCreated = $order->created_at->diffInHours(now());\n        if ($hoursSinceCreated > $maxHours) {\n            return $this->denyWithLog(\n                'TIME_LIMIT_EXCEEDED',\n                \"Order is older than {$maxHours} hours\",\n                $order,\n                $user\n            );\n        }\n\n        // 4. Payload validation\n        if (($config['require_reason'] ?? true) && empty($payload['reason'])) {\n            return $this->denyWithLog('REASON_REQUIRED', 'Cancellation reason required', $order, $user);\n        }\n\n        // 5. Rate limiting\n        if ($config['check_rate_limit'] ?? true) {\n            $maxPerMonth = $config['max_cancellations_per_month'] ?? 5;\n            $count = $this->getMonthlyCancellationCount($user);\n            if ($count >= $maxPerMonth) {\n                return $this->denyWithLog(\n                    'RATE_LIMIT_EXCEEDED',\n                    \"Exceeded {$maxPerMonth} cancellations per month\",\n                    $order,\n                    $user\n                );\n            }\n        }\n\n        // 6. Payment checks\n        if ($config['check_payment'] ?? true) {\n            if ($order->payment_status === 'refunded') {\n                return $this->denyWithLog('PAYMENT_ALREADY_REFUNDED', 'Payment already refunded', $order, $user);\n            }\n        }\n\n        // 7. Dispute checks\n        if (($config['check_disputes'] ?? true) && $this->hasActiveDispute($order)) {\n            return $this->denyWithLog('ACTIVE_DISPUTE', 'Order has active dispute', $order, $user);\n        }\n\n        // 8. Inventory checks\n        if (($config['check_inventory'] ?? true)) {\n            $restockInventory = $payload['restock_inventory'] ?? true;\n            if ($restockInventory && !$this->canRestockInventory($order)) {\n                return $this->denyWithLog('INVENTORY_RESTOCK_FAILED', 'Cannot restock inventory', $order, $user);\n            }\n        }\n\n        // All checks passed\n        Log::info('Order cancellation restriction passed', [\n            'order_id' => $order->id,\n            'user_id' => $user->id,\n        ]);\n\n        return RestrictionResult::allow();\n    }\n\n    protected function denyWithLog(string $code, string $message, Order $order, ?User $user = null): RestrictionResult\n    {\n        Log::warning('Order cancellation restriction denied', [\n            'code' => $code,\n            'message' => $message,\n            'order_id' => $order->id,\n            'user_id' => $user?->id,\n        ]);\n\n        return RestrictionResult::deny($code, $message);\n    }\n\n    protected function getMonthlyCancellationCount(User $user): int\n    {\n        $cacheKey = \"user_cancellations_{$user->id}_\" . now()->format('Y-m');\n        \n        return Cache::remember($cacheKey, 3600, function () use ($user) {\n            return $user->orders()\n                ->where('status', 'cancelled')\n                ->whereYear('cancelled_at', now()->year)\n                ->whereMonth('cancelled_at', now()->month)\n                ->count();\n        });\n    }\n\n    protected function hasActiveDispute(Order $order): bool\n    {\n        return $order->disputes()\n            ->where('status', 'open')\n            ->exists();\n    }\n\n    protected function canRestockInventory(Order $order): bool\n    {\n        foreach ($order->items as $item) {\n            if (!$item->product->canRestock()) {\n                return false;\n            }\n        }\n        return true;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Points:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Comprehensive logging"}),"\n",(0,s.jsx)(n.li,{children:"Early exit for admin override"}),"\n",(0,s.jsx)(n.li,{children:"Multiple validation layers"}),"\n",(0,s.jsx)(n.li,{children:"Caching for performance"}),"\n",(0,s.jsx)(n.li,{children:"Detailed error messages"}),"\n",(0,s.jsx)(n.li,{children:"Production-ready implementation"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"code-conventions",children:"Code Conventions"}),"\n",(0,s.jsx)(n.h3,{id:"recommended-code-format",children:"Recommended Code Format"}),"\n",(0,s.jsx)(n.p,{children:"Use uppercase with underscores:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// \u2705 Good\nRestrictionResult::deny('PERMISSION_DENIED', 'Message');\nRestrictionResult::deny('ORDER_SHIPPED', 'Message');\nRestrictionResult::deny('TIME_LIMIT_EXCEEDED', 'Message');\n\n// \u274c Bad\nRestrictionResult::deny('permission-denied', 'Message');\nRestrictionResult::deny('PermissionDenied', 'Message');\n"})}),"\n",(0,s.jsx)(n.h3,{id:"common-code-patterns",children:"Common Code Patterns"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"PERMISSION_DENIED"})," - User lacks permission"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"STATUS_INVALID"})," - Invalid model status"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"TIME_LIMIT_EXCEEDED"})," - Time constraint violation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"REQUIRED_FIELD_MISSING"})," - Required field not provided"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"BUSINESS_RULE_VIOLATION"})," - Business rule violation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"RESOURCE_LOCKED"})," - Resource is locked"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"QUOTA_EXCEEDED"})," - Quota limit exceeded"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"error-handling-and-integration",children:"Error Handling and Integration"}),"\n",(0,s.jsx)(n.h3,{id:"how-restriction-failures-work",children:"How Restriction Failures Work"}),"\n",(0,s.jsxs)(n.p,{children:["When a restriction denies a transition, the ",(0,s.jsx)(n.code,{children:"FlowTransition"})," service will:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Throw a ",(0,s.jsx)(n.code,{children:"TaskRestrictionException"})]}),"\n",(0,s.jsxs)(n.li,{children:["Include the code and message from ",(0,s.jsx)(n.code,{children:"RestrictionResult"})]}),"\n",(0,s.jsx)(n.li,{children:"Prevent the transition from executing"}),"\n",(0,s.jsx)(n.li,{children:"Stop all subsequent tasks (validation and action tasks won't run)"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"basic-error-handling",children:"Basic Error Handling"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\Flow\\Facades\\FlowTransition;\nuse JobMetric\\Flow\\Exceptions\\TaskRestrictionException;\n\ntry {\n    $result = FlowTransition::runner('cancel_order', $order, $payload, $user);\n    \n    // Transition succeeded\n    return response()->json([\n        'success' => true,\n        'data' => $result->getData(),\n    ]);\n    \n} catch (TaskRestrictionException $e) {\n    // Restriction denied\n    $code = $e->getCode();\n    $message = $e->getMessage();\n    \n    return response()->json([\n        'success' => false,\n        'error' => $code,\n        'message' => $message,\n    ], 403);\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"advanced-error-handling-with-code-based-responses",children:"Advanced Error Handling with Code-Based Responses"}),"\n",(0,s.jsx)(n.p,{children:"Handle different restriction codes with specific responses:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Http\\Controllers;\n\nuse App\\Models\\Order;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\JsonResponse;\nuse JobMetric\\Flow\\Facades\\FlowTransition;\nuse JobMetric\\Flow\\Exceptions\\TaskRestrictionException;\n\nclass OrderController extends Controller\n{\n    public function cancel(Request $request, Order $order): JsonResponse\n    {\n        $payload = [\n            'reason' => $request->input('reason'),\n            'restock_inventory' => $request->boolean('restock_inventory', true),\n        ];\n\n        try {\n            $result = FlowTransition::runner('cancel_order', $order, $payload, auth()->user());\n\n            return response()->json([\n                'success' => true,\n                'message' => 'Order cancelled successfully',\n                'data' => $result->getData(),\n            ]);\n\n        } catch (TaskRestrictionException $e) {\n            return $this->handleRestrictionError($e, $order);\n        }\n    }\n\n    protected function handleRestrictionError(TaskRestrictionException $e, Order $order): JsonResponse\n    {\n        $code = $e->getCode();\n        $message = $e->getMessage();\n\n        // Handle specific restriction codes\n        return match ($code) {\n            'USER_NOT_AUTHENTICATED' => response()->json([\n                'success' => false,\n                'error' => $code,\n                'message' => $message,\n                'action' => 'login_required',\n            ], 401),\n\n            'PERMISSION_DENIED' => response()->json([\n                'success' => false,\n                'error' => $code,\n                'message' => $message,\n                'action' => 'contact_support',\n            ], 403),\n\n            'ORDER_SHIPPED' => response()->json([\n                'success' => false,\n                'error' => $code,\n                'message' => $message,\n                'action' => 'contact_shipping',\n                'shipping_info' => [\n                    'tracking_number' => $order->tracking_number,\n                    'shipped_at' => $order->shipped_at,\n                ],\n            ], 403),\n\n            'TIME_LIMIT_EXCEEDED' => response()->json([\n                'success' => false,\n                'error' => $code,\n                'message' => $message,\n                'action' => 'contact_support',\n                'order_age_hours' => $order->created_at->diffInHours(now()),\n            ], 403),\n\n            'RATE_LIMIT_EXCEEDED' => response()->json([\n                'success' => false,\n                'error' => $code,\n                'message' => $message,\n                'action' => 'wait_or_contact',\n                'retry_after' => now()->addDay()->toIso8601String(),\n            ], 429),\n\n            'REASON_REQUIRED' => response()->json([\n                'success' => false,\n                'error' => $code,\n                'message' => $message,\n                'action' => 'provide_reason',\n                'validation' => [\n                    'reason' => ['required', 'string', 'min:10'],\n                ],\n            ], 422),\n\n            default => response()->json([\n                'success' => false,\n                'error' => $code,\n                'message' => $message,\n                'action' => 'contact_support',\n            ], 403),\n        };\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"frontend-integration-example",children:"Frontend Integration Example"}),"\n",(0,s.jsx)(n.p,{children:"Handle restriction errors in frontend applications:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// React/Vue/Angular example\nasync function cancelOrder(orderId, reason) {\n    try {\n        const response = await fetch(`/api/orders/${orderId}/cancel`, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json',\n                'Authorization': `Bearer ${token}`,\n            },\n            body: JSON.stringify({ reason }),\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            // Show success message\n            showNotification('Order cancelled successfully', 'success');\n            return data;\n        } else {\n            // Handle restriction error\n            handleRestrictionError(data);\n        }\n    } catch (error) {\n        handleError(error);\n    }\n}\n\nfunction handleRestrictionError(data) {\n    const { error, message, action } = data;\n\n    switch (error) {\n        case 'USER_NOT_AUTHENTICATED':\n            redirectToLogin();\n            break;\n\n        case 'PERMISSION_DENIED':\n            showError(message);\n            showContactSupportButton();\n            break;\n\n        case 'ORDER_SHIPPED':\n            showError(message);\n            showShippingInfo(data.shipping_info);\n            break;\n\n        case 'TIME_LIMIT_EXCEEDED':\n            showError(message);\n            showContactSupportButton();\n            break;\n\n        case 'RATE_LIMIT_EXCEEDED':\n            showError(message);\n            showRetryAfter(data.retry_after);\n            break;\n\n        case 'REASON_REQUIRED':\n            showValidationError(data.validation);\n            break;\n\n        default:\n            showError(message);\n            showContactSupportButton();\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"logging-and-monitoring",children:"Logging and Monitoring"}),"\n",(0,s.jsx)(n.p,{children:"Log restriction failures for monitoring and analytics:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use Illuminate\\Support\\Facades\\Log;\nuse JobMetric\\Flow\\Exceptions\\TaskRestrictionException;\n\ntry {\n    $result = FlowTransition::runner('cancel_order', $order, $payload, $user);\n} catch (TaskRestrictionException $e) {\n    // Log restriction failure\n    Log::warning('Order cancellation restricted', [\n        'order_id' => $order->id,\n        'user_id' => $user?->id,\n        'restriction_code' => $e->getCode(),\n        'restriction_message' => $e->getMessage(),\n        'order_status' => $order->status,\n        'order_total' => $order->total,\n        'payload' => $payload,\n    ]);\n\n    // Track in analytics\n    analytics()->track('order_cancellation_restricted', [\n        'restriction_code' => $e->getCode(),\n        'order_id' => $order->id,\n    ]);\n\n    // Send to error tracking service\n    if (app()->bound('sentry')) {\n        app('sentry')->captureException($e, [\n            'tags' => [\n                'restriction_code' => $e->getCode(),\n                'order_id' => $order->id,\n            ],\n        ]);\n    }\n\n    throw $e; // Re-throw to handle in controller\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"testing-restriction-results",children:"Testing Restriction Results"}),"\n",(0,s.jsx)(n.p,{children:"Test restriction tasks and their results:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace Tests\\Feature\\Flows;\n\nuse App\\Flows\\Order\\RestrictCancellationRestrictionTask;\nuse App\\Models\\Order;\nuse App\\Models\\User;\nuse Illuminate\\Foundation\\Testing\\RefreshDatabase;\nuse JobMetric\\Flow\\DTO\\TransitionResult;\nuse JobMetric\\Flow\\Support\\FlowTaskContext;\nuse JobMetric\\Flow\\Support\\RestrictionResult;\nuse Tests\\TestCase;\n\nclass RestrictionTaskTest extends TestCase\n{\n    use RefreshDatabase;\n\n    public function test_allows_cancellation_when_all_conditions_met(): void\n    {\n        $order = Order::factory()->create(['status' => 'pending']);\n        $user = User::factory()->create();\n        $user->givePermissionTo('cancel', Order::class);\n\n        $task = new RestrictCancellationRestrictionTask();\n        $context = new FlowTaskContext(\n            $order,\n            TransitionResult::success(),\n            ['reason' => 'Customer request'],\n            $user\n        );\n\n        $result = $task->restriction($context);\n\n        $this->assertTrue($result->allowed());\n        $this->assertNull($result->code());\n    }\n\n    public function test_denies_cancellation_when_order_shipped(): void\n    {\n        $order = Order::factory()->create(['status' => 'shipped']);\n        $user = User::factory()->create();\n\n        $task = new RestrictCancellationRestrictionTask();\n        $context = new FlowTaskContext($order, TransitionResult::success(), [], $user);\n\n        $result = $task->restriction($context);\n\n        $this->assertFalse($result->allowed());\n        $this->assertEquals('ORDER_SHIPPED', $result->code());\n        $this->assertNotNull($result->message());\n    }\n\n    public function test_denies_cancellation_without_permission(): void\n    {\n        $order = Order::factory()->create(['status' => 'pending']);\n        $user = User::factory()->create();\n        // User does NOT have permission\n\n        $task = new RestrictCancellationRestrictionTask();\n        $context = new FlowTaskContext($order, TransitionResult::success(), [], $user);\n\n        $result = $task->restriction($context);\n\n        $this->assertFalse($result->allowed());\n        $this->assertEquals('PERMISSION_DENIED', $result->code());\n    }\n\n    public function test_denies_cancellation_without_reason(): void\n    {\n        $order = Order::factory()->create(['status' => 'pending']);\n        $user = User::factory()->create();\n        $user->givePermissionTo('cancel', Order::class);\n\n        $task = new RestrictCancellationRestrictionTask();\n        $context = new FlowTaskContext(\n            $order,\n            TransitionResult::success(),\n            [], // No reason provided\n            $user\n        );\n\n        $result = $task->restriction($context);\n\n        $this->assertFalse($result->allowed());\n        $this->assertEquals('REASON_REQUIRED', $result->code());\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Use Descriptive Codes"}),": Choose codes that clearly identify the restriction reason"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// \u2705 Good\nRestrictionResult::deny('ORDER_SHIPPED', 'Message');\n\n// \u274c Bad\nRestrictionResult::deny('ERROR', 'Message');\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Provide User-Friendly Messages"}),": Messages should be understandable by end users"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// \u2705 Good\nRestrictionResult::deny('ORDER_SHIPPED', 'Cannot cancel shipped orders');\n\n// \u274c Bad\nRestrictionResult::deny('ORDER_SHIPPED', 'Error code 42');\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Check Multiple Conditions"}),": Evaluate all conditions before allowing"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// Check permission\nif (!$user->can('cancel', $order)) {\n    return RestrictionResult::deny('PERMISSION_DENIED', '...');\n}\n\n// Check status\nif ($order->status === 'shipped') {\n    return RestrictionResult::deny('ORDER_SHIPPED', '...');\n}\n\nreturn RestrictionResult::allow();\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Use Config for Flexibility"}),": Make restrictions configurable when possible"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$allowedStatuses = $context->config()['allowed_statuses'] ?? [];\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Return Early"}),": Return deny results as soon as a condition fails"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// \u2705 Good: Early return\nif ($order->status === 'shipped') {\n    return RestrictionResult::deny('ORDER_SHIPPED', '...');\n}\n\n// \u274c Bad: Nested conditions\nif ($order->status !== 'shipped') {\n    if ($user->can('cancel', $order)) {\n        return RestrictionResult::allow();\n    }\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"integration-with-flowtransition",children:"Integration with FlowTransition"}),"\n",(0,s.jsx)(n.h3,{id:"execution-order",children:"Execution Order"}),"\n",(0,s.jsxs)(n.p,{children:["Restriction tasks are executed ",(0,s.jsx)(n.strong,{children:"first"})," in the workflow transition:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// FlowTransition execution order:\n// 1. Restriction tasks (can deny) \u2190 Executed FIRST\n// 2. Validation tasks (can fail)   \u2190 Only if restrictions pass\n// 3. Action tasks (execute)        \u2190 Only if restrictions pass AND validation passes\n"})}),"\n",(0,s.jsx)(n.h3,{id:"how-restrictions-stop-transitions",children:"How Restrictions Stop Transitions"}),"\n",(0,s.jsxs)(n.p,{children:["If ",(0,s.jsx)(n.strong,{children:"any"})," restriction task returns ",(0,s.jsx)(n.code,{children:"deny()"}),", the transition is stopped immediately:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// Inside FlowTransition::runner()\nforeach ($restrictionTasks as $task) {\n    $result = $task->restriction($context);\n    \n    if (!$result->allowed()) {\n        // Transition STOPS here\n        // Validation tasks won't run\n        // Action tasks won't run\n        throw new TaskRestrictionException(\n            $result->code(),\n            $result->message()\n        );\n    }\n}\n\n// Only reached if ALL restrictions allow\n// Continue with validation tasks...\n"})}),"\n",(0,s.jsx)(n.h3,{id:"multiple-restrictions",children:"Multiple Restrictions"}),"\n",(0,s.jsxs)(n.p,{children:["When multiple restriction tasks exist, ",(0,s.jsx)(n.strong,{children:"all"})," must allow:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// Example: Three restriction tasks\n$restriction1 = new PermissionRestrictionTask();\n$restriction2 = new OrderStatusRestrictionTask();\n$restriction3 = new TimeBasedRestrictionTask();\n\n// All three must return RestrictionResult::allow()\n// If ANY returns deny(), transition stops\n"})}),"\n",(0,s.jsx)(n.h3,{id:"real-world-workflow-example",children:"Real-World Workflow Example"}),"\n",(0,s.jsx)(n.p,{children:"Complete example showing restriction flow in a real system:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Http\\Controllers;\n\nuse App\\Models\\Order;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\JsonResponse;\nuse JobMetric\\Flow\\Facades\\FlowTransition;\nuse JobMetric\\Flow\\Exceptions\\TaskRestrictionException;\n\nclass OrderController extends Controller\n{\n    /**\n     * Cancel an order with comprehensive restriction handling\n     */\n    public function cancel(Request $request, Order $order): JsonResponse\n    {\n        // Validate request\n        $validated = $request->validate([\n            'reason' => 'required|string|min:10|max:500',\n            'restock_inventory' => 'boolean',\n        ]);\n\n        try {\n            // Execute transition - restrictions are checked automatically\n            $result = FlowTransition::runner(\n                'cancel_order',\n                $order,\n                $validated,\n                auth()->user()\n            );\n\n            // Transition succeeded (all restrictions passed)\n            return response()->json([\n                'success' => true,\n                'message' => 'Order cancelled successfully',\n                'data' => $result->getData(),\n                'messages' => $result->getMessages(),\n            ]);\n\n        } catch (TaskRestrictionException $e) {\n            // A restriction denied the transition\n            return $this->handleRestrictionFailure($e, $order);\n        }\n    }\n\n    protected function handleRestrictionFailure(TaskRestrictionException $e, Order $order): JsonResponse\n    {\n        $code = $e->getCode();\n        $message = $e->getMessage();\n\n        // Map restriction codes to HTTP status codes\n        $statusCode = match ($code) {\n            'USER_NOT_AUTHENTICATED' => 401,\n            'PERMISSION_DENIED' => 403,\n            'RATE_LIMIT_EXCEEDED' => 429,\n            default => 403,\n        };\n\n        // Provide actionable error responses\n        $response = [\n            'success' => false,\n            'error' => [\n                'code' => $code,\n                'message' => $message,\n            ],\n            'order' => [\n                'id' => $order->id,\n                'status' => $order->status,\n            ],\n        ];\n\n        // Add context-specific information\n        switch ($code) {\n            case 'TIME_LIMIT_EXCEEDED':\n                $response['context'] = [\n                    'order_created_at' => $order->created_at->toIso8601String(),\n                    'hours_since_creation' => $order->created_at->diffInHours(now()),\n                ];\n                break;\n\n            case 'ORDER_SHIPPED':\n                $response['context'] = [\n                    'shipped_at' => $order->shipped_at?->toIso8601String(),\n                    'tracking_number' => $order->tracking_number,\n                ];\n                break;\n\n            case 'RATE_LIMIT_EXCEEDED':\n                $response['context'] = [\n                    'retry_after' => now()->addDay()->toIso8601String(),\n                ];\n                break;\n        }\n\n        return response()->json($response, $statusCode);\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"debugging-restrictions",children:"Debugging Restrictions"}),"\n",(0,s.jsx)(n.p,{children:"Debug restriction failures during development:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\Flow\\Facades\\FlowTransition;\nuse JobMetric\\Flow\\Exceptions\\TaskRestrictionException;\nuse Illuminate\\Support\\Facades\\Log;\n\ntry {\n    $result = FlowTransition::runner('cancel_order', $order, $payload, $user);\n} catch (TaskRestrictionException $e) {\n    // Debug information\n    Log::debug('Restriction failure', [\n        'code' => $e->getCode(),\n        'message' => $e->getMessage(),\n        'order_id' => $order->id,\n        'order_status' => $order->status,\n        'user_id' => $user?->id,\n        'payload' => $payload,\n        'stack_trace' => $e->getTraceAsString(),\n    ]);\n\n    // In development, show detailed error\n    if (app()->environment('local')) {\n        return response()->json([\n            'error' => $e->getCode(),\n            'message' => $e->getMessage(),\n            'debug' => [\n                'order' => $order->toArray(),\n                'user' => $user?->toArray(),\n                'payload' => $payload,\n            ],\n        ], 403);\n    }\n\n    throw $e;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"best-practices-for-restriction-codes",children:"Best Practices for Restriction Codes"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"1. Use Consistent Naming:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// \u2705 Good: Clear, descriptive codes\n'PERMISSION_DENIED'\n'ORDER_SHIPPED'\n'TIME_LIMIT_EXCEEDED'\n'RATE_LIMIT_EXCEEDED'\n\n// \u274c Bad: Vague codes\n'ERROR'\n'FAILED'\n'NOT_ALLOWED'\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"2. Group Related Codes:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// Permission-related\n'PERMISSION_DENIED'\n'INSUFFICIENT_ROLE'\n'OWNERSHIP_MISMATCH'\n\n// Status-related\n'ORDER_SHIPPED'\n'ORDER_DELIVERED'\n'ORDER_CANCELLED'\n\n// Time-related\n'TIME_LIMIT_EXCEEDED'\n'OUTSIDE_BUSINESS_HOURS'\n'DATE_BLOCKED'\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"3. Provide Actionable Messages:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// \u2705 Good: Tells user what to do\nRestrictionResult::deny(\n    'TIME_LIMIT_EXCEEDED',\n    'Orders can only be cancelled within 24 hours. Please contact support for assistance.'\n);\n\n// \u274c Bad: Doesn't help user\nRestrictionResult::deny(\n    'TIME_LIMIT_EXCEEDED',\n    'Time limit exceeded'\n);\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"4. Use Codes for Programmatic Handling:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// Frontend can handle specific codes\nif (error.code === 'RATE_LIMIT_EXCEEDED') {\n    showRetryAfterMessage(error.retry_after);\n} else if (error.code === 'PERMISSION_DENIED') {\n    showContactSupportButton();\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/packages/laravel-flow/deep-diving/support/flow-task-context",children:"FlowTaskContext"})," - Task execution context"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/packages/laravel-flow/deep-diving/transition-result",children:"TransitionResult"})," - Transition result DTO"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/packages/laravel-flow/deep-diving/services/flow-transition",children:"FlowTransition Service"})," - Transition execution"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/packages/laravel-flow/deep-diving/services/flow-task",children:"FlowTask Service"})," - Task management"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/packages/laravel-flow/deep-diving/make-task",children:"MakeTask Command"})," - Generating task drivers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/packages/laravel-flow/deep-diving/support/flow-task-registry",children:"FlowTaskRegistry"})," - Task driver registry"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);