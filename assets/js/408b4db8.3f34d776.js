"use strict";(globalThis.webpackChunkjobmetric_document=globalThis.webpackChunkjobmetric_document||[]).push([[2019],{8453(n,e,i){i.d(e,{R:()=>o,x:()=>a});var s=i(6540);const t={},r=s.createContext(t);function o(n){const e=s.useContext(r);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:o(n.components),s.createElement(r.Provider,{value:e},n.children)}},8642(n,e,i){i.r(e),i.d(e,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"laravel-flow/deep-diving/services/flow-transition","title":"FlowTransition Service","description":"The FlowTransition service provides CRUD operations for managing transitions between workflow states and executing transitions. Transitions define how work moves from one state to another in your workflow.","source":"@site/packages/laravel-flow/deep-diving/services/flow-transition.md","sourceDirName":"laravel-flow/deep-diving/services","slug":"/laravel-flow/deep-diving/services/flow-transition","permalink":"/packages/laravel-flow/deep-diving/services/flow-transition","draft":false,"unlisted":false,"editUrl":"https://github.com/jobmetric/document/blob/master/packages/laravel-flow/deep-diving/services/flow-transition.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"sidebar_label":"FlowTransition"},"sidebar":"packagesSidebar","previous":{"title":"FlowTask","permalink":"/packages/laravel-flow/deep-diving/services/flow-task"},"next":{"title":"MakeTask Command","permalink":"/packages/laravel-flow/deep-diving/make-task"}}');var t=i(4848),r=i(8453);const o={sidebar_position:4,sidebar_label:"FlowTransition"},a="FlowTransition Service",l={},d=[{value:"Namespace",id:"namespace",level:2},{value:"Facade",id:"facade",level:2},{value:"Transition Types",id:"transition-types",level:2},{value:"Basic CRUD Operations",id:"basic-crud-operations",level:2},{value:"Store",id:"store",level:3},{value:"Show",id:"show",level:3},{value:"Update",id:"update",level:3},{value:"Delete",id:"delete",level:3},{value:"Executing Transitions",id:"executing-transitions",level:2},{value:"Runner",id:"runner",level:3},{value:"Complete Example",id:"complete-example",level:2},{value:"Transition Execution Errors",id:"transition-execution-errors",level:2},{value:"Direct Service Usage",id:"direct-service-usage",level:2},{value:"Response Format",id:"response-format",level:2}];function c(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"flowtransition-service",children:"FlowTransition Service"})}),"\n",(0,t.jsx)(e.p,{children:"The FlowTransition service provides CRUD operations for managing transitions between workflow states and executing transitions. Transitions define how work moves from one state to another in your workflow."}),"\n",(0,t.jsx)(e.h2,{id:"namespace",children:"Namespace"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"JobMetric\\Flow\\Services\\FlowTransition\n"})}),"\n",(0,t.jsx)(e.h2,{id:"facade",children:"Facade"}),"\n",(0,t.jsx)(e.p,{children:"For convenience, you can use the FlowTransition Facade:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"use JobMetric\\Flow\\Facades\\FlowTransition;\n"})}),"\n",(0,t.jsx)(e.h2,{id:"transition-types",children:"Transition Types"}),"\n",(0,t.jsx)(e.p,{children:"Transitions can be categorized into different types:"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Specific Transition"}),": Both ",(0,t.jsx)(e.code,{children:"from"})," and ",(0,t.jsx)(e.code,{children:"to"})," states are set (normal transition between two states)"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Self-Loop Transition"}),": ",(0,t.jsx)(e.code,{children:"from"})," and ",(0,t.jsx)(e.code,{children:"to"})," are the same state (transition that returns to the same state)"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Generic Input Transition"}),": ",(0,t.jsx)(e.code,{children:"from"})," is ",(0,t.jsx)(e.code,{children:"null"})," (can enter a state from anywhere)"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Generic Output Transition"}),": ",(0,t.jsx)(e.code,{children:"to"})," is ",(0,t.jsx)(e.code,{children:"null"})," (can exit a state to anywhere)"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"basic-crud-operations",children:"Basic CRUD Operations"}),"\n",(0,t.jsx)(e.h3,{id:"store",children:"Store"}),"\n",(0,t.jsx)(e.p,{children:"Create a new transition between states."}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"use JobMetric\\Flow\\Facades\\FlowTransition;\n\n// Specific transition (from one state to another)\n$transition = FlowTransition::store($flowId, [\n    'from' => $pendingStateId,\n    'to' => $processingStateId,\n    'slug' => 'start_processing',\n]);\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Parameters:"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"$flowId"})," (int): The ID of the flow"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"$data"})," (array): Transition configuration"]}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Transition Configuration:"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"from"})," (int|null): Source state ID. Set to ",(0,t.jsx)(e.code,{children:"null"})," for generic input transitions"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"to"})," (int|null): Destination state ID. Set to ",(0,t.jsx)(e.code,{children:"null"})," for generic output transitions"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"slug"})," (string|null): Optional unique identifier for the transition within the flow"]}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Examples:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"// Specific transition: from Pending to Processing\n$transition = FlowTransition::store($flowId, [\n    'from' => $pendingStateId,\n    'to' => $processingStateId,\n    'slug' => 'approve_order',\n]);\n\n// Self-loop transition: from Processing back to Processing\n$transition = FlowTransition::store($flowId, [\n    'from' => $processingStateId,\n    'to' => $processingStateId,\n    'slug' => 'retry_processing',\n]);\n\n// Generic input transition: can enter Processing from anywhere\n$transition = FlowTransition::store($flowId, [\n    'from' => null,\n    'to' => $processingStateId,\n    'slug' => 'force_to_processing',\n]);\n\n// Generic output transition: can exit Processing to anywhere\n$transition = FlowTransition::store($flowId, [\n    'from' => $processingStateId,\n    'to' => null,\n    'slug' => 'exit_processing',\n]);\n"})}),"\n",(0,t.jsx)(e.h3,{id:"show",children:"Show"}),"\n",(0,t.jsx)(e.p,{children:"Retrieve a specific transition by ID."}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"$transition = FlowTransition::show($transitionId);\n\n// With relations\n$transition = FlowTransition::show($transitionId, ['fromState', 'toState', 'tasks']);\n"})}),"\n",(0,t.jsx)(e.h3,{id:"update",children:"Update"}),"\n",(0,t.jsx)(e.p,{children:"Update an existing transition."}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"$transition = FlowTransition::update($transitionId, [\n    'slug' => 'updated_slug',\n    'to' => $newStateId,\n]);\n"})}),"\n",(0,t.jsx)(e.h3,{id:"delete",children:"Delete"}),"\n",(0,t.jsxs)(e.p,{children:["Delete a transition. ",(0,t.jsx)(e.strong,{children:"Note:"})," The last transition from a START state cannot be deleted."]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"$transition = FlowTransition::delete($transitionId);\n"})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Important:"})," Attempting to delete the last transition from a START state will result in an error:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"try {\n    FlowTransition::delete($lastStartTransitionId);\n} catch (\\RuntimeException $e) {\n    // Cannot delete the last transition from START state\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"executing-transitions",children:"Executing Transitions"}),"\n",(0,t.jsx)(e.h3,{id:"runner",children:"Runner"}),"\n",(0,t.jsx)(e.p,{children:"Execute a transition by its ID or slug. This method runs all associated tasks (restriction, validation, and action) in the correct order and updates the model status."}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"use JobMetric\\Flow\\Facades\\FlowTransition;\nuse App\\Models\\Order;\n\n$order = Order::find(1);\n\n// Execute by transition ID\n$result = FlowTransition::runner($transitionId, $order);\n\n// Execute by slug\n$result = FlowTransition::runner('start_processing', $order);\n\n// With payload data\n$result = FlowTransition::runner($transitionId, $order, [\n    'reason' => 'Payment received',\n    'amount' => 100.00,\n]);\n\n// With user context\n$result = FlowTransition::runner($transitionId, $order, [], auth()->user());\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Parameters:"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"$key"})," (int|string): Transition ID or slug"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"$subject"})," (Model|null): The subject model instance. If ",(0,t.jsx)(e.code,{children:"null"}),", will be resolved from FlowInstance"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"$payload"})," (array): Optional data payload for validation tasks"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"$user"})," (Authenticatable|null): Optional user context for the transition"]}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Return Value:"})}),"\n",(0,t.jsxs)(e.p,{children:["Returns a ",(0,t.jsx)(e.code,{children:"TransitionResult"})," object:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"$result = FlowTransition::runner($transitionId, $order);\n\nif ($result->isSuccess()) {\n    $messages = $result->getMessages();\n    $data = $result->getData();\n} else {\n    $errors = $result->getErrors();\n    $code = $result->getCode();\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Execution Flow:"})}),"\n",(0,t.jsx)(e.p,{children:"When a transition is executed, tasks run in the following order:"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Restriction Tasks"}),": Check if the transition is allowed"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["If any restriction fails, a ",(0,t.jsx)(e.code,{children:"TaskRestrictionException"})," is thrown"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Validation Tasks"}),": Validate the payload data"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["If validation fails, a ",(0,t.jsx)(e.code,{children:"ValidationException"})," is thrown"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Action Tasks"}),": Execute actions (notifications, updates, etc.)"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"These run after restrictions and validations pass"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Update Model Status"}),": Update the subject model's status field to match the ",(0,t.jsx)(e.code,{children:"toState"})," status"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Create/Update FlowInstance"}),": Record the transition execution"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Related Transitions:"})}),"\n",(0,t.jsx)(e.p,{children:"For specific transitions (not self-loop or generic), the system also executes related transitions in order:"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsxs)(e.li,{children:["Generic output transitions (from the ",(0,t.jsx)(e.code,{children:"fromState"})," with ",(0,t.jsx)(e.code,{children:"to = null"}),")"]}),"\n",(0,t.jsx)(e.li,{children:"The specific transition itself"}),"\n",(0,t.jsxs)(e.li,{children:["Generic input transitions (to the ",(0,t.jsx)(e.code,{children:"fromState"})," with ",(0,t.jsx)(e.code,{children:"from = null"}),")"]}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"This allows for complex workflow scenarios where multiple transitions can be triggered simultaneously."}),"\n",(0,t.jsx)(e.h2,{id:"complete-example",children:"Complete Example"}),"\n",(0,t.jsx)(e.p,{children:"Here's a complete example of creating a workflow with transitions:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"use JobMetric\\Flow\\Facades\\Flow;\nuse JobMetric\\Flow\\Facades\\FlowState;\nuse JobMetric\\Flow\\Facades\\FlowTransition;\nuse JobMetric\\Flow\\Facades\\FlowTask;\nuse App\\Models\\Order;\n\n// Create the flow\n$flow = Flow::store([\n    'subject_type' => Order::class,\n    'version' => 1,\n])->getData();\n\n$flowId = $flow->id;\n\n// Get the automatically created START state\n$startState = Flow::getStartState($flowId);\n\n// Create states\n$pendingState = FlowState::store($flowId, [\n    'translation' => [\n        'en' => ['name' => 'Pending', 'description' => 'Order is pending'],\n    ],\n    'status' => 'pending',\n]);\n\n$processingState = FlowState::store($flowId, [\n    'translation' => [\n        'en' => ['name' => 'Processing', 'description' => 'Order is being processed'],\n    ],\n    'status' => 'processing',\n]);\n\n$shippedState = FlowState::store($flowId, [\n    'translation' => [\n        'en' => ['name' => 'Shipped', 'description' => 'Order has been shipped'],\n    ],\n    'status' => 'shipped',\n]);\n\n$deliveredState = FlowState::store($flowId, [\n    'translation' => [\n        'en' => ['name' => 'Delivered', 'description' => 'Order has been delivered'],\n    ],\n    'status' => 'delivered',\n    'is_terminal' => true,\n]);\n\n// Create transitions\n$transition1 = FlowTransition::store($flowId, [\n    'from' => $startState->id,\n    'to' => $pendingState->id,\n    'slug' => 'create_order',\n]);\n\n$transition2 = FlowTransition::store($flowId, [\n    'from' => $pendingState->id,\n    'to' => $processingState->id,\n    'slug' => 'start_processing',\n]);\n\n$transition3 = FlowTransition::store($flowId, [\n    'from' => $processingState->id,\n    'to' => $shippedState->id,\n    'slug' => 'ship_order',\n]);\n\n$transition4 = FlowTransition::store($flowId, [\n    'from' => $shippedState->id,\n    'to' => $deliveredState->id,\n    'slug' => 'deliver_order',\n]);\n\n// Add tasks to transitions\nFlowTask::store($flowId, $transition2->id, [\n    'driver' => 'App\\Flows\\Tasks\\CheckPermission',\n    'config' => ['permission' => 'process-orders'],\n    'ordering' => 1,\n    'status' => true,\n]);\n\nFlowTask::store($flowId, $transition2->id, [\n    'driver' => 'App\\Flows\\Tasks\\SendEmailNotification',\n    'config' => [\n        'to' => 'customer@example.com',\n        'subject' => 'Your order is being processed',\n    ],\n    'ordering' => 2,\n    'status' => true,\n]);\n\n// Execute a transition\n$order = Order::create([...]);\n\n$result = FlowTransition::runner('start_processing', $order, [\n    'processor_id' => auth()->id(),\n]);\n\nif ($result->isSuccess()) {\n    // Transition executed successfully\n    // Order status is now 'processing'\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"transition-execution-errors",children:"Transition Execution Errors"}),"\n",(0,t.jsx)(e.p,{children:"The runner method can throw several exceptions:"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"TaskRestrictionException:"})}),"\n",(0,t.jsx)(e.p,{children:"Thrown when a restriction task denies the transition:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"try {\n    FlowTransition::runner($transitionId, $order);\n} catch (\\JobMetric\\Flow\\Exceptions\\TaskRestrictionException $e) {\n    // Transition was denied by a restriction task\n    $message = $e->getMessage();\n    $code = $e->getCode();\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"ValidationException:"})}),"\n",(0,t.jsx)(e.p,{children:"Thrown when validation tasks fail:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"try {\n    FlowTransition::runner($transitionId, $order, [\n        'amount' => -100, // Invalid amount\n    ]);\n} catch (\\Illuminate\\Validation\\ValidationException $e) {\n    $errors = $e->errors();\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"LogicException:"})}),"\n",(0,t.jsx)(e.p,{children:"Thrown when the subject model is required but not provided, or when subject type doesn't match:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"try {\n    FlowTransition::runner($transitionId, null);\n} catch (\\LogicException $e) {\n    // Subject model is required\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"direct-service-usage",children:"Direct Service Usage"}),"\n",(0,t.jsx)(e.p,{children:"If you prefer dependency injection over the Facade:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"use JobMetric\\Flow\\Services\\FlowTransition as FlowTransitionService;\n\nclass YourController\n{\n    public function __construct(\n        protected FlowTransitionService $flowTransitionService\n    ) {}\n\n    public function execute($transitionId, Order $order)\n    {\n        $result = $this->flowTransitionService->runner($transitionId, $order);\n    }\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"response-format",children:"Response Format"}),"\n",(0,t.jsxs)(e.p,{children:["The service methods return the FlowTransition model directly (except ",(0,t.jsx)(e.code,{children:"runner"})," which returns ",(0,t.jsx)(e.code,{children:"TransitionResult"}),"):"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"$transition = FlowTransition::store($flowId, [...]);\n\n// Access transition properties\n$transitionId = $transition->id;\n$fromStateId = $transition->from;\n$toStateId = $transition->to;\n$slug = $transition->slug;\n"})})]})}function h(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(c,{...n})}):c(n)}}}]);