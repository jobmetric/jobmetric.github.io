"use strict";(globalThis.webpackChunkjobmetric_document=globalThis.webpackChunkjobmetric_document||[]).push([[7982],{5856(e,n,t){t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"laravel-unit-converter/deep-diving/events/unit-delete-event","title":"UnitDeleteEvent","description":"Dispatched after a unit has been successfully deleted from the database.","source":"@site/packages/laravel-unit-converter/deep-diving/events/unit-delete-event.md","sourceDirName":"laravel-unit-converter/deep-diving/events","slug":"/laravel-unit-converter/deep-diving/events/unit-delete-event","permalink":"/packages/laravel-unit-converter/deep-diving/events/unit-delete-event","draft":false,"unlisted":false,"editUrl":"https://github.com/jobmetric/document/blob/master/packages/laravel-unit-converter/deep-diving/events/unit-delete-event.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"sidebar_label":"UnitDeleteEvent"},"sidebar":"packagesSidebar","previous":{"title":"UnitUpdateEvent","permalink":"/packages/laravel-unit-converter/deep-diving/events/unit-update-event"},"next":{"title":"UnitNotFoundException","permalink":"/packages/laravel-unit-converter/deep-diving/exceptions/unit-not-found"}}');var s=t(74848),l=t(28453);const a={sidebar_position:3,sidebar_label:"UnitDeleteEvent"},r="UnitDeleteEvent",d={},c=[{value:"Namespace",id:"namespace",level:2},{value:"Event Key",id:"event-key",level:2},{value:"Class Definition",id:"class-definition",level:2},{value:"Properties",id:"properties",level:2},{value:"When Is It Dispatched?",id:"when-is-it-dispatched",level:2},{value:"Accessing Event Data",id:"accessing-event-data",level:2},{value:"Registering Listeners",id:"registering-listeners",level:2},{value:"Using EventServiceProvider",id:"using-eventserviceprovider",level:3},{value:"Using Closure",id:"using-closure",level:3},{value:"Example Listeners",id:"example-listeners",level:2},{value:"Audit Logging",id:"audit-logging",level:3},{value:"Cache Cleanup",id:"cache-cleanup",level:3},{value:"External System Sync",id:"external-system-sync",level:3},{value:"Soft Delete Archive",id:"soft-delete-archive",level:3},{value:"Notify Affected Users",id:"notify-affected-users",level:3},{value:"Cleanup Related Data",id:"cleanup-related-data",level:3},{value:"Queued Listeners",id:"queued-listeners",level:2},{value:"Event Definition",id:"event-definition",level:2},{value:"Important Notes",id:"important-notes",level:2},{value:"Unit No Longer Exists",id:"unit-no-longer-exists",level:3},{value:"Order of Operations",id:"order-of-operations",level:3},{value:"Transaction Considerations",id:"transaction-considerations",level:3},{value:"Related Events",id:"related-events",level:2}];function o(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"unitdeleteevent",children:"UnitDeleteEvent"})}),"\n",(0,s.jsx)(n.p,{children:"Dispatched after a unit has been successfully deleted from the database."}),"\n",(0,s.jsx)(n.h2,{id:"namespace",children:"Namespace"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"JobMetric\\UnitConverter\\Events\\UnitDeleteEvent\n"})}),"\n",(0,s.jsx)(n.h2,{id:"event-key",children:"Event Key"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"unit.deleted\n"})}),"\n",(0,s.jsx)(n.h2,{id:"class-definition",children:"Class Definition"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"readonly class UnitDeleteEvent implements DomainEvent\n{\n    public function __construct(\n        public Unit $unit\n    ) {\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"properties",children:"Properties"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Property"}),(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"$unit"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Unit"})}),(0,s.jsx)(n.td,{children:"The Unit model instance that was deleted"})]})})]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"$unit"})," property contains the unit data ",(0,s.jsx)(n.strong,{children:"before deletion"}),". After the event is dispatched, the record no longer exists in the database, but you still have access to all its properties through this object."]})}),"\n",(0,s.jsx)(n.h2,{id:"when-is-it-dispatched",children:"When Is It Dispatched?"}),"\n",(0,s.jsxs)(n.p,{children:["This event is dispatched by the ",(0,s.jsx)(n.code,{children:"UnitConverter::destroy()"})," method after:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Validation checks have passed (unit not in use, not base unit with siblings)"}),"\n",(0,s.jsx)(n.li,{children:"The unit's translations have been deleted"}),"\n",(0,s.jsx)(n.li,{children:"The unit record has been deleted from the database"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\UnitConverter\\Facades\\UnitConverter;\n\n$response = UnitConverter::destroy($unitId);\n\n// UnitDeleteEvent is dispatched here with:\n// - $unit: The deleted Unit model (data preserved in memory)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"accessing-event-data",children:"Accessing Event Data"}),"\n",(0,s.jsx)(n.p,{children:"In your listener, you can access the deleted unit's data:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\UnitConverter\\Events\\UnitDeleteEvent;\n\nclass HandleUnitDeletion\n{\n    public function handle(UnitDeleteEvent $event): void\n    {\n        // Access the deleted unit data\n        $unit = $event->unit;\n        \n        echo $unit->id;        // e.g., 5\n        echo $unit->type;      // e.g., 'weight'\n        echo $unit->value;     // e.g., 1000\n        echo $unit->status;    // e.g., true\n        \n        // Note: The unit no longer exists in DB at this point\n        // Unit::find($unit->id) would return null\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"registering-listeners",children:"Registering Listeners"}),"\n",(0,s.jsx)(n.h3,{id:"using-eventserviceprovider",children:"Using EventServiceProvider"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// app/Providers/EventServiceProvider.php\n\nuse JobMetric\\UnitConverter\\Events\\UnitDeleteEvent;\nuse App\\Listeners\\LogUnitDeletion;\nuse App\\Listeners\\CleanupAfterUnitDelete;\nuse App\\Listeners\\NotifyUnitDeleted;\n\nprotected $listen = [\n    UnitDeleteEvent::class => [\n        LogUnitDeletion::class,\n        CleanupAfterUnitDelete::class,\n        NotifyUnitDeleted::class,\n    ],\n];\n"})}),"\n",(0,s.jsx)(n.h3,{id:"using-closure",children:"Using Closure"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:'use Illuminate\\Support\\Facades\\Event;\nuse JobMetric\\UnitConverter\\Events\\UnitDeleteEvent;\n\nEvent::listen(UnitDeleteEvent::class, function (UnitDeleteEvent $event) {\n    \\Log::warning("Unit deleted: {$event->unit->id} ({$event->unit->type})");\n});\n'})}),"\n",(0,s.jsx)(n.h2,{id:"example-listeners",children:"Example Listeners"}),"\n",(0,s.jsx)(n.h3,{id:"audit-logging",children:"Audit Logging"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners;\n\nuse App\\Models\\AuditLog;\nuse JobMetric\\UnitConverter\\Events\\UnitDeleteEvent;\n\nclass LogUnitDeletion\n{\n    public function handle(UnitDeleteEvent $event): void\n    {\n        $unit = $event->unit;\n        \n        AuditLog::create([\n            'action' => 'unit.deleted',\n            'model_type' => 'Unit',\n            'model_id' => $unit->id,\n            'user_id' => auth()->id(),\n            'data' => [\n                'deleted_unit' => [\n                    'id' => $unit->id,\n                    'type' => $unit->type,\n                    'value' => $unit->value,\n                    'status' => $unit->status,\n                    'created_at' => $unit->created_at?->toIso8601String(),\n                ],\n            ],\n            'ip_address' => request()->ip(),\n        ]);\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"cache-cleanup",children:"Cache Cleanup"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners;\n\nuse Illuminate\\Support\\Facades\\Cache;\nuse JobMetric\\UnitConverter\\Events\\UnitDeleteEvent;\n\nclass CleanupUnitCache\n{\n    public function handle(UnitDeleteEvent $event): void\n    {\n        $unit = $event->unit;\n        \n        // Clear specific unit cache\n        Cache::forget(\"unit:{$unit->id}\");\n        \n        // Clear type-specific cache\n        Cache::forget(\"units:type:{$unit->type}\");\n        \n        // Clear all units cache\n        Cache::forget('units:all');\n        Cache::forget('units:count');\n        \n        // Clear conversion caches for this type\n        Cache::tags(['conversions', $unit->type])->flush();\n        \n        // Clear any unit-by-code cache\n        Cache::forget(\"unit:code:{$unit->code}\");\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"external-system-sync",children:"External System Sync"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners;\n\nuse App\\Services\\ExternalApiService;\nuse JobMetric\\UnitConverter\\Events\\UnitDeleteEvent;\n\nclass SyncUnitDeletion\n{\n    public function __construct(\n        private ExternalApiService $api\n    ) {\n    }\n\n    public function handle(UnitDeleteEvent $event): void\n    {\n        // Notify external system about deletion\n        $this->api->deleteUnit($event->unit->id);\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"soft-delete-archive",children:"Soft Delete Archive"}),"\n",(0,s.jsx)(n.p,{children:"If you want to keep a record of deleted units:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners;\n\nuse App\\Models\\DeletedUnitArchive;\nuse JobMetric\\UnitConverter\\Events\\UnitDeleteEvent;\n\nclass ArchiveDeletedUnit\n{\n    public function handle(UnitDeleteEvent $event): void\n    {\n        $unit = $event->unit;\n        \n        DeletedUnitArchive::create([\n            'original_id' => $unit->id,\n            'type' => $unit->type,\n            'value' => $unit->value,\n            'status' => $unit->status,\n            'deleted_by' => auth()->id(),\n            'deleted_at' => now(),\n            'original_created_at' => $unit->created_at,\n            'original_updated_at' => $unit->updated_at,\n        ]);\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"notify-affected-users",children:"Notify Affected Users"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners;\n\nuse App\\Models\\User;\nuse App\\Notifications\\UnitDeletedNotification;\nuse Illuminate\\Support\\Facades\\Notification;\nuse JobMetric\\UnitConverter\\Events\\UnitDeleteEvent;\n\nclass NotifyAffectedUsers\n{\n    public function handle(UnitDeleteEvent $event): void\n    {\n        $unit = $event->unit;\n        \n        // Notify admins about unit deletion\n        $admins = User::role('admin')->get();\n        \n        Notification::send($admins, new UnitDeletedNotification(\n            unitId: $unit->id,\n            unitType: $unit->type,\n            unitValue: $unit->value,\n            deletedBy: auth()->user()\n        ));\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"cleanup-related-data",children:"Cleanup Related Data"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners;\n\nuse Illuminate\\Support\\Facades\\DB;\nuse JobMetric\\UnitConverter\\Events\\UnitDeleteEvent;\n\nclass CleanupRelatedData\n{\n    public function handle(UnitDeleteEvent $event): void\n    {\n        $unitId = $event->unit->id;\n        \n        // Note: unit_relations are usually cleaned up automatically\n        // But you might have other related data to clean\n        \n        // Clean up any custom caches or indexes\n        DB::table('unit_search_index')\n            ->where('unit_id', $unitId)\n            ->delete();\n        \n        // Clean up any rate history\n        DB::table('unit_rate_history')\n            ->where('unit_id', $unitId)\n            ->delete();\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"queued-listeners",children:"Queued Listeners"}),"\n",(0,s.jsx)(n.p,{children:"For non-critical cleanup operations:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners;\n\nuse Illuminate\\Contracts\\Queue\\ShouldQueue;\nuse JobMetric\\UnitConverter\\Events\\UnitDeleteEvent;\n\nclass SyncDeletionToDataWarehouse implements ShouldQueue\n{\n    public $queue = 'sync';\n    \n    public $delay = 5; // Wait 5 seconds\n\n    public function handle(UnitDeleteEvent $event): void\n    {\n        // Sync deletion to data warehouse\n        DataWarehouse::delete('units', $event->unit->id);\n    }\n    \n    public function failed(UnitDeleteEvent $event, \\Throwable $exception): void\n    {\n        \\Log::error(\"Failed to sync unit deletion to warehouse\", [\n            'unit_id' => $event->unit->id,\n            'error' => $exception->getMessage(),\n        ]);\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"event-definition",children:"Event Definition"}),"\n",(0,s.jsxs)(n.p,{children:["The event implements ",(0,s.jsx)(n.code,{children:"DomainEvent"})," interface:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"public static function definition(): DomainEventDefinition\n{\n    return new DomainEventDefinition(\n        key: 'unit.deleted',\n        entityName: 'unit-converter::base.entity_names.unit',\n        title: 'unit-converter::base.events.unit_deleted.title',\n        description: 'unit-converter::base.events.unit_deleted.description',\n        icon: 'fas fa-trash-alt',\n        tags: ['unit', 'storage', 'management']\n    );\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"important-notes",children:"Important Notes"}),"\n",(0,s.jsx)(n.h3,{id:"unit-no-longer-exists",children:"Unit No Longer Exists"}),"\n",(0,s.jsx)(n.p,{children:"After this event is dispatched, the unit record no longer exists in the database:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"public function handle(UnitDeleteEvent $event): void\n{\n    $unit = $event->unit;\n    \n    // This will return null\n    $fromDb = Unit::find($unit->id);\n    // $fromDb === null\n    \n    // But you can still access the data through the event\n    echo $unit->type; // Works fine\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"order-of-operations",children:"Order of Operations"}),"\n",(0,s.jsx)(n.p,{children:"The deletion happens in this order:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Pre-delete validations (not in use, not protected base unit)"}),"\n",(0,s.jsx)(n.li,{children:"Translations deleted"}),"\n",(0,s.jsx)(n.li,{children:"Unit record deleted"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"UnitDeleteEvent dispatched"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"transaction-considerations",children:"Transaction Considerations"}),"\n",(0,s.jsx)(n.p,{children:"The deletion and event dispatch happen within a database transaction. If your listener throws an exception, the deletion will be rolled back (unless you're using a queued listener)."}),"\n",(0,s.jsx)(n.h2,{id:"related-events",children:"Related Events"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./unit-store-event",children:"UnitStoreEvent"})," - Dispatched when a unit is created"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./unit-update-event",children:"UnitUpdateEvent"})," - Dispatched when a unit is updated"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},28453(e,n,t){t.d(n,{R:()=>a,x:()=>r});var i=t(96540);const s={},l=i.createContext(s);function a(e){const n=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);