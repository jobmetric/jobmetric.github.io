"use strict";(globalThis.webpackChunkjobmetric_document=globalThis.webpackChunkjobmetric_document||[]).push([[4796],{2495(e,n,l){l.r(n),l.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"laravel-flow/deep-diving/has-workflow","title":"HasWorkflow Trait","description":"The HasWorkflow trait binds an Eloquent model to a workflow flow, automatically selecting and binding the appropriate flow when a model is created. This trait provides a seamless way to integrate workflow management into your models.","source":"@site/packages/laravel-flow/deep-diving/has-workflow.md","sourceDirName":"laravel-flow/deep-diving","slug":"/laravel-flow/deep-diving/has-workflow","permalink":"/packages/laravel-flow/deep-diving/has-workflow","draft":false,"unlisted":false,"editUrl":"https://github.com/jobmetric/document/blob/master/packages/laravel-flow/deep-diving/has-workflow.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"sidebar_label":"HasWorkflow"},"sidebar":"packagesSidebar","previous":{"title":"HasFlow","permalink":"/packages/laravel-flow/deep-diving/has-flow"},"next":{"title":"Flow","permalink":"/packages/laravel-flow/deep-diving/services/flow"}}');var r=l(4848),s=l(8453);const o={sidebar_position:2,sidebar_label:"HasWorkflow"},t="HasWorkflow Trait",c={},d=[{value:"When to Use HasWorkflow",id:"when-to-use-hasworkflow",level:2},{value:"HasWorkflow vs HasFlow",id:"hasworkflow-vs-hasflow",level:2},{value:"Namespace",id:"namespace",level:2},{value:"Basic Usage",id:"basic-usage",level:2},{value:"Requirements",id:"requirements",level:2},{value:"Status Column",id:"status-column",level:3},{value:"Flow Configuration",id:"flow-configuration",level:3},{value:"Database Migration Example",id:"database-migration-example",level:3},{value:"Automatic Flow Binding",id:"automatic-flow-binding",level:2},{value:"Customizing Flow Selection",id:"customizing-flow-selection",level:2},{value:"Override buildFlowPicker",id:"override-buildflowpicker",level:3},{value:"FlowPickerBuilder Options",id:"flowpickerbuilder-options",level:3},{value:"Subject Scope",id:"subject-scope",level:4},{value:"Environment",id:"environment",level:4},{value:"Channel",id:"channel",level:4},{value:"Preferred Environments and Channels",id:"preferred-environments-and-channels",level:4},{value:"Rollout Configuration",id:"rollout-configuration",level:4},{value:"Fallback Cascade",id:"fallback-cascade",level:4},{value:"Active Window",id:"active-window",level:4},{value:"Custom Where Clauses",id:"custom-where-clauses",level:4},{value:"Version Constraints",id:"version-constraints",level:4},{value:"Flow ID Whitelist/Blacklist",id:"flow-id-whitelistblacklist",level:4},{value:"Custom Ordering",id:"custom-ordering",level:4},{value:"Match Strategy",id:"match-strategy",level:4},{value:"Require Default",id:"require-default",level:4},{value:"Request Caching",id:"request-caching",level:4},{value:"Subject Collection",id:"subject-collection",level:3},{value:"Working with Bound Flows",id:"working-with-bound-flows",level:2},{value:"Get Bound Flow",id:"get-bound-flow",level:3},{value:"Flow Use Relation",id:"flow-use-relation",level:3},{value:"Eager Loading",id:"eager-loading",level:3},{value:"Manual Flow Binding",id:"manual-flow-binding",level:2},{value:"Bind Flow",id:"bind-flow",level:3},{value:"Rebind Flow",id:"rebind-flow",level:3},{value:"Unbind Flow",id:"unbind-flow",level:3},{value:"Flow Picking",id:"flow-picking",level:2},{value:"Pick Flow",id:"pick-flow",level:3},{value:"Understanding makeFlowPicker()",id:"understanding-makeflowpicker",level:3},{value:"Preview Flow Selection",id:"preview-flow-selection",level:3},{value:"Status Management",id:"status-management",level:2},{value:"Current Status Value",id:"current-status-value",level:3},{value:"Status Enum Support",id:"status-enum-support",level:3},{value:"Custom Status Enum",id:"custom-status-enum",level:3},{value:"Enum Detection Priority",id:"enum-detection-priority",level:3},{value:"Getting Current Status",id:"getting-current-status",level:3},{value:"Advanced FlowPickerBuilder Examples",id:"advanced-flowpickerbuilder-examples",level:2},{value:"Multi-Tenant Application",id:"multi-tenant-application",level:3},{value:"A/B Testing with Rollout",id:"ab-testing-with-rollout",level:3},{value:"Environment-Specific Workflows",id:"environment-specific-workflows",level:3},{value:"Channel-Based Workflows",id:"channel-based-workflows",level:3},{value:"Collection-Based Workflows",id:"collection-based-workflows",level:3},{value:"Scheduled Workflows",id:"scheduled-workflows",level:3},{value:"Complex Multi-Criteria Selection",id:"complex-multi-criteria-selection",level:3},{value:"Complete Example",id:"complete-example",level:2},{value:"Real-World Scenarios",id:"real-world-scenarios",level:2},{value:"Scenario 1: Multi-Tenant SaaS Application",id:"scenario-1-multi-tenant-saas-application",level:3},{value:"Scenario 2: E-Commerce with A/B Testing",id:"scenario-2-e-commerce-with-ab-testing",level:3},{value:"Scenario 3: Content Management with Collections",id:"scenario-3-content-management-with-collections",level:3},{value:"Scenario 4: Scheduled Workflow Activation",id:"scenario-4-scheduled-workflow-activation",level:3},{value:"Scenario 5: Complex Multi-Criteria Selection",id:"scenario-5-complex-multi-criteria-selection",level:3},{value:"Lifecycle Events",id:"lifecycle-events",level:2},{value:"Creating Event",id:"creating-event",level:3},{value:"Created Event",id:"created-event",level:3},{value:"Understanding selectedFlowIdForBinding",id:"understanding-selectedflowidforbinding",level:3},{value:"Skipping Automatic Binding",id:"skipping-automatic-binding",level:3},{value:"Performance Optimization",id:"performance-optimization",level:2},{value:"Caching Flow Picker Results",id:"caching-flow-picker-results",level:3},{value:"Optimizing Flow Queries",id:"optimizing-flow-queries",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Testing and Debugging",id:"testing-and-debugging",level:2},{value:"Testing Flow Selection",id:"testing-flow-selection",level:3},{value:"Debugging Flow Picker Configuration",id:"debugging-flow-picker-configuration",level:3},{value:"Testing Rollout",id:"testing-rollout",level:3},{value:"Verifying Flow Binding",id:"verifying-flow-binding",level:3},{value:"Common Issues and Solutions",id:"common-issues-and-solutions",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Flow Not Binding",id:"flow-not-binding",level:3},{value:"Status Column Missing",id:"status-column-missing",level:3},{value:"Enum Not Detected",id:"enum-not-detected",level:3},{value:"Flow Picking Returns Null",id:"flow-picking-returns-null",level:3},{value:"Multiple Flows Match",id:"multiple-flows-match",level:3},{value:"Fallback Cascade Exhausted",id:"fallback-cascade-exhausted",level:3}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"hasworkflow-trait",children:"HasWorkflow Trait"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"HasWorkflow"})," trait binds an Eloquent model to a workflow flow, automatically selecting and binding the appropriate flow when a model is created. This trait provides a seamless way to integrate workflow management into your models."]}),"\n",(0,r.jsx)(n.h2,{id:"when-to-use-hasworkflow",children:"When to Use HasWorkflow"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Use ",(0,r.jsx)(n.code,{children:"HasWorkflow"})," when you need:"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Complex flow selection logic"}),": Multiple flows for the same model type based on different criteria"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Dynamic flow selection"}),": Flows selected based on subject scope, collection, environment, channel, or rollout percentage"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Multiple workflow variants"}),": Different workflows for the same model based on business rules"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Advanced features"}),": Active time windows, canary deployments, environment-specific flows"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Flexible configuration"}),": Need to customize flow picking based on runtime conditions"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example scenarios:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"E-commerce orders with different workflows for premium vs standard customers"}),"\n",(0,r.jsx)(n.li,{children:"Content approval workflows that vary by department or region"}),"\n",(0,r.jsx)(n.li,{children:"Multi-tenant applications where each tenant has different workflows"}),"\n",(0,r.jsx)(n.li,{children:"A/B testing workflows with rollout percentages"}),"\n",(0,r.jsx)(n.li,{children:"Environment-specific workflows (development, staging, production)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"hasworkflow-vs-hasflow",children:"HasWorkflow vs HasFlow"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Choose ",(0,r.jsx)(n.code,{children:"HasWorkflow"})," if:"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"You have multiple flows for the same model type"}),"\n",(0,r.jsx)(n.li,{children:"Flow selection depends on dynamic criteria (user, collection, environment, etc.)"}),"\n",(0,r.jsx)(n.li,{children:"You need advanced features like rollout percentages or active windows"}),"\n",(0,r.jsx)(n.li,{children:"Your workflow requirements are complex and may change over time"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Choose ",(0,r.jsx)(n.code,{children:"HasFlow"})," if:"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"You have a single, fixed flow per model type"}),"\n",(0,r.jsx)(n.li,{children:"Flow selection is simple and doesn't change"}),"\n",(0,r.jsx)(n.li,{children:"You prefer explicit flow ID assignment"}),"\n",(0,r.jsx)(n.li,{children:"Your project is straightforward with minimal workflow complexity"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["For most simple projects (90% of use cases), ",(0,r.jsx)(n.code,{children:"HasFlow"})," is recommended. For complex scenarios with multiple flows and dynamic selection, use ",(0,r.jsx)(n.code,{children:"HasWorkflow"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"namespace",children:"Namespace"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"JobMetric\\Flow\\HasWorkflow\n"})}),"\n",(0,r.jsx)(n.h2,{id:"basic-usage",children:"Basic Usage"}),"\n",(0,r.jsx)(n.p,{children:"To use the HasWorkflow trait, simply add it to your model:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"use Illuminate\\Database\\Eloquent\\Model;\nuse JobMetric\\Flow\\HasWorkflow;\n\nclass Order extends Model\n{\n    use HasWorkflow;\n\n    protected $fillable = [\n        'user_id',\n        'status',\n    ];\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,r.jsx)(n.h3,{id:"status-column",children:"Status Column"}),"\n",(0,r.jsxs)(n.p,{children:["Your model ",(0,r.jsx)(n.strong,{children:"must"})," have a ",(0,r.jsx)(n.code,{children:"status"})," column in the database table. The trait will automatically check for this column when the model is created."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Migration example\nSchema::create('orders', function (Blueprint $table) {\n    $table->id();\n    $table->string('status')->nullable();\n    // ... other columns\n});\n"})}),"\n",(0,r.jsxs)(n.p,{children:["If you need to use a different column name, override the ",(0,r.jsx)(n.code,{children:"flowStatusColumn()"})," method:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Order extends Model\n{\n    use HasWorkflow;\n\n    protected function flowStatusColumn(): string\n    {\n        return 'order_status'; // Custom column name\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"flow-configuration",children:"Flow Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["Make sure you have created flows with the correct ",(0,r.jsx)(n.code,{children:"subject_type"})," matching your model class. You can create multiple flows for different scenarios:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"use JobMetric\\Flow\\Facades\\Flow;\n\n// Production flow\n$prodFlow = Flow::store([\n    'subject_type' => Order::class,\n    'subject_scope' => null,\n    'subject_collection' => null,\n    'environment' => 'production',\n    'channel' => 'web',\n    'version' => 1,\n    'status' => true,\n    'is_default' => true,\n]);\n\n// Staging flow\n$stagingFlow = Flow::store([\n    'subject_type' => Order::class,\n    'subject_scope' => null,\n    'subject_collection' => null,\n    'environment' => 'staging',\n    'channel' => 'web',\n    'version' => 1,\n    'status' => true,\n    'is_default' => true,\n]);\n\n// Premium collection flow\n$premiumFlow = Flow::store([\n    'subject_type' => Order::class,\n    'subject_scope' => null,\n    'subject_collection' => 'premium',\n    'environment' => 'production',\n    'channel' => 'web',\n    'version' => 1,\n    'status' => true,\n    'is_default' => true,\n]);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"database-migration-example",children:"Database Migration Example"}),"\n",(0,r.jsxs)(n.p,{children:["Here's a complete migration example for a model using ",(0,r.jsx)(n.code,{children:"HasWorkflow"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"use Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('orders', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained();\n            $table->string('collection')->nullable(); // For subject_collection\n            $table->string('status')->nullable(); // Required for HasWorkflow\n            $table->decimal('total', 10, 2);\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('orders');\n    }\n};\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Required columns:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"status"}),": Required for workflow state management"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Optional columns:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"collection"}),": If you use ",(0,r.jsx)(n.code,{children:"flowSubjectCollection()"})]}),"\n",(0,r.jsx)(n.li,{children:"Any other columns your model needs"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"automatic-flow-binding",children:"Automatic Flow Binding"}),"\n",(0,r.jsxs)(n.p,{children:["When a model using ",(0,r.jsx)(n.code,{children:"HasWorkflow"})," is created, the trait automatically:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Picks the appropriate flow based on the model's configuration"}),"\n",(0,r.jsxs)(n.li,{children:["Binds the flow to the model via the ",(0,r.jsx)(n.code,{children:"flow_uses"})," table"]}),"\n",(0,r.jsx)(n.li,{children:"Sets the initial status if the flow has a START state"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order = Order::create([\n    'user_id' => 1,\n    'status' => null, // Will be set automatically if flow has START state\n]);\n\n// Flow is automatically bound\n$boundFlow = $order->boundFlow();\n"})}),"\n",(0,r.jsx)(n.h2,{id:"customizing-flow-selection",children:"Customizing Flow Selection"}),"\n",(0,r.jsx)(n.h3,{id:"override-buildflowpicker",children:"Override buildFlowPicker"}),"\n",(0,r.jsxs)(n.p,{children:["You can customize how flows are selected by overriding the ",(0,r.jsx)(n.code,{children:"buildFlowPicker()"})," method. This method receives a ",(0,r.jsx)(n.code,{children:"FlowPickerBuilder"})," instance that you can configure with various options:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"use JobMetric\\Flow\\Support\\FlowPickerBuilder;\n\nclass Order extends Model\n{\n    use HasWorkflow;\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        // Call parent to set defaults\n        parent::buildFlowPicker($builder);\n\n        // Customize the builder\n        $builder\n            ->subjectScope($this->user_id ? (string)$this->user_id : null)\n            ->environment('production')\n            ->channel('web')\n            ->preferEnvironments(['production', 'staging'])\n            ->preferChannels(['web', 'api'])\n            ->rolloutNamespace('order')\n            ->rolloutKeyResolver(function ($model) {\n                return (string)$model->getKey();\n            });\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"flowpickerbuilder-options",children:"FlowPickerBuilder Options"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"FlowPickerBuilder"})," provides extensive configuration options for flow selection:"]}),"\n",(0,r.jsx)(n.h4,{id:"subject-scope",children:"Subject Scope"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"subjectScope()"})," to partition flows by tenant, organization, or any logical grouping:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"protected function buildFlowPicker(FlowPickerBuilder $builder): void\n{\n    parent::buildFlowPicker($builder);\n\n    // Partition flows by user/tenant\n    $builder->subjectScope($this->user_id ? (string)$this->user_id : null);\n\n    // Or by organization\n    $builder->subjectScope($this->organization_id ? (string)$this->organization_id : null);\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Use case:"})," Multi-tenant applications where each tenant has different workflows."]}),"\n",(0,r.jsx)(n.h4,{id:"environment",children:"Environment"}),"\n",(0,r.jsx)(n.p,{children:"Filter flows by environment (production, staging, development):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$builder->environment(config('app.env'));\n\n// Or based on request\n$builder->environment(request()->header('X-Environment', 'production'));\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Use case:"})," Different workflows for different deployment environments."]}),"\n",(0,r.jsx)(n.h4,{id:"channel",children:"Channel"}),"\n",(0,r.jsx)(n.p,{children:"Filter flows by channel (web, api, mobile, etc.):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$builder->channel(request()->header('X-Channel', 'web'));\n\n// Or based on route\n$builder->channel(request()->is('api/*') ? 'api' : 'web');\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Use case:"})," Different workflows for web vs API requests."]}),"\n",(0,r.jsx)(n.h4,{id:"preferred-environments-and-channels",children:"Preferred Environments and Channels"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"preferEnvironments()"})," and ",(0,r.jsx)(n.code,{children:"preferChannels()"})," for ordering (not filtering). Earlier items rank higher:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$builder\n    ->preferEnvironments(['production', 'staging', 'development'])\n    ->preferChannels(['web', 'api', 'mobile']);\n"})}),"\n",(0,r.jsx)(n.p,{children:"This means if multiple flows match, the one with the preferred environment/channel will be selected first."}),"\n",(0,r.jsx)(n.h4,{id:"rollout-configuration",children:"Rollout Configuration"}),"\n",(0,r.jsx)(n.p,{children:"Configure rollout (canary deployment) for gradual feature rollouts:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$builder\n    ->evaluateRollout(true)\n    ->rolloutNamespace('order') // Isolate rollout buckets\n    ->rolloutSalt('v2') // Additional salt for stability\n    ->rolloutKeyResolver(function ($model) {\n        // Return a stable key (e.g., user_id, order_id)\n        return (string)$model->getKey();\n    });\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Rollout Namespace:"})," Isolates rollout buckets across different features/domains. This ensures that rollout percentages are independent for different features."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Rollout Salt:"})," Additional salt for hashing to further stabilize or segregate rollout buckets."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Rollout Key Resolver:"})," Returns a stable key (like user_id or order_id) that determines which bucket the model falls into. The same key will always fall into the same bucket."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Example:"})," If a flow has ",(0,r.jsx)(n.code,{children:"rollout_pct: 50"}),", only 50% of models (based on the rollout key) will be assigned to this flow."]}),"\n",(0,r.jsx)(n.h4,{id:"fallback-cascade",children:"Fallback Cascade"}),"\n",(0,r.jsx)(n.p,{children:"Define fallback steps to progressively relax constraints if no flow matches:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"use JobMetric\\Flow\\Support\\FlowPickerBuilder;\n\n$builder->fallbackCascade([\n    FlowPickerBuilder::FB_DROP_CHANNEL,        // Remove channel filter\n    FlowPickerBuilder::FB_DROP_ENVIRONMENT,    // Remove environment filter\n    FlowPickerBuilder::FB_IGNORE_TIMEWINDOW,   // Ignore active window\n    FlowPickerBuilder::FB_DISABLE_ROLLOUT,      // Disable rollout checks\n    FlowPickerBuilder::FB_DROP_REQUIRE_DEFAULT, // Don't require is_default\n]);\n"})}),"\n",(0,r.jsx)(n.p,{children:"The system will try each step in order until a flow is found."}),"\n",(0,r.jsx)(n.h4,{id:"active-window",children:"Active Window"}),"\n",(0,r.jsx)(n.p,{children:"Control time-based flow activation:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$builder\n    ->onlyActive(true)           // Require status=true and active window\n    ->ignoreTimeWindow(false)    // Enforce active_from/active_to\n    ->timeNow(Carbon::now('UTC')); // Reference time for evaluation\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Use case:"})," Schedule workflows to activate/deactivate at specific times."]}),"\n",(0,r.jsx)(n.h4,{id:"custom-where-clauses",children:"Custom Where Clauses"}),"\n",(0,r.jsx)(n.p,{children:"Add custom query constraints to filter flows:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"protected function buildFlowPicker(FlowPickerBuilder $builder): void\n{\n    parent::buildFlowPicker($builder);\n\n    $builder->where(function ($query, $model) {\n        // Filter flows based on model attributes\n        $query->where('custom_field', $model->some_attribute);\n        \n        // Or complex conditions\n        if ($model->is_premium) {\n            $query->where('is_premium_flow', true);\n        }\n    });\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Use case:"})," Custom business logic that doesn't fit standard criteria."]}),"\n",(0,r.jsx)(n.h4,{id:"version-constraints",children:"Version Constraints"}),"\n",(0,r.jsx)(n.p,{children:"Control which flow versions are eligible:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$builder\n    ->versionEquals(2)        // Exact version\n    // OR\n    ->versionMin(1)           // Minimum version\n    ->versionMax(3);          // Maximum version\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Use case:"})," Gradual migration between flow versions."]}),"\n",(0,r.jsx)(n.h4,{id:"flow-id-whitelistblacklist",children:"Flow ID Whitelist/Blacklist"}),"\n",(0,r.jsx)(n.p,{children:"Include or exclude specific flows:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$builder\n    ->includeFlowIds([1, 2, 3])  // Only these flows\n    ->excludeFlowIds([4, 5])     // Exclude these flows\n    ->preferFlowIds([1, 2]);     // Prefer these (for ordering)\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Use case:"})," Testing specific flows or excluding deprecated flows."]}),"\n",(0,r.jsx)(n.h4,{id:"custom-ordering",children:"Custom Ordering"}),"\n",(0,r.jsx)(n.p,{children:"Override default ordering:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$builder->orderBy(function ($query) {\n    $query->orderBy('priority', 'desc')\n          ->orderBy('created_at', 'asc');\n});\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Default ordering is: ",(0,r.jsx)(n.code,{children:"version DESC, is_default DESC, ordering DESC, id DESC"}),"."]}),"\n",(0,r.jsx)(n.h4,{id:"match-strategy",children:"Match Strategy"}),"\n",(0,r.jsx)(n.p,{children:"Control how flows are selected when multiple matches exist:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// STRATEGY_BEST: Returns the best candidate based on ordering rules (default)\n$builder->matchStrategy(FlowPickerBuilder::STRATEGY_BEST);\n\n// STRATEGY_FIRST: Returns the first matching record (minimal ordering)\n$builder->matchStrategy(FlowPickerBuilder::STRATEGY_FIRST);\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"STRATEGY_BEST"})," (default):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Applies full ordering (version, is_default, ordering, id)"}),"\n",(0,r.jsx)(n.li,{children:"Returns the highest-ranked flow"}),"\n",(0,r.jsx)(n.li,{children:"Best for production use"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"STRATEGY_FIRST"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Minimal ordering (just enough to get first match)"}),"\n",(0,r.jsx)(n.li,{children:"Faster but less predictable"}),"\n",(0,r.jsx)(n.li,{children:"Useful for testing or when order doesn't matter"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"require-default",children:"Require Default"}),"\n",(0,r.jsx)(n.p,{children:"Only select flows marked as default:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$builder->requireDefault(true);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This ensures only flows with ",(0,r.jsx)(n.code,{children:"is_default = true"})," are selected. Useful when you want to enforce a single default flow per scope."]}),"\n",(0,r.jsx)(n.h4,{id:"request-caching",children:"Request Caching"}),"\n",(0,r.jsx)(n.p,{children:"Enable per-request caching for better performance:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$builder->cacheInRequest(true);\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Warning:"})," Only enable if your builder doesn't use dynamic callbacks that depend on request state. If callbacks access ",(0,r.jsx)(n.code,{children:"$request"}),", ",(0,r.jsx)(n.code,{children:"auth()"}),", or other request-specific data, caching may return incorrect results."]}),"\n",(0,r.jsx)(n.h3,{id:"subject-collection",children:"Subject Collection"}),"\n",(0,r.jsx)(n.p,{children:"If your model has a collection field, you can use it for flow selection. Collections allow you to have different workflows for the same model type:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Order extends Model\n{\n    use HasWorkflow;\n\n    protected $fillable = [\n        'collection', // e.g., 'premium', 'standard', 'enterprise'\n        'status',\n    ];\n\n    protected function flowSubjectCollection(): ?string\n    {\n        return $this->getAttribute('collection');\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"How it works:"})}),"\n",(0,r.jsxs)(n.p,{children:["When you create flows, set the ",(0,r.jsx)(n.code,{children:"subject_collection"})," field:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Premium order flow\n$premiumFlow = Flow::store([\n    'subject_type' => Order::class,\n    'subject_collection' => 'premium',\n    'version' => 1,\n]);\n\n// Standard order flow\n$standardFlow = Flow::store([\n    'subject_type' => Order::class,\n    'subject_collection' => 'standard',\n    'version' => 1,\n]);\n"})}),"\n",(0,r.jsx)(n.p,{children:"When creating orders:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Premium order - gets premium flow\n$premiumOrder = Order::create([\n    'collection' => 'premium',\n    'user_id' => 1,\n]);\n\n// Standard order - gets standard flow\n$standardOrder = Order::create([\n    'collection' => 'standard',\n    'user_id' => 1,\n]);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Advanced Collection Scenarios:"})}),"\n",(0,r.jsx)(n.p,{children:"You can combine collections with other criteria:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"protected function buildFlowPicker(FlowPickerBuilder $builder): void\n{\n    parent::buildFlowPicker($builder);\n\n    $builder\n        ->subjectCollection($this->collection)\n        ->subjectScope((string)$this->tenant_id)\n        ->environment(config('app.env'));\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"This allows you to have:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Different flows per collection (premium vs standard)"}),"\n",(0,r.jsx)(n.li,{children:"Different flows per tenant"}),"\n",(0,r.jsx)(n.li,{children:"Different flows per environment"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"All combined for maximum flexibility."}),"\n",(0,r.jsx)(n.h2,{id:"working-with-bound-flows",children:"Working with Bound Flows"}),"\n",(0,r.jsx)(n.h3,{id:"get-bound-flow",children:"Get Bound Flow"}),"\n",(0,r.jsx)(n.p,{children:"Retrieve the currently bound flow for a model:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order = Order::find(1);\n\n// Get bound flow (lazy loading)\n$flow = $order->boundFlow();\n\n// Eager load for better performance\n$order = Order::withFlow()->find(1);\n$flow = $order->boundFlow();\n"})}),"\n",(0,r.jsx)(n.h3,{id:"flow-use-relation",children:"Flow Use Relation"}),"\n",(0,r.jsxs)(n.p,{children:["Access the ",(0,r.jsx)(n.code,{children:"FlowUse"})," relationship directly:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order = Order::find(1);\n\n// Get the FlowUse record\n$flowUse = $order->flowUse;\n\n// Access the flow through the relation\n$flow = $order->flowUse->flow;\n"})}),"\n",(0,r.jsx)(n.h3,{id:"eager-loading",children:"Eager Loading"}),"\n",(0,r.jsxs)(n.p,{children:["Use the ",(0,r.jsx)(n.code,{children:"withFlow()"})," scope to efficiently load flows. This prevents N+1 query problems:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Single model\n$order = Order::withFlow()->find(1);\n\n// Multiple models (prevents N+1 queries)\n$orders = Order::withFlow()->get();\n\n// In queries\n$orders = Order::withFlow()\n    ->where('status', 'pending')\n    ->get();\n\n// Combined with other relations\n$orders = Order::withFlow()\n    ->with('user', 'items')\n    ->get();\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["What ",(0,r.jsx)(n.code,{children:"withFlow()"})," does:"]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Internally, it does:\n$query->with(['flowUse.flow']);\n\n// This eager loads:\n// 1. FlowUse records (polymorphic relation)\n// 2. Flow models (through FlowUse)\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Performance Tip:"})}),"\n",(0,r.jsxs)(n.p,{children:["Always use ",(0,r.jsx)(n.code,{children:"withFlow()"})," when loading multiple models:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// \u274c Bad: N+1 queries\n$orders = Order::all();\nforeach ($orders as $order) {\n    $flow = $order->boundFlow(); // Query for each order\n}\n\n// \u2705 Good: Single query\n$orders = Order::withFlow()->get();\nforeach ($orders as $order) {\n    $flow = $order->boundFlow(); // Already loaded\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"manual-flow-binding",children:"Manual Flow Binding"}),"\n",(0,r.jsx)(n.h3,{id:"bind-flow",children:"Bind Flow"}),"\n",(0,r.jsx)(n.p,{children:"Manually bind a specific flow to a model:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"use JobMetric\\Flow\\Facades\\Flow;\n\n$order = Order::find(1);\n$flow = Flow::show($flowId)->getData();\n\n$order->bindFlow($flow);\n\n// With custom timestamp\n$order->bindFlow($flow, Carbon::now()->subDays(1));\n"})}),"\n",(0,r.jsx)(n.h3,{id:"rebind-flow",children:"Rebind Flow"}),"\n",(0,r.jsx)(n.p,{children:"Re-pick and rebind a flow (useful when flow configuration changes):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Rebind with default picker\n$flow = $order->rebindFlow();\n\n// Rebind with custom tuner\n$flow = $order->rebindFlow(function ($builder) {\n    $builder->environment('staging');\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"unbind-flow",children:"Unbind Flow"}),"\n",(0,r.jsx)(n.p,{children:"Remove the flow binding:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order->unbindFlow();\n"})}),"\n",(0,r.jsx)(n.h2,{id:"flow-picking",children:"Flow Picking"}),"\n",(0,r.jsx)(n.h3,{id:"pick-flow",children:"Pick Flow"}),"\n",(0,r.jsxs)(n.p,{children:["Manually pick a flow without binding it. This uses the configured ",(0,r.jsx)(n.code,{children:"buildFlowPicker()"})," logic:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order = Order::find(1);\n\n// Pick with default configuration (uses buildFlowPicker())\n$flow = $order->pickFlow();\n\n// The flow is not automatically bound\n// You can manually bind it if needed:\nif ($flow) {\n    $order->bindFlow($flow);\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"How it works:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Creates a new ",(0,r.jsx)(n.code,{children:"FlowPickerBuilder"})," instance"]}),"\n",(0,r.jsxs)(n.li,{children:["Calls ",(0,r.jsx)(n.code,{children:"buildFlowPicker()"})," to configure it"]}),"\n",(0,r.jsxs)(n.li,{children:["Uses ",(0,r.jsx)(n.code,{children:"FlowPicker"})," to select the best matching flow"]}),"\n",(0,r.jsxs)(n.li,{children:["Returns the selected Flow or ",(0,r.jsx)(n.code,{children:"null"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"understanding-makeflowpicker",children:"Understanding makeFlowPicker()"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"makeFlowPicker()"})," method creates and configures a ",(0,r.jsx)(n.code,{children:"FlowPickerBuilder"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Internal implementation\nprotected function makeFlowPicker(): FlowPickerBuilder\n{\n    $builder = new FlowPickerBuilder();\n    $this->buildFlowPicker($builder); // Your custom configuration\n    return $builder;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"You can use this in custom scenarios:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order = Order::find(1);\n\n// Get the configured builder\n$builder = $order->makeFlowPicker();\n\n// Modify it further\n$builder->environment('staging');\n\n// Use it with FlowPicker\n$flow = (new FlowPicker())->pick($order, $builder);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"preview-flow-selection",children:"Preview Flow Selection"}),"\n",(0,r.jsx)(n.p,{children:"Use the Flow service to preview which flow would be selected:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"use JobMetric\\Flow\\Facades\\Flow;\n\n$order = Order::find(1);\n\n// Preview without binding\n$flow = Flow::previewPick($order);\n\n// Preview with custom tuner\n$flow = Flow::previewPick($order, function ($builder) {\n    $builder->environment('staging');\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"status-management",children:"Status Management"}),"\n",(0,r.jsx)(n.h3,{id:"current-status-value",children:"Current Status Value"}),"\n",(0,r.jsx)(n.p,{children:"Get the current status as a scalar value (handles enum casting):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order = Order::find(1);\n\n// Returns the status value (works with enums too)\n$status = $order->flowCurrentStatusValue();\n// Returns: 'pending', 'processing', etc.\n"})}),"\n",(0,r.jsx)(n.h3,{id:"status-enum-support",children:"Status Enum Support"}),"\n",(0,r.jsx)(n.p,{children:"The trait automatically detects if your status column uses an enum:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"use App\\Enums\\OrderStatus;\n\nclass Order extends Model\n{\n    use HasWorkflow;\n\n    protected $casts = [\n        'status' => OrderStatus::class,\n    ];\n}\n\n// Get enum class\n$enumClass = $order->flowStatusEnumClass();\n// Returns: OrderStatus::class\n\n// Get enum values\n$values = $order->flowStatusEnumValues();\n// Returns: ['pending', 'processing', 'shipped', 'delivered']\n"})}),"\n",(0,r.jsx)(n.h3,{id:"custom-status-enum",children:"Custom Status Enum"}),"\n",(0,r.jsxs)(n.p,{children:["If you're using a custom enum with a ",(0,r.jsx)(n.code,{children:"values()"})," method:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"enum OrderStatus: string\n{\n    case PENDING = 'pending';\n    case PROCESSING = 'processing';\n    case SHIPPED = 'shipped';\n    case DELIVERED = 'delivered';\n\n    public static function values(): array\n    {\n        return array_column(self::cases(), 'value');\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"The trait will automatically use this method to get enum values."}),"\n",(0,r.jsx)(n.h3,{id:"enum-detection-priority",children:"Enum Detection Priority"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"flowStatusEnumValues()"})," method uses this priority:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Custom ",(0,r.jsx)(n.code,{children:"values()"})," method"]}),": If your enum defines ",(0,r.jsx)(n.code,{children:"static values()"}),", it's used first"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Backed Enum values"}),": If it's a ",(0,r.jsx)(n.code,{children:"BackedEnum"}),", returns scalar values from cases"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Pure Enum names"}),": Otherwise, returns case names"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Backed Enum\nenum OrderStatus: string\n{\n    case PENDING = 'pending';\n    case PROCESSING = 'processing';\n}\n\n$values = $order->flowStatusEnumValues();\n// Returns: ['pending', 'processing']\n\n// Pure Enum\nenum OrderStatus\n{\n    case PENDING;\n    case PROCESSING;\n}\n\n$values = $order->flowStatusEnumValues();\n// Returns: ['PENDING', 'PROCESSING']\n\n// Custom values() method (highest priority)\nenum OrderStatus: string\n{\n    case PENDING = 'pending';\n    case PROCESSING = 'processing';\n\n    public static function values(): array\n    {\n        return ['custom', 'values']; // This will be used\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"getting-current-status",children:"Getting Current Status"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"flowCurrentStatusValue()"})," method handles enum conversion:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order = Order::find(1);\n\n// If status is a Backed Enum\n$order->status = OrderStatus::PENDING; // OrderStatus enum\n$value = $order->flowCurrentStatusValue();\n// Returns: 'pending' (scalar value)\n\n// If status is a Pure Enum\n$order->status = OrderStatus::PENDING; // OrderStatus enum\n$value = $order->flowCurrentStatusValue();\n// Returns: 'PENDING' (case name)\n\n// If status is a string\n$order->status = 'pending';\n$value = $order->flowCurrentStatusValue();\n// Returns: 'pending' (raw value)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"advanced-flowpickerbuilder-examples",children:"Advanced FlowPickerBuilder Examples"}),"\n",(0,r.jsx)(n.h3,{id:"multi-tenant-application",children:"Multi-Tenant Application"}),"\n",(0,r.jsx)(n.p,{children:"For a multi-tenant application where each tenant has different workflows:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Order extends Model\n{\n    use HasWorkflow;\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $builder\n            ->subjectScope((string)$this->tenant_id) // Partition by tenant\n            ->environment(config('app.env'))\n            ->channel('web')\n            ->fallbackCascade([\n                FlowPickerBuilder::FB_DROP_CHANNEL,\n                FlowPickerBuilder::FB_DROP_ENVIRONMENT,\n            ]);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"ab-testing-with-rollout",children:"A/B Testing with Rollout"}),"\n",(0,r.jsx)(n.p,{children:"For gradual rollout of new workflows:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Order extends Model\n{\n    use HasWorkflow;\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $builder\n            ->environment('production')\n            ->channel('web')\n            ->evaluateRollout(true)\n            ->rolloutNamespace('order_v2') // Isolate from other features\n            ->rolloutSalt('2024') // Version salt\n            ->rolloutKeyResolver(function ($model) {\n                // Use user_id for consistent bucket assignment\n                return (string)$model->user_id;\n            })\n            ->fallbackCascade([\n                FlowPickerBuilder::FB_DISABLE_ROLLOUT, // Fallback to 100% if needed\n            ]);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"How Rollout Works:"})}),"\n",(0,r.jsx)(n.p,{children:"If you have two flows:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Flow A: ",(0,r.jsx)(n.code,{children:"rollout_pct: 50"})," (old workflow)"]}),"\n",(0,r.jsxs)(n.li,{children:["Flow B: ",(0,r.jsx)(n.code,{children:"rollout_pct: 50"})," (new workflow)"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The system will:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Hash the rollout key (user_id) with namespace and salt"}),"\n",(0,r.jsx)(n.li,{children:"Determine which bucket (0-100) the user falls into"}),"\n",(0,r.jsx)(n.li,{children:"Assign Flow A to users in bucket 0-50"}),"\n",(0,r.jsx)(n.li,{children:"Assign Flow B to users in bucket 51-100"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The same user will always get the same flow (consistent bucket assignment)."}),"\n",(0,r.jsx)(n.h3,{id:"environment-specific-workflows",children:"Environment-Specific Workflows"}),"\n",(0,r.jsx)(n.p,{children:"For different workflows per environment:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Order extends Model\n{\n    use HasWorkflow;\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $env = config('app.env');\n        \n        $builder\n            ->environment($env)\n            ->preferEnvironments(['production', 'staging', 'development'])\n            ->fallbackCascade([\n                FlowPickerBuilder::FB_DROP_ENVIRONMENT, // Fallback to any environment\n            ]);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"channel-based-workflows",children:"Channel-Based Workflows"}),"\n",(0,r.jsx)(n.p,{children:"For different workflows based on request channel:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Order extends Model\n{\n    use HasWorkflow;\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $channel = request()->is('api/*') ? 'api' : 'web';\n        \n        $builder\n            ->channel($channel)\n            ->preferChannels(['web', 'api', 'mobile'])\n            ->fallbackCascade([\n                FlowPickerBuilder::FB_DROP_CHANNEL, // Fallback to any channel\n            ]);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"collection-based-workflows",children:"Collection-Based Workflows"}),"\n",(0,r.jsx)(n.p,{children:"For different workflows based on model collection:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Order extends Model\n{\n    use HasWorkflow;\n\n    protected $fillable = [\n        'collection', // 'premium', 'standard', 'enterprise'\n        'status',\n    ];\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $builder\n            ->subjectCollection($this->collection)\n            ->environment(config('app.env'));\n    }\n\n    protected function flowSubjectCollection(): ?string\n    {\n        return $this->getAttribute('collection');\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"scheduled-workflows",children:"Scheduled Workflows"}),"\n",(0,r.jsx)(n.p,{children:"For workflows that activate/deactivate at specific times:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Order extends Model\n{\n    use HasWorkflow;\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $builder\n            ->onlyActive(true)\n            ->ignoreTimeWindow(false) // Enforce active_from/active_to\n            ->timeNow(Carbon::now('UTC'))\n            ->fallbackCascade([\n                FlowPickerBuilder::FB_IGNORE_TIMEWINDOW, // Fallback: ignore time window\n            ]);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"complex-multi-criteria-selection",children:"Complex Multi-Criteria Selection"}),"\n",(0,r.jsx)(n.p,{children:"Combining multiple criteria:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Order extends Model\n{\n    use HasWorkflow;\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $builder\n            ->subjectScope((string)$this->tenant_id)\n            ->subjectCollection($this->order_type) // 'premium', 'standard'\n            ->environment(config('app.env'))\n            ->channel(request()->header('X-Channel', 'web'))\n            ->preferEnvironments(['production', 'staging'])\n            ->preferChannels(['web', 'api'])\n            ->evaluateRollout(true)\n            ->rolloutNamespace('order')\n            ->rolloutKeyResolver(function ($model) {\n                return (string)$model->user_id;\n            })\n            ->fallbackCascade([\n                FlowPickerBuilder::FB_DROP_CHANNEL,\n                FlowPickerBuilder::FB_DROP_ENVIRONMENT,\n                FlowPickerBuilder::FB_IGNORE_TIMEWINDOW,\n                FlowPickerBuilder::FB_DISABLE_ROLLOUT,\n            ]);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"complete-example",children:"Complete Example"}),"\n",(0,r.jsx)(n.p,{children:"Here's a complete example of using HasWorkflow in a real-world scenario:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"use Illuminate\\Database\\Eloquent\\Model;\nuse JobMetric\\Flow\\HasWorkflow;\nuse JobMetric\\Flow\\Support\\FlowPickerBuilder;\nuse App\\Enums\\OrderStatus;\n\nclass Order extends Model\n{\n    use HasWorkflow;\n\n    protected $fillable = [\n        'user_id',\n        'collection',\n        'status',\n        'total',\n    ];\n\n    protected $casts = [\n        'status' => OrderStatus::class,\n        'total' => 'decimal:2',\n    ];\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $builder\n            ->subjectScope($this->user_id ? (string)$this->user_id : null)\n            ->subjectCollection($this->collection)\n            ->environment(config('app.env'))\n            ->channel(request()->header('X-Channel', 'web'))\n            ->rolloutNamespace('order')\n            ->rolloutKeyResolver(function ($model) {\n                return (string)$model->getKey();\n            });\n    }\n\n    protected function flowSubjectCollection(): ?string\n    {\n        return $this->getAttribute('collection');\n    }\n}\n\n// Usage\n$order = Order::create([\n    'user_id' => 1,\n    'collection' => 'premium',\n    'total' => 100.00,\n]);\n\n// Flow is automatically bound\n$flow = $order->boundFlow();\n\n// Get current status\n$status = $order->flowCurrentStatusValue();\n\n// Execute a transition\nuse JobMetric\\Flow\\Facades\\FlowTransition;\n\nFlowTransition::runner('start_processing', $order);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"real-world-scenarios",children:"Real-World Scenarios"}),"\n",(0,r.jsx)(n.h3,{id:"scenario-1-multi-tenant-saas-application",children:"Scenario 1: Multi-Tenant SaaS Application"}),"\n",(0,r.jsx)(n.p,{children:"Different workflows per tenant with environment-specific variants:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Document extends Model\n{\n    use HasWorkflow;\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $builder\n            ->subjectScope((string)$this->tenant_id) // Partition by tenant\n            ->environment(config('app.env'))\n            ->channel(request()->header('X-Channel', 'web'))\n            ->preferEnvironments(['production', 'staging', 'development'])\n            ->fallbackCascade([\n                FlowPickerBuilder::FB_DROP_CHANNEL,\n                FlowPickerBuilder::FB_DROP_ENVIRONMENT,\n            ]);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Flow setup:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Tenant 1, Production: Flow ID 1"}),"\n",(0,r.jsx)(n.li,{children:"Tenant 1, Staging: Flow ID 2"}),"\n",(0,r.jsx)(n.li,{children:"Tenant 2, Production: Flow ID 3"}),"\n",(0,r.jsx)(n.li,{children:"etc."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"scenario-2-e-commerce-with-ab-testing",children:"Scenario 2: E-Commerce with A/B Testing"}),"\n",(0,r.jsx)(n.p,{children:"Gradual rollout of new checkout workflow:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Checkout extends Model\n{\n    use HasWorkflow;\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $builder\n            ->environment('production')\n            ->channel('web')\n            ->evaluateRollout(true)\n            ->rolloutNamespace('checkout_v2')\n            ->rolloutSalt('2024-01')\n            ->rolloutKeyResolver(function ($model) {\n                // Use customer ID for consistent assignment\n                return (string)$model->customer_id;\n            })\n            ->fallbackCascade([\n                FlowPickerBuilder::FB_DISABLE_ROLLOUT, // Fallback to 100%\n            ]);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Flow setup:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Old checkout: ",(0,r.jsx)(n.code,{children:"rollout_pct: 50"})]}),"\n",(0,r.jsxs)(n.li,{children:["New checkout: ",(0,r.jsx)(n.code,{children:"rollout_pct: 50"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"50% of customers get old workflow, 50% get new workflow, consistently assigned by customer ID."}),"\n",(0,r.jsx)(n.h3,{id:"scenario-3-content-management-with-collections",children:"Scenario 3: Content Management with Collections"}),"\n",(0,r.jsx)(n.p,{children:"Different approval workflows for different content types:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Article extends Model\n{\n    use HasWorkflow;\n\n    protected $fillable = [\n        'collection', // 'news', 'blog', 'press-release'\n        'status',\n    ];\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $builder\n            ->subjectCollection($this->collection)\n            ->environment(config('app.env'))\n            ->channel('web');\n    }\n\n    protected function flowSubjectCollection(): ?string\n    {\n        return $this->getAttribute('collection');\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Flow setup:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["News articles: ",(0,r.jsx)(n.code,{children:"subject_collection: 'news'"})]}),"\n",(0,r.jsxs)(n.li,{children:["Blog posts: ",(0,r.jsx)(n.code,{children:"subject_collection: 'blog'"})]}),"\n",(0,r.jsxs)(n.li,{children:["Press releases: ",(0,r.jsx)(n.code,{children:"subject_collection: 'press-release'"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"scenario-4-scheduled-workflow-activation",children:"Scenario 4: Scheduled Workflow Activation"}),"\n",(0,r.jsx)(n.p,{children:"Workflows that activate at specific times:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Campaign extends Model\n{\n    use HasWorkflow;\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $builder\n            ->onlyActive(true)\n            ->ignoreTimeWindow(false) // Enforce active_from/active_to\n            ->timeNow(Carbon::now('UTC'))\n            ->fallbackCascade([\n                FlowPickerBuilder::FB_IGNORE_TIMEWINDOW, // Fallback if outside window\n            ]);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Flow setup:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Summer campaign: ",(0,r.jsx)(n.code,{children:"active_from: '2024-06-01'"}),", ",(0,r.jsx)(n.code,{children:"active_to: '2024-08-31'"})]}),"\n",(0,r.jsxs)(n.li,{children:["Winter campaign: ",(0,r.jsx)(n.code,{children:"active_from: '2024-12-01'"}),", ",(0,r.jsx)(n.code,{children:"active_to: '2024-02-28'"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"scenario-5-complex-multi-criteria-selection",children:"Scenario 5: Complex Multi-Criteria Selection"}),"\n",(0,r.jsx)(n.p,{children:"Combining all features for maximum flexibility:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"class Invoice extends Model\n{\n    use HasWorkflow;\n\n    protected $fillable = [\n        'tenant_id',\n        'invoice_type', // 'recurring', 'one-time'\n        'status',\n    ];\n\n    protected function buildFlowPicker(FlowPickerBuilder $builder): void\n    {\n        parent::buildFlowPicker($builder);\n\n        $builder\n            ->subjectScope((string)$this->tenant_id)\n            ->subjectCollection($this->invoice_type)\n            ->environment(config('app.env'))\n            ->channel(request()->header('X-Channel', 'web'))\n            ->preferEnvironments(['production', 'staging'])\n            ->preferChannels(['web', 'api'])\n            ->evaluateRollout(true)\n            ->rolloutNamespace('invoice')\n            ->rolloutKeyResolver(function ($model) {\n                return (string)$model->customer_id;\n            })\n            ->onlyActive(true)\n            ->ignoreTimeWindow(false)\n            ->timeNow(Carbon::now('UTC'))\n            ->fallbackCascade([\n                FlowPickerBuilder::FB_DROP_CHANNEL,\n                FlowPickerBuilder::FB_DROP_ENVIRONMENT,\n                FlowPickerBuilder::FB_IGNORE_TIMEWINDOW,\n                FlowPickerBuilder::FB_DISABLE_ROLLOUT,\n            ]);\n    }\n\n    protected function flowSubjectCollection(): ?string\n    {\n        return $this->getAttribute('invoice_type');\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"This configuration allows for:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Different workflows per tenant"}),"\n",(0,r.jsx)(n.li,{children:"Different workflows per invoice type"}),"\n",(0,r.jsx)(n.li,{children:"Environment-specific workflows"}),"\n",(0,r.jsx)(n.li,{children:"Channel-specific workflows"}),"\n",(0,r.jsx)(n.li,{children:"Gradual rollout of new workflows"}),"\n",(0,r.jsx)(n.li,{children:"Time-based activation"}),"\n",(0,r.jsx)(n.li,{children:"Graceful fallbacks if no exact match"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"lifecycle-events",children:"Lifecycle Events"}),"\n",(0,r.jsxs)(n.p,{children:["The trait hooks into Eloquent's ",(0,r.jsx)(n.code,{children:"creating"})," and ",(0,r.jsx)(n.code,{children:"created"})," events to automatically bind flows:"]}),"\n",(0,r.jsx)(n.h3,{id:"creating-event",children:"Creating Event"}),"\n",(0,r.jsxs)(n.p,{children:["During the ",(0,r.jsx)(n.code,{children:"creating"})," event:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Checks if the model has a status column (throws exception if missing)"}),"\n",(0,r.jsx)(n.li,{children:"Checks if a flow binding already exists (skips if it does)"}),"\n",(0,r.jsxs)(n.li,{children:["Calls ",(0,r.jsx)(n.code,{children:"pickFlow()"})," to select the appropriate flow"]}),"\n",(0,r.jsxs)(n.li,{children:["Stores the selected flow ID in ",(0,r.jsx)(n.code,{children:"selectedFlowIdForBinding"})," property"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// This happens automatically when you create a model\n$order = Order::create([...]);\n// Flow is picked and stored temporarily during 'creating' event\n"})}),"\n",(0,r.jsx)(n.h3,{id:"created-event",children:"Created Event"}),"\n",(0,r.jsxs)(n.p,{children:["During the ",(0,r.jsx)(n.code,{children:"created"})," event:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Checks if the model has a status column"}),"\n",(0,r.jsx)(n.li,{children:"Checks if a flow binding already exists (skips if it does)"}),"\n",(0,r.jsxs)(n.li,{children:["Uses the stored ",(0,r.jsx)(n.code,{children:"selectedFlowIdForBinding"})," or calls ",(0,r.jsx)(n.code,{children:"pickFlow()"})," again"]}),"\n",(0,r.jsxs)(n.li,{children:["Creates a ",(0,r.jsx)(n.code,{children:"FlowUse"})," record to bind the flow to the model"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Flow binding is persisted to database during 'created' event\n// FlowUse record is created in flow_uses table\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Important Notes:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["If a ",(0,r.jsx)(n.code,{children:"FlowUse"})," record already exists, the trait skips automatic binding"]}),"\n",(0,r.jsxs)(n.li,{children:["If ",(0,r.jsx)(n.code,{children:"pickFlow()"})," returns ",(0,r.jsx)(n.code,{children:"null"}),", no binding is created (no error thrown)"]}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"selectedFlowIdForBinding"})," property is used to avoid picking the flow twice"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"understanding-selectedflowidforbinding",children:"Understanding selectedFlowIdForBinding"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"selectedFlowIdForBinding"})," property is a temporary storage mechanism:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["During ",(0,r.jsx)(n.code,{children:"creating"})," event"]}),": Flow is picked and ID is stored in this property"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["During ",(0,r.jsx)(n.code,{children:"created"})," event"]}),": The stored ID is used instead of picking again"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Purpose"}),": Avoids picking the flow twice (once in creating, once in created)"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This is important because:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Flow picking can be expensive (database queries, complex logic)"}),"\n",(0,r.jsxs)(n.li,{children:["Model attributes might change between ",(0,r.jsx)(n.code,{children:"creating"})," and ",(0,r.jsx)(n.code,{children:"created"})," events"]}),"\n",(0,r.jsx)(n.li,{children:"Storing the ID ensures consistency"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Manual Access:"})}),"\n",(0,r.jsx)(n.p,{children:"You generally don't need to access this property directly, but if you do:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// This is set automatically during creating event\n$order->selectedFlowIdForBinding; // int|null\n"})}),"\n",(0,r.jsx)(n.h3,{id:"skipping-automatic-binding",children:"Skipping Automatic Binding"}),"\n",(0,r.jsx)(n.p,{children:"If you want to skip automatic binding and handle it manually:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Create FlowUse record before creating the model\n$order = new Order([...]);\n$order->flowUse()->create(['flow_id' => $flowId]);\n$order->save();\n\n// The trait will detect existing FlowUse and skip automatic binding\n"})}),"\n",(0,r.jsx)(n.h2,{id:"performance-optimization",children:"Performance Optimization"}),"\n",(0,r.jsx)(n.h3,{id:"caching-flow-picker-results",children:"Caching Flow Picker Results"}),"\n",(0,r.jsx)(n.p,{children:"For models with complex flow selection logic, you can enable request-level caching:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"protected function buildFlowPicker(FlowPickerBuilder $builder): void\n{\n    parent::buildFlowPicker($builder);\n\n    // Enable caching if builder doesn't use dynamic callbacks\n    $builder->cacheInRequest(true);\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Warning:"})," Only enable if your callbacks don't depend on request state. If callbacks access ",(0,r.jsx)(n.code,{children:"$request"}),", ",(0,r.jsx)(n.code,{children:"auth()"}),", or other request-specific data, caching may return incorrect results."]}),"\n",(0,r.jsx)(n.h3,{id:"optimizing-flow-queries",children:"Optimizing Flow Queries"}),"\n",(0,r.jsx)(n.p,{children:"The FlowPicker automatically optimizes queries, but you can help by:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Indexing database columns"})," used in flow selection:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Migration\nSchema::table('flows', function (Blueprint $table) {\n    $table->index(['subject_type', 'subject_scope', 'subject_collection']);\n    $table->index(['environment', 'channel']);\n    $table->index(['status', 'active_from', 'active_to']);\n});\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Using specific criteria"})," instead of broad filters:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// \u2705 Good: Specific\n$builder->environment('production')->channel('web');\n\n// \u26a0\ufe0f Less optimal: Broad\n$builder->environment(null)->channel(null);\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Limiting fallback cascade"})," to necessary steps:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// \u2705 Good: Only necessary fallbacks\n$builder->fallbackCascade([FlowPickerBuilder::FB_DROP_CHANNEL]);\n\n// \u26a0\ufe0f Less optimal: Too many fallbacks\n$builder->fallbackCascade([\n    FlowPickerBuilder::FB_DROP_CHANNEL,\n    FlowPickerBuilder::FB_DROP_ENVIRONMENT,\n    FlowPickerBuilder::FB_IGNORE_TIMEWINDOW,\n    FlowPickerBuilder::FB_DISABLE_ROLLOUT,\n    FlowPickerBuilder::FB_DROP_REQUIRE_DEFAULT,\n]);\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Always use eager loading"})," when working with multiple models:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$orders = Order::withFlow()->get();\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsxs)(n.strong,{children:["Override ",(0,r.jsx)(n.code,{children:"buildFlowPicker()"})]})," to customize flow selection based on your business logic"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsxs)(n.strong,{children:["Use ",(0,r.jsx)(n.code,{children:"flowSubjectCollection()"})]})," if you have different workflow variants for the same model type"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Ensure status column exists"})," before using the trait to avoid runtime errors"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Use enums for status"})," to get better type safety and automatic value detection"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Index database columns"})," used in flow selection for better performance"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsxs)(n.strong,{children:["Keep ",(0,r.jsx)(n.code,{children:"buildFlowPicker()"})," efficient"]})," - avoid heavy computations in callbacks"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Use specific criteria"})," instead of broad filters when possible"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Limit fallback cascade"})," to necessary steps only"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Enable request caching"})," only if callbacks don't depend on request state"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"testing-and-debugging",children:"Testing and Debugging"}),"\n",(0,r.jsx)(n.h3,{id:"testing-flow-selection",children:"Testing Flow Selection"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"Flow::previewPick()"})," to test which flow would be selected:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order = Order::make(['user_id' => 1, 'collection' => 'premium']);\n\n// Preview without creating the model\n$flow = Flow::previewPick($order);\n\n// Test with different configurations\n$flow = Flow::previewPick($order, function ($builder) {\n    $builder->environment('staging');\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"debugging-flow-picker-configuration",children:"Debugging Flow Picker Configuration"}),"\n",(0,r.jsx)(n.p,{children:"Log the builder configuration to see what's being used:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"protected function buildFlowPicker(FlowPickerBuilder $builder): void\n{\n    parent::buildFlowPicker($builder);\n\n    // Your configuration\n    $builder->subjectScope((string)$this->user_id);\n\n    // Debug: Log configuration\n    if (config('app.debug')) {\n        logger()->debug('FlowPicker configuration', [\n            'subject_type' => static::class,\n            'subject_scope' => $this->user_id,\n            'environment' => config('app.env'),\n        ]);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"testing-rollout",children:"Testing Rollout"}),"\n",(0,r.jsx)(n.p,{children:"To test rollout behavior, you can temporarily override the rollout key:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order = Order::make(['user_id' => 1]);\n\n// Test with specific rollout key\n$flow = Flow::previewPick($order, function ($builder) use ($order) {\n    $builder->rolloutKeyResolver(function () {\n        return 'test-key-123'; // Fixed key for testing\n    });\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"verifying-flow-binding",children:"Verifying Flow Binding"}),"\n",(0,r.jsx)(n.p,{children:"After creating a model, verify the flow was bound:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order = Order::create([...]);\n\n// Check if flow was bound\nif ($order->boundFlow()) {\n    logger()->info('Flow bound successfully', [\n        'flow_id' => $order->boundFlow()->id,\n    ]);\n} else {\n    logger()->warning('No flow bound to order', [\n        'order_id' => $order->id,\n    ]);\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"common-issues-and-solutions",children:"Common Issues and Solutions"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Issue: Flow not binding automatically"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Check if flow exists\n$flows = Flow::query()\n    ->where('subject_type', Order::class)\n    ->where('status', true)\n    ->get();\n\n// Check if flow matches criteria\n$flow = Flow::previewPick($order);\nif (!$flow) {\n    // No flow matches - check your buildFlowPicker() configuration\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Issue: Wrong flow being selected"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Check all matching flows\n$builder = $order->makeFlowPicker();\n$candidates = (new FlowPicker())->pick($order, $builder->returnCandidates(true));\n\n// See which flows match\nforeach ($candidates as $candidate) {\n    logger()->info('Matching flow', [\n        'flow_id' => $candidate->id,\n        'version' => $candidate->version,\n        'is_default' => $candidate->is_default,\n    ]);\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.h3,{id:"flow-not-binding",children:"Flow Not Binding"}),"\n",(0,r.jsx)(n.p,{children:"If a flow is not being bound automatically:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Check that a flow exists with the correct ",(0,r.jsx)(n.code,{children:"subject_type"})]}),"\n",(0,r.jsx)(n.li,{children:"Verify the flow is active and matches your selection criteria"}),"\n",(0,r.jsxs)(n.li,{children:["Check the ",(0,r.jsx)(n.code,{children:"buildFlowPicker()"})," configuration"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"status-column-missing",children:"Status Column Missing"}),"\n",(0,r.jsx)(n.p,{children:"If you get an error about missing status column:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Error: Model Order must have a \"status\" column in table \"orders\"\n\n// Solution: Add the column in a migration\nSchema::table('orders', function (Blueprint $table) {\n    $table->string('status')->nullable();\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"enum-not-detected",children:"Enum Not Detected"}),"\n",(0,r.jsx)(n.p,{children:"If enum values are not being detected:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Ensure the enum class exists and is properly imported"}),"\n",(0,r.jsxs)(n.li,{children:["Check that the ",(0,r.jsx)(n.code,{children:"$casts"})," array includes the status column"]}),"\n",(0,r.jsxs)(n.li,{children:["For custom enums, implement a ",(0,r.jsx)(n.code,{children:"values()"})," static method"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"flow-picking-returns-null",children:"Flow Picking Returns Null"}),"\n",(0,r.jsxs)(n.p,{children:["If ",(0,r.jsx)(n.code,{children:"pickFlow()"})," returns ",(0,r.jsx)(n.code,{children:"null"}),", no binding is created (no error thrown):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order = Order::create([...]);\n\n// If pickFlow() returns null, no FlowUse record is created\n// This is intentional - not all models need workflows\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Common reasons for null:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"No flows match the selection criteria"}),"\n",(0,r.jsx)(n.li,{children:"All matching flows are inactive"}),"\n",(0,r.jsx)(n.li,{children:"Rollout percentage excludes this model"}),"\n",(0,r.jsx)(n.li,{children:"Active window doesn't include current time"}),"\n",(0,r.jsx)(n.li,{children:"Fallback cascade exhausted all options"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Debugging:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Preview which flow would be selected\n$flow = Flow::previewPick($order);\n\nif (!$flow) {\n    // No flow matches - check your buildFlowPicker() configuration\n    // Or check if flows exist with matching criteria\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"multiple-flows-match",children:"Multiple Flows Match"}),"\n",(0,r.jsx)(n.p,{children:"When multiple flows match the criteria, the system uses ordering to select the best one:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Version"})," (DESC): Higher versions preferred"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"is_default"})," (DESC): Default flows preferred"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"ordering"})," (DESC): Higher ordering preferred"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"id"})," (DESC): Higher ID as tiebreaker"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["You can customize this with ",(0,r.jsx)(n.code,{children:"orderBy()"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"protected function buildFlowPicker(FlowPickerBuilder $builder): void\n{\n    parent::buildFlowPicker($builder);\n\n    $builder->orderBy(function ($query) {\n        $query->orderBy('priority', 'desc')\n              ->orderBy('created_at', 'asc');\n    });\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"fallback-cascade-exhausted",children:"Fallback Cascade Exhausted"}),"\n",(0,r.jsx)(n.p,{children:"If all fallback steps are exhausted and no flow is found:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// No flow will be bound\n// No error is thrown\n// Model is created successfully without workflow\n"})}),"\n",(0,r.jsx)(n.p,{children:"This is intentional - workflows are optional. If you need to enforce workflow binding, check after creation:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$order = Order::create([...]);\n\nif (!$order->boundFlow()) {\n    throw new \\Exception('Order must have a workflow');\n}\n"})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453(e,n,l){l.d(n,{R:()=>o,x:()=>t});var i=l(6540);const r={},s=i.createContext(r);function o(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);