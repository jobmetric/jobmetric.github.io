"use strict";(globalThis.webpackChunkjobmetric_document=globalThis.webpackChunkjobmetric_document||[]).push([[9177],{28453(e,n,t){t.d(n,{R:()=>o,x:()=>l});var i=t(96540);const s={},r=i.createContext(s);function o(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:n},e.children)}},46693(e,n,t){t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"laravel-unit-converter/deep-diving/exceptions/unit-type-used-in","title":"UnitTypeUsedInException","description":"Thrown when attempting to delete or modify a unit that is currently used in unit relations.","source":"@site/packages/laravel-unit-converter/deep-diving/exceptions/unit-type-used-in.md","sourceDirName":"laravel-unit-converter/deep-diving/exceptions","slug":"/laravel-unit-converter/deep-diving/exceptions/unit-type-used-in","permalink":"/packages/laravel-unit-converter/deep-diving/exceptions/unit-type-used-in","draft":false,"unlisted":false,"editUrl":"https://github.com/jobmetric/document/blob/master/packages/laravel-unit-converter/deep-diving/exceptions/unit-type-used-in.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8,"sidebar_label":"UnitTypeUsedInException"},"sidebar":"packagesSidebar","previous":{"title":"CannotDeleteDefaultValueException","permalink":"/packages/laravel-unit-converter/deep-diving/exceptions/cannot-delete-default-value"},"next":{"title":"UnitValueZeroException","permalink":"/packages/laravel-unit-converter/deep-diving/exceptions/unit-value-zero"}}');var s=t(74848),r=t(28453);const o={sidebar_position:8,sidebar_label:"UnitTypeUsedInException"},l="UnitTypeUsedInException",a={},d=[{value:"Namespace",id:"namespace",level:2},{value:"HTTP Status Code",id:"http-status-code",level:2},{value:"Constructor",id:"constructor",level:2},{value:"Parameters",id:"parameters",level:3},{value:"Understanding Unit Relations",id:"understanding-unit-relations",level:2},{value:"When Is It Thrown?",id:"when-is-it-thrown",level:2},{value:"1. Deleting a Used Unit",id:"1-deleting-a-used-unit",level:3},{value:"2. Changing Default Value of a Used Unit",id:"2-changing-default-value-of-a-used-unit",level:3},{value:"Exception Properties",id:"exception-properties",level:2},{value:"Handling the Exception",id:"handling-the-exception",level:2},{value:"In Controllers",id:"in-controllers",level:3},{value:"Show Usage Details",id:"show-usage-details",level:3},{value:"Solutions",id:"solutions",level:2},{value:"Solution 1: Remove All Usages First",id:"solution-1-remove-all-usages-first",level:3},{value:"Solution 2: Migrate to Another Unit",id:"solution-2-migrate-to-another-unit",level:3},{value:"Solution 3: Soft Delete / Disable Instead",id:"solution-3-soft-delete--disable-instead",level:3},{value:"Solution 4: Check Before Attempting Delete",id:"solution-4-check-before-attempting-delete",level:3},{value:"Prevention",id:"prevention",level:2},{value:"1. Check Usage Before Delete UI",id:"1-check-usage-before-delete-ui",level:3},{value:"2. Confirmation Dialog with Usage Count",id:"2-confirmation-dialog-with-usage-count",level:3},{value:"3. Provide Migration Tool",id:"3-provide-migration-tool",level:3},{value:"Related Exceptions",id:"related-exceptions",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"unittypeusedinexception",children:"UnitTypeUsedInException"})}),"\n",(0,s.jsx)(n.p,{children:"Thrown when attempting to delete or modify a unit that is currently used in unit relations."}),"\n",(0,s.jsx)(n.h2,{id:"namespace",children:"Namespace"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"JobMetric\\UnitConverter\\Exceptions\\UnitTypeUsedInException\n"})}),"\n",(0,s.jsx)(n.h2,{id:"http-status-code",children:"HTTP Status Code"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"400 Bad Request"})}),"\n",(0,s.jsx)(n.h2,{id:"constructor",children:"Constructor"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"public function __construct(\n    int $unit_id,\n    int $number,\n    int $code = 400,\n    ?Throwable $previous = null\n)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"parameters",children:"Parameters"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"$unit_id"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"int"})}),(0,s.jsx)(n.td,{children:"The unit ID that is being used"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"$number"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"int"})}),(0,s.jsx)(n.td,{children:"Number of relations using this unit"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"$code"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"int"})}),(0,s.jsx)(n.td,{children:"HTTP status code (default: 400)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"$previous"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Throwable|null"})}),(0,s.jsx)(n.td,{children:"Previous exception for chaining"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"understanding-unit-relations",children:"Understanding Unit Relations"}),"\n",(0,s.jsxs)(n.p,{children:["When you attach a unit to a model using ",(0,s.jsx)(n.code,{children:"HasUnit"}),", a record is created in ",(0,s.jsx)(n.code,{children:"unit_relations"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// This creates a unit_relation record\n$product->storeUnit('weight', $kilogramId, 2.5);\n\n// unit_relations table:\n// | unit_id | unitable_type      | unitable_id | type   | value |\n// |---------|-------------------|-------------|--------|-------|\n// | 2       | App\\Models\\Product | 1           | weight | 2.5   |\n"})}),"\n",(0,s.jsxs)(n.p,{children:["A unit ",(0,s.jsx)(n.strong,{children:"cannot be deleted"})," if any relations reference it."]}),"\n",(0,s.jsx)(n.h2,{id:"when-is-it-thrown",children:"When Is It Thrown?"}),"\n",(0,s.jsx)(n.h3,{id:"1-deleting-a-used-unit",children:"1. Deleting a Used Unit"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\UnitConverter\\Facades\\UnitConverter;\n\n// Kilogram is used by 150 products\nUnitConverter::destroy($kilogramId);\n// Throws: UnitTypeUsedInException with number = 150\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-changing-default-value-of-a-used-unit",children:"2. Changing Default Value of a Used Unit"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\UnitConverter\\Facades\\UnitConverter;\n\n// Kilogram is used by products\nUnitConverter::changeDefaultValue($kilogramId);\n// Throws: UnitTypeUsedInException\n"})}),"\n",(0,s.jsx)(n.h2,{id:"exception-properties",children:"Exception Properties"}),"\n",(0,s.jsx)(n.p,{children:"You can access the count of relations from the exception message:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:'try {\n    UnitConverter::destroy($unitId);\n} catch (UnitTypeUsedInException $e) {\n    // Message includes: "Unit {unit_id} is used in {number} relations"\n    echo $e->getMessage();\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"handling-the-exception",children:"Handling the Exception"}),"\n",(0,s.jsx)(n.h3,{id:"in-controllers",children:"In Controllers"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\UnitConverter\\Exceptions\\UnitTypeUsedInException;\nuse JobMetric\\UnitConverter\\Facades\\UnitConverter;\n\nclass UnitController extends Controller\n{\n    public function destroy(int $id)\n    {\n        try {\n            $response = UnitConverter::destroy($id);\n            return response()->json(['message' => 'Unit deleted']);\n        } catch (UnitTypeUsedInException $e) {\n            // Get usage details\n            $usageResponse = UnitConverter::usedIn($id);\n            \n            return response()->json([\n                'error' => 'unit_in_use',\n                'message' => $e->getMessage(),\n                'usage_count' => $usageResponse->data->count(),\n                'hint' => 'Remove all usages before deleting, or migrate to a different unit.',\n            ], 400);\n        }\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"show-usage-details",children:"Show Usage Details"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\UnitConverter\\Facades\\UnitConverter;\n\nclass UnitController extends Controller\n{\n    public function usedIn(int $id)\n    {\n        $response = UnitConverter::usedIn($id);\n        \n        return response()->json([\n            'unit_id' => $id,\n            'usage_count' => $response->data->count(),\n            'usages' => $response->data->map(function ($relation) {\n                return [\n                    'model_type' => $relation->unitable_type,\n                    'model_id' => $relation->unitable_id,\n                    'key' => $relation->type,\n                    'value' => $relation->value,\n                ];\n            }),\n        ]);\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"solutions",children:"Solutions"}),"\n",(0,s.jsx)(n.h3,{id:"solution-1-remove-all-usages-first",children:"Solution 1: Remove All Usages First"}),"\n",(0,s.jsx)(n.p,{children:"Delete all unit relations before deleting the unit:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\UnitConverter\\Facades\\UnitConverter;\nuse JobMetric\\UnitConverter\\Models\\UnitRelation;\n\n$unitId = 2; // Kilogram\n\n// Step 1: Remove all relations\nUnitRelation::where('unit_id', $unitId)->delete();\n\n// Step 2: Now delete the unit\nUnitConverter::destroy($unitId);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"solution-2-migrate-to-another-unit",children:"Solution 2: Migrate to Another Unit"}),"\n",(0,s.jsx)(n.p,{children:"If you want to replace one unit with another, migrate the data:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\UnitConverter\\Facades\\UnitConverter;\nuse JobMetric\\UnitConverter\\Models\\UnitRelation;\n\n$oldUnitId = 2; // Kilogram (to be deleted)\n$newUnitId = 1; // Gram (replacement)\n\n// Step 1: Convert all values and update relations\n$relations = UnitRelation::where('unit_id', $oldUnitId)->get();\n\nforeach ($relations as $relation) {\n    // Convert value from old unit to new unit\n    $convertedValue = UnitConverter::convert($oldUnitId, $newUnitId, $relation->value);\n    \n    // Update the relation\n    $relation->update([\n        'unit_id' => $newUnitId,\n        'value' => $convertedValue,\n    ]);\n}\n\n// Step 2: Now delete the old unit\nUnitConverter::destroy($oldUnitId);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"solution-3-soft-delete--disable-instead",children:"Solution 3: Soft Delete / Disable Instead"}),"\n",(0,s.jsx)(n.p,{children:"Instead of deleting, disable the unit:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\UnitConverter\\Facades\\UnitConverter;\n\n// Instead of deleting, just disable\nUnitConverter::update($unitId, ['status' => false]);\n\n// The unit still exists for historical data\n// But won't appear in active unit lists\n"})}),"\n",(0,s.jsx)(n.h3,{id:"solution-4-check-before-attempting-delete",children:"Solution 4: Check Before Attempting Delete"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use JobMetric\\UnitConverter\\Facades\\UnitConverter;\n\nclass UnitService\n{\n    public function safeDelete(int $unitId): array\n    {\n        // Check if unit is used\n        if (UnitConverter::hasUsed($unitId)) {\n            $usage = UnitConverter::usedIn($unitId);\n            \n            return [\n                'success' => false,\n                'reason' => 'unit_in_use',\n                'usage_count' => $usage->data->count(),\n            ];\n        }\n        \n        // Safe to delete\n        UnitConverter::destroy($unitId);\n        \n        return ['success' => true];\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"prevention",children:"Prevention"}),"\n",(0,s.jsx)(n.h3,{id:"1-check-usage-before-delete-ui",children:"1. Check Usage Before Delete UI"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// API endpoint for checking deletability\npublic function canDelete(int $id): JsonResponse\n{\n    $unit = Unit::find($id);\n    \n    if (!$unit) {\n        return response()->json(['error' => 'Unit not found'], 404);\n    }\n    \n    $isUsed = UnitConverter::hasUsed($id);\n    $isBase = (float) $unit->value === 1.0;\n    $hasOtherUnits = Unit::where('type', $unit->type)\n        ->where('id', '!=', $id)\n        ->exists();\n    \n    return response()->json([\n        'can_delete' => !$isUsed && (!$isBase || !$hasOtherUnits),\n        'is_used' => $isUsed,\n        'is_base' => $isBase,\n        'usage_count' => $isUsed ? UnitConverter::usedIn($id)->data->count() : 0,\n    ]);\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-confirmation-dialog-with-usage-count",children:"2. Confirmation Dialog with Usage Count"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// Frontend\nasync function confirmDeleteUnit(unitId) {\n    const { can_delete, is_used, usage_count } = await checkCanDelete(unitId);\n    \n    if (!can_delete) {\n        if (is_used) {\n            alert(`Cannot delete: Unit is used by ${usage_count} items. Please migrate or remove usages first.`);\n        }\n        return false;\n    }\n    \n    return confirm('Are you sure you want to delete this unit?');\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-provide-migration-tool",children:"3. Provide Migration Tool"}),"\n",(0,s.jsx)(n.p,{children:"Build a UI for migrating from one unit to another:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// Migration endpoint\npublic function migrateUnit(Request $request): JsonResponse\n{\n    $request->validate([\n        'from_unit_id' => 'required|exists:units,id',\n        'to_unit_id' => 'required|exists:units,id|different:from_unit_id',\n    ]);\n    \n    $fromUnit = Unit::find($request->from_unit_id);\n    $toUnit = Unit::find($request->to_unit_id);\n    \n    // Ensure same type\n    if ($fromUnit->type !== $toUnit->type) {\n        return response()->json([\n            'error' => 'Units must be of the same type'\n        ], 400);\n    }\n    \n    // Migrate all relations\n    $migrated = $this->unitService->migrateRelations(\n        $request->from_unit_id,\n        $request->to_unit_id\n    );\n    \n    return response()->json([\n        'success' => true,\n        'migrated_count' => $migrated,\n    ]);\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"related-exceptions",children:"Related Exceptions"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./cannot-delete-default-value",children:"CannotDeleteDefaultValueException"})," - When trying to delete base unit"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./unit-not-found",children:"UnitNotFoundException"})," - When unit doesn't exist"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);