"use strict";(globalThis.webpackChunkjobmetric_document=globalThis.webpackChunkjobmetric_document||[]).push([[6924],{28453(e,n,t){t.d(n,{R:()=>i,x:()=>d});var a=t(96540);const r={},s=a.createContext(r);function i(e){const n=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(s.Provider,{value:n},e.children)}},96635(e,n,t){t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>d,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"laravel-star/deep-diving/events","title":"Events","description":"Laravel Star provides a comprehensive event system that fires domain events for all star rating operations. These events allow you to hook into the rating lifecycle and perform additional actions when stars are added, updated, or removed.","source":"@site/packages/laravel-star/deep-diving/events.md","sourceDirName":"laravel-star/deep-diving","slug":"/laravel-star/deep-diving/events","permalink":"/packages/laravel-star/deep-diving/events","draft":false,"unlisted":false,"editUrl":"https://github.com/jobmetric/document/blob/master/packages/laravel-star/deep-diving/events.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"sidebar_label":"Events"},"sidebar":"packagesSidebar","previous":{"title":"Star","permalink":"/packages/laravel-star/deep-diving/models/star"},"next":{"title":"MaxStarException","permalink":"/packages/laravel-star/deep-diving/exceptions/max-star-exception"}}');var r=t(74848),s=t(28453),i=t(28774);const d={sidebar_position:5,sidebar_label:"Events"},l="Events",c={},o=[{value:"Overview",id:"overview",level:2},{value:"Event Structure",id:"event-structure",level:2},{value:"Base Event Structure",id:"base-event-structure",level:3},{value:"Available Events",id:"available-events",level:2},{value:"Star Events",id:"star-events",level:3},{value:"Listening to Events",id:"listening-to-events",level:2},{value:"Method 1: Event Listeners in Service Provider",id:"method-1-event-listeners-in-service-provider",level:3},{value:"Method 2: Using Event Facade",id:"method-2-using-event-facade",level:3},{value:"Method 3: Using Event Subscribers",id:"method-3-using-event-subscribers",level:3},{value:"Complete Examples",id:"complete-examples",level:2},{value:"Example 1: Cache Invalidation on Star Changes",id:"example-1-cache-invalidation-on-star-changes",level:3},{value:"Example 2: Audit Logging",id:"example-2-audit-logging",level:3},{value:"Example 3: Notification System",id:"example-3-notification-system",level:3},{value:"Example 4: Analytics Tracking",id:"example-4-analytics-tracking",level:3},{value:"Example 5: Rating Aggregation",id:"example-5-rating-aggregation",level:3},{value:"Example 6: Real-time Updates",id:"example-6-real-time-updates",level:3},{value:"Example 7: Spam Detection",id:"example-7-spam-detection",level:3},{value:"Example 8: Complete Event Listener Setup",id:"example-8-complete-event-listener-setup",level:3},{value:"Event Timing",id:"event-timing",level:2},{value:"StarAddEvent",id:"staraddevent",level:3},{value:"StarUpdatingEvent / StarUpdatedEvent",id:"starupdatingevent--starupdatedevent",level:3},{value:"StarRemovingEvent / StarRemovedEvent",id:"starremovingevent--starremovedevent",level:3},{value:"Queued Events",id:"queued-events",level:2},{value:"Event Payload Details",id:"event-payload-details",level:2},{value:"StarAddEvent",id:"staraddevent-1",level:3},{value:"StarUpdatingEvent / StarUpdatedEvent",id:"starupdatingevent--starupdatedevent-1",level:3},{value:"StarRemovingEvent / StarRemovedEvent",id:"starremovingevent--starremovedevent-1",level:3},{value:"When to Use Events",id:"when-to-use-events",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function v(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"events",children:"Events"})}),"\n",(0,r.jsx)(n.p,{children:"Laravel Star provides a comprehensive event system that fires domain events for all star rating operations. These events allow you to hook into the rating lifecycle and perform additional actions when stars are added, updated, or removed."}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.p,{children:"The event system in Laravel Star:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Fires automatically"})," during star rating operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Provides Star model instances"})," in event payloads"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Uses DomainEvent interface"})," for consistency"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Supports event listeners"})," for custom logic"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Enables event-driven architecture"})," for rating management"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"event-structure",children:"Event Structure"}),"\n",(0,r.jsx)(n.p,{children:"All events in Laravel Star:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Implement ",(0,r.jsx)(n.code,{children:"JobMetric\\EventSystem\\Contracts\\DomainEvent"})]}),"\n",(0,r.jsxs)(n.li,{children:["Are ",(0,r.jsx)(n.code,{children:"readonly"})," classes for immutability"]}),"\n",(0,r.jsx)(n.li,{children:"Contain the affected Star model instance"}),"\n",(0,r.jsxs)(n.li,{children:["Provide a stable ",(0,r.jsx)(n.code,{children:"key()"})," method"]}),"\n",(0,r.jsxs)(n.li,{children:["Include metadata via ",(0,r.jsx)(n.code,{children:"definition()"})," method"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"base-event-structure",children:"Base Event Structure"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"readonly class StarAddEvent implements DomainEvent\n{\n    public function __construct(\n        public Star $star\n    ) {}\n\n    public static function key(): string\n    {\n        return 'star.added';\n    }\n\n    public static function definition(): DomainEventDefinition\n    {\n        return new DomainEventDefinition(\n            self::key(),\n            'star::base.entity_names.star',\n            'star::base.events.star_added.title',\n            'star::base.events.star_added.description',\n            'fas fa-star',\n            ['star', 'rating', 'evaluation']\n        );\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"available-events",children:"Available Events"}),"\n",(0,r.jsx)(n.h3,{id:"star-events",children:"Star Events"}),"\n",(0,r.jsx)(n.p,{children:"Events fired for Star rating operations."}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Event Class"}),(0,r.jsx)(n.th,{children:"Event Key"}),(0,r.jsx)(n.th,{children:"Description"}),(0,r.jsx)(n.th,{children:"Payload"}),(0,r.jsx)(n.th,{children:"Triggered When"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"StarAddEvent"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"star.added"})}),(0,r.jsx)(n.td,{children:"Fired when a new star rating is added"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Star $star"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"HasStar::addStar()"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"StarUpdatingEvent"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"star.updating"})}),(0,r.jsx)(n.td,{children:"Fired before a star rating is updated"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Star $star, int $rate"})}),(0,r.jsxs)(n.td,{children:["Before ",(0,r.jsx)(n.code,{children:"Star::update()"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"StarUpdatedEvent"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"star.updated"})}),(0,r.jsx)(n.td,{children:"Fired after a star rating is updated"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Star $star, int $rate"})}),(0,r.jsxs)(n.td,{children:["After ",(0,r.jsx)(n.code,{children:"Star::update()"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"StarRemovingEvent"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"star.removing"})}),(0,r.jsx)(n.td,{children:"Fired before a star rating is removed"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Star $star"})}),(0,r.jsxs)(n.td,{children:["Before ",(0,r.jsx)(n.code,{children:"Star::delete()"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"StarRemovedEvent"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"star.removed"})}),(0,r.jsx)(n.td,{children:"Fired after a star rating is removed"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Star $star"})}),(0,r.jsxs)(n.td,{children:["After ",(0,r.jsx)(n.code,{children:"Star::delete()"})]})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Namespace:"})," ",(0,r.jsx)(n.code,{children:"JobMetric\\Star\\Events\\*"})]}),"\n",(0,r.jsx)(n.h2,{id:"listening-to-events",children:"Listening to Events"}),"\n",(0,r.jsx)(n.h3,{id:"method-1-event-listeners-in-service-provider",children:"Method 1: Event Listeners in Service Provider"}),"\n",(0,r.jsx)(n.p,{children:"Register event listeners in a service provider:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"namespace App\\Providers;\n\nuse Illuminate\\Foundation\\Support\\Providers\\EventServiceProvider as ServiceProvider;\nuse JobMetric\\Star\\Events\\StarAddEvent;\nuse JobMetric\\Star\\Events\\StarUpdatedEvent;\nuse JobMetric\\Star\\Events\\StarRemovedEvent;\n\nclass EventServiceProvider extends ServiceProvider\n{\n    protected $listen = [\n        StarAddEvent::class => [\n            \\App\\Listeners\\Star\\LogStarCreation::class,\n            \\App\\Listeners\\Star\\InvalidateStarCache::class,\n            \\App\\Listeners\\Star\\NotifyStarAdded::class,\n        ],\n        StarUpdatedEvent::class => [\n            \\App\\Listeners\\Star\\LogStarUpdate::class,\n            \\App\\Listeners\\Star\\InvalidateStarCache::class,\n        ],\n        StarRemovedEvent::class => [\n            \\App\\Listeners\\Star\\LogStarRemoval::class,\n            \\App\\Listeners\\Star\\InvalidateStarCache::class,\n        ],\n    ];\n\n    public function boot(): void\n    {\n        parent::boot();\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"method-2-using-event-facade",children:"Method 2: Using Event Facade"}),"\n",(0,r.jsx)(n.p,{children:"Listen to events using the Event facade:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"use Illuminate\\Support\\Facades\\Event;\nuse JobMetric\\Star\\Events\\StarAddEvent;\n\nEvent::listen(StarAddEvent::class, function (StarAddEvent $event) {\n    $star = $event->star;\n    \n    // Perform actions\n    Log::info('Star rating added', [\n        'star_id' => $star->id,\n        'rate' => $star->rate,\n        'starable_type' => $star->starable_type,\n        'starable_id' => $star->starable_id,\n    ]);\n    \n    Cache::forget(\"star_ratings.{$star->starable_type}.{$star->starable_id}\");\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"method-3-using-event-subscribers",children:"Method 3: Using Event Subscribers"}),"\n",(0,r.jsx)(n.p,{children:"Create event subscribers for multiple events:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners;\n\nuse Illuminate\\Events\\Dispatcher;\nuse JobMetric\\Star\\Events\\StarAddEvent;\nuse JobMetric\\Star\\Events\\StarUpdatedEvent;\nuse JobMetric\\Star\\Events\\StarRemovedEvent;\n\nclass StarEventSubscriber\n{\n    public function handleStarAdded(StarAddEvent $event): void\n    {\n        $star = $event->star;\n        Log::info('Star added', [\n            'star_id' => $star->id,\n            'rate' => $star->rate,\n            'starable' => \"{$star->starable_type}:{$star->starable_id}\",\n        ]);\n    }\n\n    public function handleStarUpdated(StarUpdatedEvent $event): void\n    {\n        $star = $event->star;\n        Log::info('Star updated', [\n            'star_id' => $star->id,\n            'old_rate' => $star->getOriginal('rate'),\n            'new_rate' => $event->rate,\n        ]);\n    }\n\n    public function handleStarRemoved(StarRemovedEvent $event): void\n    {\n        $star = $event->star;\n        Log::warning('Star removed', [\n            'star_id' => $star->id,\n            'rate' => $star->rate,\n        ]);\n    }\n\n    public function subscribe(Dispatcher $events): void\n    {\n        $events->listen(\n            StarAddEvent::class,\n            [StarEventSubscriber::class, 'handleStarAdded']\n        );\n\n        $events->listen(\n            StarUpdatedEvent::class,\n            [StarEventSubscriber::class, 'handleStarUpdated']\n        );\n\n        $events->listen(\n            StarRemovedEvent::class,\n            [StarEventSubscriber::class, 'handleStarRemoved']\n        );\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Register the subscriber:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"namespace App\\Providers;\n\nuse App\\Listeners\\StarEventSubscriber;\nuse Illuminate\\Foundation\\Support\\Providers\\EventServiceProvider as ServiceProvider;\n\nclass EventServiceProvider extends ServiceProvider\n{\n    protected $subscribe = [\n        StarEventSubscriber::class,\n    ];\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"complete-examples",children:"Complete Examples"}),"\n",(0,r.jsx)(n.h3,{id:"example-1-cache-invalidation-on-star-changes",children:"Example 1: Cache Invalidation on Star Changes"}),"\n",(0,r.jsx)(n.p,{children:"Invalidate cache when star ratings are modified:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:'namespace App\\Listeners\\Star;\n\nuse Illuminate\\Support\\Facades\\Cache;\nuse JobMetric\\Star\\Events\\StarAddEvent;\nuse JobMetric\\Star\\Events\\StarUpdatedEvent;\nuse JobMetric\\Star\\Events\\StarRemovedEvent;\n\nclass InvalidateStarCache\n{\n    public function handle(StarAddEvent|StarUpdatedEvent|StarRemovedEvent $event): void\n    {\n        $star = $event->star;\n\n        // Invalidate specific starable cache\n        Cache::forget("star_ratings.{$star->starable_type}.{$star->starable_id}");\n        Cache::forget("star_average.{$star->starable_type}.{$star->starable_id}");\n        Cache::forget("star_count.{$star->starable_type}.{$star->starable_id}");\n\n        // Invalidate all stars cache for this starable\n        Cache::tags(["starable_{$star->starable_type}_{$star->starable_id}"])->flush();\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"example-2-audit-logging",children:"Example 2: Audit Logging"}),"\n",(0,r.jsx)(n.p,{children:"Log all star rating operations for audit trail:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\Star;\n\nuse App\\Models\\AuditLog;\nuse Illuminate\\Support\\Facades\\Auth;\nuse JobMetric\\Star\\Events\\StarAddEvent;\nuse JobMetric\\Star\\Events\\StarUpdatedEvent;\nuse JobMetric\\Star\\Events\\StarRemovedEvent;\n\nclass AuditStarOperations\n{\n    public function handleStarAdded(StarAddEvent $event): void\n    {\n        $this->logAudit('added', $event->star);\n    }\n\n    public function handleStarUpdated(StarUpdatedEvent $event): void\n    {\n        $this->logAudit('updated', $event->star, [\n            'old_rate' => $event->star->getOriginal('rate'),\n            'new_rate' => $event->rate,\n        ]);\n    }\n\n    public function handleStarRemoved(StarRemovedEvent $event): void\n    {\n        $this->logAudit('removed', $event->star);\n    }\n\n    protected function logAudit(string $action, $star, array $extra = []): void\n    {\n        AuditLog::create([\n            'user_id' => Auth::id(),\n            'action' => \"star.{$action}\",\n            'model_type' => get_class($star),\n            'model_id' => $star->id,\n            'starable_type' => $star->starable_type,\n            'starable_id' => $star->starable_id,\n            'rate' => $star->rate,\n            'data' => $extra,\n            'ip_address' => request()->ip(),\n        ]);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"example-3-notification-system",children:"Example 3: Notification System"}),"\n",(0,r.jsx)(n.p,{children:"Send notifications when star ratings are added or updated:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\Star;\n\nuse App\\Notifications\\StarRatingAdded;\nuse App\\Notifications\\StarRatingUpdated;\nuse Illuminate\\Support\\Facades\\Notification;\nuse JobMetric\\Star\\Events\\StarAddEvent;\nuse JobMetric\\Star\\Events\\StarUpdatedEvent;\n\nclass NotifyStarChanges\n{\n    public function handleStarAdded(StarAddEvent $event): void\n    {\n        $star = $event->star;\n        $starable = $star->starable;\n\n        // Notify starable owner if it has an author/user\n        if (method_exists($starable, 'user') && $starable->user) {\n            $starable->user->notify(new StarRatingAdded($star));\n        }\n\n        // Notify administrators for high ratings\n        if ($star->rate >= 5) {\n            $admins = User::whereHas('roles', function ($query) {\n                $query->where('name', 'admin');\n            })->get();\n\n            Notification::send($admins, new StarRatingAdded($star));\n        }\n    }\n\n    public function handleStarUpdated(StarUpdatedEvent $event): void\n    {\n        $star = $event->star;\n        $oldRate = $star->getOriginal('rate');\n        $newRate = $event->rate;\n\n        // Notify if rating significantly changed\n        if (abs($oldRate - $newRate) >= 2) {\n            $starable = $star->starable;\n            \n            if (method_exists($starable, 'user') && $starable->user) {\n                $starable->user->notify(new StarRatingUpdated($star, $oldRate, $newRate));\n            }\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"example-4-analytics-tracking",children:"Example 4: Analytics Tracking"}),"\n",(0,r.jsx)(n.p,{children:"Track star rating changes for analytics:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\Star;\n\nuse App\\Services\\AnalyticsService;\nuse JobMetric\\Star\\Events\\StarAddEvent;\nuse JobMetric\\Star\\Events\\StarUpdatedEvent;\nuse JobMetric\\Star\\Events\\StarRemovedEvent;\n\nclass TrackStarAnalytics\n{\n    public function __construct(\n        protected AnalyticsService $analytics\n    ) {}\n\n    public function handleStarAdded(StarAddEvent $event): void\n    {\n        $star = $event->star;\n        \n        $this->analytics->track('star.added', [\n            'star_id' => $star->id,\n            'rate' => $star->rate,\n            'starable_type' => $star->starable_type,\n            'starable_id' => $star->starable_id,\n            'starrer_type' => $star->starrer_type,\n            'starrer_id' => $star->starrer_id,\n            'device_id' => $star->device_id,\n            'source' => $star->source,\n        ]);\n    }\n\n    public function handleStarUpdated(StarUpdatedEvent $event): void\n    {\n        $star = $event->star;\n        \n        $this->analytics->track('star.updated', [\n            'star_id' => $star->id,\n            'old_rate' => $star->getOriginal('rate'),\n            'new_rate' => $event->rate,\n            'starable_type' => $star->starable_type,\n            'starable_id' => $star->starable_id,\n        ]);\n    }\n\n    public function handleStarRemoved(StarRemovedEvent $event): void\n    {\n        $star = $event->star;\n        \n        $this->analytics->track('star.removed', [\n            'star_id' => $star->id,\n            'rate' => $star->rate,\n            'starable_type' => $star->starable_type,\n            'starable_id' => $star->starable_id,\n        ]);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"example-5-rating-aggregation",children:"Example 5: Rating Aggregation"}),"\n",(0,r.jsx)(n.p,{children:"Update rating aggregates when stars change:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\Star;\n\nuse JobMetric\\Star\\Events\\StarAddEvent;\nuse JobMetric\\Star\\Events\\StarUpdatedEvent;\nuse JobMetric\\Star\\Events\\StarRemovedEvent;\n\nclass UpdateRatingAggregates\n{\n    public function handleStarAdded(StarAddEvent $event): void\n    {\n        $this->recalculateAggregates($event->star);\n    }\n\n    public function handleStarUpdated(StarUpdatedEvent $event): void\n    {\n        $this->recalculateAggregates($event->star);\n    }\n\n    public function handleStarRemoved(StarRemovedEvent $event): void\n    {\n        $this->recalculateAggregates($event->star);\n    }\n\n    protected function recalculateAggregates($star): void\n    {\n        $starable = $star->starable;\n        \n        // Recalculate average rating\n        $average = $starable->stars()->avg('rate');\n        $count = $starable->stars()->count();\n        \n        // Update starable model if it has rating fields\n        if (method_exists($starable, 'updateRating')) {\n            $starable->updateRating($average, $count);\n        }\n        \n        // Or update directly if columns exist\n        if (Schema::hasColumn($starable->getTable(), 'rating_average')) {\n            $starable->update([\n                'rating_average' => round($average, 2),\n                'rating_count' => $count,\n            ]);\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"example-6-real-time-updates",children:"Example 6: Real-time Updates"}),"\n",(0,r.jsx)(n.p,{children:"Send real-time updates via WebSockets or broadcasting:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\Star;\n\nuse Illuminate\\Support\\Facades\\Broadcast;\nuse JobMetric\\Star\\Events\\StarAddEvent;\nuse JobMetric\\Star\\Events\\StarUpdatedEvent;\nuse JobMetric\\Star\\Events\\StarRemovedEvent;\n\nclass BroadcastStarChanges\n{\n    public function handleStarAdded(StarAddEvent $event): void\n    {\n        $star = $event->star;\n        \n        Broadcast::channel(\"starable.{$star->starable_type}.{$star->starable_id}\", function () {\n            return true;\n        })->toOthers();\n        \n        event(new StarRatingChanged([\n            'type' => 'added',\n            'star' => $star,\n            'average' => $star->starable->stars()->avg('rate'),\n            'count' => $star->starable->stars()->count(),\n        ]));\n    }\n\n    public function handleStarUpdated(StarUpdatedEvent $event): void\n    {\n        $star = $event->star;\n        \n        event(new StarRatingChanged([\n            'type' => 'updated',\n            'star' => $star,\n            'old_rate' => $star->getOriginal('rate'),\n            'new_rate' => $event->rate,\n            'average' => $star->starable->stars()->avg('rate'),\n        ]));\n    }\n\n    public function handleStarRemoved(StarRemovedEvent $event): void\n    {\n        $star = $event->star;\n        \n        event(new StarRatingChanged([\n            'type' => 'removed',\n            'star' => $star,\n            'average' => $star->starable->stars()->avg('rate'),\n            'count' => $star->starable->stars()->count(),\n        ]));\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"example-7-spam-detection",children:"Example 7: Spam Detection"}),"\n",(0,r.jsx)(n.p,{children:"Detect and handle potential spam ratings:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\Star;\n\nuse App\\Services\\SpamDetectionService;\nuse JobMetric\\Star\\Events\\StarAddEvent;\nuse JobMetric\\Star\\Events\\StarUpdatingEvent;\n\nclass DetectSpamRatings\n{\n    public function __construct(\n        protected SpamDetectionService $spamDetection\n    ) {}\n\n    public function handleStarAdded(StarAddEvent $event): void\n    {\n        $star = $event->star;\n        \n        // Check for spam patterns\n        $isSpam = $this->spamDetection->check([\n            'ip_address' => $star->ip_address,\n            'device_id' => $star->device_id,\n            'rate' => $star->rate,\n            'starable_id' => $star->starable_id,\n        ]);\n        \n        if ($isSpam) {\n            // Mark as spam or delete\n            $star->update(['is_spam' => true]);\n            \n            // Log for review\n            Log::warning('Potential spam rating detected', [\n                'star_id' => $star->id,\n                'ip_address' => $star->ip_address,\n            ]);\n        }\n    }\n\n    public function handleStarUpdating(StarUpdatingEvent $event): void\n    {\n        $star = $event->star;\n        \n        // Prevent rapid rating changes (potential abuse)\n        $recentChanges = $star->starable->stars()\n            ->where('starrer_id', $star->starrer_id)\n            ->where('updated_at', '>', now()->subMinutes(5))\n            ->count();\n        \n        if ($recentChanges > 3) {\n            Log::warning('Rapid rating changes detected', [\n                'star_id' => $star->id,\n                'changes' => $recentChanges,\n            ]);\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"example-8-complete-event-listener-setup",children:"Example 8: Complete Event Listener Setup"}),"\n",(0,r.jsx)(n.p,{children:"Complete setup for all star events:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"namespace App\\Providers;\n\nuse App\\Listeners\\Star\\AuditStarOperations;\nuse App\\Listeners\\Star\\BroadcastStarChanges;\nuse App\\Listeners\\Star\\DetectSpamRatings;\nuse App\\Listeners\\Star\\InvalidateStarCache;\nuse App\\Listeners\\Star\\NotifyStarChanges;\nuse App\\Listeners\\Star\\TrackStarAnalytics;\nuse App\\Listeners\\Star\\UpdateRatingAggregates;\nuse Illuminate\\Foundation\\Support\\Providers\\EventServiceProvider as ServiceProvider;\nuse JobMetric\\Star\\Events\\StarAddEvent;\nuse JobMetric\\Star\\Events\\StarRemovedEvent;\nuse JobMetric\\Star\\Events\\StarRemovingEvent;\nuse JobMetric\\Star\\Events\\StarUpdatedEvent;\nuse JobMetric\\Star\\Events\\StarUpdatingEvent;\n\nclass EventServiceProvider extends ServiceProvider\n{\n    protected $listen = [\n        // Star added\n        StarAddEvent::class => [\n            AuditStarOperations::class,\n            InvalidateStarCache::class,\n            NotifyStarChanges::class,\n            TrackStarAnalytics::class,\n            UpdateRatingAggregates::class,\n            BroadcastStarChanges::class,\n            DetectSpamRatings::class,\n        ],\n\n        // Star updating (before update)\n        StarUpdatingEvent::class => [\n            DetectSpamRatings::class,\n        ],\n\n        // Star updated (after update)\n        StarUpdatedEvent::class => [\n            AuditStarOperations::class,\n            InvalidateStarCache::class,\n            NotifyStarChanges::class,\n            TrackStarAnalytics::class,\n            UpdateRatingAggregates::class,\n            BroadcastStarChanges::class,\n        ],\n\n        // Star removing (before deletion)\n        StarRemovingEvent::class => [\n            // Add any pre-deletion logic here\n        ],\n\n        // Star removed (after deletion)\n        StarRemovedEvent::class => [\n            AuditStarOperations::class,\n            InvalidateStarCache::class,\n            TrackStarAnalytics::class,\n            UpdateRatingAggregates::class,\n            BroadcastStarChanges::class,\n        ],\n    ];\n\n    public function boot(): void\n    {\n        parent::boot();\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"event-timing",children:"Event Timing"}),"\n",(0,r.jsx)(n.h3,{id:"staraddevent",children:"StarAddEvent"}),"\n",(0,r.jsxs)(n.p,{children:["Fired ",(0,r.jsx)(n.strong,{children:"after"})," the star rating is saved to database:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Execution order:\n// 1. Validate input\n// 2. Create star record\n// 3. Save to database\n// 4. Fire StarAddEvent \u2190 Event fired here\n// 5. Return response\n"})}),"\n",(0,r.jsx)(n.h3,{id:"starupdatingevent--starupdatedevent",children:"StarUpdatingEvent / StarUpdatedEvent"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"StarUpdatingEvent"}),": Fired ",(0,r.jsx)(n.strong,{children:"before"})," the update operation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"StarUpdatedEvent"}),": Fired ",(0,r.jsx)(n.strong,{children:"after"})," the update operation completes"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Execution order:\n// 1. Validate input\n// 2. Fire StarUpdatingEvent \u2190 Before update\n// 3. Update star record\n// 4. Save to database\n// 5. Fire StarUpdatedEvent \u2190 After update\n// 6. Return response\n"})}),"\n",(0,r.jsx)(n.h3,{id:"starremovingevent--starremovedevent",children:"StarRemovingEvent / StarRemovedEvent"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"StarRemovingEvent"}),": Fired ",(0,r.jsx)(n.strong,{children:"before"})," the deletion operation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"StarRemovedEvent"}),": Fired ",(0,r.jsx)(n.strong,{children:"after"})," the deletion operation completes"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Execution order:\n// 1. Fire StarRemovingEvent \u2190 Before deletion\n// 2. Delete star record\n// 3. Fire StarRemovedEvent \u2190 After deletion\n// 4. Return response\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Important Notes"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The model is ",(0,r.jsx)(n.strong,{children:"saved"})," to database before ",(0,r.jsx)(n.code,{children:"StarAddEvent"})," fires"]}),"\n",(0,r.jsxs)(n.li,{children:["You can access ",(0,r.jsx)(n.strong,{children:"fresh model data"})," in listeners"]}),"\n",(0,r.jsxs)(n.li,{children:["Database transaction is ",(0,r.jsx)(n.strong,{children:"committed"})," before events fire"]}),"\n",(0,r.jsxs)(n.li,{children:["Events are ",(0,r.jsx)(n.strong,{children:"synchronous"})," by default (can be queued)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"StarUpdatingEvent"})," and ",(0,r.jsx)(n.code,{children:"StarRemovingEvent"})," allow you to ",(0,r.jsx)(n.strong,{children:"prevent"})," operations if needed"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"queued-events",children:"Queued Events"}),"\n",(0,r.jsx)(n.p,{children:"You can queue events for asynchronous processing:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\Star;\n\nuse Illuminate\\Contracts\\Queue\\ShouldQueue;\nuse JobMetric\\Star\\Events\\StarAddEvent;\n\nclass ProcessStarAsync implements ShouldQueue\n{\n    public function handle(StarAddEvent $event): void\n    {\n        $star = $event->star;\n        \n        // Heavy processing that doesn't block the request\n        $this->updateSearchIndex($star);\n        $this->sendWelcomeNotifications($star);\n        $this->generateAnalyticsReport($star);\n    }\n\n    protected function updateSearchIndex($star): void\n    {\n        // Update search index with new rating\n    }\n\n    protected function sendWelcomeNotifications($star): void\n    {\n        // Send notifications\n    }\n\n    protected function generateAnalyticsReport($star): void\n    {\n        // Generate analytics\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"event-payload-details",children:"Event Payload Details"}),"\n",(0,r.jsx)(n.h3,{id:"staraddevent-1",children:"StarAddEvent"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"readonly class StarAddEvent implements DomainEvent\n{\n    public function __construct(\n        public Star $star  // Complete Star model instance\n    ) {}\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsxs)(n.strong,{children:["Available Properties on ",(0,r.jsx)(n.code,{children:"$star"})]}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),": Star ID"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"rate"}),": Rating value (1-5 or configured range)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"starable_type"}),": Type of rated model"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"starable_id"}),": ID of rated model"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"starrer_type"}),": Type of rating entity (User, Device, etc.)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"starrer_id"}),": ID of rating entity"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"device_id"}),": Device identifier (if anonymous)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ip_address"}),": IP address of rater"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"source"}),": Source of rating"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"created_at"}),": Creation timestamp"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"updated_at"}),": Update timestamp"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"starupdatingevent--starupdatedevent-1",children:"StarUpdatingEvent / StarUpdatedEvent"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"readonly class StarUpdatedEvent implements DomainEvent\n{\n    public function __construct(\n        public Star $star,  // Star model instance\n        public int $rate    // New rating value\n    ) {}\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Available Properties"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$star"}),": Star model instance (with old ",(0,r.jsx)(n.code,{children:"rate"})," value in ",(0,r.jsx)(n.code,{children:"getOriginal('rate')"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$rate"}),": New rating value being set"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"starremovingevent--starremovedevent-1",children:"StarRemovingEvent / StarRemovedEvent"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"readonly class StarRemovedEvent implements DomainEvent\n{\n    public function __construct(\n        public Star $star  // Star model instance (before deletion)\n    ) {}\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Available Properties"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$star"}),": Star model instance (still accessible before deletion)"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"when-to-use-events",children:"When to Use Events"}),"\n",(0,r.jsx)(n.p,{children:"Use events when you need to:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cache Management"}),": Invalidate or update cached rating data"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Notifications"}),": Send notifications when ratings change"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Analytics"}),": Track rating operations for analytics"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Audit Logging"}),": Log rating changes for compliance"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Rating Aggregation"}),": Update average ratings and counts"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Real-time Updates"}),": Broadcast rating changes to clients"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Spam Detection"}),": Detect and handle spam ratings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Integration"}),": Integrate with external services"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Side Effects"}),": Perform side effects without coupling"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(i.A,{to:"/packages/laravel-star/deep-diving/has-star",children:"HasStar"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(i.A,{to:"/packages/laravel-star/deep-diving/can-star",children:"CanStar"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(i.A,{to:"/packages/laravel-star/deep-diving/models/star",children:"Star Model"}),"\n"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(v,{...e})}):v(e)}}}]);