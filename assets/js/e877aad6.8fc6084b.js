"use strict";(globalThis.webpackChunkjobmetric_document=globalThis.webpackChunkjobmetric_document||[]).push([[1782],{6079(e,n,t){t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"laravel-flow/deep-diving/events","title":"Events","description":"Laravel Flow provides a comprehensive event system that fires domain events for all CRUD operations on Flow entities. These events allow you to hook into the workflow lifecycle and perform additional actions when flows, states, tasks, or transitions are created, updated, or deleted.","source":"@site/packages/laravel-flow/deep-diving/events.md","sourceDirName":"laravel-flow/deep-diving","slug":"/laravel-flow/deep-diving/events","permalink":"/packages/laravel-flow/deep-diving/events","draft":false,"unlisted":false,"editUrl":"https://github.com/jobmetric/document/blob/master/packages/laravel-flow/deep-diving/events.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8,"sidebar_label":"Events"},"sidebar":"packagesSidebar","previous":{"title":"FlowUseResource","permalink":"/packages/laravel-flow/deep-diving/resources/flow-use-resource"},"next":{"title":"TransitionResult DTO","permalink":"/packages/laravel-flow/deep-diving/transition-result"}}');var l=t(4848),i=t(8453);const o={sidebar_position:8,sidebar_label:"Events"},r="Events",a={},d=[{value:"Overview",id:"overview",level:2},{value:"Event Structure",id:"event-structure",level:2},{value:"Base Event Structure",id:"base-event-structure",level:3},{value:"Available Events",id:"available-events",level:2},{value:"Flow Events",id:"flow-events",level:3},{value:"FlowState Events",id:"flowstate-events",level:3},{value:"FlowTask Events",id:"flowtask-events",level:3},{value:"FlowTransition Events",id:"flowtransition-events",level:3},{value:"Listening to Events",id:"listening-to-events",level:2},{value:"Method 1: Event Listeners in Service Provider",id:"method-1-event-listeners-in-service-provider",level:3},{value:"Method 2: Using Event Facade",id:"method-2-using-event-facade",level:3},{value:"Method 3: Using Event Subscribers",id:"method-3-using-event-subscribers",level:3},{value:"Complete Examples",id:"complete-examples",level:2},{value:"Example 1: Cache Invalidation on Flow Changes",id:"example-1-cache-invalidation-on-flow-changes",level:3},{value:"Example 2: Audit Logging",id:"example-2-audit-logging",level:3},{value:"Example 3: Notification System",id:"example-3-notification-system",level:3},{value:"Example 4: Search Index Update",id:"example-4-search-index-update",level:3},{value:"Example 5: State Change Tracking",id:"example-5-state-change-tracking",level:3},{value:"Example 6: Task Execution Monitoring",id:"example-6-task-execution-monitoring",level:3},{value:"Example 7: Transition Validation Logging",id:"example-7-transition-validation-logging",level:3},{value:"Example 8: Complete Event Listener Setup",id:"example-8-complete-event-listener-setup",level:3},{value:"Event Timing",id:"event-timing",level:2},{value:"Queued Events",id:"queued-events",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Testing Events",id:"testing-events",level:2},{value:"Fake Events in Tests",id:"fake-events-in-tests",level:3},{value:"Assert Event Not Dispatched",id:"assert-event-not-dispatched",level:3},{value:"Assert Multiple Events",id:"assert-multiple-events",level:3},{value:"Related Documentation",id:"related-documentation",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"events",children:"Events"})}),"\n",(0,l.jsx)(n.p,{children:"Laravel Flow provides a comprehensive event system that fires domain events for all CRUD operations on Flow entities. These events allow you to hook into the workflow lifecycle and perform additional actions when flows, states, tasks, or transitions are created, updated, or deleted."}),"\n",(0,l.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,l.jsx)(n.p,{children:"The event system in Laravel Flow:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Fires automatically"})," during CRUD operations"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Provides model instances"})," in event payloads"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Uses DomainEvent interface"})," for consistency"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Supports event listeners"})," for custom logic"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Enables event-driven architecture"})," for workflow management"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"event-structure",children:"Event Structure"}),"\n",(0,l.jsx)(n.p,{children:"All events in Laravel Flow:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Implement ",(0,l.jsx)(n.code,{children:"JobMetric\\EventSystem\\Contracts\\DomainEvent"})]}),"\n",(0,l.jsxs)(n.li,{children:["Are ",(0,l.jsx)(n.code,{children:"readonly"})," classes for immutability"]}),"\n",(0,l.jsx)(n.li,{children:"Contain the affected model instance"}),"\n",(0,l.jsxs)(n.li,{children:["Provide a stable ",(0,l.jsx)(n.code,{children:"key()"})," method"]}),"\n",(0,l.jsxs)(n.li,{children:["Include metadata via ",(0,l.jsx)(n.code,{children:"definition()"})," method"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"base-event-structure",children:"Base Event Structure"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"readonly class FlowStoreEvent implements DomainEvent\n{\n    public function __construct(\n        public Flow $flow\n    ) {}\n\n    public static function key(): string\n    {\n        return 'flow.stored';\n    }\n\n    public static function definition(): DomainEventDefinition\n    {\n        return new DomainEventDefinition(\n            self::key(),\n            'flow::base.events.flow_stored.group',\n            'flow::base.events.flow_stored.title',\n            'flow::base.events.flow_stored.description',\n            'fas fa-save',\n            ['flow', 'storage', 'management']\n        );\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"available-events",children:"Available Events"}),"\n",(0,l.jsx)(n.h3,{id:"flow-events",children:"Flow Events"}),"\n",(0,l.jsx)(n.p,{children:"Events fired for Flow entity CRUD operations."}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Event Class"}),(0,l.jsx)(n.th,{children:"Event Key"}),(0,l.jsx)(n.th,{children:"Description"}),(0,l.jsx)(n.th,{children:"Payload"}),(0,l.jsx)(n.th,{children:"Triggered When"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowStoreEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow.stored"})}),(0,l.jsx)(n.td,{children:"Fired when a new Flow is created"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"Flow $flow"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"Flow::store()"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowUpdateEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow.updated"})}),(0,l.jsx)(n.td,{children:"Fired when an existing Flow is updated"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"Flow $flow"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"Flow::update()"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowDeleteEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow.deleted"})}),(0,l.jsx)(n.td,{children:"Fired when a Flow is soft-deleted"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"Flow $flow"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"Flow::destroy()"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowRestoreEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow.restored"})}),(0,l.jsx)(n.td,{children:"Fired when a soft-deleted Flow is restored"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"Flow $flow"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"Flow::restore()"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowForceDeleteEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow.force_deleted"})}),(0,l.jsx)(n.td,{children:"Fired when a Flow is permanently deleted"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"Flow $flow"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"Flow::forceDelete()"})})]})]})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Namespace:"})," ",(0,l.jsx)(n.code,{children:"JobMetric\\Flow\\Events\\Flow\\*"})]}),"\n",(0,l.jsx)(n.h3,{id:"flowstate-events",children:"FlowState Events"}),"\n",(0,l.jsx)(n.p,{children:"Events fired for FlowState entity CRUD operations."}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Event Class"}),(0,l.jsx)(n.th,{children:"Event Key"}),(0,l.jsx)(n.th,{children:"Description"}),(0,l.jsx)(n.th,{children:"Payload"}),(0,l.jsx)(n.th,{children:"Triggered When"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowStateStoreEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow_state.stored"})}),(0,l.jsx)(n.td,{children:"Fired when a new FlowState is created"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowState $flowState"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowState::store()"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowStateUpdateEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow_state.updated"})}),(0,l.jsx)(n.td,{children:"Fired when an existing FlowState is updated"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowState $flowState"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowState::update()"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowStateDeleteEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow_state.deleted"})}),(0,l.jsx)(n.td,{children:"Fired when a FlowState is deleted"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowState $flowState"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowState::destroy()"})})]})]})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Namespace:"})," ",(0,l.jsx)(n.code,{children:"JobMetric\\Flow\\Events\\FlowState\\*"})]}),"\n",(0,l.jsx)(n.h3,{id:"flowtask-events",children:"FlowTask Events"}),"\n",(0,l.jsx)(n.p,{children:"Events fired for FlowTask entity CRUD operations."}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Event Class"}),(0,l.jsx)(n.th,{children:"Event Key"}),(0,l.jsx)(n.th,{children:"Description"}),(0,l.jsx)(n.th,{children:"Payload"}),(0,l.jsx)(n.th,{children:"Triggered When"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTaskStoreEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow_task.stored"})}),(0,l.jsx)(n.td,{children:"Fired when a new FlowTask is created"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTask $flowTask"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTask::store()"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTaskUpdateEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow_task.updated"})}),(0,l.jsx)(n.td,{children:"Fired when an existing FlowTask is updated"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTask $flowTask"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTask::update()"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTaskDeleteEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow_task.deleted"})}),(0,l.jsx)(n.td,{children:"Fired when a FlowTask is deleted"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTask $flowTask"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTask::destroy()"})})]})]})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Namespace:"})," ",(0,l.jsx)(n.code,{children:"JobMetric\\Flow\\Events\\FlowTask\\*"})]}),"\n",(0,l.jsx)(n.h3,{id:"flowtransition-events",children:"FlowTransition Events"}),"\n",(0,l.jsx)(n.p,{children:"Events fired for FlowTransition entity CRUD operations."}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Event Class"}),(0,l.jsx)(n.th,{children:"Event Key"}),(0,l.jsx)(n.th,{children:"Description"}),(0,l.jsx)(n.th,{children:"Payload"}),(0,l.jsx)(n.th,{children:"Triggered When"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTransitionStoreEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow_transition.stored"})}),(0,l.jsx)(n.td,{children:"Fired when a new FlowTransition is created"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTransition $flowTransition"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTransition::store()"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTransitionUpdateEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow_transition.updated"})}),(0,l.jsx)(n.td,{children:"Fired when an existing FlowTransition is updated"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTransition $flowTransition"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTransition::update()"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTransitionDeleteEvent"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"flow_transition.deleted"})}),(0,l.jsx)(n.td,{children:"Fired when a FlowTransition is deleted"}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTransition $flowTransition"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"FlowTransition::destroy()"})})]})]})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Namespace:"})," ",(0,l.jsx)(n.code,{children:"JobMetric\\Flow\\Events\\FlowTransition\\*"})]}),"\n",(0,l.jsx)(n.h2,{id:"listening-to-events",children:"Listening to Events"}),"\n",(0,l.jsx)(n.h3,{id:"method-1-event-listeners-in-service-provider",children:"Method 1: Event Listeners in Service Provider"}),"\n",(0,l.jsx)(n.p,{children:"Register event listeners in a service provider:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"namespace App\\Providers;\n\nuse Illuminate\\Foundation\\Support\\Providers\\EventServiceProvider as ServiceProvider;\nuse JobMetric\\Flow\\Events\\Flow\\FlowStoreEvent;\nuse JobMetric\\Flow\\Events\\Flow\\FlowUpdateEvent;\nuse JobMetric\\Flow\\Events\\FlowState\\FlowStateStoreEvent;\n\nclass EventServiceProvider extends ServiceProvider\n{\n    protected $listen = [\n        FlowStoreEvent::class => [\n            \\App\\Listeners\\Flow\\LogFlowCreation::class,\n            \\App\\Listeners\\Flow\\InvalidateFlowCache::class,\n        ],\n        FlowUpdateEvent::class => [\n            \\App\\Listeners\\Flow\\LogFlowUpdate::class,\n            \\App\\Listeners\\Flow\\InvalidateFlowCache::class,\n        ],\n        FlowStateStoreEvent::class => [\n            \\App\\Listeners\\FlowState\\UpdateFlowVisualization::class,\n        ],\n    ];\n\n    public function boot(): void\n    {\n        parent::boot();\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"method-2-using-event-facade",children:"Method 2: Using Event Facade"}),"\n",(0,l.jsx)(n.p,{children:"Listen to events using the Event facade:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"use Illuminate\\Support\\Facades\\Event;\nuse JobMetric\\Flow\\Events\\Flow\\FlowStoreEvent;\n\nEvent::listen(FlowStoreEvent::class, function (FlowStoreEvent $event) {\n    $flow = $event->flow;\n    \n    // Perform actions\n    Log::info('Flow created', ['flow_id' => $flow->id]);\n    Cache::forget(\"flow_{$flow->id}\");\n});\n"})}),"\n",(0,l.jsx)(n.h3,{id:"method-3-using-event-subscribers",children:"Method 3: Using Event Subscribers"}),"\n",(0,l.jsx)(n.p,{children:"Create event subscribers for multiple events:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners;\n\nuse Illuminate\\Events\\Dispatcher;\nuse JobMetric\\Flow\\Events\\Flow\\FlowStoreEvent;\nuse JobMetric\\Flow\\Events\\Flow\\FlowUpdateEvent;\nuse JobMetric\\Flow\\Events\\Flow\\FlowDeleteEvent;\n\nclass FlowEventSubscriber\n{\n    public function handleFlowStored(FlowStoreEvent $event): void\n    {\n        $flow = $event->flow;\n        Log::info('Flow stored', ['flow_id' => $flow->id]);\n    }\n\n    public function handleFlowUpdated(FlowUpdateEvent $event): void\n    {\n        $flow = $event->flow;\n        Log::info('Flow updated', ['flow_id' => $flow->id]);\n    }\n\n    public function handleFlowDeleted(FlowDeleteEvent $event): void\n    {\n        $flow = $event->flow;\n        Log::info('Flow deleted', ['flow_id' => $flow->id]);\n    }\n\n    public function subscribe(Dispatcher $events): void\n    {\n        $events->listen(\n            FlowStoreEvent::class,\n            [FlowEventSubscriber::class, 'handleFlowStored']\n        );\n\n        $events->listen(\n            FlowUpdateEvent::class,\n            [FlowEventSubscriber::class, 'handleFlowUpdated']\n        );\n\n        $events->listen(\n            FlowDeleteEvent::class,\n            [FlowEventSubscriber::class, 'handleFlowDeleted']\n        );\n    }\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"Register the subscriber:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"namespace App\\Providers;\n\nuse App\\Listeners\\FlowEventSubscriber;\nuse Illuminate\\Foundation\\Support\\Providers\\EventServiceProvider as ServiceProvider;\n\nclass EventServiceProvider extends ServiceProvider\n{\n    protected $subscribe = [\n        FlowEventSubscriber::class,\n    ];\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"complete-examples",children:"Complete Examples"}),"\n",(0,l.jsx)(n.h3,{id:"example-1-cache-invalidation-on-flow-changes",children:"Example 1: Cache Invalidation on Flow Changes"}),"\n",(0,l.jsx)(n.p,{children:"Invalidate cache when flows are modified:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:'namespace App\\Listeners\\Flow;\n\nuse Illuminate\\Support\\Facades\\Cache;\nuse JobMetric\\Flow\\Events\\Flow\\FlowStoreEvent;\nuse JobMetric\\Flow\\Events\\Flow\\FlowUpdateEvent;\nuse JobMetric\\Flow\\Events\\Flow\\FlowDeleteEvent;\n\nclass InvalidateFlowCache\n{\n    public function handle(FlowStoreEvent|FlowUpdateEvent|FlowDeleteEvent $event): void\n    {\n        $flow = $event->flow;\n\n        // Invalidate specific flow cache\n        Cache::forget("flow_{$flow->id}");\n        Cache::forget("flow_{$flow->id}_states");\n        Cache::forget("flow_{$flow->id}_transitions");\n\n        // Invalidate flow list cache\n        Cache::forget("flows_{$flow->subject_type}");\n\n        // Clear all flow caches\n        forgetFlowCache();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"example-2-audit-logging",children:"Example 2: Audit Logging"}),"\n",(0,l.jsx)(n.p,{children:"Log all flow operations for audit trail:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\Flow;\n\nuse App\\Models\\AuditLog;\nuse Illuminate\\Support\\Facades\\Auth;\nuse JobMetric\\Flow\\Events\\Flow\\FlowStoreEvent;\nuse JobMetric\\Flow\\Events\\Flow\\FlowUpdateEvent;\nuse JobMetric\\Flow\\Events\\Flow\\FlowDeleteEvent;\n\nclass AuditFlowOperations\n{\n    public function handleFlowStored(FlowStoreEvent $event): void\n    {\n        $this->logAudit('created', $event->flow);\n    }\n\n    public function handleFlowUpdated(FlowUpdateEvent $event): void\n    {\n        $this->logAudit('updated', $event->flow);\n    }\n\n    public function handleFlowDeleted(FlowDeleteEvent $event): void\n    {\n        $this->logAudit('deleted', $event->flow);\n    }\n\n    protected function logAudit(string $action, $flow): void\n    {\n        AuditLog::create([\n            'user_id' => Auth::id(),\n            'action' => \"flow.{$action}\",\n            'model_type' => get_class($flow),\n            'model_id' => $flow->id,\n            'changes' => $flow->getChanges(),\n            'ip_address' => request()->ip(),\n        ]);\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"example-3-notification-system",children:"Example 3: Notification System"}),"\n",(0,l.jsx)(n.p,{children:"Send notifications when flows are created or updated:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\Flow;\n\nuse App\\Notifications\\FlowCreated;\nuse App\\Notifications\\FlowUpdated;\nuse Illuminate\\Support\\Facades\\Notification;\nuse JobMetric\\Flow\\Events\\Flow\\FlowStoreEvent;\nuse JobMetric\\Flow\\Events\\Flow\\FlowUpdateEvent;\n\nclass NotifyFlowChanges\n{\n    public function handleFlowStored(FlowStoreEvent $event): void\n    {\n        $flow = $event->flow;\n\n        // Notify administrators\n        $admins = User::whereHas('roles', function ($query) {\n            $query->where('name', 'admin');\n        })->get();\n\n        Notification::send($admins, new FlowCreated($flow));\n    }\n\n    public function handleFlowUpdated(FlowUpdateEvent $event): void\n    {\n        $flow = $event->flow;\n\n        // Notify flow owners\n        if ($flow->created_by) {\n            $owner = User::find($flow->created_by);\n            if ($owner) {\n                $owner->notify(new FlowUpdated($flow));\n            }\n        }\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"example-4-search-index-update",children:"Example 4: Search Index Update"}),"\n",(0,l.jsx)(n.p,{children:"Update search index when flows change:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\Flow;\n\nuse App\\Services\\SearchService;\nuse JobMetric\\Flow\\Events\\Flow\\FlowStoreEvent;\nuse JobMetric\\Flow\\Events\\Flow\\FlowUpdateEvent;\nuse JobMetric\\Flow\\Events\\Flow\\FlowDeleteEvent;\n\nclass UpdateSearchIndex\n{\n    public function __construct(\n        protected SearchService $searchService\n    ) {}\n\n    public function handleFlowStored(FlowStoreEvent $event): void\n    {\n        $this->searchService->indexFlow($event->flow);\n    }\n\n    public function handleFlowUpdated(FlowUpdateEvent $event): void\n    {\n        $this->searchService->updateFlow($event->flow);\n    }\n\n    public function handleFlowDeleted(FlowDeleteEvent $event): void\n    {\n        $this->searchService->removeFlow($event->flow->id);\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"example-5-state-change-tracking",children:"Example 5: State Change Tracking"}),"\n",(0,l.jsx)(n.p,{children:"Track state changes when FlowStates are modified:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\FlowState;\n\nuse App\\Models\\StateChangeHistory;\nuse JobMetric\\Flow\\Events\\FlowState\\FlowStateStoreEvent;\nuse JobMetric\\Flow\\Events\\FlowState\\FlowStateUpdateEvent;\nuse JobMetric\\Flow\\Events\\FlowState\\FlowStateDeleteEvent;\n\nclass TrackStateChanges\n{\n    public function handleStateStored(FlowStateStoreEvent $event): void\n    {\n        $this->recordChange('created', $event->flowState);\n    }\n\n    public function handleStateUpdated(FlowStateUpdateEvent $event): void\n    {\n        $this->recordChange('updated', $event->flowState);\n    }\n\n    public function handleStateDeleted(FlowStateDeleteEvent $event): void\n    {\n        $this->recordChange('deleted', $event->flowState);\n    }\n\n    protected function recordChange(string $action, $state): void\n    {\n        StateChangeHistory::create([\n            'flow_id' => $state->flow_id,\n            'state_id' => $state->id,\n            'action' => $action,\n            'changes' => $state->getChanges(),\n            'performed_by' => auth()->id(),\n            'performed_at' => now(),\n        ]);\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"example-6-task-execution-monitoring",children:"Example 6: Task Execution Monitoring"}),"\n",(0,l.jsx)(n.p,{children:"Monitor task changes for analytics:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\FlowTask;\n\nuse App\\Services\\AnalyticsService;\nuse JobMetric\\Flow\\Events\\FlowTask\\FlowTaskStoreEvent;\nuse JobMetric\\Flow\\Events\\FlowTask\\FlowTaskUpdateEvent;\nuse JobMetric\\Flow\\Events\\FlowTask\\FlowTaskDeleteEvent;\n\nclass MonitorTaskChanges\n{\n    public function __construct(\n        protected AnalyticsService $analytics\n    ) {}\n\n    public function handleTaskStored(FlowTaskStoreEvent $event): void\n    {\n        $task = $event->flowTask;\n        \n        $this->analytics->track('flow_task.created', [\n            'task_id' => $task->id,\n            'flow_id' => $task->flow_id,\n            'transition_id' => $task->flow_transition_id,\n            'driver' => $task->driver,\n            'type' => $task->type,\n        ]);\n    }\n\n    public function handleTaskUpdated(FlowTaskUpdateEvent $event): void\n    {\n        $task = $event->flowTask;\n        \n        $this->analytics->track('flow_task.updated', [\n            'task_id' => $task->id,\n            'changes' => $task->getChanges(),\n        ]);\n    }\n\n    public function handleTaskDeleted(FlowTaskDeleteEvent $event): void\n    {\n        $task = $event->flowTask;\n        \n        $this->analytics->track('flow_task.deleted', [\n            'task_id' => $task->id,\n        ]);\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"example-7-transition-validation-logging",children:"Example 7: Transition Validation Logging"}),"\n",(0,l.jsx)(n.p,{children:"Log transition changes for debugging:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\FlowTransition;\n\nuse Illuminate\\Support\\Facades\\Log;\nuse JobMetric\\Flow\\Events\\FlowTransition\\FlowTransitionStoreEvent;\nuse JobMetric\\Flow\\Events\\FlowTransition\\FlowTransitionUpdateEvent;\nuse JobMetric\\Flow\\Events\\FlowTransition\\FlowTransitionDeleteEvent;\n\nclass LogTransitionChanges\n{\n    public function handleTransitionStored(FlowTransitionStoreEvent $event): void\n    {\n        $transition = $event->flowTransition;\n        \n        Log::info('Flow transition created', [\n            'transition_id' => $transition->id,\n            'flow_id' => $transition->flow_id,\n            'from_state' => $transition->from,\n            'to_state' => $transition->to,\n            'slug' => $transition->slug,\n        ]);\n    }\n\n    public function handleTransitionUpdated(FlowTransitionUpdateEvent $event): void\n    {\n        $transition = $event->flowTransition;\n        \n        Log::info('Flow transition updated', [\n            'transition_id' => $transition->id,\n            'changes' => $transition->getChanges(),\n        ]);\n    }\n\n    public function handleTransitionDeleted(FlowTransitionDeleteEvent $event): void\n    {\n        $transition = $event->flowTransition;\n        \n        Log::warning('Flow transition deleted', [\n            'transition_id' => $transition->id,\n            'flow_id' => $transition->flow_id,\n        ]);\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"example-8-complete-event-listener-setup",children:"Example 8: Complete Event Listener Setup"}),"\n",(0,l.jsx)(n.p,{children:"Complete setup for all flow events:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"namespace App\\Providers;\n\nuse App\\Listeners\\Flow\\AuditFlowOperations;\nuse App\\Listeners\\Flow\\InvalidateFlowCache;\nuse App\\Listeners\\Flow\\NotifyFlowChanges;\nuse App\\Listeners\\FlowState\\TrackStateChanges;\nuse App\\Listeners\\FlowTask\\MonitorTaskChanges;\nuse App\\Listeners\\FlowTransition\\LogTransitionChanges;\nuse Illuminate\\Foundation\\Support\\Providers\\EventServiceProvider as ServiceProvider;\nuse JobMetric\\Flow\\Events\\Flow\\FlowDeleteEvent;\nuse JobMetric\\Flow\\Events\\Flow\\FlowStoreEvent;\nuse JobMetric\\Flow\\Events\\Flow\\FlowUpdateEvent;\nuse JobMetric\\Flow\\Events\\FlowState\\FlowStateDeleteEvent;\nuse JobMetric\\Flow\\Events\\FlowState\\FlowStateStoreEvent;\nuse JobMetric\\Flow\\Events\\FlowState\\FlowStateUpdateEvent;\nuse JobMetric\\Flow\\Events\\FlowTask\\FlowTaskDeleteEvent;\nuse JobMetric\\Flow\\Events\\FlowTask\\FlowTaskStoreEvent;\nuse JobMetric\\Flow\\Events\\FlowTask\\FlowTaskUpdateEvent;\nuse JobMetric\\Flow\\Events\\FlowTransition\\FlowTransitionDeleteEvent;\nuse JobMetric\\Flow\\Events\\FlowTransition\\FlowTransitionStoreEvent;\nuse JobMetric\\Flow\\Events\\FlowTransition\\FlowTransitionUpdateEvent;\n\nclass EventServiceProvider extends ServiceProvider\n{\n    protected $listen = [\n        // Flow events\n        FlowStoreEvent::class => [\n            AuditFlowOperations::class,\n            InvalidateFlowCache::class,\n            NotifyFlowChanges::class,\n        ],\n        FlowUpdateEvent::class => [\n            AuditFlowOperations::class,\n            InvalidateFlowCache::class,\n            NotifyFlowChanges::class,\n        ],\n        FlowDeleteEvent::class => [\n            AuditFlowOperations::class,\n            InvalidateFlowCache::class,\n        ],\n\n        // FlowState events\n        FlowStateStoreEvent::class => [\n            TrackStateChanges::class,\n        ],\n        FlowStateUpdateEvent::class => [\n            TrackStateChanges::class,\n        ],\n        FlowStateDeleteEvent::class => [\n            TrackStateChanges::class,\n        ],\n\n        // FlowTask events\n        FlowTaskStoreEvent::class => [\n            MonitorTaskChanges::class,\n        ],\n        FlowTaskUpdateEvent::class => [\n            MonitorTaskChanges::class,\n        ],\n        FlowTaskDeleteEvent::class => [\n            MonitorTaskChanges::class,\n        ],\n\n        // FlowTransition events\n        FlowTransitionStoreEvent::class => [\n            LogTransitionChanges::class,\n        ],\n        FlowTransitionUpdateEvent::class => [\n            LogTransitionChanges::class,\n        ],\n        FlowTransitionDeleteEvent::class => [\n            LogTransitionChanges::class,\n        ],\n    ];\n\n    public function boot(): void\n    {\n        parent::boot();\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"event-timing",children:"Event Timing"}),"\n",(0,l.jsxs)(n.p,{children:["Events are fired ",(0,l.jsx)(n.strong,{children:"after"})," the database operation completes:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"// Execution order:\n// 1. Validate input\n// 2. Perform database operation (create/update/delete)\n// 3. Fire event \u2190 Event fired here\n// 4. Return response\n"})}),"\n",(0,l.jsx)(n.p,{children:"This means:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["The model is ",(0,l.jsx)(n.strong,{children:"saved"})," to database before event fires"]}),"\n",(0,l.jsxs)(n.li,{children:["You can access ",(0,l.jsx)(n.strong,{children:"fresh model data"})," in listeners"]}),"\n",(0,l.jsxs)(n.li,{children:["Database transaction is ",(0,l.jsx)(n.strong,{children:"committed"})," before event fires"]}),"\n",(0,l.jsxs)(n.li,{children:["Events are ",(0,l.jsx)(n.strong,{children:"synchronous"})," by default (can be queued)"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"queued-events",children:"Queued Events"}),"\n",(0,l.jsx)(n.p,{children:"You can queue events for asynchronous processing:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"namespace App\\Listeners\\Flow;\n\nuse Illuminate\\Contracts\\Queue\\ShouldQueue;\nuse JobMetric\\Flow\\Events\\Flow\\FlowStoreEvent;\n\nclass ProcessFlowAsync implements ShouldQueue\n{\n    public function handle(FlowStoreEvent $event): void\n    {\n        $flow = $event->flow;\n        \n        // Heavy processing\n        $this->generateFlowDocumentation($flow);\n        $this->updateSearchIndex($flow);\n        $this->sendNotifications($flow);\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Keep Listeners Lightweight"}),": Perform heavy operations asynchronously"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"// \u2705 Good: Queue heavy operations\nclass HeavyOperationListener implements ShouldQueue\n{\n    public function handle($event) { /* ... */ }\n}\n\n// \u274c Bad: Blocking operations in listener\nclass HeavyOperationListener\n{\n    public function handle($event) {\n        sleep(10); // Blocks execution\n    }\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Handle Failures Gracefully"}),": Use try-catch in listeners"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"public function handle(FlowStoreEvent $event): void\n{\n    try {\n        // Operation that might fail\n        $this->externalService->sync($event->flow);\n    } catch (\\Exception $e) {\n        Log::error('Failed to sync flow', [\n            'flow_id' => $event->flow->id,\n            'error' => $e->getMessage(),\n        ]);\n    }\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Avoid Circular Events"}),": Don't trigger events that cause the same event"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"// \u274c Bad: Circular event\npublic function handle(FlowStoreEvent $event): void\n{\n    // This will fire FlowStoreEvent again!\n    Flow::store([...]);\n}\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Use Event Keys for Filtering"}),": Filter events by key if needed"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"Event::listen(function ($event) {\n    if (method_exists($event, 'key')) {\n        $key = $event::key();\n        if (str_starts_with($key, 'flow.')) {\n            // Handle flow events\n        }\n    }\n});\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Test Event Listeners"}),": Write tests for your listeners"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"public function test_flow_store_event_triggers_cache_invalidation(): void\n{\n    Event::fake();\n    \n    Flow::store([...]);\n    \n    Event::assertDispatched(FlowStoreEvent::class);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"testing-events",children:"Testing Events"}),"\n",(0,l.jsx)(n.h3,{id:"fake-events-in-tests",children:"Fake Events in Tests"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"use Illuminate\\Support\\Facades\\Event;\nuse JobMetric\\Flow\\Events\\Flow\\FlowStoreEvent;\n\npublic function test_flow_creation_fires_event(): void\n{\n    Event::fake();\n\n    $flow = Flow::store([...]);\n\n    Event::assertDispatched(FlowStoreEvent::class, function ($event) use ($flow) {\n        return $event->flow->id === $flow->id;\n    });\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"assert-event-not-dispatched",children:"Assert Event Not Dispatched"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"Event::fake();\n\n// Perform operation that shouldn't fire event\nFlow::query()->where('id', 999)->delete();\n\nEvent::assertNotDispatched(FlowDeleteEvent::class);\n"})}),"\n",(0,l.jsx)(n.h3,{id:"assert-multiple-events",children:"Assert Multiple Events"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-php",children:"Event::fake();\n\nFlow::store([...]);\nFlow::update($id, [...]);\n\nEvent::assertDispatched(FlowStoreEvent::class);\nEvent::assertDispatched(FlowUpdateEvent::class);\n"})}),"\n",(0,l.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"/packages/laravel-flow/deep-diving/services/flow",children:"Flow Service"})," - Flow management"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"/packages/laravel-flow/deep-diving/services/flow-state",children:"FlowState Service"})," - State management"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"/packages/laravel-flow/deep-diving/services/flow-task",children:"FlowTask Service"})," - Task management"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"/packages/laravel-flow/deep-diving/services/flow-transition",children:"FlowTransition Service"})," - Transition management"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"/packages/laravel-flow/deep-diving/requests/store-flow-request",children:"StoreFlowRequest"})," - Flow creation validation"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"/packages/laravel-flow/deep-diving/requests/update-flow-request",children:"UpdateFlowRequest"})," - Flow update validation"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(c,{...e})}):c(e)}},8453(e,n,t){t.d(n,{R:()=>o,x:()=>r});var s=t(6540);const l={},i=s.createContext(l);function o(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);