<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-packages docs-version-current docs-doc-page docs-doc-id-laravel-flow/deep-diving/support/flow-task-context" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">FlowTaskContext | JobMetric</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jobmetric.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://jobmetric.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://jobmetric.github.io/packages/laravel-flow/deep-diving/support/flow-task-context"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-packages-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-packages-current"><meta data-rh="true" property="og:title" content="FlowTaskContext | JobMetric"><meta data-rh="true" name="description" content="The FlowTaskContext class provides runtime context for flow task execution. It carries all relevant data needed by tasks during transition execution, including the subject model, transition result, payload, user, and task configuration."><meta data-rh="true" property="og:description" content="The FlowTaskContext class provides runtime context for flow task execution. It carries all relevant data needed by tasks during transition execution, including the subject model, transition result, payload, user, and task configuration."><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://jobmetric.github.io/packages/laravel-flow/deep-diving/support/flow-task-context"><link data-rh="true" rel="alternate" href="https://jobmetric.github.io/packages/laravel-flow/deep-diving/support/flow-task-context" hreflang="en"><link data-rh="true" rel="alternate" href="https://jobmetric.github.io/packages/laravel-flow/deep-diving/support/flow-task-context" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Laravel Flow","item":"https://jobmetric.github.io/packages/laravel-flow/"},{"@type":"ListItem","position":2,"name":"FlowTaskContext","item":"https://jobmetric.github.io/packages/laravel-flow/deep-diving/support/flow-task-context"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="JobMetric RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="JobMetric Atom Feed"><link rel="stylesheet" href="/assets/css/styles.aeeec671.css">
<script src="/assets/js/runtime~main.29e7f198.js" defer="defer"></script>
<script src="/assets/js/main.0e88ba72.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="JobMetric Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="JobMetric Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">JobMetric</b></a><div class="navbar__item"><div id="projects-dropdown-container"></div></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/packages/intro">Packages</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/team">Team</a><a href="https://github.com/jobmetric" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/packages/intro"><span title="Packages" class="linkLabel_WmDU">Packages</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/packages/contributing"><span title="Contributing" class="linkLabel_WmDU">Contributing</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/packages/licence"><span title="License" class="linkLabel_WmDU">License</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/packages/laravel-flow/"><span title="Laravel Flow" class="categoryLinkLabel_W154">Laravel Flow</span></a><button aria-label="Collapse sidebar category &#x27;Laravel Flow&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/intro"><span title="Getting Started" class="linkLabel_WmDU">Getting Started</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/installation"><span title="Installation" class="linkLabel_WmDU">Installation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/showcase"><span title="Showcase" class="linkLabel_WmDU">Showcase</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/packages/laravel-flow/deep-diving/has-workflow"><span title="Deep Diving in Document" class="categoryLinkLabel_W154">Deep Diving in Document</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/has-workflow"><span title="HasWorkflow" class="linkLabel_WmDU">HasWorkflow</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/has-flow"><span title="HasFlow" class="linkLabel_WmDU">HasFlow</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/packages/laravel-flow/deep-diving/services/flow"><span title="Services" class="categoryLinkLabel_W154">Services</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/make-task"><span title="MakeTask Command" class="linkLabel_WmDU">MakeTask Command</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/packages/laravel-flow/deep-diving/support/flow-task-registry"><span title="Support" class="categoryLinkLabel_W154">Support</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/support/flow-task-registry"><span title="FlowTaskRegistry" class="linkLabel_WmDU">FlowTaskRegistry</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/support/flow-picker"><span title="FlowPicker" class="linkLabel_WmDU">FlowPicker</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/support/flow-picker-builder"><span title="FlowPickerBuilder" class="linkLabel_WmDU">FlowPickerBuilder</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/packages/laravel-flow/deep-diving/support/flow-task-context"><span title="FlowTaskContext" class="linkLabel_WmDU">FlowTaskContext</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/support/restriction-result"><span title="RestrictionResult" class="linkLabel_WmDU">RestrictionResult</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/packages/laravel-flow/deep-diving/requests/store-flow-request"><span title="Requests" class="categoryLinkLabel_W154">Requests</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/packages/laravel-flow/deep-diving/resources/flow-resource"><span title="Resources" class="categoryLinkLabel_W154">Resources</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/events"><span title="Events" class="linkLabel_WmDU">Events</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/transition-result"><span title="TransitionResult DTO" class="linkLabel_WmDU">TransitionResult DTO</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/packages/laravel-flow/deep-diving/rules/check-status-in-driver-rule"><span title="Rules" class="categoryLinkLabel_W154">Rules</span></a></div></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-translation/"><span title="Laravel Translation" class="categoryLinkLabel_W154">Laravel Translation</span></a><button aria-label="Expand sidebar category &#x27;Laravel Translation&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-event-system/"><span title="Laravel Event System" class="categoryLinkLabel_W154">Laravel Event System</span></a><button aria-label="Expand sidebar category &#x27;Laravel Event System&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-env-modifier/"><span title="Laravel Env Modifier" class="categoryLinkLabel_W154">Laravel Env Modifier</span></a><button aria-label="Expand sidebar category &#x27;Laravel Env Modifier&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-metadata/"><span title="Laravel Metadata" class="categoryLinkLabel_W154">Laravel Metadata</span></a><button aria-label="Expand sidebar category &#x27;Laravel Metadata&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-custom-field/"><span title="Laravel Custom Field" class="categoryLinkLabel_W154">Laravel Custom Field</span></a><button aria-label="Expand sidebar category &#x27;Laravel Custom Field&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-form/"><span title="Laravel Form" class="categoryLinkLabel_W154">Laravel Form</span></a><button aria-label="Expand sidebar category &#x27;Laravel Form&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-reaction/"><span title="Laravel Reaction" class="categoryLinkLabel_W154">Laravel Reaction</span></a><button aria-label="Expand sidebar category &#x27;Laravel Reaction&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-star/"><span title="Laravel Star" class="categoryLinkLabel_W154">Laravel Star</span></a><button aria-label="Expand sidebar category &#x27;Laravel Star&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-language/"><span title="Laravel Language" class="categoryLinkLabel_W154">Laravel Language</span></a><button aria-label="Expand sidebar category &#x27;Laravel Language&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/packages/laravel-flow/"><span>Laravel Flow</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Deep Diving in Document</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Support</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">FlowTaskContext</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>FlowTaskContext</h1></header>
<p>The <code>FlowTaskContext</code> class provides runtime context for flow task execution. It carries all relevant data needed by tasks during transition execution, including the subject model, transition result, payload, user, and task configuration.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="namespace">Namespace<a href="#namespace" class="hash-link" aria-label="Direct link to Namespace" title="Direct link to Namespace" translate="no">​</a></h2>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">JobMetric\Flow\Support\FlowTaskContext</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h2>
<p>The context provides access to:</p>
<ul>
<li class=""><strong>Subject</strong>: The main model instance the flow is operating on</li>
<li class=""><strong>Result</strong>: The <code>TransitionResult</code> for collecting messages, errors, and data</li>
<li class=""><strong>Payload</strong>: Arbitrary input data from form or API request</li>
<li class=""><strong>User</strong>: The authenticated user who triggered the transition</li>
<li class=""><strong>Config</strong>: Cached task configuration (avoiding database calls)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="constructor">Constructor<a href="#constructor" class="hash-link" aria-label="Direct link to Constructor" title="Direct link to Constructor" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="basic-usage">Basic Usage<a href="#basic-usage" class="hash-link" aria-label="Direct link to Basic Usage" title="Direct link to Basic Usage" translate="no">​</a></h3>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\DTO\TransitionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$subject = Order::find(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result = TransitionResult::success();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$payload = [&#x27;reason&#x27; =&gt; &#x27;Customer request&#x27;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$user = auth()-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$context = new FlowTaskContext($subject, $result, $payload, $user);</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="parameters">Parameters<a href="#parameters" class="hash-link" aria-label="Direct link to Parameters" title="Direct link to Parameters" translate="no">​</a></h3>
<ul>
<li class=""><code>Model $subject</code>: The main model instance</li>
<li class=""><code>TransitionResult $result</code>: The transition result object</li>
<li class=""><code>array $payload = []</code>: Input payload (optional)</li>
<li class=""><code>Authenticatable|null $user = null</code>: Authenticated user (optional)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="accessing-context-data">Accessing Context Data<a href="#accessing-context-data" class="hash-link" aria-label="Direct link to Accessing Context Data" title="Direct link to Accessing Context Data" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="subject">subject()<a href="#subject" class="hash-link" aria-label="Direct link to subject()" title="Direct link to subject()" translate="no">​</a></h3>
<p>Get the main subject model:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Returns: Order model instance</span><br></span></code></pre></div></div>
<p><strong>Returns:</strong> <code>Model</code> - The model the flow is operating on</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="result">result()<a href="#result" class="hash-link" aria-label="Direct link to result()" title="Direct link to result()" translate="no">​</a></h3>
<p>Get the transition result:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$result = $context-&gt;result();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result-&gt;addMessage(&#x27;Task completed&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result-&gt;setData(&#x27;key&#x27;, &#x27;value&#x27;);</span><br></span></code></pre></div></div>
<p><strong>Returns:</strong> <code>TransitionResult</code> - The result object for this transition</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="payload">payload()<a href="#payload" class="hash-link" aria-label="Direct link to payload()" title="Direct link to payload()" translate="no">​</a></h3>
<p>Get the input payload:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$reason = $payload[&#x27;reason&#x27;] ?? null;</span><br></span></code></pre></div></div>
<p><strong>Returns:</strong> <code>array&lt;string, mixed&gt;</code> - Input payload from request</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="user">user()<a href="#user" class="hash-link" aria-label="Direct link to user()" title="Direct link to user()" translate="no">​</a></h3>
<p>Get the authenticated user:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ($user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $userId = $user-&gt;id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Returns:</strong> <code>Authenticatable|null</code> - The user who triggered the transition</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="config">config()<a href="#config" class="hash-link" aria-label="Direct link to config()" title="Direct link to config()" translate="no">​</a></h3>
<p>Get the task configuration:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$emailTo = $config[&#x27;email_to&#x27;] ?? null;</span><br></span></code></pre></div></div>
<p><strong>Returns:</strong> <code>array&lt;string, mixed&gt;</code> - Task configuration (empty array if not set)</p>
<p><strong>Note:</strong> No database calls are performed; returns cached configuration</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="replaceconfig">replaceConfig()<a href="#replaceconfig" class="hash-link" aria-label="Direct link to replaceConfig()" title="Direct link to replaceConfig()" translate="no">​</a></h3>
<p>Replace the in-memory configuration:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$context-&gt;replaceConfig([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;email_to&#x27; =&gt; &#x27;user@example.com&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;template&#x27; =&gt; &#x27;order-status&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]);</span><br></span></code></pre></div></div>
<p><strong>Use Cases:</strong></p>
<ul>
<li class="">Inject configuration from outside</li>
<li class="">Override configuration for testing</li>
<li class="">Avoid database calls</li>
</ul>
<p><strong>Returns:</strong> <code>$this</code> (fluent interface)</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="understanding-the-context-flow">Understanding the Context Flow<a href="#understanding-the-context-flow" class="hash-link" aria-label="Direct link to Understanding the Context Flow" title="Direct link to Understanding the Context Flow" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="how-context-is-created-and-passed">How Context is Created and Passed<a href="#how-context-is-created-and-passed" class="hash-link" aria-label="Direct link to How Context is Created and Passed" title="Direct link to How Context is Created and Passed" translate="no">​</a></h3>
<p>When a transition is executed, <code>FlowTransition</code> service automatically creates a <code>FlowTaskContext</code> and passes it to each task:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Inside FlowTransition::runner()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$transitionResult = TransitionResult::success();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$context = new FlowTaskContext(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $subject,           // The model (Order, Invoice, etc.)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $transitionResult,  // Shared result object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $payload,           // Request data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $user               // Authenticated user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Tasks receive the same context instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$restrictionTask-&gt;restriction($context);  // First: Restriction checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$validationTask-&gt;rules($context);          // Second: Validation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$actionTask-&gt;handle($context);             // Third: Actions</span><br></span></code></pre></div></div>
<p><strong>Key Point:</strong> All tasks in a transition share the <strong>same</strong> <code>TransitionResult</code> object. This means:</p>
<ul>
<li class="">Messages/errors from one task are visible to others</li>
<li class="">Data set by one task can be read by subsequent tasks</li>
<li class="">The final result aggregates all task outcomes</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="complete-examples">Complete Examples<a href="#complete-examples" class="hash-link" aria-label="Direct link to Complete Examples" title="Direct link to Complete Examples" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-1-advanced-action-task---order-processing">Example 1: Advanced Action Task - Order Processing<a href="#example-1-advanced-action-task---order-processing" class="hash-link" aria-label="Direct link to Example 1: Advanced Action Task - Order Processing" title="Direct link to Example 1: Advanced Action Task - Order Processing" translate="no">​</a></h3>
<p>A comprehensive action task that demonstrates using all context components:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Mail\OrderStatusChanged;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Notifications\OrderProcessed;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\DB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Mail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Queue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractActionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Form\FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ProcessOrderActionTask extends AbstractActionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function subject(): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return \App\Models\Order::class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function definition(): FlowTaskDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FlowTaskDefinition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title: &#x27;flow::base.task.process_order.title&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description: &#x27;Processes order and sends notifications&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            icon: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tags: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function form(): FormBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (new FormBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;send_email&#x27;, &#x27;boolean&#x27;, true, &#x27;Send email notification&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;send_sms&#x27;, &#x27;boolean&#x27;, false, &#x27;Send SMS notification&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;email_template&#x27;, &#x27;string&#x27;, &#x27;order-status&#x27;, &#x27;Email template name&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;queue_notifications&#x27;, &#x27;boolean&#x27;, true, &#x27;Queue notifications&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;log_activity&#x27;, &#x27;boolean&#x27;, true, &#x27;Log activity&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function handle(FlowTaskContext $context): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get all context components</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();        // Order model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = $context-&gt;result();       // Shared TransitionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();        // Task configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();            // User who triggered transition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();      // Request payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Extract configuration with defaults</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $sendEmail = $config[&#x27;send_email&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $sendSms = $config[&#x27;send_sms&#x27;] ?? false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $emailTemplate = $config[&#x27;email_template&#x27;] ?? &#x27;order-status&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $queueNotifications = $config[&#x27;queue_notifications&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $logActivity = $config[&#x27;log_activity&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Extract payload data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $reason = $payload[&#x27;reason&#x27;] ?? &#x27;Status changed&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $notes = $payload[&#x27;notes&#x27;] ?? &#x27;&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $metadata = $payload[&#x27;metadata&#x27;] ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DB::beginTransaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1. Update order with payload data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (isset($payload[&#x27;notes&#x27;])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $order-&gt;notes = $notes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $order-&gt;save();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. Log activity if enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($logActivity) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $this-&gt;logActivity($order, $user, $reason, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3. Send email notification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($sendEmail) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $this-&gt;sendEmailNotification($order, $user, $emailTemplate, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4. Send SMS notification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($sendSms) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $this-&gt;sendSmsNotification($order, $user, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 5. Queue additional notifications</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($queueNotifications) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $this-&gt;queueNotifications($order, $user, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 6. Update result with success information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&#x27;Order processed successfully&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;addMessage(&#x27;Notifications sent&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;order_id&#x27;, $order-&gt;id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;new_status&#x27;, $order-&gt;status)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;processed_at&#x27;, now()-&gt;toIso8601String())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;email_sent&#x27;, $sendEmail)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;sms_sent&#x27;, $sendSms)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;execution_time&#x27;, microtime(true) - LARAVEL_START);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DB::commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (\Exception $e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DB::rollBack();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Add error to shared result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addError(&#x27;Failed to process order: &#x27; . $e-&gt;getMessage())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;error_class&#x27;, get_class($e))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;error_trace&#x27;, $e-&gt;getTraceAsString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Log error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Log::error(&#x27;Order processing failed&#x27;, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;order_id&#x27; =&gt; $order-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;error&#x27; =&gt; $e-&gt;getMessage(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;user_id&#x27; =&gt; $user?-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function logActivity($order, $user, $reason, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        activity()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;performedOn($order)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;causedBy($user)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;withProperties([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;reason&#x27; =&gt; $reason,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;old_status&#x27; =&gt; $order-&gt;getOriginal(&#x27;status&#x27;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;new_status&#x27; =&gt; $order-&gt;status,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;log(&#x27;Order status changed&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;addMessage(&#x27;Activity logged&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setMeta(&#x27;activity_logged&#x27;, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function sendEmailNotification($order, $user, $template, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $recipient = $user?-&gt;email ?? $order-&gt;customer_email;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($queueNotifications ?? true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Mail::to($recipient)-&gt;queue(new OrderStatusChanged($order, $template));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Mail::to($recipient)-&gt;send(new OrderStatusChanged($order, $template));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Email notification sent to {$recipient}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;email_recipient&#x27;, $recipient)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;email_template&#x27;, $template);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (\Exception $e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Don&#x27;t fail the entire task, just log the error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addError(&#x27;Email notification failed: &#x27; . $e-&gt;getMessage(), false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;email_error&#x27;, $e-&gt;getMessage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function sendSmsNotification($order, $user, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $phone = $user?-&gt;phone ?? $order-&gt;customer_phone;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($phone) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Send SMS logic here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $result-&gt;addMessage(&quot;SMS notification sent to {$phone}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -&gt;setMeta(&#x27;sms_sent_to&#x27;, $phone);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (\Exception $e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addError(&#x27;SMS notification failed: &#x27; . $e-&gt;getMessage(), false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function queueNotifications($order, $user, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Queue additional notifications</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $user-&gt;notify(new OrderProcessed($order));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;setMeta(&#x27;notifications_queued&#x27;, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (\Exception $e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addError(&#x27;Failed to queue notifications: &#x27; . $e-&gt;getMessage(), false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Uses all context components (subject, result, config, user, payload)</li>
<li class="">Reads configuration from <code>config()</code></li>
<li class="">Extracts data from <code>payload()</code></li>
<li class="">Updates shared <code>result()</code> object</li>
<li class="">Handles errors gracefully without breaking the transition</li>
<li class="">Uses user information for logging and notifications</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-2-advanced-restriction-task---multi-condition-order-cancellation">Example 2: Advanced Restriction Task - Multi-Condition Order Cancellation<a href="#example-2-advanced-restriction-task---multi-condition-order-cancellation" class="hash-link" aria-label="Direct link to Example 2: Advanced Restriction Task - Multi-Condition Order Cancellation" title="Direct link to Example 2: Advanced Restriction Task - Multi-Condition Order Cancellation" translate="no">​</a></h3>
<p>A comprehensive restriction task that checks multiple conditions using all context components:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Cache;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\DB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractRestrictionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\RestrictionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Form\FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class RestrictOrderCancellationRestrictionTask extends AbstractRestrictionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function subject(): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return \App\Models\Order::class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function definition(): FlowTaskDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FlowTaskDefinition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title: &#x27;flow::base.task.restrict_cancellation.title&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description: &#x27;Restricts order cancellation based on multiple conditions&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            icon: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tags: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function form(): FormBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (new FormBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;allow_cancellation_after_shipping&#x27;, &#x27;boolean&#x27;, false, &#x27;Allow cancellation after shipping&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;max_cancellation_hours&#x27;, &#x27;integer&#x27;, 24, &#x27;Maximum hours after creation to allow cancellation&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;require_cancellation_reason&#x27;, &#x27;boolean&#x27;, true, &#x27;Require cancellation reason&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;check_payment_status&#x27;, &#x27;boolean&#x27;, true, &#x27;Check payment status&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;check_inventory&#x27;, &#x27;boolean&#x27;, true, &#x27;Check inventory impact&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function restriction(FlowTaskContext $context): RestrictionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get all context components</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = $context-&gt;result(); // Can add messages for debugging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Extract configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $allowAfterShipping = $config[&#x27;allow_cancellation_after_shipping&#x27;] ?? false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $maxCancellationHours = $config[&#x27;max_cancellation_hours&#x27;] ?? 24;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $requireReason = $config[&#x27;require_cancellation_reason&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $checkPayment = $config[&#x27;check_payment_status&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $checkInventory = $config[&#x27;check_inventory&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Check user authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!$user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&#x27;Restriction check: No authenticated user&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;USER_NOT_AUTHENTICATED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;You must be logged in to cancel orders&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Check user permission</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!$user-&gt;can(&#x27;cancel&#x27;, $order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Restriction check: User {$user-&gt;id} lacks cancel permission&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;PERMISSION_DENIED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;You do not have permission to cancel this order&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Check order ownership (if applicable)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;user_id !== $user-&gt;id &amp;&amp; !$user-&gt;hasRole(&#x27;admin&#x27;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Restriction check: User {$user-&gt;id} does not own order {$order-&gt;id}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ORDER_OWNERSHIP_MISMATCH&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;You can only cancel your own orders&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. Check order status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;status === &#x27;shipped&#x27; &amp;&amp; !$allowAfterShipping) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Restriction check: Order {$order-&gt;id} is shipped&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ORDER_SHIPPED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Cannot cancel shipped orders&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;status === &#x27;delivered&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Restriction check: Order {$order-&gt;id} is delivered&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ORDER_DELIVERED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Cannot cancel delivered orders&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;status === &#x27;cancelled&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Restriction check: Order {$order-&gt;id} is already cancelled&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ORDER_ALREADY_CANCELLED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Order is already cancelled&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. Check time limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $hoursSinceCreated = $order-&gt;created_at-&gt;diffInHours(now());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($hoursSinceCreated &gt; $maxCancellationHours) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Restriction check: Order {$order-&gt;id} exceeds time limit ({$hoursSinceCreated}h &gt; {$maxCancellationHours}h)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;TIME_LIMIT_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Orders can only be cancelled within {$maxCancellationHours} hours of creation&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6. Check cancellation reason (from payload)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($requireReason &amp;&amp; empty($payload[&#x27;reason&#x27;])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Restriction check: Cancellation reason required but not provided&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;REASON_REQUIRED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Cancellation reason is required&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 7. Check payment status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($checkPayment) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($order-&gt;payment_status === &#x27;refunded&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;PAYMENT_ALREADY_REFUNDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;Payment has already been refunded&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($order-&gt;payment_status === &#x27;pending&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Allow cancellation if payment not yet processed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $result-&gt;addMessage(&quot;Restriction check: Payment pending, cancellation allowed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 8. Check inventory impact (from payload or config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($checkInventory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $restockInventory = $payload[&#x27;restock_inventory&#x27;] ?? $config[&#x27;restock_inventory&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($restockInventory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Check if inventory can be restocked</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $canRestock = $this-&gt;canRestockInventory($order);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!$canRestock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &#x27;INVENTORY_RESTOCK_FAILED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &#x27;Cannot cancel order: inventory cannot be restocked&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 9. Check for active disputes (custom business logic)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($this-&gt;hasActiveDispute($order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Restriction check: Order {$order-&gt;id} has active dispute&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ACTIVE_DISPUTE&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Cannot cancel order with active dispute&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 10. Check rate limiting (prevent abuse)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $cancellationCount = $this-&gt;getRecentCancellationCount($user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($cancellationCount &gt;= 5) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;RATE_LIMIT_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Too many cancellations. Please contact support.&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // All checks passed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;addMessage(&quot;Restriction check: All conditions met for order {$order-&gt;id}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setMeta(&#x27;cancellation_allowed&#x27;, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setMeta(&#x27;time_since_creation&#x27;, $hoursSinceCreated)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setMeta(&#x27;user_id&#x27;, $user-&gt;id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function canRestockInventory(Order $order): bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check if inventory items can be restocked</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach ($order-&gt;items as $item) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!$item-&gt;product-&gt;canRestock()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function hasActiveDispute(Order $order): bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return $order-&gt;disputes()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;where(&#x27;status&#x27;, &#x27;open&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;exists();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function getRecentCancellationCount(User $user): int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $cacheKey = &quot;user_cancellations_{$user-&gt;id}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Cache::remember($cacheKey, 3600, function () use ($user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $user-&gt;orders()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;where(&#x27;status&#x27;, &#x27;cancelled&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;where(&#x27;updated_at&#x27;, &#x27;&gt;=&#x27;, now()-&gt;subDays(30))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;count();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Uses all context components for comprehensive checks</li>
<li class="">Reads configuration to make restrictions configurable</li>
<li class="">Uses payload data for dynamic checks</li>
<li class="">Adds messages to result for debugging</li>
<li class="">Implements complex business logic</li>
<li class="">Handles edge cases and rate limiting</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-3-advanced-validation-task---dynamic-payment-validation">Example 3: Advanced Validation Task - Dynamic Payment Validation<a href="#example-3-advanced-validation-task---dynamic-payment-validation" class="hash-link" aria-label="Direct link to Example 3: Advanced Validation Task - Dynamic Payment Validation" title="Direct link to Example 3: Advanced Validation Task - Dynamic Payment Validation" translate="no">​</a></h3>
<p>A comprehensive validation task that demonstrates dynamic rule generation based on context:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\DB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractValidationTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Form\FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ValidatePaymentValidationTask extends AbstractValidationTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function subject(): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return \App\Models\Order::class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function definition(): FlowTaskDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FlowTaskDefinition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title: &#x27;flow::base.task.validate_payment.title&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description: &#x27;Validates payment information before processing&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            icon: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tags: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function form(): FormBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (new FormBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;require_cvv&#x27;, &#x27;boolean&#x27;, true, &#x27;Require CVV for credit cards&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;require_billing_address&#x27;, &#x27;boolean&#x27;, true, &#x27;Require billing address&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;min_amount&#x27;, &#x27;decimal&#x27;, 0, &#x27;Minimum payment amount&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;max_amount&#x27;, &#x27;decimal&#x27;, null, &#x27;Maximum payment amount&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;allowed_payment_methods&#x27;, &#x27;array&#x27;, [&#x27;credit_card&#x27;, &#x27;paypal&#x27;], &#x27;Allowed payment methods&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function rules(FlowTaskContext $context): array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get all context components</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Extract configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $requireCvv = $config[&#x27;require_cvv&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $requireBillingAddress = $config[&#x27;require_billing_address&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $minAmount = $config[&#x27;min_amount&#x27;] ?? 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $maxAmount = $config[&#x27;max_amount&#x27;] ?? $order-&gt;total;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $allowedMethods = $config[&#x27;allowed_payment_methods&#x27;] ?? [&#x27;credit_card&#x27;, &#x27;paypal&#x27;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Base rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $rules = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;payment_method&#x27; =&gt; [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;string&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;in:&#x27; . implode(&#x27;,&#x27;, $allowedMethods),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;amount&#x27; =&gt; [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;numeric&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;min:{$minAmount}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;max:{$maxAmount}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Dynamic rules based on payment method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $paymentMethod = $payload[&#x27;payment_method&#x27;] ?? null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($paymentMethod === &#x27;credit_card&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $rules[&#x27;card_number&#x27;] = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;string&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;regex:/^[0-9]{13,19}$/&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $rules[&#x27;card_holder_name&#x27;] = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;string&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;max:255&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $rules[&#x27;expiry_month&#x27;] = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;integer&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;min:1&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;max:12&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $rules[&#x27;expiry_year&#x27;] = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;integer&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;min:&#x27; . date(&#x27;Y&#x27;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;max:&#x27; . (date(&#x27;Y&#x27;) + 10),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($requireCvv) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $rules[&#x27;cvv&#x27;] = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;string&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;regex:/^[0-9]{3,4}$/&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($requireBillingAddress) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $rules[&#x27;billing_address&#x27;] = &#x27;required|string|max:500&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $rules[&#x27;billing_city&#x27;] = &#x27;required|string|max:100&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $rules[&#x27;billing_country&#x27;] = &#x27;required|string|size:2&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $rules[&#x27;billing_postal_code&#x27;] = &#x27;required|string|max:20&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($paymentMethod === &#x27;paypal&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $rules[&#x27;paypal_email&#x27;] = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;email&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Verify PayPal account exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $rules[&#x27;paypal_email&#x27;][] = function ($attribute, $value, $fail) use ($user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!$this-&gt;isValidPayPalAccount($value, $user)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    $fail(&#x27;The PayPal account is not valid or not linked to your account.&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Dynamic amount validation based on order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $rules[&#x27;amount&#x27;][] = function ($attribute, $value, $fail) use ($order, $user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Check if amount matches order total (with tolerance for fees)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $tolerance = 0.01; // 1 cent tolerance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (abs($value - $order-&gt;total) &gt; $tolerance) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $fail(&quot;Payment amount must match order total of {$order-&gt;total}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Check if user has sufficient balance (for wallet payments)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($order-&gt;payment_method === &#x27;wallet&#x27; &amp;&amp; $user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if ($user-&gt;wallet_balance &lt; $value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    $fail(&#x27;Insufficient wallet balance&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Currency validation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isset($payload[&#x27;currency&#x27;])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $rules[&#x27;currency&#x27;] = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;string&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;in:&#x27; . implode(&#x27;,&#x27;, $order-&gt;supported_currencies ?? [&#x27;USD&#x27;]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return $rules;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function messages(FlowTaskContext $context): array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;payment_method.required&#x27; =&gt; &#x27;Payment method is required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;payment_method.in&#x27; =&gt; &#x27;Selected payment method is not allowed&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;amount.required&#x27; =&gt; &#x27;Payment amount is required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;amount.numeric&#x27; =&gt; &#x27;Payment amount must be a number&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;amount.min&#x27; =&gt; &quot;Payment amount must be at least {$config[&#x27;min_amount&#x27;]}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;amount.max&#x27; =&gt; &quot;Payment amount cannot exceed {$order-&gt;total}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;card_number.required&#x27; =&gt; &#x27;Card number is required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;card_number.regex&#x27; =&gt; &#x27;Card number format is invalid&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;cvv.required&#x27; =&gt; &#x27;CVV is required for credit card payments&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;cvv.regex&#x27; =&gt; &#x27;CVV must be 3 or 4 digits&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;paypal_email.required&#x27; =&gt; &#x27;PayPal email is required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;paypal_email.email&#x27; =&gt; &#x27;PayPal email must be a valid email address&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function attributes(FlowTaskContext $context): array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;payment_method&#x27; =&gt; &#x27;payment method&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;amount&#x27; =&gt; &#x27;payment amount&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;card_number&#x27; =&gt; &#x27;card number&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;card_holder_name&#x27; =&gt; &#x27;cardholder name&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;expiry_month&#x27; =&gt; &#x27;expiry month&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;expiry_year&#x27; =&gt; &#x27;expiry year&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;cvv&#x27; =&gt; &#x27;CVV&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;paypal_email&#x27; =&gt; &#x27;PayPal email&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;billing_address&#x27; =&gt; &#x27;billing address&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function isValidPayPalAccount(string $email, ?User $user): bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!$user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check if PayPal account is linked to user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return $user-&gt;paypalAccounts()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;where(&#x27;email&#x27;, $email)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;where(&#x27;verified&#x27;, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;exists();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Dynamic rule generation based on payment method</li>
<li class="">Uses configuration to make validation flexible</li>
<li class="">Uses subject (order) to get context-specific rules</li>
<li class="">Custom validation closures for complex logic</li>
<li class="">Custom messages and attributes for better UX</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-4-complex-payload-processing---order-status-update">Example 4: Complex Payload Processing - Order Status Update<a href="#example-4-complex-payload-processing---order-status-update" class="hash-link" aria-label="Direct link to Example 4: Complex Payload Processing - Order Status Update" title="Direct link to Example 4: Complex Payload Processing - Order Status Update" translate="no">​</a></h3>
<p>Demonstrates comprehensive payload processing with validation and transformation:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\DB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Validator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractActionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class UpdateOrderStatusActionTask extends AbstractActionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function handle(FlowTaskContext $context): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = $context-&gt;result();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Extract and validate payload structure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $newStatus = $payload[&#x27;status&#x27;] ?? null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $reason = $payload[&#x27;reason&#x27;] ?? &#x27;Status updated&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $notes = $payload[&#x27;notes&#x27;] ?? &#x27;&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $metadata = $payload[&#x27;metadata&#x27;] ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $notifyCustomer = $payload[&#x27;notify_customer&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $updateInventory = $payload[&#x27;update_inventory&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $sendEmail = $payload[&#x27;send_email&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Validate payload structure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $validator = Validator::make($payload, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;status&#x27; =&gt; &#x27;required|string|in:pending,processing,shipped,delivered,cancelled&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;reason&#x27; =&gt; &#x27;nullable|string|max:500&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;notes&#x27; =&gt; &#x27;nullable|string|max:1000&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;metadata&#x27; =&gt; &#x27;nullable|array&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;notify_customer&#x27; =&gt; &#x27;boolean&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;update_inventory&#x27; =&gt; &#x27;boolean&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($validator-&gt;fails()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addError(&#x27;Invalid payload: &#x27; . $validator-&gt;errors()-&gt;first());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Store old status for audit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $oldStatus = $order-&gt;status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DB::beginTransaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Update order status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $order-&gt;status = $newStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $order-&gt;status_changed_at = now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $order-&gt;status_changed_by = $user?-&gt;id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Update notes if provided</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!empty($notes)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $order-&gt;notes = ($order-&gt;notes ? $order-&gt;notes . &quot;\n\n&quot; : &#x27;&#x27;) . </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    now()-&gt;format(&#x27;Y-m-d H:i:s&#x27;) . &quot; - {$notes}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Store metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!empty($metadata)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $existingMetadata = $order-&gt;metadata ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $order-&gt;metadata = array_merge($existingMetadata, $metadata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $order-&gt;save();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Update inventory if needed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($updateInventory &amp;&amp; $newStatus === &#x27;cancelled&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $this-&gt;restockInventory($order, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Send notifications</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($notifyCustomer &amp;&amp; $sendEmail) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $this-&gt;sendStatusUpdateEmail($order, $user, $reason, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Log status change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $this-&gt;logStatusChange($order, $oldStatus, $newStatus, $user, $reason, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Update result with complete information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Order status updated from {$oldStatus} to {$newStatus}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;addMessage(&quot;Reason: {$reason}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;order_id&#x27;, $order-&gt;id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;old_status&#x27;, $oldStatus)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;new_status&#x27;, $newStatus)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;status_changed_at&#x27;, $order-&gt;status_changed_at-&gt;toIso8601String())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;status_changed_by&#x27;, $user?-&gt;id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;inventory_updated&#x27;, $updateInventory)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;customer_notified&#x27;, $notifyCustomer &amp;&amp; $sendEmail)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;metadata&#x27;, $metadata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DB::commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (\Exception $e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DB::rollBack();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addError(&#x27;Failed to update order status: &#x27; . $e-&gt;getMessage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function restockInventory(Order $order, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach ($order-&gt;items as $item) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $item-&gt;product-&gt;increment(&#x27;stock&#x27;, $item-&gt;quantity);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Restocked {$item-&gt;quantity} units of {$item-&gt;product-&gt;name}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function sendStatusUpdateEmail(Order $order, $user, $reason, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Email sending logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;addMessage(&#x27;Status update email sent&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function logStatusChange($order, $oldStatus, $newStatus, $user, $reason, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        activity()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;performedOn($order)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;causedBy($user)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;withProperties([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;old_status&#x27; =&gt; $oldStatus,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;new_status&#x27; =&gt; $newStatus,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;reason&#x27; =&gt; $reason,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;log(&#x27;Order status changed&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;setMeta(&#x27;activity_logged&#x27;, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Comprehensive payload extraction with defaults</li>
<li class="">Payload validation before processing</li>
<li class="">Uses payload data to control task behavior</li>
<li class="">Stores payload data in result for tracking</li>
<li class="">Handles nested payload structures</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-5-advanced-user-context-usage---audit-and-authorization">Example 5: Advanced User Context Usage - Audit and Authorization<a href="#example-5-advanced-user-context-usage---audit-and-authorization" class="hash-link" aria-label="Direct link to Example 5: Advanced User Context Usage - Audit and Authorization" title="Direct link to Example 5: Advanced User Context Usage - Audit and Authorization" translate="no">​</a></h3>
<p>Demonstrates comprehensive user context usage for audit trails, authorization, and personalization:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Cache;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractActionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class AuditOrderActionTask extends AbstractActionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function handle(FlowTaskContext $context): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = $context-&gt;result();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Always check if user exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!$user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addError(&#x27;User context is required for audit logging&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. User-based audit logging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;logUserAction($order, $user, $payload, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. User permission verification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;verifyUserPermissions($order, $user, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. User-specific notifications</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;sendUserNotifications($order, $user, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. User preference handling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;applyUserPreferences($order, $user, $payload, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. User activity tracking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;trackUserActivity($order, $user, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6. User-based rate limiting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;checkUserRateLimit($user, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function logUserAction(Order $order, User $user, array $payload, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Comprehensive audit log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $auditData = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;user_id&#x27; =&gt; $user-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;user_email&#x27; =&gt; $user-&gt;email,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;user_name&#x27; =&gt; $user-&gt;name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;user_roles&#x27; =&gt; $user-&gt;roles-&gt;pluck(&#x27;name&#x27;)-&gt;toArray(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;order_id&#x27; =&gt; $order-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;action&#x27; =&gt; $payload[&#x27;action&#x27;] ?? &#x27;unknown&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;ip_address&#x27; =&gt; request()-&gt;ip(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;user_agent&#x27; =&gt; request()-&gt;userAgent(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;timestamp&#x27; =&gt; now()-&gt;toIso8601String(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Log to database</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DB::table(&#x27;audit_logs&#x27;)-&gt;insert($auditData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Log to file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Log::info(&#x27;Order action performed&#x27;, $auditData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Store in result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;setMeta(&#x27;audit_logged&#x27;, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setMeta(&#x27;performed_by&#x27;, $user-&gt;id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setMeta(&#x27;performed_by_email&#x27;, $user-&gt;email)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setData(&#x27;audit_id&#x27;, DB::getPdo()-&gt;lastInsertId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function verifyUserPermissions(Order $order, User $user, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check ownership</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;user_id !== $user-&gt;id &amp;&amp; !$user-&gt;hasRole(&#x27;admin&#x27;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addError(&#x27;User does not have permission to perform this action&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check role-based permissions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $requiredRole = $result-&gt;getData()[&#x27;required_role&#x27;] ?? null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($requiredRole &amp;&amp; !$user-&gt;hasRole($requiredRole)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addError(&quot;User must have {$requiredRole} role&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;addMessage(&quot;User {$user-&gt;id} has required permissions&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setMeta(&#x27;permission_verified&#x27;, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function sendUserNotifications(Order $order, User $user, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get user notification preferences</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $preferences = $user-&gt;notificationPreferences ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Email notification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($preferences[&#x27;email&#x27;] ?? true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Mail::to($user-&gt;email)-&gt;send(new OrderStatusChanged($order));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Email sent to {$user-&gt;email}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // SMS notification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (($preferences[&#x27;sms&#x27;] ?? false) &amp;&amp; $user-&gt;phone) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Send SMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;SMS sent to {$user-&gt;phone}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // In-app notification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user-&gt;notify(new OrderStatusChanged($order));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;addMessage(&quot;In-app notification sent&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;setMeta(&#x27;notifications_sent&#x27;, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setMeta(&#x27;user_notification_preferences&#x27;, $preferences);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function applyUserPreferences(Order $order, User $user, array $payload, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Apply user&#x27;s language preference</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $userLanguage = $user-&gt;language ?? &#x27;en&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app()-&gt;setLocale($userLanguage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Apply user&#x27;s timezone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $userTimezone = $user-&gt;timezone ?? &#x27;UTC&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;setMeta(&#x27;user_timezone&#x27;, $userTimezone);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Apply user&#x27;s currency preference</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $userCurrency = $user-&gt;currency ?? &#x27;USD&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;setMeta(&#x27;user_currency&#x27;, $userCurrency);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Store user preferences in result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;setData(&#x27;applied_language&#x27;, $userLanguage)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setData(&#x27;applied_timezone&#x27;, $userTimezone)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setData(&#x27;applied_currency&#x27;, $userCurrency);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function trackUserActivity(Order $order, User $user, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Track user activity for analytics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $activityKey = &quot;user_activity_{$user-&gt;id}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $activities = Cache::get($activityKey, []);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $activities[] = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;order_id&#x27; =&gt; $order-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;action&#x27; =&gt; &#x27;order_processed&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;timestamp&#x27; =&gt; now()-&gt;toIso8601String(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Keep last 100 activities</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $activities = array_slice($activities, -100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Cache::put($activityKey, $activities, 3600);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;setMeta(&#x27;activity_tracked&#x27;, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setMeta(&#x27;total_activities&#x27;, count($activities));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function checkUserRateLimit(User $user, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $rateLimitKey = &quot;user_rate_limit_{$user-&gt;id}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $currentCount = Cache::get($rateLimitKey, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check if user exceeded rate limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $maxActions = 100; // per hour</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($currentCount &gt;= $maxActions) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addError(&#x27;Rate limit exceeded. Please try again later.&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Increment counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Cache::put($rateLimitKey, $currentCount + 1, 3600);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;setMeta(&#x27;rate_limit_checked&#x27;, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setMeta(&#x27;rate_limit_remaining&#x27;, $maxActions - $currentCount - 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Always checks if user exists before use</li>
<li class="">Uses user information for audit trails</li>
<li class="">Applies user preferences and settings</li>
<li class="">Tracks user activity</li>
<li class="">Implements user-based rate limiting</li>
<li class="">Personalizes experience based on user data</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-6-comprehensive-result-management---multi-task-coordination">Example 6: Comprehensive Result Management - Multi-Task Coordination<a href="#example-6-comprehensive-result-management---multi-task-coordination" class="hash-link" aria-label="Direct link to Example 6: Comprehensive Result Management - Multi-Task Coordination" title="Direct link to Example 6: Comprehensive Result Management - Multi-Task Coordination" translate="no">​</a></h3>
<p>Demonstrates how multiple tasks coordinate through the shared result object:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\DB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractActionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class CoordinateOrderProcessingActionTask extends AbstractActionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function handle(FlowTaskContext $context): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = $context-&gt;result(); // Shared across all tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check if previous tasks succeeded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($result-&gt;hasErrors()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Previous task failed, log but continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&#x27;Continuing despite previous errors&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Read data from previous tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $previousTaskData = $result-&gt;getData();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $emailSent = $previousTaskData[&#x27;email_sent&#x27;] ?? false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $inventoryUpdated = $previousTaskData[&#x27;inventory_updated&#x27;] ?? false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1. Add informational messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&#x27;Starting order coordination&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;addMessage(&quot;Order ID: {$order-&gt;id}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;addMessage(&quot;User: {$user?-&gt;name}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. Set initial data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;setData(&#x27;coordination_started_at&#x27;, now()-&gt;toIso8601String())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;order_id&#x27;, $order-&gt;id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;order_total&#x27;, $order-&gt;total)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;order_status&#x27;, $order-&gt;status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3. Merge data from payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!empty($payload)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $result-&gt;mergeData([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;payload_reason&#x27; =&gt; $payload[&#x27;reason&#x27;] ?? null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;payload_notes&#x27; =&gt; $payload[&#x27;notes&#x27;] ?? null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4. Process based on previous task results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($emailSent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $result-&gt;addMessage(&#x27;Email was sent by previous task&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $result-&gt;addMessage(&#x27;Email was not sent, sending now&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $this-&gt;sendEmail($order, $user, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 5. Add execution metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $startTime = microtime(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Perform operations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $this-&gt;performOperations($order, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $executionTime = microtime(true) - $startTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;setMeta(&#x27;execution_time&#x27;, round($executionTime, 4))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;memory_usage&#x27;, memory_get_peak_usage(true))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;tasks_coordinated&#x27;, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 6. Aggregate all messages for final summary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $allMessages = $result-&gt;getMessages();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Coordination complete. Total messages: &quot; . count($allMessages));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 7. Final data aggregation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $allData = $result-&gt;getData();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;setData(&#x27;total_data_points&#x27;, count($allData))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;coordination_completed_at&#x27;, now()-&gt;toIso8601String());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (\Exception $e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Add error but don&#x27;t fail entire transition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addError(&#x27;Coordination failed: &#x27; . $e-&gt;getMessage(), false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;coordination_error&#x27;, $e-&gt;getMessage())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;coordination_error_class&#x27;, get_class($e));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function sendEmail(Order $order, $user, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Email sending logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;setData(&#x27;email_sent&#x27;, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;addMessage(&#x27;Email sent during coordination&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function performOperations(Order $order, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Operations that update result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;addMessage(&#x27;Operations performed&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setData(&#x27;operations_completed&#x27;, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Reads data from previous tasks via shared result</li>
<li class="">Coordinates multiple tasks through result object</li>
<li class="">Aggregates information from all tasks</li>
<li class="">Handles errors gracefully</li>
<li class="">Tracks execution metrics</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-7-configuration-management---testing-and-overrides">Example 7: Configuration Management - Testing and Overrides<a href="#example-7-configuration-management---testing-and-overrides" class="hash-link" aria-label="Direct link to Example 7: Configuration Management - Testing and Overrides" title="Direct link to Example 7: Configuration Management - Testing and Overrides" translate="no">​</a></h3>
<p>Demonstrates advanced configuration usage, including testing scenarios and dynamic configuration:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractActionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ConfigurableEmailActionTask extends AbstractActionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function handle(FlowTaskContext $context): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = $context-&gt;result();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config(); // Cached, no DB call</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get configuration with intelligent defaults</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $emailTo = $config[&#x27;email_to&#x27;] ?? $order-&gt;customer_email;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $template = $config[&#x27;template&#x27;] ?? &#x27;order-status&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $subject = $config[&#x27;subject&#x27;] ?? &quot;Order #{$order-&gt;id} Status Update&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $cc = $config[&#x27;cc&#x27;] ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $bcc = $config[&#x27;bcc&#x27;] ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $attachInvoice = $config[&#x27;attach_invoice&#x27;] ?? false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $priority = $config[&#x27;priority&#x27;] ?? &#x27;normal&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Use configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mail::to($emailTo)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;cc($cc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;bcc($bcc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;send(new OrderStatusChanged($order, $template, $subject));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;addMessage(&quot;Email sent to {$emailTo}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;setData(&#x27;email_config&#x27;, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;to&#x27; =&gt; $emailTo,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;template&#x27; =&gt; $template,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;subject&#x27; =&gt; $subject,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Usage in Production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Configuration is loaded from database (task config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$context = new FlowTaskContext($order, $result, $payload, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Config is automatically loaded from FlowTask model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Usage in Tests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$context = new FlowTaskContext($order, $result, $payload, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$context-&gt;replaceConfig([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;email_to&#x27; =&gt; &#x27;test@example.com&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;template&#x27; =&gt; &#x27;test-template&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;subject&#x27; =&gt; &#x27;Test Email&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;attach_invoice&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$task-&gt;handle($context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Usage with Dynamic Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$context = new FlowTaskContext($order, $result, $payload, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Override config based on order type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ($order-&gt;is_premium) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $config[&#x27;template&#x27;] = &#x27;premium-order-status&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $config[&#x27;priority&#x27;] = &#x27;high&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$context-&gt;replaceConfig($config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$task-&gt;handle($context);</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Configuration is cached (no DB calls during execution)</li>
<li class="">Can be overridden for testing</li>
<li class="">Supports intelligent defaults</li>
<li class="">Can be modified dynamically based on context</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="real-world-complete-system-example">Real-World Complete System Example<a href="#real-world-complete-system-example" class="hash-link" aria-label="Direct link to Real-World Complete System Example" title="Direct link to Real-World Complete System Example" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="complete-order-cancellation-workflow">Complete Order Cancellation Workflow<a href="#complete-order-cancellation-workflow" class="hash-link" aria-label="Direct link to Complete Order Cancellation Workflow" title="Direct link to Complete Order Cancellation Workflow" translate="no">​</a></h3>
<p>A complete example showing how all context components work together in a real workflow:</p>
<p><strong>1. Restriction Task - Check if cancellation is allowed:</strong></p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class RestrictCancellationRestrictionTask extends AbstractRestrictionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function restriction(FlowTaskContext $context): RestrictionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = $context-&gt;result();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!$user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(&#x27;USER_REQUIRED&#x27;, &#x27;User must be authenticated&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check permission</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!$user-&gt;can(&#x27;cancel&#x27;, $order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;User {$user-&gt;id} lacks cancel permission&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(&#x27;PERMISSION_DENIED&#x27;, &#x27;No permission&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check reason from payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (($config[&#x27;require_reason&#x27;] ?? true) &amp;&amp; empty($payload[&#x27;reason&#x27;])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(&#x27;REASON_REQUIRED&#x27;, &#x27;Reason required&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check order status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;status === &#x27;shipped&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&quot;Order {$order-&gt;id} is shipped, cannot cancel&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(&#x27;ORDER_SHIPPED&#x27;, &#x27;Cannot cancel shipped orders&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;addMessage(&quot;Cancellation allowed for order {$order-&gt;id}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>2. Validation Task - Validate cancellation data:</strong></p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class ValidateCancellationValidationTask extends AbstractValidationTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function rules(FlowTaskContext $context): array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;reason&#x27; =&gt; [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;string&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;min:10&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;max:500&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;refund_method&#x27; =&gt; [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;string&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;in:original,store_credit&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;restock_inventory&#x27; =&gt; [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;boolean&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function messages(FlowTaskContext $context): array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;reason.required&#x27; =&gt; &#x27;Cancellation reason is required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;reason.min&#x27; =&gt; &#x27;Reason must be at least 10 characters&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;refund_method.required&#x27; =&gt; &#x27;Refund method must be selected&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>3. Action Task - Execute cancellation:</strong></p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class CancelOrderActionTask extends AbstractActionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function handle(FlowTaskContext $context): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = $context-&gt;result();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Extract payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $reason = $payload[&#x27;reason&#x27;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $refundMethod = $payload[&#x27;refund_method&#x27;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $restockInventory = $payload[&#x27;restock_inventory&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DB::beginTransaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1. Update order status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $order-&gt;status = &#x27;cancelled&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $order-&gt;cancelled_at = now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $order-&gt;cancelled_by = $user-&gt;id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $order-&gt;cancellation_reason = $reason;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $order-&gt;save();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. Process refund</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $this-&gt;processRefund($order, $refundMethod, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3. Restock inventory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($restockInventory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $this-&gt;restockInventory($order, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4. Send notifications</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $this-&gt;sendNotifications($order, $user, $reason, $result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 5. Update result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addMessage(&#x27;Order cancelled successfully&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;addMessage(&quot;Reason: {$reason}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;order_id&#x27;, $order-&gt;id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;cancelled_at&#x27;, $order-&gt;cancelled_at-&gt;toIso8601String())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;cancelled_by&#x27;, $user-&gt;id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setData(&#x27;refund_method&#x27;, $refundMethod)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;setMeta(&#x27;inventory_restocked&#x27;, $restockInventory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DB::commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (\Exception $e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DB::rollBack();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;addError(&#x27;Cancellation failed: &#x27; . $e-&gt;getMessage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function processRefund(Order $order, string $method, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Refund logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;addMessage(&quot;Refund processed via {$method}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function restockInventory(Order $order, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Restock logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;addMessage(&#x27;Inventory restocked&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function sendNotifications(Order $order, $user, string $reason, $result): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Notification logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result-&gt;addMessage(&#x27;Notifications sent&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>4. Usage in Controller:</strong></p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Http\Controllers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Http\Request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Facades\FlowTransition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class OrderController extends Controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function cancel(Request $request, Order $order)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Prepare payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;reason&#x27; =&gt; $request-&gt;input(&#x27;reason&#x27;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;refund_method&#x27; =&gt; $request-&gt;input(&#x27;refund_method&#x27;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;restock_inventory&#x27; =&gt; $request-&gt;boolean(&#x27;restock_inventory&#x27;, true),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Execute transition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = FlowTransition::runner(&#x27;cancel_order&#x27;, $order, $payload, auth()-&gt;user());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($result-&gt;isSuccess()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;success&#x27; =&gt; true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;message&#x27; =&gt; &#x27;Order cancelled successfully&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;data&#x27; =&gt; $result-&gt;getData(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;success&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;errors&#x27; =&gt; $result-&gt;getErrors(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;messages&#x27; =&gt; $result-&gt;getMessages(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ], 400);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Flow of Context Through Tasks:</strong></p>
<ol>
<li class="">
<p><strong>Restriction Task</strong> receives context:</p>
<ul>
<li class="">Reads <code>subject()</code> (order)</li>
<li class="">Reads <code>user()</code> (permission check)</li>
<li class="">Reads <code>payload()</code> (reason check)</li>
<li class="">Reads <code>config()</code> (require_reason setting)</li>
<li class="">Writes to <code>result()</code> (messages for debugging)</li>
</ul>
</li>
<li class="">
<p><strong>Validation Task</strong> receives same context:</p>
<ul>
<li class="">Reads <code>payload()</code> (validation rules)</li>
<li class="">Reads <code>subject()</code> (order for context)</li>
<li class="">Validation errors go to <code>result()</code></li>
</ul>
</li>
<li class="">
<p><strong>Action Task</strong> receives same context:</p>
<ul>
<li class="">Reads <code>subject()</code> (order to update)</li>
<li class="">Reads <code>user()</code> (who cancelled)</li>
<li class="">Reads <code>payload()</code> (reason, refund method)</li>
<li class="">Reads <code>config()</code> (task settings)</li>
<li class="">Writes to <code>result()</code> (success messages, data, metadata)</li>
</ul>
</li>
</ol>
<p><strong>Key Insight:</strong> All tasks share the <strong>same</strong> <code>TransitionResult</code> object. This means:</p>
<ul>
<li class="">Messages from restriction task are visible in action task</li>
<li class="">Data set by one task can be read by another</li>
<li class="">Errors accumulate across all tasks</li>
<li class="">Final result contains complete workflow outcome</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="integration-with-flowtransition">Integration with FlowTransition<a href="#integration-with-flowtransition" class="hash-link" aria-label="Direct link to Integration with FlowTransition" title="Direct link to Integration with FlowTransition" translate="no">​</a></h2>
<p>The <code>FlowTransition</code> service creates <code>FlowTaskContext</code> instances automatically and passes the same context to all tasks:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Inside FlowTransition::runner()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$transitionResult = TransitionResult::success();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$context = new FlowTaskContext($subject, $transitionResult, $payload, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// All tasks receive the SAME context instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$restrictionTask-&gt;restriction($context);  // Can read/write result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$validationTask-&gt;rules($context);        // Can read result from restriction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$actionTask-&gt;handle($context);           // Can read result from all previous tasks</span><br></span></code></pre></div></div>
<p><strong>Important:</strong> The context is created once and shared. This allows tasks to coordinate and build upon each other&#x27;s work.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="best-practices">Best Practices<a href="#best-practices" class="hash-link" aria-label="Direct link to Best Practices" title="Direct link to Best Practices" translate="no">​</a></h2>
<ol>
<li class="">
<p><strong>Always Check User</strong>: Check if user exists before accessing:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ($user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Use user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
</li>
<li class="">
<p><strong>Use Result Object</strong>: Always use <code>$context-&gt;result()</code> to add messages/errors:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$context-&gt;result()-&gt;addMessage(&#x27;Task completed&#x27;);</span><br></span></code></pre></div></div>
</li>
<li class="">
<p><strong>Validate Payload</strong>: Always validate payload data:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$value = $payload[&#x27;key&#x27;] ?? null;</span><br></span></code></pre></div></div>
</li>
<li class="">
<p><strong>Cache Configuration</strong>: Use <code>replaceConfig()</code> to avoid database calls in tests</p>
</li>
<li class="">
<p><strong>Type Hints</strong>: Use proper type hints when accessing context:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/** @var Order $order */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$order = $context-&gt;subject();</span><br></span></code></pre></div></div>
</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="related-documentation">Related Documentation<a href="#related-documentation" class="hash-link" aria-label="Direct link to Related Documentation" title="Direct link to Related Documentation" translate="no">​</a></h2>
<ul>
<li class=""><a class="" href="/packages/laravel-flow/deep-diving/transition-result">TransitionResult</a> - Transition result DTO</li>
<li class=""><a class="" href="/packages/laravel-flow/deep-diving/support/restriction-result">RestrictionResult</a> - Restriction task results</li>
<li class=""><a class="" href="/packages/laravel-flow/deep-diving/services/flow-transition">FlowTransition Service</a> - Transition execution</li>
<li class=""><a class="" href="/packages/laravel-flow/deep-diving/support/flow-task-registry">FlowTaskRegistry</a> - Task driver registry</li>
<li class=""><a class="" href="/packages/laravel-flow/deep-diving/make-task">MakeTask Command</a> - Generating task drivers</li>
<li class=""><a class="" href="/packages/laravel-flow/deep-diving/services/flow-task">FlowTask Service</a> - Task management</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/jobmetric/document/blob/master/packages/laravel-flow/deep-diving/support/flow-task-context.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/packages/laravel-flow/deep-diving/support/flow-picker-builder"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">FlowPickerBuilder</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/packages/laravel-flow/deep-diving/support/restriction-result"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">RestrictionResult</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#namespace" class="table-of-contents__link toc-highlight">Namespace</a></li><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#constructor" class="table-of-contents__link toc-highlight">Constructor</a><ul><li><a href="#basic-usage" class="table-of-contents__link toc-highlight">Basic Usage</a></li><li><a href="#parameters" class="table-of-contents__link toc-highlight">Parameters</a></li></ul></li><li><a href="#accessing-context-data" class="table-of-contents__link toc-highlight">Accessing Context Data</a><ul><li><a href="#subject" class="table-of-contents__link toc-highlight">subject()</a></li><li><a href="#result" class="table-of-contents__link toc-highlight">result()</a></li><li><a href="#payload" class="table-of-contents__link toc-highlight">payload()</a></li><li><a href="#user" class="table-of-contents__link toc-highlight">user()</a></li><li><a href="#config" class="table-of-contents__link toc-highlight">config()</a></li><li><a href="#replaceconfig" class="table-of-contents__link toc-highlight">replaceConfig()</a></li></ul></li><li><a href="#understanding-the-context-flow" class="table-of-contents__link toc-highlight">Understanding the Context Flow</a><ul><li><a href="#how-context-is-created-and-passed" class="table-of-contents__link toc-highlight">How Context is Created and Passed</a></li></ul></li><li><a href="#complete-examples" class="table-of-contents__link toc-highlight">Complete Examples</a><ul><li><a href="#example-1-advanced-action-task---order-processing" class="table-of-contents__link toc-highlight">Example 1: Advanced Action Task - Order Processing</a></li><li><a href="#example-2-advanced-restriction-task---multi-condition-order-cancellation" class="table-of-contents__link toc-highlight">Example 2: Advanced Restriction Task - Multi-Condition Order Cancellation</a></li><li><a href="#example-3-advanced-validation-task---dynamic-payment-validation" class="table-of-contents__link toc-highlight">Example 3: Advanced Validation Task - Dynamic Payment Validation</a></li><li><a href="#example-4-complex-payload-processing---order-status-update" class="table-of-contents__link toc-highlight">Example 4: Complex Payload Processing - Order Status Update</a></li><li><a href="#example-5-advanced-user-context-usage---audit-and-authorization" class="table-of-contents__link toc-highlight">Example 5: Advanced User Context Usage - Audit and Authorization</a></li><li><a href="#example-6-comprehensive-result-management---multi-task-coordination" class="table-of-contents__link toc-highlight">Example 6: Comprehensive Result Management - Multi-Task Coordination</a></li><li><a href="#example-7-configuration-management---testing-and-overrides" class="table-of-contents__link toc-highlight">Example 7: Configuration Management - Testing and Overrides</a></li></ul></li><li><a href="#real-world-complete-system-example" class="table-of-contents__link toc-highlight">Real-World Complete System Example</a><ul><li><a href="#complete-order-cancellation-workflow" class="table-of-contents__link toc-highlight">Complete Order Cancellation Workflow</a></li></ul></li><li><a href="#integration-with-flowtransition" class="table-of-contents__link toc-highlight">Integration with FlowTransition</a></li><li><a href="#best-practices" class="table-of-contents__link toc-highlight">Best Practices</a></li><li><a href="#related-documentation" class="table-of-contents__link toc-highlight">Related Documentation</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">© 2025 JobMetric.</div></div></div></footer></div>
</body>
</html>