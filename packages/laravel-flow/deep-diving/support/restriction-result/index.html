<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-packages docs-version-current docs-doc-page docs-doc-id-laravel-flow/deep-diving/support/restriction-result" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">RestrictionResult | JobMetric</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jobmetric.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://jobmetric.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://jobmetric.github.io/packages/laravel-flow/deep-diving/support/restriction-result"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-packages-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-packages-current"><meta data-rh="true" property="og:title" content="RestrictionResult | JobMetric"><meta data-rh="true" name="description" content="The RestrictionResult class represents the outcome of a restriction task evaluation. It indicates whether a workflow transition is allowed to proceed and provides machine-readable codes and human-readable messages to explain the decision."><meta data-rh="true" property="og:description" content="The RestrictionResult class represents the outcome of a restriction task evaluation. It indicates whether a workflow transition is allowed to proceed and provides machine-readable codes and human-readable messages to explain the decision."><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://jobmetric.github.io/packages/laravel-flow/deep-diving/support/restriction-result"><link data-rh="true" rel="alternate" href="https://jobmetric.github.io/packages/laravel-flow/deep-diving/support/restriction-result" hreflang="en"><link data-rh="true" rel="alternate" href="https://jobmetric.github.io/packages/laravel-flow/deep-diving/support/restriction-result" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Laravel Flow","item":"https://jobmetric.github.io/packages/laravel-flow/"},{"@type":"ListItem","position":2,"name":"RestrictionResult","item":"https://jobmetric.github.io/packages/laravel-flow/deep-diving/support/restriction-result"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="JobMetric RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="JobMetric Atom Feed"><link rel="stylesheet" href="/assets/css/styles.aeeec671.css">
<script src="/assets/js/runtime~main.29e7f198.js" defer="defer"></script>
<script src="/assets/js/main.0e88ba72.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="JobMetric Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="JobMetric Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">JobMetric</b></a><div class="navbar__item"><div id="projects-dropdown-container"></div></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/packages/intro">Packages</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/team">Team</a><a href="https://github.com/jobmetric" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/packages/intro"><span title="Packages" class="linkLabel_WmDU">Packages</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/packages/contributing"><span title="Contributing" class="linkLabel_WmDU">Contributing</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/packages/licence"><span title="License" class="linkLabel_WmDU">License</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/packages/laravel-flow/"><span title="Laravel Flow" class="categoryLinkLabel_W154">Laravel Flow</span></a><button aria-label="Collapse sidebar category &#x27;Laravel Flow&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/intro"><span title="Getting Started" class="linkLabel_WmDU">Getting Started</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/installation"><span title="Installation" class="linkLabel_WmDU">Installation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/showcase"><span title="Showcase" class="linkLabel_WmDU">Showcase</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/packages/laravel-flow/deep-diving/has-workflow"><span title="Deep Diving in Document" class="categoryLinkLabel_W154">Deep Diving in Document</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/has-workflow"><span title="HasWorkflow" class="linkLabel_WmDU">HasWorkflow</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/has-flow"><span title="HasFlow" class="linkLabel_WmDU">HasFlow</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/packages/laravel-flow/deep-diving/services/flow"><span title="Services" class="categoryLinkLabel_W154">Services</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/make-task"><span title="MakeTask Command" class="linkLabel_WmDU">MakeTask Command</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/packages/laravel-flow/deep-diving/support/flow-task-registry"><span title="Support" class="categoryLinkLabel_W154">Support</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/support/flow-task-registry"><span title="FlowTaskRegistry" class="linkLabel_WmDU">FlowTaskRegistry</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/support/flow-picker"><span title="FlowPicker" class="linkLabel_WmDU">FlowPicker</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/support/flow-picker-builder"><span title="FlowPickerBuilder" class="linkLabel_WmDU">FlowPickerBuilder</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/support/flow-task-context"><span title="FlowTaskContext" class="linkLabel_WmDU">FlowTaskContext</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/packages/laravel-flow/deep-diving/support/restriction-result"><span title="RestrictionResult" class="linkLabel_WmDU">RestrictionResult</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/packages/laravel-flow/deep-diving/requests/store-flow-request"><span title="Requests" class="categoryLinkLabel_W154">Requests</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/packages/laravel-flow/deep-diving/resources/flow-resource"><span title="Resources" class="categoryLinkLabel_W154">Resources</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/events"><span title="Events" class="linkLabel_WmDU">Events</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/packages/laravel-flow/deep-diving/transition-result"><span title="TransitionResult DTO" class="linkLabel_WmDU">TransitionResult DTO</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/packages/laravel-flow/deep-diving/rules/check-status-in-driver-rule"><span title="Rules" class="categoryLinkLabel_W154">Rules</span></a></div></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-translation/"><span title="Laravel Translation" class="categoryLinkLabel_W154">Laravel Translation</span></a><button aria-label="Expand sidebar category &#x27;Laravel Translation&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-event-system/"><span title="Laravel Event System" class="categoryLinkLabel_W154">Laravel Event System</span></a><button aria-label="Expand sidebar category &#x27;Laravel Event System&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-env-modifier/"><span title="Laravel Env Modifier" class="categoryLinkLabel_W154">Laravel Env Modifier</span></a><button aria-label="Expand sidebar category &#x27;Laravel Env Modifier&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-metadata/"><span title="Laravel Metadata" class="categoryLinkLabel_W154">Laravel Metadata</span></a><button aria-label="Expand sidebar category &#x27;Laravel Metadata&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-custom-field/"><span title="Laravel Custom Field" class="categoryLinkLabel_W154">Laravel Custom Field</span></a><button aria-label="Expand sidebar category &#x27;Laravel Custom Field&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-form/"><span title="Laravel Form" class="categoryLinkLabel_W154">Laravel Form</span></a><button aria-label="Expand sidebar category &#x27;Laravel Form&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-reaction/"><span title="Laravel Reaction" class="categoryLinkLabel_W154">Laravel Reaction</span></a><button aria-label="Expand sidebar category &#x27;Laravel Reaction&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-star/"><span title="Laravel Star" class="categoryLinkLabel_W154">Laravel Star</span></a><button aria-label="Expand sidebar category &#x27;Laravel Star&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/packages/laravel-language/"><span title="Laravel Language" class="categoryLinkLabel_W154">Laravel Language</span></a><button aria-label="Expand sidebar category &#x27;Laravel Language&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/packages/laravel-flow/"><span>Laravel Flow</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Deep Diving in Document</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Support</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">RestrictionResult</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>RestrictionResult</h1></header>
<p>The <code>RestrictionResult</code> class represents the outcome of a restriction task evaluation. It indicates whether a workflow transition is allowed to proceed and provides machine-readable codes and human-readable messages to explain the decision.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="namespace">Namespace<a href="#namespace" class="hash-link" aria-label="Direct link to Namespace" title="Direct link to Namespace" translate="no">​</a></h2>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">JobMetric\Flow\Support\RestrictionResult</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h2>
<p><code>RestrictionResult</code> encapsulates:</p>
<ul>
<li class=""><strong>Allowed Flag</strong>: Boolean indicating if the operation is allowed</li>
<li class=""><strong>Code</strong>: Machine-readable code identifying the reason</li>
<li class=""><strong>Message</strong>: Human-readable explanation for UI or logging</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="static-factory-methods">Static Factory Methods<a href="#static-factory-methods" class="hash-link" aria-label="Direct link to Static Factory Methods" title="Direct link to Static Factory Methods" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="allow">allow()<a href="#allow" class="hash-link" aria-label="Direct link to allow()" title="Direct link to allow()" translate="no">​</a></h3>
<p>Create a result that allows the operation:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\RestrictionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result = RestrictionResult::allow();</span><br></span></code></pre></div></div>
<p><strong>Returns:</strong> <code>RestrictionResult</code> with <code>allowed=true</code>, <code>code=null</code>, <code>message=null</code></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="deny">deny()<a href="#deny" class="hash-link" aria-label="Direct link to deny()" title="Direct link to deny()" translate="no">​</a></h3>
<p>Create a result that denies the operation:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// With code only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result = RestrictionResult::deny(&#x27;PERMISSION_DENIED&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// With code and message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result = RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;ORDER_SHIPPED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;Cannot cancel shipped orders&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre></div></div>
<p><strong>Parameters:</strong></p>
<ul>
<li class=""><code>string $code</code>: Machine-readable code (required)</li>
<li class=""><code>?string $message = null</code>: Human-readable message (optional)</li>
</ul>
<p><strong>Returns:</strong> <code>RestrictionResult</code> with <code>allowed=false</code></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="query-methods">Query Methods<a href="#query-methods" class="hash-link" aria-label="Direct link to Query Methods" title="Direct link to Query Methods" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="allowed">allowed()<a href="#allowed" class="hash-link" aria-label="Direct link to allowed()" title="Direct link to allowed()" translate="no">​</a></h3>
<p>Determine if the operation is allowed:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$result = RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result-&gt;allowed(); // true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result = RestrictionResult::deny(&#x27;ERROR_CODE&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result-&gt;allowed(); // false</span><br></span></code></pre></div></div>
<p><strong>Returns:</strong> <code>bool</code></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="code">code()<a href="#code" class="hash-link" aria-label="Direct link to code()" title="Direct link to code()" translate="no">​</a></h3>
<p>Get the machine-readable code:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$result = RestrictionResult::deny(&#x27;PERMISSION_DENIED&#x27;, &#x27;Message&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result-&gt;code(); // &#x27;PERMISSION_DENIED&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result = RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result-&gt;code(); // null</span><br></span></code></pre></div></div>
<p><strong>Returns:</strong> <code>?string</code></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="message">message()<a href="#message" class="hash-link" aria-label="Direct link to message()" title="Direct link to message()" translate="no">​</a></h3>
<p>Get the human-readable message:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$result = RestrictionResult::deny(&#x27;ERROR&#x27;, &#x27;Error message&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result-&gt;message(); // &#x27;Error message&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result = RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$result-&gt;message(); // null</span><br></span></code></pre></div></div>
<p><strong>Returns:</strong> <code>?string</code></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="understanding-restrictionresult-in-workflow-execution">Understanding RestrictionResult in Workflow Execution<a href="#understanding-restrictionresult-in-workflow-execution" class="hash-link" aria-label="Direct link to Understanding RestrictionResult in Workflow Execution" title="Direct link to Understanding RestrictionResult in Workflow Execution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="how-restrictionresult-works">How RestrictionResult Works<a href="#how-restrictionresult-works" class="hash-link" aria-label="Direct link to How RestrictionResult Works" title="Direct link to How RestrictionResult Works" translate="no">​</a></h3>
<p>When a transition is executed, restriction tasks are evaluated <strong>first</strong>:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Inside FlowTransition::runner()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 1. Execute all restriction tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foreach ($restrictionTasks as $task) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $result = $task-&gt;restriction($context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!$result-&gt;allowed()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Transition is DENIED - stop immediately</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new TaskRestrictionException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;code(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;message()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2. If all restrictions pass, continue with validation tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 3. Then execute action tasks</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Restriction tasks run <strong>before</strong> validation and action tasks</li>
<li class="">If <strong>any</strong> restriction denies, the transition stops immediately</li>
<li class="">The code and message are used for error handling and user feedback</li>
<li class="">Multiple restriction tasks can exist - all must allow</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="complete-examples">Complete Examples<a href="#complete-examples" class="hash-link" aria-label="Direct link to Complete Examples" title="Direct link to Complete Examples" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-1-basic-allow---simple-pass-through">Example 1: Basic Allow - Simple Pass-Through<a href="#example-1-basic-allow---simple-pass-through" class="hash-link" aria-label="Direct link to Example 1: Basic Allow - Simple Pass-Through" title="Direct link to Example 1: Basic Allow - Simple Pass-Through" translate="no">​</a></h3>
<p>A simple restriction that always allows (useful for testing or optional restrictions):</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractRestrictionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\RestrictionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Form\FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class BasicAllowRestrictionTask extends AbstractRestrictionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function subject(): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return \App\Models\Order::class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function definition(): FlowTaskDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FlowTaskDefinition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title: &#x27;flow::base.task.basic_allow.title&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description: &#x27;Always allows the transition&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function form(): FormBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function restriction(FlowTaskContext $context): RestrictionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Always allow - no restrictions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Use Cases:</strong></p>
<ul>
<li class="">Testing scenarios</li>
<li class="">Optional restrictions that can be enabled/disabled</li>
<li class="">Placeholder restrictions</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-2-advanced-permission-check---multi-level-authorization">Example 2: Advanced Permission Check - Multi-Level Authorization<a href="#example-2-advanced-permission-check---multi-level-authorization" class="hash-link" aria-label="Direct link to Example 2: Advanced Permission Check - Multi-Level Authorization" title="Direct link to Example 2: Advanced Permission Check - Multi-Level Authorization" translate="no">​</a></h3>
<p>A comprehensive permission check that handles multiple authorization scenarios:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Gate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractRestrictionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\RestrictionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Form\FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class PermissionRestrictionTask extends AbstractRestrictionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function subject(): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return \App\Models\Order::class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function definition(): FlowTaskDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FlowTaskDefinition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title: &#x27;flow::base.task.permission_check.title&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description: &#x27;Checks user permissions before allowing transition&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function form(): FormBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (new FormBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;require_authentication&#x27;, &#x27;boolean&#x27;, true, &#x27;Require user authentication&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;allowed_roles&#x27;, &#x27;array&#x27;, [&#x27;admin&#x27;, &#x27;manager&#x27;], &#x27;Allowed roles&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;check_ownership&#x27;, &#x27;boolean&#x27;, true, &#x27;Check resource ownership&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;require_specific_permission&#x27;, &#x27;string&#x27;, &#x27;cancel&#x27;, &#x27;Required permission&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function restriction(FlowTaskContext $context): RestrictionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Extract configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $requireAuth = $config[&#x27;require_authentication&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $allowedRoles = $config[&#x27;allowed_roles&#x27;] ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $checkOwnership = $config[&#x27;check_ownership&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $requiredPermission = $config[&#x27;require_specific_permission&#x27;] ?? &#x27;cancel&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Check authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($requireAuth &amp;&amp; !$user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;USER_NOT_AUTHENTICATED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;You must be logged in to perform this action&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Check role-based access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!empty($allowedRoles)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $userRoles = $user?-&gt;roles-&gt;pluck(&#x27;name&#x27;)-&gt;toArray() ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $hasAllowedRole = !empty(array_intersect($userRoles, $allowedRoles));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!$hasAllowedRole) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;INSUFFICIENT_ROLE&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;You do not have the required role to perform this action&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Check policy/permission</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($requiredPermission &amp;&amp; $user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!Gate::allows($requiredPermission, $order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;PERMISSION_DENIED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;You do not have permission to {$requiredPermission} this order&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. Check ownership (if enabled)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($checkOwnership &amp;&amp; $user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Admin can access any order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!$user-&gt;hasRole(&#x27;admin&#x27;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if ($order-&gt;user_id !== $user-&gt;id) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &#x27;OWNERSHIP_MISMATCH&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &#x27;You can only perform this action on your own orders&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. Check account status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($user &amp;&amp; $user-&gt;account_status === &#x27;suspended&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ACCOUNT_SUSPENDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Your account is suspended. Please contact support.&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // All permission checks passed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Multiple permission checks in sequence</li>
<li class="">Configurable permission requirements</li>
<li class="">Role-based and policy-based authorization</li>
<li class="">Ownership verification</li>
<li class="">Account status checks</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-3-comprehensive-business-rule-check---order-state-machine">Example 3: Comprehensive Business Rule Check - Order State Machine<a href="#example-3-comprehensive-business-rule-check---order-state-machine" class="hash-link" aria-label="Direct link to Example 3: Comprehensive Business Rule Check - Order State Machine" title="Direct link to Example 3: Comprehensive Business Rule Check - Order State Machine" translate="no">​</a></h3>
<p>A complete business rule check that validates order state transitions:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\DB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractRestrictionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\RestrictionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Form\FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class OrderStateRestrictionTask extends AbstractRestrictionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function subject(): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return \App\Models\Order::class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function definition(): FlowTaskDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FlowTaskDefinition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title: &#x27;flow::base.task.order_state_check.title&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description: &#x27;Validates order state transitions&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function form(): FormBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (new FormBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;allowed_from_statuses&#x27;, &#x27;array&#x27;, [&#x27;pending&#x27;, &#x27;processing&#x27;], &#x27;Allowed source statuses&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;blocked_statuses&#x27;, &#x27;array&#x27;, [&#x27;cancelled&#x27;, &#x27;refunded&#x27;], &#x27;Blocked statuses&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;check_payment_status&#x27;, &#x27;boolean&#x27;, true, &#x27;Check payment status&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;check_inventory&#x27;, &#x27;boolean&#x27;, true, &#x27;Check inventory availability&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function restriction(FlowTaskContext $context): RestrictionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Extract configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $allowedFromStatuses = $config[&#x27;allowed_from_statuses&#x27;] ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $blockedStatuses = $config[&#x27;blocked_statuses&#x27;] ?? [&#x27;cancelled&#x27;, &#x27;refunded&#x27;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $checkPayment = $config[&#x27;check_payment_status&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $checkInventory = $config[&#x27;check_inventory&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get target status from payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $targetStatus = $payload[&#x27;status&#x27;] ?? null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Check if order is in a blocked state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (in_array($order-&gt;status, $blockedStatuses)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ORDER_IN_BLOCKED_STATE&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Cannot transition from &#x27;{$order-&gt;status}&#x27; status&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Check if current status allows transition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!empty($allowedFromStatuses) &amp;&amp; !in_array($order-&gt;status, $allowedFromStatuses)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;INVALID_SOURCE_STATUS&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Cannot transition from &#x27;{$order-&gt;status}&#x27; status. Allowed statuses: &quot; . implode(&#x27;, &#x27;, $allowedFromStatuses)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Check state machine rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $stateMachineRules = $this-&gt;getStateMachineRules();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isset($stateMachineRules[$order-&gt;status])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $allowedTransitions = $stateMachineRules[$order-&gt;status];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($targetStatus &amp;&amp; !in_array($targetStatus, $allowedTransitions)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;INVALID_STATE_TRANSITION&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;Cannot transition from &#x27;{$order-&gt;status}&#x27; to &#x27;{$targetStatus}&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. Check payment status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($checkPayment) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($order-&gt;payment_status === &#x27;refunded&#x27; &amp;&amp; $targetStatus !== &#x27;cancelled&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;PAYMENT_ALREADY_REFUNDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;Payment has already been refunded. Order must remain cancelled.&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($order-&gt;payment_status === &#x27;pending&#x27; &amp;&amp; in_array($targetStatus, [&#x27;shipped&#x27;, &#x27;delivered&#x27;])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;PAYMENT_PENDING&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;Cannot ship or deliver order with pending payment&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. Check inventory availability (for shipping)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($checkInventory &amp;&amp; $targetStatus === &#x27;shipped&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            foreach ($order-&gt;items as $item) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if ($item-&gt;product-&gt;stock &lt; $item-&gt;quantity) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &#x27;INSUFFICIENT_INVENTORY&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;Insufficient inventory for product: {$item-&gt;product-&gt;name}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6. Check if order has active disputes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($this-&gt;hasActiveDispute($order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ACTIVE_DISPUTE&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Cannot modify order with active dispute&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 7. Check if order is locked</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;is_locked) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ORDER_LOCKED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Order is currently locked and cannot be modified&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // All business rule checks passed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function getStateMachineRules(): array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;pending&#x27; =&gt; [&#x27;processing&#x27;, &#x27;cancelled&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;processing&#x27; =&gt; [&#x27;shipped&#x27;, &#x27;cancelled&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;shipped&#x27; =&gt; [&#x27;delivered&#x27;, &#x27;returned&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;delivered&#x27; =&gt; [&#x27;returned&#x27;, &#x27;completed&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;cancelled&#x27; =&gt; [], // Terminal state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;completed&#x27; =&gt; [], // Terminal state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function hasActiveDispute(Order $order): bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return $order-&gt;disputes()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;where(&#x27;status&#x27;, &#x27;open&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;exists();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">State machine validation</li>
<li class="">Configurable business rules</li>
<li class="">Multiple validation layers</li>
<li class="">Terminal state protection</li>
<li class="">Payment and inventory checks</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-4-enterprise-level-multi-condition-restriction">Example 4: Enterprise-Level Multi-Condition Restriction<a href="#example-4-enterprise-level-multi-condition-restriction" class="hash-link" aria-label="Direct link to Example 4: Enterprise-Level Multi-Condition Restriction" title="Direct link to Example 4: Enterprise-Level Multi-Condition Restriction" translate="no">​</a></h3>
<p>A comprehensive restriction that checks multiple business conditions with detailed error reporting:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Cache;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\DB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractRestrictionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\RestrictionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Form\FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class EnterpriseOrderCancellationRestrictionTask extends AbstractRestrictionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function subject(): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return \App\Models\Order::class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function definition(): FlowTaskDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FlowTaskDefinition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title: &#x27;flow::base.task.enterprise_cancellation_restriction.title&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description: &#x27;Comprehensive order cancellation restrictions&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function form(): FormBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (new FormBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;max_cancellation_hours&#x27;, &#x27;integer&#x27;, 24, &#x27;Maximum hours after creation&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;max_cancellation_amount&#x27;, &#x27;decimal&#x27;, 1000, &#x27;Maximum order amount for cancellation&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;require_reason&#x27;, &#x27;boolean&#x27;, true, &#x27;Require cancellation reason&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;check_rate_limit&#x27;, &#x27;boolean&#x27;, true, &#x27;Check user rate limit&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;max_cancellations_per_month&#x27;, &#x27;integer&#x27;, 5, &#x27;Maximum cancellations per month&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;allow_admin_override&#x27;, &#x27;boolean&#x27;, true, &#x27;Allow admin override&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function restriction(FlowTaskContext $context): RestrictionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Extract configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $maxHours = $config[&#x27;max_cancellation_hours&#x27;] ?? 24;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $maxAmount = $config[&#x27;max_cancellation_amount&#x27;] ?? 1000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $requireReason = $config[&#x27;require_reason&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $checkRateLimit = $config[&#x27;check_rate_limit&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $maxPerMonth = $config[&#x27;max_cancellations_per_month&#x27;] ?? 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $allowAdminOverride = $config[&#x27;allow_admin_override&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Admin override check (early exit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($allowAdminOverride &amp;&amp; $user &amp;&amp; $user-&gt;hasRole(&#x27;admin&#x27;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. User authentication check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!$user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;USER_NOT_AUTHENTICATED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;You must be logged in to cancel orders&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Permission check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!$user-&gt;can(&#x27;cancel&#x27;, $order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;PERMISSION_DENIED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;You do not have permission to cancel this order&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Ownership check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;user_id !== $user-&gt;id &amp;&amp; !$user-&gt;hasRole(&#x27;admin&#x27;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;OWNERSHIP_MISMATCH&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;You can only cancel your own orders&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. Order status check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $blockedStatuses = [&#x27;shipped&#x27;, &#x27;delivered&#x27;, &#x27;cancelled&#x27;, &#x27;refunded&#x27;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (in_array($order-&gt;status, $blockedStatuses)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ORDER_STATUS_INVALID&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Cannot cancel order with status: {$order-&gt;status}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. Time limit check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $hoursSinceCreated = $order-&gt;created_at-&gt;diffInHours(now());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($hoursSinceCreated &gt; $maxHours) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;TIME_LIMIT_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Orders can only be cancelled within {$maxHours} hours of creation. &quot; .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Order was created {$hoursSinceCreated} hours ago.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6. Amount limit check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;total &gt; $maxAmount) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;AMOUNT_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Orders over {$maxAmount} cannot be cancelled automatically. Please contact support.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 7. Reason requirement check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($requireReason &amp;&amp; empty($payload[&#x27;reason&#x27;])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;REASON_REQUIRED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Cancellation reason is required&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($requireReason &amp;&amp; strlen($payload[&#x27;reason&#x27;] ?? &#x27;&#x27;) &lt; 10) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;REASON_TOO_SHORT&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Cancellation reason must be at least 10 characters&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 8. Rate limiting check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($checkRateLimit) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $cancellationCount = $this-&gt;getRecentCancellationCount($user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($cancellationCount &gt;= $maxPerMonth) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;RATE_LIMIT_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;You have exceeded the maximum of {$maxPerMonth} cancellations per month. Please contact support.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 9. Payment status check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;payment_status === &#x27;refunded&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;PAYMENT_ALREADY_REFUNDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Payment has already been refunded. Order cannot be cancelled again.&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 10. Active dispute check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($this-&gt;hasActiveDispute($order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ACTIVE_DISPUTE&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Cannot cancel order with active dispute. Please resolve the dispute first.&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 11. Inventory restock check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $restockInventory = $payload[&#x27;restock_inventory&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($restockInventory &amp;&amp; !$this-&gt;canRestockInventory($order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;INVENTORY_RESTOCK_FAILED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Cannot cancel order: some items cannot be restocked to inventory&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 12. Shipping status check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;shipping_status === &#x27;in_transit&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ORDER_IN_TRANSIT&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Cannot cancel order that is already in transit. Please contact shipping department.&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 13. Subscription order check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;is_subscription &amp;&amp; $order-&gt;subscription-&gt;is_active) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ACTIVE_SUBSCRIPTION&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Cannot cancel order with active subscription. Please cancel the subscription first.&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // All checks passed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function getRecentCancellationCount(User $user): int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $cacheKey = &quot;user_cancellations_{$user-&gt;id}_&quot; . now()-&gt;format(&#x27;Y-m&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Cache::remember($cacheKey, 3600, function () use ($user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $user-&gt;orders()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;where(&#x27;status&#x27;, &#x27;cancelled&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;where(&#x27;cancelled_at&#x27;, &#x27;&gt;=&#x27;, now()-&gt;startOfMonth())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;count();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function hasActiveDispute(Order $order): bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return $order-&gt;disputes()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;where(&#x27;status&#x27;, &#x27;open&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;exists();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function canRestockInventory(Order $order): bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach ($order-&gt;items as $item) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!$item-&gt;product-&gt;canRestock()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Multiple validation layers</li>
<li class="">Early exit for admin override</li>
<li class="">Detailed error messages with context</li>
<li class="">Rate limiting with caching</li>
<li class="">Complex business logic</li>
<li class="">Configurable restrictions</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-5-advanced-configurable-restrictions---dynamic-business-rules">Example 5: Advanced Configurable Restrictions - Dynamic Business Rules<a href="#example-5-advanced-configurable-restrictions---dynamic-business-rules" class="hash-link" aria-label="Direct link to Example 5: Advanced Configurable Restrictions - Dynamic Business Rules" title="Direct link to Example 5: Advanced Configurable Restrictions - Dynamic Business Rules" translate="no">​</a></h3>
<p>A sophisticated restriction system that uses configuration for flexible business rules:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\DB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractRestrictionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\RestrictionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Form\FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ConfigurableBusinessRulesRestrictionTask extends AbstractRestrictionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function subject(): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return \App\Models\Order::class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function definition(): FlowTaskDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FlowTaskDefinition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title: &#x27;flow::base.task.configurable_rules.title&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description: &#x27;Configurable business rules restriction&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function form(): FormBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (new FormBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;allowed_statuses&#x27;, &#x27;array&#x27;, [&#x27;pending&#x27;, &#x27;processing&#x27;], &#x27;Allowed source statuses&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;blocked_statuses&#x27;, &#x27;array&#x27;, [&#x27;cancelled&#x27;], &#x27;Blocked statuses&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;allowed_user_roles&#x27;, &#x27;array&#x27;, [&#x27;customer&#x27;, &#x27;admin&#x27;], &#x27;Allowed user roles&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;min_order_amount&#x27;, &#x27;decimal&#x27;, 0, &#x27;Minimum order amount&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;max_order_amount&#x27;, &#x27;decimal&#x27;, 10000, &#x27;Maximum order amount&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;allowed_payment_methods&#x27;, &#x27;array&#x27;, [&#x27;credit_card&#x27;, &#x27;paypal&#x27;], &#x27;Allowed payment methods&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;require_verification&#x27;, &#x27;boolean&#x27;, false, &#x27;Require email verification&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;business_hours_only&#x27;, &#x27;boolean&#x27;, false, &#x27;Only allow during business hours&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;business_hours_start&#x27;, &#x27;integer&#x27;, 9, &#x27;Business hours start&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;business_hours_end&#x27;, &#x27;integer&#x27;, 17, &#x27;Business hours end&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function restriction(FlowTaskContext $context): RestrictionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Extract all configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $allowedStatuses = $config[&#x27;allowed_statuses&#x27;] ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $blockedStatuses = $config[&#x27;blocked_statuses&#x27;] ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $allowedRoles = $config[&#x27;allowed_user_roles&#x27;] ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $minAmount = $config[&#x27;min_order_amount&#x27;] ?? 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $maxAmount = $config[&#x27;max_order_amount&#x27;] ?? 10000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $allowedPaymentMethods = $config[&#x27;allowed_payment_methods&#x27;] ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $requireVerification = $config[&#x27;require_verification&#x27;] ?? false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $businessHoursOnly = $config[&#x27;business_hours_only&#x27;] ?? false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $businessHoursStart = $config[&#x27;business_hours_start&#x27;] ?? 9;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $businessHoursEnd = $config[&#x27;business_hours_end&#x27;] ?? 17;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Status validation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!empty($allowedStatuses) &amp;&amp; !in_array($order-&gt;status, $allowedStatuses)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;STATUS_NOT_ALLOWED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Order status &#x27;{$order-&gt;status}&#x27; is not allowed. Allowed statuses: &quot; . implode(&#x27;, &#x27;, $allowedStatuses)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!empty($blockedStatuses) &amp;&amp; in_array($order-&gt;status, $blockedStatuses)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;STATUS_BLOCKED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Order status &#x27;{$order-&gt;status}&#x27; is blocked for this transition&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. User role validation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!empty($allowedRoles) &amp;&amp; $user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $userRoles = $user-&gt;roles-&gt;pluck(&#x27;name&#x27;)-&gt;toArray();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $hasAllowedRole = !empty(array_intersect($userRoles, $allowedRoles));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!$hasAllowedRole) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;ROLE_NOT_ALLOWED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;Your role is not allowed for this transition&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Amount validation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;total &lt; $minAmount) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;AMOUNT_TOO_LOW&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Order amount {$order-&gt;total} is below minimum {$minAmount}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;total &gt; $maxAmount) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;AMOUNT_TOO_HIGH&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Order amount {$order-&gt;total} exceeds maximum {$maxAmount}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. Payment method validation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!empty($allowedPaymentMethods) &amp;&amp; !in_array($order-&gt;payment_method, $allowedPaymentMethods)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;PAYMENT_METHOD_NOT_ALLOWED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Payment method &#x27;{$order-&gt;payment_method}&#x27; is not allowed&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. Email verification check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($requireVerification &amp;&amp; $user &amp;&amp; !$user-&gt;email_verified_at) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;EMAIL_NOT_VERIFIED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Email verification is required for this transition&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6. Business hours check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($businessHoursOnly) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $currentHour = now()-&gt;hour;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($currentHour &lt; $businessHoursStart || $currentHour &gt;= $businessHoursEnd) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;OUTSIDE_BUSINESS_HOURS&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;This operation is only available during business hours ({$businessHoursStart}:00 - {$businessHoursEnd}:00)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // All configurable checks passed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Fully configurable restrictions</li>
<li class="">Multiple validation layers from config</li>
<li class="">Flexible business rules</li>
<li class="">Easy to adjust without code changes</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-6-advanced-time-based-restrictions---scheduling-and-windows">Example 6: Advanced Time-Based Restrictions - Scheduling and Windows<a href="#example-6-advanced-time-based-restrictions---scheduling-and-windows" class="hash-link" aria-label="Direct link to Example 6: Advanced Time-Based Restrictions - Scheduling and Windows" title="Direct link to Example 6: Advanced Time-Based Restrictions - Scheduling and Windows" translate="no">​</a></h3>
<p>A comprehensive time-based restriction system with multiple time windows and scheduling:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Carbon\Carbon;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Cache;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractRestrictionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\RestrictionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Form\FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class TimeBasedRestrictionTask extends AbstractRestrictionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function subject(): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return \App\Models\Order::class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function definition(): FlowTaskDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FlowTaskDefinition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title: &#x27;flow::base.task.time_based_restriction.title&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description: &#x27;Time-based restrictions for transitions&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function form(): FormBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (new FormBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;business_hours_start&#x27;, &#x27;integer&#x27;, 9, &#x27;Business hours start (24h format)&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;business_hours_end&#x27;, &#x27;integer&#x27;, 17, &#x27;Business hours end (24h format)&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;allowed_days&#x27;, &#x27;array&#x27;, [&#x27;monday&#x27;, &#x27;tuesday&#x27;, &#x27;wednesday&#x27;, &#x27;thursday&#x27;, &#x27;friday&#x27;], &#x27;Allowed days of week&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;blocked_dates&#x27;, &#x27;array&#x27;, [], &#x27;Blocked dates (YYYY-MM-DD)&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;time_window_start&#x27;, &#x27;string&#x27;, null, &#x27;Time window start (HH:MM)&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;time_window_end&#x27;, &#x27;string&#x27;, null, &#x27;Time window end (HH:MM)&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;max_operations_per_hour&#x27;, &#x27;integer&#x27;, 10, &#x27;Maximum operations per hour&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;timezone&#x27;, &#x27;string&#x27;, &#x27;UTC&#x27;, &#x27;Timezone for time checks&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function restriction(FlowTaskContext $context): RestrictionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Extract configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $businessHoursStart = $config[&#x27;business_hours_start&#x27;] ?? 9;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $businessHoursEnd = $config[&#x27;business_hours_end&#x27;] ?? 17;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $allowedDays = $config[&#x27;allowed_days&#x27;] ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $blockedDates = $config[&#x27;blocked_dates&#x27;] ?? [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $timeWindowStart = $config[&#x27;time_window_start&#x27;] ?? null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $timeWindowEnd = $config[&#x27;time_window_end&#x27;] ?? null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $maxPerHour = $config[&#x27;max_operations_per_hour&#x27;] ?? 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $timezone = $config[&#x27;timezone&#x27;] ?? &#x27;UTC&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $now = Carbon::now($timezone);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Business hours check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $currentHour = $now-&gt;hour;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($currentHour &lt; $businessHoursStart || $currentHour &gt;= $businessHoursEnd) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;OUTSIDE_BUSINESS_HOURS&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;This operation is only available during business hours ({$businessHoursStart}:00 - {$businessHoursEnd}:00 {$timezone})&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Day of week check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!empty($allowedDays)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $currentDay = strtolower($now-&gt;format(&#x27;l&#x27;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!in_array($currentDay, $allowedDays)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;DAY_NOT_ALLOWED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;This operation is not available on {$currentDay}. Allowed days: &quot; . implode(&#x27;, &#x27;, $allowedDays)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Blocked dates check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!empty($blockedDates)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $currentDate = $now-&gt;format(&#x27;Y-m-d&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (in_array($currentDate, $blockedDates)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;DATE_BLOCKED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;This operation is blocked on {$currentDate}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. Time window check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($timeWindowStart &amp;&amp; $timeWindowEnd) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $windowStart = Carbon::parse($timeWindowStart, $timezone);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $windowEnd = Carbon::parse($timeWindowEnd, $timezone);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $currentTime = $now-&gt;copy()-&gt;setDate($windowStart-&gt;year, $windowStart-&gt;month, $windowStart-&gt;day);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($currentTime-&gt;lt($windowStart) || $currentTime-&gt;gt($windowEnd)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;OUTSIDE_TIME_WINDOW&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;This operation is only available between {$timeWindowStart} and {$timeWindowEnd} {$timezone}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. Rate limiting per hour</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($maxPerHour &gt; 0 &amp;&amp; $user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $rateLimitKey = &quot;operation_rate_limit_{$user-&gt;id}_&quot; . $now-&gt;format(&#x27;Y-m-d-H&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $currentCount = Cache::get($rateLimitKey, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($currentCount &gt;= $maxPerHour) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;RATE_LIMIT_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;You have exceeded the maximum of {$maxPerHour} operations per hour. Please try again later.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Increment counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Cache::put($rateLimitKey, $currentCount + 1, 3600);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6. Order age check (time since creation)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $hoursSinceCreation = $order-&gt;created_at-&gt;diffInHours($now);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($hoursSinceCreation &gt; 48) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;ORDER_TOO_OLD&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;This operation is not available for orders older than 48 hours. Order was created {$hoursSinceCreation} hours ago.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // All time-based checks passed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Multiple time-based validations</li>
<li class="">Business hours and days</li>
<li class="">Time windows</li>
<li class="">Rate limiting with caching</li>
<li class="">Timezone support</li>
<li class="">Order age restrictions</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-7-resource-locking-and-concurrency-control">Example 7: Resource Locking and Concurrency Control<a href="#example-7-resource-locking-and-concurrency-control" class="hash-link" aria-label="Direct link to Example 7: Resource Locking and Concurrency Control" title="Direct link to Example 7: Resource Locking and Concurrency Control" translate="no">​</a></h3>
<p>A restriction that prevents concurrent modifications and handles resource locking:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Cache;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\DB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractRestrictionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\RestrictionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Form\FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ResourceLockingRestrictionTask extends AbstractRestrictionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function subject(): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return \App\Models\Order::class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function definition(): FlowTaskDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FlowTaskDefinition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title: &#x27;flow::base.task.resource_locking.title&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description: &#x27;Prevents concurrent modifications&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function form(): FormBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (new FormBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;lock_timeout&#x27;, &#x27;integer&#x27;, 300, &#x27;Lock timeout in seconds&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;check_concurrent_edits&#x27;, &#x27;boolean&#x27;, true, &#x27;Check for concurrent edits&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;require_lock&#x27;, &#x27;boolean&#x27;, true, &#x27;Require resource lock&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function restriction(FlowTaskContext $context): RestrictionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $lockTimeout = $config[&#x27;lock_timeout&#x27;] ?? 300;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $checkConcurrent = $config[&#x27;check_concurrent_edits&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $requireLock = $config[&#x27;require_lock&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Check if resource is locked</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $lockKey = &quot;order_lock_{$order-&gt;id}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $lockedBy = Cache::get($lockKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($lockedBy &amp;&amp; $lockedBy !== $user?-&gt;id) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $lockedUser = \App\Models\User::find($lockedBy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;RESOURCE_LOCKED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Order is currently being edited by {$lockedUser?-&gt;name}. Please try again later.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Check for concurrent edits (optimistic locking)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($checkConcurrent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $lastModified = $order-&gt;updated_at;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $payloadVersion = $context-&gt;payload()[&#x27;version&#x27;] ?? null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($payloadVersion &amp;&amp; $order-&gt;version !== $payloadVersion) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;CONCURRENT_MODIFICATION&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;Order has been modified by another user. Please refresh and try again.&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Acquire lock if required</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($requireLock &amp;&amp; $user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $lockAcquired = Cache::add($lockKey, $user-&gt;id, $lockTimeout);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!$lockAcquired) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;LOCK_ACQUISITION_FAILED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;Could not acquire lock on resource. Please try again.&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. Check if order is in a transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (DB::transactionLevel() &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Order is already in a transaction, might be locked</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;RESOURCE_IN_TRANSACTION&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;Order is currently being processed in another transaction&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // All locking checks passed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-8-quota-and-limit-restrictions">Example 8: Quota and Limit Restrictions<a href="#example-8-quota-and-limit-restrictions" class="hash-link" aria-label="Direct link to Example 8: Quota and Limit Restrictions" title="Direct link to Example 8: Quota and Limit Restrictions" translate="no">​</a></h3>
<p>A restriction that enforces quotas and usage limits:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Cache;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\DB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractRestrictionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\RestrictionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Form\FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class QuotaRestrictionTask extends AbstractRestrictionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function subject(): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return \App\Models\Order::class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function definition(): FlowTaskDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FlowTaskDefinition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title: &#x27;flow::base.task.quota_restriction.title&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description: &#x27;Enforces quotas and usage limits&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function form(): FormBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (new FormBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;max_orders_per_day&#x27;, &#x27;integer&#x27;, 10, &#x27;Maximum orders per day&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;max_orders_per_month&#x27;, &#x27;integer&#x27;, 100, &#x27;Maximum orders per month&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;max_total_amount_per_day&#x27;, &#x27;decimal&#x27;, 5000, &#x27;Maximum total amount per day&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;check_user_tier&#x27;, &#x27;boolean&#x27;, true, &#x27;Check user tier limits&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;allow_unlimited_tier&#x27;, &#x27;string&#x27;, &#x27;premium&#x27;, &#x27;Tier with unlimited access&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function restriction(FlowTaskContext $context): RestrictionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!$user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;USER_REQUIRED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;User is required for quota checks&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $maxPerDay = $config[&#x27;max_orders_per_day&#x27;] ?? 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $maxPerMonth = $config[&#x27;max_orders_per_month&#x27;] ?? 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $maxAmountPerDay = $config[&#x27;max_total_amount_per_day&#x27;] ?? 5000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $checkTier = $config[&#x27;check_user_tier&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $unlimitedTier = $config[&#x27;allow_unlimited_tier&#x27;] ?? &#x27;premium&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check if user has unlimited tier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($checkTier &amp;&amp; $user-&gt;tier === $unlimitedTier) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Daily order count check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $dailyCount = $this-&gt;getDailyOrderCount($user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($dailyCount &gt;= $maxPerDay) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;DAILY_QUOTA_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;You have reached the daily limit of {$maxPerDay} orders. Please try again tomorrow.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Monthly order count check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $monthlyCount = $this-&gt;getMonthlyOrderCount($user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($monthlyCount &gt;= $maxPerMonth) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;MONTHLY_QUOTA_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;You have reached the monthly limit of {$maxPerMonth} orders.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Daily amount check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $dailyAmount = $this-&gt;getDailyOrderAmount($user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $newTotal = $dailyAmount + $order-&gt;total;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($newTotal &gt; $maxAmountPerDay) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;DAILY_AMOUNT_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;This order would exceed your daily spending limit of {$maxAmountPerDay}. &quot; .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Current daily total: {$dailyAmount}, Order amount: {$order-&gt;total}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // All quota checks passed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function getDailyOrderCount(User $user): int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $cacheKey = &quot;user_daily_orders_{$user-&gt;id}_&quot; . now()-&gt;format(&#x27;Y-m-d&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Cache::remember($cacheKey, 3600, function () use ($user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $user-&gt;orders()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;whereDate(&#x27;created_at&#x27;, today())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;count();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function getMonthlyOrderCount(User $user): int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $cacheKey = &quot;user_monthly_orders_{$user-&gt;id}_&quot; . now()-&gt;format(&#x27;Y-m&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Cache::remember($cacheKey, 3600, function () use ($user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $user-&gt;orders()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;whereYear(&#x27;created_at&#x27;, now()-&gt;year)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;whereMonth(&#x27;created_at&#x27;, now()-&gt;month)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;count();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function getDailyOrderAmount(User $user): float</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $cacheKey = &quot;user_daily_amount_{$user-&gt;id}_&quot; . now()-&gt;format(&#x27;Y-m-d&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Cache::remember($cacheKey, 3600, function () use ($user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $user-&gt;orders()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;whereDate(&#x27;created_at&#x27;, today())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;sum(&#x27;total&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-9-complete-real-world-system---order-cancellation-workflow">Example 9: Complete Real-World System - Order Cancellation Workflow<a href="#example-9-complete-real-world-system---order-cancellation-workflow" class="hash-link" aria-label="Direct link to Example 9: Complete Real-World System - Order Cancellation Workflow" title="Direct link to Example 9: Complete Real-World System - Order Cancellation Workflow" translate="no">​</a></h3>
<p>A complete example showing all restriction patterns working together:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Flows\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Cache;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\DB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Contracts\AbstractRestrictionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\RestrictionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Form\FormBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class CompleteOrderCancellationRestrictionTask extends AbstractRestrictionTask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function subject(): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return \App\Models\Order::class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static function definition(): FlowTaskDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FlowTaskDefinition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title: &#x27;flow::base.task.complete_cancellation_restriction.title&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description: &#x27;Complete order cancellation restrictions&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function form(): FormBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (new FormBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;max_cancellation_hours&#x27;, &#x27;integer&#x27;, 24, &#x27;Max hours after creation&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;require_reason&#x27;, &#x27;boolean&#x27;, true, &#x27;Require cancellation reason&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;check_rate_limit&#x27;, &#x27;boolean&#x27;, true, &#x27;Check rate limit&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;max_cancellations_per_month&#x27;, &#x27;integer&#x27;, 5, &#x27;Max cancellations per month&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;allow_admin_override&#x27;, &#x27;boolean&#x27;, true, &#x27;Allow admin override&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;check_inventory&#x27;, &#x27;boolean&#x27;, true, &#x27;Check inventory restock&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;check_payment&#x27;, &#x27;boolean&#x27;, true, &#x27;Check payment status&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;hiddenCustomField(&#x27;check_disputes&#x27;, &#x27;boolean&#x27;, true, &#x27;Check active disputes&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function restriction(FlowTaskContext $context): RestrictionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = $context-&gt;subject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = $context-&gt;user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = $context-&gt;payload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $config = $context-&gt;config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Log restriction check start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Log::info(&#x27;Order cancellation restriction check&#x27;, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;order_id&#x27; =&gt; $order-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;user_id&#x27; =&gt; $user?-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Admin override (early exit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (($config[&#x27;allow_admin_override&#x27;] ?? true) &amp;&amp; $user &amp;&amp; $user-&gt;hasRole(&#x27;admin&#x27;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Log::info(&#x27;Admin override granted&#x27;, [&#x27;order_id&#x27; =&gt; $order-&gt;id, &#x27;user_id&#x27; =&gt; $user-&gt;id]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. User checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!$user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $this-&gt;denyWithLog(&#x27;USER_NOT_AUTHENTICATED&#x27;, &#x27;User must be authenticated&#x27;, $order);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!$user-&gt;can(&#x27;cancel&#x27;, $order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $this-&gt;denyWithLog(&#x27;PERMISSION_DENIED&#x27;, &#x27;No permission to cancel&#x27;, $order, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($order-&gt;user_id !== $user-&gt;id &amp;&amp; !$user-&gt;hasRole(&#x27;admin&#x27;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $this-&gt;denyWithLog(&#x27;OWNERSHIP_MISMATCH&#x27;, &#x27;Not your order&#x27;, $order, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Order status checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (in_array($order-&gt;status, [&#x27;shipped&#x27;, &#x27;delivered&#x27;, &#x27;cancelled&#x27;, &#x27;refunded&#x27;])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $this-&gt;denyWithLog(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;INVALID_STATUS&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Cannot cancel order with status: {$order-&gt;status}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $order,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Time-based checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $maxHours = $config[&#x27;max_cancellation_hours&#x27;] ?? 24;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $hoursSinceCreated = $order-&gt;created_at-&gt;diffInHours(now());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($hoursSinceCreated &gt; $maxHours) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $this-&gt;denyWithLog(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;TIME_LIMIT_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Order is older than {$maxHours} hours&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $order,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. Payload validation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (($config[&#x27;require_reason&#x27;] ?? true) &amp;&amp; empty($payload[&#x27;reason&#x27;])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $this-&gt;denyWithLog(&#x27;REASON_REQUIRED&#x27;, &#x27;Cancellation reason required&#x27;, $order, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. Rate limiting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($config[&#x27;check_rate_limit&#x27;] ?? true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $maxPerMonth = $config[&#x27;max_cancellations_per_month&#x27;] ?? 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $count = $this-&gt;getMonthlyCancellationCount($user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($count &gt;= $maxPerMonth) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return $this-&gt;denyWithLog(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;RATE_LIMIT_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;Exceeded {$maxPerMonth} cancellations per month&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    $order,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    $user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6. Payment checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($config[&#x27;check_payment&#x27;] ?? true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($order-&gt;payment_status === &#x27;refunded&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return $this-&gt;denyWithLog(&#x27;PAYMENT_ALREADY_REFUNDED&#x27;, &#x27;Payment already refunded&#x27;, $order, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 7. Dispute checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (($config[&#x27;check_disputes&#x27;] ?? true) &amp;&amp; $this-&gt;hasActiveDispute($order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $this-&gt;denyWithLog(&#x27;ACTIVE_DISPUTE&#x27;, &#x27;Order has active dispute&#x27;, $order, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 8. Inventory checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (($config[&#x27;check_inventory&#x27;] ?? true)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $restockInventory = $payload[&#x27;restock_inventory&#x27;] ?? true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($restockInventory &amp;&amp; !$this-&gt;canRestockInventory($order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return $this-&gt;denyWithLog(&#x27;INVENTORY_RESTOCK_FAILED&#x27;, &#x27;Cannot restock inventory&#x27;, $order, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // All checks passed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Log::info(&#x27;Order cancellation restriction passed&#x27;, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;order_id&#x27; =&gt; $order-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;user_id&#x27; =&gt; $user-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function denyWithLog(string $code, string $message, Order $order, ?User $user = null): RestrictionResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Log::warning(&#x27;Order cancellation restriction denied&#x27;, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;code&#x27; =&gt; $code,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;message&#x27; =&gt; $message,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;order_id&#x27; =&gt; $order-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;user_id&#x27; =&gt; $user?-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::deny($code, $message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function getMonthlyCancellationCount(User $user): int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $cacheKey = &quot;user_cancellations_{$user-&gt;id}_&quot; . now()-&gt;format(&#x27;Y-m&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Cache::remember($cacheKey, 3600, function () use ($user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $user-&gt;orders()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;where(&#x27;status&#x27;, &#x27;cancelled&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;whereYear(&#x27;cancelled_at&#x27;, now()-&gt;year)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;whereMonth(&#x27;cancelled_at&#x27;, now()-&gt;month)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;count();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function hasActiveDispute(Order $order): bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return $order-&gt;disputes()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;where(&#x27;status&#x27;, &#x27;open&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt;exists();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function canRestockInventory(Order $order): bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach ($order-&gt;items as $item) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!$item-&gt;product-&gt;canRestock()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class="">Comprehensive logging</li>
<li class="">Early exit for admin override</li>
<li class="">Multiple validation layers</li>
<li class="">Caching for performance</li>
<li class="">Detailed error messages</li>
<li class="">Production-ready implementation</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="code-conventions">Code Conventions<a href="#code-conventions" class="hash-link" aria-label="Direct link to Code Conventions" title="Direct link to Code Conventions" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="recommended-code-format">Recommended Code Format<a href="#recommended-code-format" class="hash-link" aria-label="Direct link to Recommended Code Format" title="Direct link to Recommended Code Format" translate="no">​</a></h3>
<p>Use uppercase with underscores:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ Good</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestrictionResult::deny(&#x27;PERMISSION_DENIED&#x27;, &#x27;Message&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestrictionResult::deny(&#x27;ORDER_SHIPPED&#x27;, &#x27;Message&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestrictionResult::deny(&#x27;TIME_LIMIT_EXCEEDED&#x27;, &#x27;Message&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ Bad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestrictionResult::deny(&#x27;permission-denied&#x27;, &#x27;Message&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestrictionResult::deny(&#x27;PermissionDenied&#x27;, &#x27;Message&#x27;);</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="common-code-patterns">Common Code Patterns<a href="#common-code-patterns" class="hash-link" aria-label="Direct link to Common Code Patterns" title="Direct link to Common Code Patterns" translate="no">​</a></h3>
<ul>
<li class=""><code>PERMISSION_DENIED</code> - User lacks permission</li>
<li class=""><code>STATUS_INVALID</code> - Invalid model status</li>
<li class=""><code>TIME_LIMIT_EXCEEDED</code> - Time constraint violation</li>
<li class=""><code>REQUIRED_FIELD_MISSING</code> - Required field not provided</li>
<li class=""><code>BUSINESS_RULE_VIOLATION</code> - Business rule violation</li>
<li class=""><code>RESOURCE_LOCKED</code> - Resource is locked</li>
<li class=""><code>QUOTA_EXCEEDED</code> - Quota limit exceeded</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="error-handling-and-integration">Error Handling and Integration<a href="#error-handling-and-integration" class="hash-link" aria-label="Direct link to Error Handling and Integration" title="Direct link to Error Handling and Integration" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="how-restriction-failures-work">How Restriction Failures Work<a href="#how-restriction-failures-work" class="hash-link" aria-label="Direct link to How Restriction Failures Work" title="Direct link to How Restriction Failures Work" translate="no">​</a></h3>
<p>When a restriction denies a transition, the <code>FlowTransition</code> service will:</p>
<ol>
<li class="">Throw a <code>TaskRestrictionException</code></li>
<li class="">Include the code and message from <code>RestrictionResult</code></li>
<li class="">Prevent the transition from executing</li>
<li class="">Stop all subsequent tasks (validation and action tasks won&#x27;t run)</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="basic-error-handling">Basic Error Handling<a href="#basic-error-handling" class="hash-link" aria-label="Direct link to Basic Error Handling" title="Direct link to Basic Error Handling" translate="no">​</a></h3>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Facades\FlowTransition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Exceptions\TaskRestrictionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $result = FlowTransition::runner(&#x27;cancel_order&#x27;, $order, $payload, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Transition succeeded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;success&#x27; =&gt; true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;data&#x27; =&gt; $result-&gt;getData(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} catch (TaskRestrictionException $e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Restriction denied</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $code = $e-&gt;getCode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $message = $e-&gt;getMessage();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;success&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;error&#x27; =&gt; $code,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;message&#x27; =&gt; $message,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ], 403);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="advanced-error-handling-with-code-based-responses">Advanced Error Handling with Code-Based Responses<a href="#advanced-error-handling-with-code-based-responses" class="hash-link" aria-label="Direct link to Advanced Error Handling with Code-Based Responses" title="Direct link to Advanced Error Handling with Code-Based Responses" translate="no">​</a></h3>
<p>Handle different restriction codes with specific responses:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Http\Controllers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Http\Request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Http\JsonResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Facades\FlowTransition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Exceptions\TaskRestrictionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class OrderController extends Controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function cancel(Request $request, Order $order): JsonResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $payload = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;reason&#x27; =&gt; $request-&gt;input(&#x27;reason&#x27;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;restock_inventory&#x27; =&gt; $request-&gt;boolean(&#x27;restock_inventory&#x27;, true),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result = FlowTransition::runner(&#x27;cancel_order&#x27;, $order, $payload, auth()-&gt;user());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;success&#x27; =&gt; true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;message&#x27; =&gt; &#x27;Order cancelled successfully&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;data&#x27; =&gt; $result-&gt;getData(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TaskRestrictionException $e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $this-&gt;handleRestrictionError($e, $order);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function handleRestrictionError(TaskRestrictionException $e, Order $order): JsonResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $code = $e-&gt;getCode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $message = $e-&gt;getMessage();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Handle specific restriction codes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return match ($code) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;USER_NOT_AUTHENTICATED&#x27; =&gt; response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;success&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;error&#x27; =&gt; $code,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;message&#x27; =&gt; $message,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;action&#x27; =&gt; &#x27;login_required&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ], 401),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;PERMISSION_DENIED&#x27; =&gt; response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;success&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;error&#x27; =&gt; $code,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;message&#x27; =&gt; $message,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;action&#x27; =&gt; &#x27;contact_support&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ], 403),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;ORDER_SHIPPED&#x27; =&gt; response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;success&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;error&#x27; =&gt; $code,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;message&#x27; =&gt; $message,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;action&#x27; =&gt; &#x27;contact_shipping&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;shipping_info&#x27; =&gt; [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;tracking_number&#x27; =&gt; $order-&gt;tracking_number,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;shipped_at&#x27; =&gt; $order-&gt;shipped_at,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ], 403),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;TIME_LIMIT_EXCEEDED&#x27; =&gt; response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;success&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;error&#x27; =&gt; $code,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;message&#x27; =&gt; $message,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;action&#x27; =&gt; &#x27;contact_support&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;order_age_hours&#x27; =&gt; $order-&gt;created_at-&gt;diffInHours(now()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ], 403),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;RATE_LIMIT_EXCEEDED&#x27; =&gt; response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;success&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;error&#x27; =&gt; $code,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;message&#x27; =&gt; $message,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;action&#x27; =&gt; &#x27;wait_or_contact&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;retry_after&#x27; =&gt; now()-&gt;addDay()-&gt;toIso8601String(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ], 429),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;REASON_REQUIRED&#x27; =&gt; response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;success&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;error&#x27; =&gt; $code,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;message&#x27; =&gt; $message,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;action&#x27; =&gt; &#x27;provide_reason&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;validation&#x27; =&gt; [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;reason&#x27; =&gt; [&#x27;required&#x27;, &#x27;string&#x27;, &#x27;min:10&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ], 422),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            default =&gt; response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;success&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;error&#x27; =&gt; $code,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;message&#x27; =&gt; $message,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;action&#x27; =&gt; &#x27;contact_support&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ], 403),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="frontend-integration-example">Frontend Integration Example<a href="#frontend-integration-example" class="hash-link" aria-label="Direct link to Frontend Integration Example" title="Direct link to Frontend Integration Example" translate="no">​</a></h3>
<p>Handle restriction errors in frontend applications:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// React/Vue/Angular example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cancelOrder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">orderId</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> reason</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">/api/orders/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">orderId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">/cancel</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">headers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string-property property" style="color:#36acaa">&#x27;Content-Type&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;application/json&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string-property property" style="color:#36acaa">&#x27;Authorization&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Bearer </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">token</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">body</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> reason </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">success</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Show success message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">showNotification</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Order cancelled successfully&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;success&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Handle restriction error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">handleRestrictionError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">handleError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleRestrictionError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> action </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;USER_NOT_AUTHENTICATED&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">redirectToLogin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;PERMISSION_DENIED&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">showError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">showContactSupportButton</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ORDER_SHIPPED&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">showError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">showShippingInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">shipping_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;TIME_LIMIT_EXCEEDED&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">showError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">showContactSupportButton</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;RATE_LIMIT_EXCEEDED&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">showError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">showRetryAfter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">retry_after</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;REASON_REQUIRED&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">showValidationError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">validation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">showError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">showContactSupportButton</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="logging-and-monitoring">Logging and Monitoring<a href="#logging-and-monitoring" class="hash-link" aria-label="Direct link to Logging and Monitoring" title="Direct link to Logging and Monitoring" translate="no">​</a></h3>
<p>Log restriction failures for monitoring and analytics:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Exceptions\TaskRestrictionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $result = FlowTransition::runner(&#x27;cancel_order&#x27;, $order, $payload, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} catch (TaskRestrictionException $e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Log restriction failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Log::warning(&#x27;Order cancellation restricted&#x27;, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;order_id&#x27; =&gt; $order-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;user_id&#x27; =&gt; $user?-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;restriction_code&#x27; =&gt; $e-&gt;getCode(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;restriction_message&#x27; =&gt; $e-&gt;getMessage(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;order_status&#x27; =&gt; $order-&gt;status,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;order_total&#x27; =&gt; $order-&gt;total,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;payload&#x27; =&gt; $payload,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Track in analytics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    analytics()-&gt;track(&#x27;order_cancellation_restricted&#x27;, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;restriction_code&#x27; =&gt; $e-&gt;getCode(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;order_id&#x27; =&gt; $order-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Send to error tracking service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (app()-&gt;bound(&#x27;sentry&#x27;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app(&#x27;sentry&#x27;)-&gt;captureException($e, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;tags&#x27; =&gt; [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;restriction_code&#x27; =&gt; $e-&gt;getCode(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;order_id&#x27; =&gt; $order-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw $e; // Re-throw to handle in controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="testing-restriction-results">Testing Restriction Results<a href="#testing-restriction-results" class="hash-link" aria-label="Direct link to Testing Restriction Results" title="Direct link to Testing Restriction Results" translate="no">​</a></h3>
<p>Test restriction tasks and their results:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace Tests\Feature\Flows;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Flows\Order\RestrictCancellationRestrictionTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Foundation\Testing\RefreshDatabase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\DTO\TransitionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\FlowTaskContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Support\RestrictionResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Tests\TestCase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class RestrictionTaskTest extends TestCase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use RefreshDatabase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function test_allows_cancellation_when_all_conditions_met(): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = Order::factory()-&gt;create([&#x27;status&#x27; =&gt; &#x27;pending&#x27;]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = User::factory()-&gt;create();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user-&gt;givePermissionTo(&#x27;cancel&#x27;, Order::class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $task = new RestrictCancellationRestrictionTask();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $context = new FlowTaskContext(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $order,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TransitionResult::success(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [&#x27;reason&#x27; =&gt; &#x27;Customer request&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = $task-&gt;restriction($context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;assertTrue($result-&gt;allowed());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;assertNull($result-&gt;code());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function test_denies_cancellation_when_order_shipped(): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = Order::factory()-&gt;create([&#x27;status&#x27; =&gt; &#x27;shipped&#x27;]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = User::factory()-&gt;create();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $task = new RestrictCancellationRestrictionTask();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $context = new FlowTaskContext($order, TransitionResult::success(), [], $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = $task-&gt;restriction($context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;assertFalse($result-&gt;allowed());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;assertEquals(&#x27;ORDER_SHIPPED&#x27;, $result-&gt;code());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;assertNotNull($result-&gt;message());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function test_denies_cancellation_without_permission(): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = Order::factory()-&gt;create([&#x27;status&#x27; =&gt; &#x27;pending&#x27;]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = User::factory()-&gt;create();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // User does NOT have permission</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $task = new RestrictCancellationRestrictionTask();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $context = new FlowTaskContext($order, TransitionResult::success(), [], $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = $task-&gt;restriction($context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;assertFalse($result-&gt;allowed());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;assertEquals(&#x27;PERMISSION_DENIED&#x27;, $result-&gt;code());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function test_denies_cancellation_without_reason(): void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $order = Order::factory()-&gt;create([&#x27;status&#x27; =&gt; &#x27;pending&#x27;]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user = User::factory()-&gt;create();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $user-&gt;givePermissionTo(&#x27;cancel&#x27;, Order::class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $task = new RestrictCancellationRestrictionTask();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $context = new FlowTaskContext(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $order,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TransitionResult::success(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [], // No reason provided</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $result = $task-&gt;restriction($context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;assertFalse($result-&gt;allowed());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $this-&gt;assertEquals(&#x27;REASON_REQUIRED&#x27;, $result-&gt;code());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="best-practices">Best Practices<a href="#best-practices" class="hash-link" aria-label="Direct link to Best Practices" title="Direct link to Best Practices" translate="no">​</a></h2>
<ol>
<li class="">
<p><strong>Use Descriptive Codes</strong>: Choose codes that clearly identify the restriction reason</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ Good</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestrictionResult::deny(&#x27;ORDER_SHIPPED&#x27;, &#x27;Message&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ Bad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestrictionResult::deny(&#x27;ERROR&#x27;, &#x27;Message&#x27;);</span><br></span></code></pre></div></div>
</li>
<li class="">
<p><strong>Provide User-Friendly Messages</strong>: Messages should be understandable by end users</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ Good</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestrictionResult::deny(&#x27;ORDER_SHIPPED&#x27;, &#x27;Cannot cancel shipped orders&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ Bad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestrictionResult::deny(&#x27;ORDER_SHIPPED&#x27;, &#x27;Error code 42&#x27;);</span><br></span></code></pre></div></div>
</li>
<li class="">
<p><strong>Check Multiple Conditions</strong>: Evaluate all conditions before allowing</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Check permission</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (!$user-&gt;can(&#x27;cancel&#x27;, $order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return RestrictionResult::deny(&#x27;PERMISSION_DENIED&#x27;, &#x27;...&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Check status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ($order-&gt;status === &#x27;shipped&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return RestrictionResult::deny(&#x27;ORDER_SHIPPED&#x27;, &#x27;...&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return RestrictionResult::allow();</span><br></span></code></pre></div></div>
</li>
<li class="">
<p><strong>Use Config for Flexibility</strong>: Make restrictions configurable when possible</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$allowedStatuses = $context-&gt;config()[&#x27;allowed_statuses&#x27;] ?? [];</span><br></span></code></pre></div></div>
</li>
<li class="">
<p><strong>Return Early</strong>: Return deny results as soon as a condition fails</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ Good: Early return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ($order-&gt;status === &#x27;shipped&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return RestrictionResult::deny(&#x27;ORDER_SHIPPED&#x27;, &#x27;...&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ Bad: Nested conditions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ($order-&gt;status !== &#x27;shipped&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ($user-&gt;can(&#x27;cancel&#x27;, $order)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RestrictionResult::allow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="integration-with-flowtransition">Integration with FlowTransition<a href="#integration-with-flowtransition" class="hash-link" aria-label="Direct link to Integration with FlowTransition" title="Direct link to Integration with FlowTransition" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="execution-order">Execution Order<a href="#execution-order" class="hash-link" aria-label="Direct link to Execution Order" title="Direct link to Execution Order" translate="no">​</a></h3>
<p>Restriction tasks are executed <strong>first</strong> in the workflow transition:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// FlowTransition execution order:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 1. Restriction tasks (can deny) ← Executed FIRST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2. Validation tasks (can fail)   ← Only if restrictions pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 3. Action tasks (execute)        ← Only if restrictions pass AND validation passes</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="how-restrictions-stop-transitions">How Restrictions Stop Transitions<a href="#how-restrictions-stop-transitions" class="hash-link" aria-label="Direct link to How Restrictions Stop Transitions" title="Direct link to How Restrictions Stop Transitions" translate="no">​</a></h3>
<p>If <strong>any</strong> restriction task returns <code>deny()</code>, the transition is stopped immediately:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Inside FlowTransition::runner()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foreach ($restrictionTasks as $task) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $result = $task-&gt;restriction($context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!$result-&gt;allowed()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Transition STOPS here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Validation tasks won&#x27;t run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Action tasks won&#x27;t run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new TaskRestrictionException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;code(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result-&gt;message()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Only reached if ALL restrictions allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Continue with validation tasks...</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="multiple-restrictions">Multiple Restrictions<a href="#multiple-restrictions" class="hash-link" aria-label="Direct link to Multiple Restrictions" title="Direct link to Multiple Restrictions" translate="no">​</a></h3>
<p>When multiple restriction tasks exist, <strong>all</strong> must allow:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Example: Three restriction tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$restriction1 = new PermissionRestrictionTask();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$restriction2 = new OrderStatusRestrictionTask();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$restriction3 = new TimeBasedRestrictionTask();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// All three must return RestrictionResult::allow()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// If ANY returns deny(), transition stops</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="real-world-workflow-example">Real-World Workflow Example<a href="#real-world-workflow-example" class="hash-link" aria-label="Direct link to Real-World Workflow Example" title="Direct link to Real-World Workflow Example" translate="no">​</a></h3>
<p>Complete example showing restriction flow in a real system:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace App\Http\Controllers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use App\Models\Order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Http\Request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Http\JsonResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Facades\FlowTransition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Exceptions\TaskRestrictionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class OrderController extends Controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Cancel an order with comprehensive restriction handling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function cancel(Request $request, Order $order): JsonResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Validate request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $validated = $request-&gt;validate([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;reason&#x27; =&gt; &#x27;required|string|min:10|max:500&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;restock_inventory&#x27; =&gt; &#x27;boolean&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Execute transition - restrictions are checked automatically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $result = FlowTransition::runner(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;cancel_order&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $order,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $validated,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                auth()-&gt;user()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Transition succeeded (all restrictions passed)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;success&#x27; =&gt; true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;message&#x27; =&gt; &#x27;Order cancelled successfully&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;data&#x27; =&gt; $result-&gt;getData(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;messages&#x27; =&gt; $result-&gt;getMessages(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TaskRestrictionException $e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // A restriction denied the transition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $this-&gt;handleRestrictionFailure($e, $order);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected function handleRestrictionFailure(TaskRestrictionException $e, Order $order): JsonResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $code = $e-&gt;getCode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $message = $e-&gt;getMessage();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Map restriction codes to HTTP status codes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $statusCode = match ($code) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;USER_NOT_AUTHENTICATED&#x27; =&gt; 401,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;PERMISSION_DENIED&#x27; =&gt; 403,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;RATE_LIMIT_EXCEEDED&#x27; =&gt; 429,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            default =&gt; 403,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Provide actionable error responses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $response = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;success&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;error&#x27; =&gt; [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;code&#x27; =&gt; $code,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;message&#x27; =&gt; $message,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;order&#x27; =&gt; [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;id&#x27; =&gt; $order-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;status&#x27; =&gt; $order-&gt;status,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add context-specific information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch ($code) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            case &#x27;TIME_LIMIT_EXCEEDED&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $response[&#x27;context&#x27;] = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;order_created_at&#x27; =&gt; $order-&gt;created_at-&gt;toIso8601String(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;hours_since_creation&#x27; =&gt; $order-&gt;created_at-&gt;diffInHours(now()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            case &#x27;ORDER_SHIPPED&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $response[&#x27;context&#x27;] = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;shipped_at&#x27; =&gt; $order-&gt;shipped_at?-&gt;toIso8601String(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;tracking_number&#x27; =&gt; $order-&gt;tracking_number,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            case &#x27;RATE_LIMIT_EXCEEDED&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $response[&#x27;context&#x27;] = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;retry_after&#x27; =&gt; now()-&gt;addDay()-&gt;toIso8601String(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return response()-&gt;json($response, $statusCode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="debugging-restrictions">Debugging Restrictions<a href="#debugging-restrictions" class="hash-link" aria-label="Direct link to Debugging Restrictions" title="Direct link to Debugging Restrictions" translate="no">​</a></h3>
<p>Debug restriction failures during development:</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Facades\FlowTransition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use JobMetric\Flow\Exceptions\TaskRestrictionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Illuminate\Support\Facades\Log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $result = FlowTransition::runner(&#x27;cancel_order&#x27;, $order, $payload, $user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} catch (TaskRestrictionException $e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Debug information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Log::debug(&#x27;Restriction failure&#x27;, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;code&#x27; =&gt; $e-&gt;getCode(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;message&#x27; =&gt; $e-&gt;getMessage(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;order_id&#x27; =&gt; $order-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;order_status&#x27; =&gt; $order-&gt;status,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;user_id&#x27; =&gt; $user?-&gt;id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;payload&#x27; =&gt; $payload,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;stack_trace&#x27; =&gt; $e-&gt;getTraceAsString(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // In development, show detailed error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (app()-&gt;environment(&#x27;local&#x27;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return response()-&gt;json([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;error&#x27; =&gt; $e-&gt;getCode(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;message&#x27; =&gt; $e-&gt;getMessage(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;debug&#x27; =&gt; [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;order&#x27; =&gt; $order-&gt;toArray(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;user&#x27; =&gt; $user?-&gt;toArray(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;payload&#x27; =&gt; $payload,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ], 403);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw $e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="best-practices-for-restriction-codes">Best Practices for Restriction Codes<a href="#best-practices-for-restriction-codes" class="hash-link" aria-label="Direct link to Best Practices for Restriction Codes" title="Direct link to Best Practices for Restriction Codes" translate="no">​</a></h3>
<p><strong>1. Use Consistent Naming:</strong></p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ Good: Clear, descriptive codes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;PERMISSION_DENIED&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;ORDER_SHIPPED&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;TIME_LIMIT_EXCEEDED&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;RATE_LIMIT_EXCEEDED&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ Bad: Vague codes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;ERROR&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;FAILED&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;NOT_ALLOWED&#x27;</span><br></span></code></pre></div></div>
<p><strong>2. Group Related Codes:</strong></p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Permission-related</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;PERMISSION_DENIED&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;INSUFFICIENT_ROLE&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;OWNERSHIP_MISMATCH&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Status-related</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;ORDER_SHIPPED&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;ORDER_DELIVERED&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;ORDER_CANCELLED&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Time-related</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;TIME_LIMIT_EXCEEDED&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;OUTSIDE_BUSINESS_HOURS&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;DATE_BLOCKED&#x27;</span><br></span></code></pre></div></div>
<p><strong>3. Provide Actionable Messages:</strong></p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ Good: Tells user what to do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;TIME_LIMIT_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;Orders can only be cancelled within 24 hours. Please contact support for assistance.&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ Bad: Doesn&#x27;t help user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestrictionResult::deny(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;TIME_LIMIT_EXCEEDED&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;Time limit exceeded&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre></div></div>
<p><strong>4. Use Codes for Programmatic Handling:</strong></p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Frontend can handle specific codes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (error.code === &#x27;RATE_LIMIT_EXCEEDED&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    showRetryAfterMessage(error.retry_after);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} else if (error.code === &#x27;PERMISSION_DENIED&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    showContactSupportButton();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="related-documentation">Related Documentation<a href="#related-documentation" class="hash-link" aria-label="Direct link to Related Documentation" title="Direct link to Related Documentation" translate="no">​</a></h2>
<ul>
<li class=""><a class="" href="/packages/laravel-flow/deep-diving/support/flow-task-context">FlowTaskContext</a> - Task execution context</li>
<li class=""><a class="" href="/packages/laravel-flow/deep-diving/transition-result">TransitionResult</a> - Transition result DTO</li>
<li class=""><a class="" href="/packages/laravel-flow/deep-diving/services/flow-transition">FlowTransition Service</a> - Transition execution</li>
<li class=""><a class="" href="/packages/laravel-flow/deep-diving/services/flow-task">FlowTask Service</a> - Task management</li>
<li class=""><a class="" href="/packages/laravel-flow/deep-diving/make-task">MakeTask Command</a> - Generating task drivers</li>
<li class=""><a class="" href="/packages/laravel-flow/deep-diving/support/flow-task-registry">FlowTaskRegistry</a> - Task driver registry</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/jobmetric/document/blob/master/packages/laravel-flow/deep-diving/support/restriction-result.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/packages/laravel-flow/deep-diving/support/flow-task-context"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">FlowTaskContext</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/packages/laravel-flow/deep-diving/requests/store-flow-request"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">StoreFlowRequest</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#namespace" class="table-of-contents__link toc-highlight">Namespace</a></li><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#static-factory-methods" class="table-of-contents__link toc-highlight">Static Factory Methods</a><ul><li><a href="#allow" class="table-of-contents__link toc-highlight">allow()</a></li><li><a href="#deny" class="table-of-contents__link toc-highlight">deny()</a></li></ul></li><li><a href="#query-methods" class="table-of-contents__link toc-highlight">Query Methods</a><ul><li><a href="#allowed" class="table-of-contents__link toc-highlight">allowed()</a></li><li><a href="#code" class="table-of-contents__link toc-highlight">code()</a></li><li><a href="#message" class="table-of-contents__link toc-highlight">message()</a></li></ul></li><li><a href="#understanding-restrictionresult-in-workflow-execution" class="table-of-contents__link toc-highlight">Understanding RestrictionResult in Workflow Execution</a><ul><li><a href="#how-restrictionresult-works" class="table-of-contents__link toc-highlight">How RestrictionResult Works</a></li></ul></li><li><a href="#complete-examples" class="table-of-contents__link toc-highlight">Complete Examples</a><ul><li><a href="#example-1-basic-allow---simple-pass-through" class="table-of-contents__link toc-highlight">Example 1: Basic Allow - Simple Pass-Through</a></li><li><a href="#example-2-advanced-permission-check---multi-level-authorization" class="table-of-contents__link toc-highlight">Example 2: Advanced Permission Check - Multi-Level Authorization</a></li><li><a href="#example-3-comprehensive-business-rule-check---order-state-machine" class="table-of-contents__link toc-highlight">Example 3: Comprehensive Business Rule Check - Order State Machine</a></li><li><a href="#example-4-enterprise-level-multi-condition-restriction" class="table-of-contents__link toc-highlight">Example 4: Enterprise-Level Multi-Condition Restriction</a></li><li><a href="#example-5-advanced-configurable-restrictions---dynamic-business-rules" class="table-of-contents__link toc-highlight">Example 5: Advanced Configurable Restrictions - Dynamic Business Rules</a></li><li><a href="#example-6-advanced-time-based-restrictions---scheduling-and-windows" class="table-of-contents__link toc-highlight">Example 6: Advanced Time-Based Restrictions - Scheduling and Windows</a></li><li><a href="#example-7-resource-locking-and-concurrency-control" class="table-of-contents__link toc-highlight">Example 7: Resource Locking and Concurrency Control</a></li><li><a href="#example-8-quota-and-limit-restrictions" class="table-of-contents__link toc-highlight">Example 8: Quota and Limit Restrictions</a></li><li><a href="#example-9-complete-real-world-system---order-cancellation-workflow" class="table-of-contents__link toc-highlight">Example 9: Complete Real-World System - Order Cancellation Workflow</a></li></ul></li><li><a href="#code-conventions" class="table-of-contents__link toc-highlight">Code Conventions</a><ul><li><a href="#recommended-code-format" class="table-of-contents__link toc-highlight">Recommended Code Format</a></li><li><a href="#common-code-patterns" class="table-of-contents__link toc-highlight">Common Code Patterns</a></li></ul></li><li><a href="#error-handling-and-integration" class="table-of-contents__link toc-highlight">Error Handling and Integration</a><ul><li><a href="#how-restriction-failures-work" class="table-of-contents__link toc-highlight">How Restriction Failures Work</a></li><li><a href="#basic-error-handling" class="table-of-contents__link toc-highlight">Basic Error Handling</a></li><li><a href="#advanced-error-handling-with-code-based-responses" class="table-of-contents__link toc-highlight">Advanced Error Handling with Code-Based Responses</a></li><li><a href="#frontend-integration-example" class="table-of-contents__link toc-highlight">Frontend Integration Example</a></li><li><a href="#logging-and-monitoring" class="table-of-contents__link toc-highlight">Logging and Monitoring</a></li><li><a href="#testing-restriction-results" class="table-of-contents__link toc-highlight">Testing Restriction Results</a></li></ul></li><li><a href="#best-practices" class="table-of-contents__link toc-highlight">Best Practices</a></li><li><a href="#integration-with-flowtransition" class="table-of-contents__link toc-highlight">Integration with FlowTransition</a><ul><li><a href="#execution-order" class="table-of-contents__link toc-highlight">Execution Order</a></li><li><a href="#how-restrictions-stop-transitions" class="table-of-contents__link toc-highlight">How Restrictions Stop Transitions</a></li><li><a href="#multiple-restrictions" class="table-of-contents__link toc-highlight">Multiple Restrictions</a></li><li><a href="#real-world-workflow-example" class="table-of-contents__link toc-highlight">Real-World Workflow Example</a></li><li><a href="#debugging-restrictions" class="table-of-contents__link toc-highlight">Debugging Restrictions</a></li><li><a href="#best-practices-for-restriction-codes" class="table-of-contents__link toc-highlight">Best Practices for Restriction Codes</a></li></ul></li><li><a href="#related-documentation" class="table-of-contents__link toc-highlight">Related Documentation</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">© 2025 JobMetric.</div></div></div></footer></div>
</body>
</html>